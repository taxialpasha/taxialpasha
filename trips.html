<!DOCTYPE html>
<html dir="rtl" lang="ar">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="قائمة السائقين في تطبيق تاكسي العراق">
    <meta name="keywords" content="تاكسي العراق، سائقين، سيارات أجرة">
    <meta name="author" content="تاكسي العراق">
    <meta name="theme-color" content="#FFD700">

    <title>قائمة السائقين - تاكسي العراق</title>

    <!-- App Icons -->
    <link rel="icon" type="image/png" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527">
    <link rel="apple-touch-icon" sizes="180x180" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527">

    <!-- External CSS Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <!-- App CSS -->
    <link rel="stylesheet" href="./style.css">

    <style>
    /* أنماط عامة للتطبيق */
:root {
    --main-color: #FFD700;
    --secondary-color: #333;
    --dark-bg: #1a1a1a;
    --darker-bg: #151515;
    --text-color: #FFFFFF;
    --muted-text: #CCCCCC;
    --success-color: #2ECC40;
    --error-color: #FF4136;
    --warning-color: #FFDC00;
    --info-color: #39CCCC;
}

body {
    background-color: #121212;
    color: var(--text-color);
    font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
    direction: rtl;
}

/* تحسين شكل الإشعارات */
.toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    width: auto;
    max-width: 90%;
}

.custom-toast {
    background-color: var(--dark-bg);
    color: var(--text-color);
    padding: 12px 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    max-width: 350px;
    position: relative;
    overflow: hidden;
    border-right: 3px solid var(--main-color);
}

.custom-toast.toast-success {
    border-right-color: var(--success-color);
}

.custom-toast.toast-error {
    border-right-color: var(--error-color);
}

.custom-toast.toast-warning {
    border-right-color: var(--warning-color);
}

.custom-toast.toast-info {
    border-right-color: var(--info-color);
}

.custom-toast i {
    margin-left: 10px;
    font-size: 1.2rem;
}

.custom-toast .toast-content {
    flex: 1;
}

.custom-toast .toast-close {
    background: none;
    border: none;
    color: var(--muted-text);
    margin-right: 5px;
    font-size: 1.2rem;
    cursor: pointer;
}

/* أنماط مؤشر التحميل */
.loading-spinner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 9999;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(255, 215, 0, 0.3);
    border-radius: 50%;
    border-top-color: var(--main-color);
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* تعديلات لنافذة SweetAlert */
.swal2-popup {
    background-color: var(--dark-bg) !important;
    color: var(--text-color) !important;
}

.swal2-title, .swal2-html-container {
    color: var(--text-color) !important;
}

.swal2-icon.swal2-success .swal2-success-ring {
    border-color: var(--success-color) !important;
}

.swal2-icon.swal2-success [class^='swal2-success-line'] {
    background-color: var(--success-color) !important;
}

/* أنماط نوافذ التسجيل والإضافة */
.modal-content {
    background-color: var(--dark-bg);
    color: var(--text-color);
    border: 1px solid rgba(255, 215, 0, 0.2);
}

.modal-header {
    border-bottom: 1px solid rgba(255, 215, 0, 0.2);
}

.modal-footer {
    border-top: 1px solid rgba(255, 215, 0, 0.2);
}

.form-control, .form-select {
    background-color: var(--darker-bg);
    color: var(--text-color);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.form-control:focus, .form-select:focus {
    background-color: var(--darker-bg);
    color: var(--text-color);
    border-color: var(--main-color);
    box-shadow: 0 0 0 0.25rem rgba(255, 215, 0, 0.25);
}

.form-label {
    color: var(--muted-text);
}

.image-upload-container, .document-upload, .user-photo-upload {
    width: 100%;
    height: 200px;
    border: 2px dashed rgba(255, 215, 0, 0.3);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    overflow: hidden;
    background-color: rgba(255, 215, 0, 0.05);
    transition: all 0.3s ease;
}

.image-upload-container:hover, .document-upload:hover, .user-photo-upload:hover {
    border-color: var(--main-color);
    background-color: rgba(255, 215, 0, 0.1);
}

.upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--muted-text);
    text-align: center;
    padding: 20px;
}

.upload-placeholder i {
    font-size: 2rem;
    color: var(--main-color);
    margin-bottom: 10px;
}

.document-upload {
    height: 150px;
}

.account-type-card {
    padding: 20px;
    border-radius: 10px;
    background-color: var(--darker-bg);
    border: 1px solid rgba(255, 215, 0, 0.1);
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.account-type-card:hover {
    transform: translateY(-5px);
    border-color: var(--main-color);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.icon-container {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: rgba(255, 215, 0, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
}
    
        /* أنماط خاصة بصفحة السائقين */
        .drivers-filter-section {
            background-color: #1a1a1a;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .drivers-list-container {
            margin-top: 20px;
        }
        
        .driver-list-item {
            background-color: #1a1a1a;
            border-radius: 10px;
            margin-bottom: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.1);
            position: relative;
        }
        
        .driver-list-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.3);
        }
        
        .driver-item-status {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .status-active {
            background-color: #2ECC40;
            color: #fff;
        }
        
        .status-inactive {
            background-color: #FF4136;
            color: #fff;
        }
        
        .status-pending {
            background-color: #FFD700;
            color: #000;
        }
        
        .driver-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #FFD700;
            margin-left: 15px;
        }
        
        .driver-info {
            flex: 1;
        }
        
        .driver-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
        }
        
        .driver-meta {
            color: #CCCCCC;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .driver-rating {
            color: #FFD700;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .driver-actions {
            display: flex;
            gap: 10px;
        }
        
        .driver-actions button {
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .view-btn {
            background-color: #333;
            color: #FFD700;
            border: 1px solid #FFD700;
        }
        
        .view-btn:hover {
            background-color: #444;
        }
        
        .chat-btn {
            background-color: #FFD700;
            color: #000;
        }
        
        .chat-btn:hover {
            background-color: #e5c100;
        }
        
        .driver-details-modal .modal-content {
            background-color: #1a1a1a;
            color: #FFFFFF;
            border-radius: 15px;
        }
        
        .driver-details-header {
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
            position: relative;
        }
        
        .driver-details-header .status-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .driver-cover-photo {
            height: 150px;
            background-color: #333;
            background-image: linear-gradient(45deg, #333, #222);
            position: relative;
            border-radius: 15px 15px 0 0;
            margin-bottom: 60px;
        }
        
        .driver-big-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid #FFD700;
            object-fit: cover;
            position: absolute;
            bottom: -60px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        
        .driver-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 15px 0;
        }
        
        .stat-item {
            text-align: center;
            border-radius: 10px;
            padding: 10px 15px;
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FFD700;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #CCCCCC;
        }
        
        .driver-details-content {
            padding: 20px;
        }
        
        .info-section {
            margin-bottom: 20px;
        }
        
        .info-section-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-row {
            display: flex;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .info-label {
            min-width: 120px;
            color: #CCCCCC;
            font-weight: bold;
        }
        
        .info-value {
            flex: 1;
            color: #FFFFFF;
        }
        
        .driver-actions-large {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-btn-large {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-weight: bold;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-btn-large.primary {
            background-color: #FFD700;
            color: #000;
        }
        
        .action-btn-large.secondary {
            background-color: #333;
            color: #FFD700;
            border: 1px solid #FFD700;
        }
        
        .action-btn-large:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .no-drivers-message {
            text-align: center;
            padding: 50px 0;
            color: #CCCCCC;
        }
        
        .pendingApproval {
            opacity: 0.7;
            filter: grayscale(50%);
        }
        
        /* نمط للرسوم المتحركة */
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        /* تأثير التمرير السلس */
        html {
            scroll-behavior: smooth;
        }
        
        /* التوافق مع الشاشات الصغيرة */
        @media (max-width: 768px) {
            .driver-list-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .driver-avatar {
                margin-bottom: 15px;
                margin-left: 0;
            }
            
            .driver-actions {
                margin-top: 15px;
                width: 100%;
            }
            
            .driver-actions button {
                flex: 1;
            }
            
            .driver-stats {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .stat-item {
                flex: 1;
                min-width: 80px;
            }
        }
    </style>
</head>

<body>
    <!-- تصميم شريط العنوان -->
    <nav class="navbar app-header fixed-top">
        <div class="container-fluid">
            <div class="header-content">
                <!-- زر فتح الشريط الجانبي -->
                <button class="nav-toggle" onclick="toggleSideNav()">
                    <i class="fas fa-bars" style="color: #FFD700;"></i>
                </button>
                
                <!-- Logo and App Name -->
                <a class="app-logo d-flex align-items-center" href="index.html">
                    <i class="fas fa-taxi me-2" style="color: #FFD700;"></i>
                    <span style="font-size: 0.8rem;">Iraq Taxi</span>
                </a>
                
                <!-- Tools: Search, Notifications, Messages, Profile -->
                <div class="tools d-flex align-items-center">
                    <!-- Search Icon -->
                    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#searchModal">
                        <i class="fas fa-search" style="color: #FFD700;"></i>
                    </a>
                    
                    <!-- Notifications Icon -->
                    <a class="nav-link position-relative" href="#" data-bs-toggle="modal" data-bs-target="#notificationsModal" id="notificationsBtn">
                        <i class="fas fa-bell" style="color: #FFD700;"></i>
                        <span class="notification-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">0</span>
                    </a>
                    
                    <!-- Messages Icon -->
                    <a class="nav-link position-relative" href="#" data-bs-toggle="modal" data-bs-target="#messagesModal">
                        <i class="fas fa-envelope" style="color: #FFD700;"></i>
                        <span class="message-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">0</span>
                    </a>
                    
                    <!-- Profile/Account Icon -->
                    <a class="nav-link user-profile-btn" href="#" data-bs-toggle="modal" data-bs-target="#profileModal">
                        <img id="userProfileImage" src="default-profile.png" alt="Profile" class="rounded-circle" style="width: 35px; height: 35px; object-fit: cover; display: none;">
                        <i class="fas fa-user-circle" id="defaultProfileIcon" style="color: #FFD700;"></i>
                        <span class="ms-1 d-none d-md-inline" id="profileText">تسجيل الدخول</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- الشريط الجانبي -->
    <div class="side-nav" id="sideNav">
        <div class="side-nav-header">
            <h2 class="side-nav-title">تاكسي العراق</h2>
            <button class="side-nav-close" onclick="toggleSideNav()">×</button>
        </div>
        
        <!-- قسم معلومات المستخدم -->
        <div class="side-nav-user-info">
            <div class="text-center">
                <i class="fas fa-user-circle text-white" style="font-size: 4rem;"></i>
                <h6 class="text-white mt-3">مرحباً بك</h6>
                <p class="text-white-50 small">قم بتسجيل الدخول للوصول إلى حسابك</p>
                <div class="mt-3">
                    <button class="btn btn-gold w-100 mb-2" data-bs-toggle="modal" data-bs-target="#loginModal">
                        تسجيل الدخول
                    </button>
                    <button class="btn btn-outline-light w-100 mb-2" data-bs-toggle="modal" data-bs-target="#userRegistrationModal">
                        إنشاء حساب
                    </button>
                    <button class="btn btn-outline-light w-100" data-bs-toggle="modal" data-bs-target="#addDriverModal">
                        إضافة سائق
                    </button>
                </div>
            </div>
        </div>
        
        <div class="side-nav-items">
            <a href="/" class="side-nav-item"><i class="fas fa-home" style="color: #FFD700;"></i> الرئيسية</a>
            <a href="/drivers" class="side-nav-item active"><i class="fas fa-users" style="color: #4CAF50;"></i> السائقين</a>
            <a href="trips.html" class="side-nav-item"><i class="fas fa-car" style="color: #2196F3;"></i> الرحلات</a>
            <a href="map.html" class="side-nav-item"><i class="fas fa-map" style="color: #FF5722;"></i> الخريطة</a>
            <a href="notifications.html" class="side-nav-item"><i class="fas fa-bell" style="color: #9C27B0;"></i> الإشعارات</a>
            <a href="messages.html" class="side-nav-item"><i class="fas fa-envelope" style="color: #FFC107;"></i> الرسائل</a>
            <a href="settings.html" class="side-nav-item"><i class="fas fa-cog" style="color: #607D8B;"></i> الإعدادات</a>
            <a href="#" class="side-nav-item driver-only" style="display: none;"><i class="fas fa-user-plus" style="color: #E91E63;"></i> إضافة سائق</a>
        </div>
        
        <!-- زر تسجيل الخروج في الشريط الجانبي -->
        <div class="side-nav-footer">
            <button onclick="handleLogout()" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
            </button>
        </div>
    </div>

    <!-- خلفية الشريط الجانبي -->
    <div class="nav-backdrop" id="navBackdrop" onclick="toggleSideNav()"></div>

    <!-- المحتوى الرئيسي -->
    <div class="container main-content" style="margin-top: 80px; padding-bottom: 50px;">
        <!-- عنوان الصفحة -->
        <div class="page-header animate__animated animate__fadeIn">
            <h1 class="page-title">
                <i class="fas fa-users" style="color: #4CAF50;"></i>
                قائمة السائقين
            </h1>
            <p class="text-muted">اعثر على السائقين حسب المحافظة والمنطقة</p>
        </div>

        <!-- قسم التصفية -->
        <div class="drivers-filter-section animate__animated animate__fadeIn">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">المحافظة</label>
                    <select class="form-select" id="provinceFilter" onchange="loadAreas(this.value); filterDrivers();">
                        <option value="">كل المحافظات</option>
                        <!-- سيتم تعبئتها بواسطة JavaScript -->
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">المنطقة</label>
                    <select class="form-select" id="areaFilter" onchange="filterDrivers();" disabled>
                        <option value="">كل المناطق</option>
                        <!-- سيتم تعبئتها بواسطة JavaScript بناءً على اختيار المحافظة -->
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">الحالة</label>
                    <select class="form-select" id="statusFilter" onchange="filterDrivers();">
                        <option value="">الكل</option>
                        <option value="active">متاح</option>
                        <option value="inactive">مشغول</option>
                        <option value="pending">قيد المراجعة</option>
                    </select>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-8 mb-3">
                    <label class="form-label">بحث</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="ابحث عن اسم السائق، نوع السيارة..." onkeyup="filterDrivers()">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">ترتيب حسب</label>
                    <select class="form-select" id="sortDrivers" onchange="filterDrivers();">
                        <option value="rating">التقييم (الأعلى أولاً)</option>
                        <option value="trips">عدد الرحلات (الأعلى أولاً)</option>
                        <option value="name">الاسم (أبجدياً)</option>
                        <option value="recent">الأحدث</option>
                    </select>
                </div>
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-sm btn-outline-light" onclick="resetFilters()">
                    <i class="fas fa-sync-alt me-2"></i> إعادة تعيين الفلترة
                </button>
                <span class="mx-3 text-muted" id="driversCount">0 سائق</span>
            </div>
        </div>

        <!-- حاوية قائمة السائقين -->
        <div class="drivers-list-container" id="driversListContainer">
            <div class="text-center py-5" id="loadingDrivers">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">جاري التحميل...</span>
                </div>
                <p class="mt-3 text-muted">جاري تحميل قائمة السائقين...</p>
            </div>
            
            <!-- ستتم تعبئة هذا القسم بواسطة JavaScript -->
            <div id="driversList"></div>
            
            <!-- رسالة عند عدم وجود سائقين -->
            <div class="no-drivers-message" id="noDriversMessage" style="display: none;">
                <i class="fas fa-search fa-3x mb-3" style="color: #555;"></i>
                <h3>لا يوجد سائقين</h3>
                <p class="text-muted">لم يتم العثور على سائقين يطابقون معايير البحث</p>
            </div>
        </div>
    </div>

    <!-- نافذة تفاصيل السائق المنبثقة -->
    <div class="modal fade" id="driverDetailsModal" tabindex="-1" aria-labelledby="driverDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered driver-details-modal">
            <div class="modal-content">
                <div class="modal-body p-0">
                    <!-- ستتم تعبئة هذا القسم بواسطة JavaScript -->
                    <div id="driverDetailsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- نافذة تسجيل الدخول -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تسجيل الدخول</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm" onsubmit="handleLogin(event)">
                        <div class="mb-3">
                            <label class="form-label">البريد الإلكتروني</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">كلمة المرور</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-sign-in-alt me-2"></i>
                                تسجيل الدخول
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تسجيل المستخدم -->
    <div class="modal fade" id="userRegistrationModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="text-center w-100">
                        <img src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527"
                            alt="شعار التطبيق" style="height: 60px;">
                        <h5 class="modal-title mt-2">تسجيل مستخدم جديد</h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userRegistrationForm" class="needs-validation" novalidate>
                        <!-- المعلومات الشخصية -->
                        <div class="registration-section mb-4">
                            <h6 class="section-title">المعلومات الشخصية</h6>
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="text-center mb-3">
                                        <div class="user-photo-upload"
                                            onclick="document.getElementById('userPhoto').click()">
                                            <img id="userPhotoPreview" src="#" alt="">
                                            <div class="upload-placeholder">
                                                <i class="fas fa-camera"></i>
                                                <span>صورة شخصية</span>
                                            </div>
                                        </div>
                                        <input type="file" id="userPhoto" accept="image/*" style="display: none;"
                                            onchange="previewUserPhoto(this)">
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">الاسم الثلاثي</label>
                                    <input type="text" class="form-control" name="fullName" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">البريد الإلكتروني</label>
                                    <input type="email" class="form-control" name="email" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">رقم الهاتف</label>
                                    <input type="tel" class="form-control" name="phone" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">كلمة المرور</label>
                                    <input type="password" class="form-control" name="password" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">تأكيد كلمة المرور</label>
                                    <input type="password" class="form-control" name="confirmPassword" required>
                                </div>
                            </div>
                        </div>

                        <!-- معلومات السكن -->
                        <div class="registration-section mb-4">
                            <h6 class="section-title">معلومات السكن</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">المحافظة</label>
                                    <select class="form-select" name="province" id="userProvince" onchange="loadAreas(this.value)"
                                        required>
                                        <option value="">اختر المحافظة</option>
                                        <!-- سيتم ملء الخيارات عبر JavaScript -->
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">المنطقة</label>
                                    <select class="form-select" name="area" id="userArea" required>
                                        <option value="">اختر المنطقة</option>
                                        <!-- سيتم ملء الخيارات عبر JavaScript -->
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">العنوان التفصيلي</label>
                                    <textarea class="form-control" name="address" rows="2" required></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- الشروط والأحكام -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="terms" id="terms" required>
                            <label class="form-check-label" for="terms">
                                أوافق على <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">الشروط
                                    والأحكام</a>
                            </label>
                        </div>

                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="fas fa-user-plus me-2"></i>
                                تسجيل
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة سائق -->
    <div class="modal fade" id="addDriverModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة سائق جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addDriverForm" onsubmit="handleAddDriver(event)">
                        <div class="mb-4 text-center">
                            <div class="image-upload-container"
                                onclick="document.getElementById('driverImage').click()">
                                <input type="file" id="driverImage" accept="image/*" style="display: none"
                                    onchange="handleImagePreview(event)">
                                <img id="imagePreview" src="#" alt=""
                                    style="display: none; width: 100%; height: 100%; object-fit: cover;">
                                <div class="upload-placeholder">
                                    <i class="fas fa-camera fa-2x mb-2"></i>
                                    <p>انقر لإضافة صورة</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">البريد الإلكتروني</label>
                                <input type="email" class="form-control" id="driverEmail" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">كلمة المرور</label>
                                <input type="password" class="form-control" id="driverPassword" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">إعادة كتابة كلمة المرور</label>
                                <input type="password" class="form-control" id="confirmDriverPassword" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">اسم السائق</label>
                                <input type="text" class="form-control" id="driverName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">رقم الهاتف</label>
                                <input type="tel" class="form-control" id="driverPhone" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">نوع السيارة</label>
                                <input type="text" class="form-control" id="carType" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">موديل السيارة</label>
                                <input type="number" class="form-control" id="carModel" required>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">المحافظة</label>
                                <select class="form-select" id="driverLocation" onchange="loadAreas(this.value)" required>
                                    <option value="">اختر المحافظة</option>
                                    <!-- سيتم ملء الخيارات عبر JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">المنطقة</label>
                                <select class="form-select" id="driverArea" required>
                                    <option value="">اختر المنطقة</option>
                                    <!-- سيتم ملء الخيارات عبر JavaScript -->
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">معلومات إضافية</label>
                                <textarea class="form-control" id="driverBio" rows="3"></textarea>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">موقع السائق</label>
                                <div class="d-flex gap-2 mb-2">
                                    <input type="text" class="form-control" id="driverLatitude" placeholder="خط العرض"
                                        readonly>
                                    <input type="text" class="form-control" id="driverLongitude" placeholder="خط الطول"
                                        readonly>
                                </div>
                                <button type="button" class="btn btn-primary w-100" onclick="captureCurrentLocation()">
                                    <i class="fas fa-location-arrow me-2"></i>
                                    تحديد الموقع الحالي
                                </button>
                            </div>
                        </div>

                        <div class="registration-section mb-4">
                            <h6 class="section-title">المستمسكات الرسمية</h6>

                            <!-- هوية الأحوال المدنية -->
                            <div class="row g-3 mb-4">
                                <div class="col-12">
                                    <label class="form-label">هوية الأحوال المدنية</label>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('idCardFront').click()">
                                        <input type="file" id="idCardFront" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'idCardFrontPreview')" required>
                                        <img id="idCardFrontPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <p>صورة الهوية (الأمامية)</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('idCardBack').click()">
                                        <input type="file" id="idCardBack" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'idCardBackPreview')" required>
                                        <img id="idCardBackPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <p>صورة الهوية (الخلفية)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- إجازة السوق -->
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">إجازة السوق</label>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('licenseFront').click()">
                                        <input type="file" id="licenseFront" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'licenseFrontPreview')" required>
                                        <img id="licenseFrontPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <p>إجازة السوق (الأمامية)</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('licenseBack').click()">
                                        <input type="file" id="licenseBack" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'licenseBackPreview')" required>
                                        <img id="licenseBackPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <p>إجازة السوق (الخلفية)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary w-100">إضافة السائق</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة اختيار نوع الحساب -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 text-center">
                    <h5 class="modal-title w-100">اختر العملية</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body py-4">
                    <div class="row g-4">
                        <!-- زر تسجيل الدخول -->
                        <div class="col-12 mb-3">
                            <div class="account-type-card" onclick="openLoginModal()">
                                <div class="icon-container mb-3">
                                    <i class="fas fa-sign-in-alt fa-3x"></i>
                                </div>
                                <h6>تسجيل الدخول</h6>
                                <p class="small text-muted">لديك حساب بالفعل؟ سجل دخولك</p>
                            </div>
                        </div>
                        <!-- زر انشاء حساب -->
                        <div class="col-12">
                            <div class="account-type-card" onclick="openUserRegistration()">
                                <div class="icon-container mb-3">
                                    <i class="fas fa-user fa-3x"></i>
                                </div>
                                <h6>انشاء حساب</h6>
                                <p class="small text-muted">احجز رحلاتك بسهولة</p>
                            </div>
                        </div>
                        <!-- زر إضافة سائق -->
                        <div class="col-12">
                            <div class="account-type-card" onclick="showAddDriverModal()">
                                <div class="icon-container mb-3">
                                    <i class="fas fa-user-plus fa-3x"></i>
                                </div>
                                <h6>إضافة سائق</h6>
                                <p class="small text-muted">أضف سائق جديد إلى النظام</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة البحث المنبثقة -->
    <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="searchModalLabel">بحث عن سائق</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="search-wrapper">
                        <!-- حقل البحث -->
                        <div class="search-input-wrapper mb-3">
                            <div class="input-group">
                                <input type="text" class="form-control search-input" id="navbarSearchInput"
                                    placeholder="ابحث عن اسم السائق، المنطقة، نوع السيارة..." autofocus>
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                            </div>
                        </div>

                        <!-- خيارات البحث -->
                        <div class="search-options mb-3">
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="searchType" id="searchAll" checked>
                                <label class="btn btn-outline-primary" for="searchAll">الكل</label>

                                <input type="radio" class="btn-check" name="searchType" id="searchName">
                                <label class="btn btn-outline-primary" for="searchName">الاسم</label>

                                <input type="radio" class="btn-check" name="searchType" id="searchLocation">
                                <label class="btn btn-outline-primary" for="searchLocation">المنطقة</label>

                                <input type="radio" class="btn-check" name="searchType" id="searchCar">
                                <label class="btn btn-outline-primary" for="searchCar">السيارة</label>
                            </div>
                        </div>

                        <!-- نتائج البحث -->
                        <div id="searchResults" class="search-results"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <!-- App Scripts -->
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEMiAI",
            authDomain: "messageemeapp.firebaseapp.com",
            databaseURL: "https://messageemeapp-default-rtdb.firebaseio.com",
            projectId: "messageemeapp",
            storageBucket: "messageemeapp.appspot.com",
            messagingSenderId: "255034474844",
            appId: "1:255034474844:web:5e3b7a6bc4b2fb94cc4199"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();
        const auth = firebase.auth();

        // قاموس المحافظات والمناطق
        const iraqProvinces = {
            "بغداد": ["الكرخ", "الرصافة", "الأعظمية", "الكاظمية", "المنصور", "الدورة", "الشعب", "الكرادة", "زيونة", "الغدير", "البلديات", "الشعلة", "الحرية", "الوشاش", "حي الجامعة", "الصليخ", "بغداد الجديدة", "مدينة الصدر", "الزعفرانية", "العامرية", "الغزالية", "الجادرية", "الحارثية", "الجهاد", "البياع", "الخضراء", "حي الخليج", "التاجي"],
            "البصرة": ["البصرة الجديدة", "الزبير", "أبو الخصيب", "القرنة", "شط العرب", "الفاو", "الهارثة", "الدير", "المدينة", "العشار", "البراضعية", "الخور", "النجيبية", "الفيحاء", "المعقل", "سفوان", "الخصيب", "جبيلة", "القبلة", "ياسين خريبط", "الشعيبة"],
            "نينوى": ["الموصل", "تلعفر", "الحمدانية", "سنجار", "الحضر", "البعاج", "عين سفني", "تلكيف", "القيارة", "مخمور", "شيخان", "الحيدانية", "الشمال", "وانة", "سميل"],
            "أربيل": ["عنكاوا", "شقلاوة", "خبات", "سوران", "جومان", "رواندوز", "ميرگسور", "كوية", "المركز", "دشتي هولير", "خيفتي", "دارتو", "بنصلاوة", "حرير", "سيديكان", "شيروان-مزن", "مخمور", "قوشتبة"],
            "النجف": ["الكوفة", "المناذرة", "المشخاب", "الحيدرية", "العباسية", "القادسية", "الحرية", "النجف القديمة", "الغري", "النصر", "الوفاء", "الزهراء", "الجامعة", "السلام", "الغدير", "المرتضى", "القدس", "الأمير"],
            "كربلاء": ["الحسينية", "الهندية", "عين التمر", "الحر", "الجدول الغربي", "مركز كربلاء", "الخيرات", "الرشيد", "العباس", "الإصلاح", "الحسين", "المخيم", "الأنصار", "باب الخان", "الإسكان"],
            "كركوك": ["دبس", "الحويجة", "داقوق", "تازة", "شوان", "يايجي", "الملتقى", "العروبة", "القادسية", "الواسطي", "المنصور", "النصر", "الرياض", "الرشاد", "الزاب", "الرياض", "الصناعي"],
            "الأنبار": ["الرمادي", "الفلوجة", "هيت", "حديثة", "الخالدية", "الصقلاوية", "كبيسة", "العامرية", "الحبانية", "راوة", "عنه", "الرطبة", "القائم", "البغدادي", "الكرمة", "الوليد", "الحقلانية", "الرحالية"],
            "بابل": ["الحلة", "المسيب", "الهاشمية", "القاسم", "المحاويل", "الكفل", "النيل", "أبو غرق", "المدحتية", "الإسكندرية"],
            "ديالى": ["بعقوبة", "المقدادية", "خانقين", "بلدروز", "كفري", "الخالص", "جلولاء", "قزانية", "مندلي", "قرة تبة"],
            "ذي قار": ["الناصرية", "سوق الشيوخ", "الشطرة", "الرفاعي", "الجبايش", "قلعة سكر", "الغراف"],
            "صلاح الدين": ["تكريت", "سامراء", "بيجي", "بلد", "الدور", "الشرقاط", "طوز خورماتو", "العلم"],
            "واسط": ["الكوت", "النعمانية", "الحي", "بدرة", "الصويرة", "العزيزية", "الموفقية"],
            "ميسان": ["العمارة", "المجر الكبير", "الكحلاء", "علي الغربي", "قلعة صالح", "الميمونة"],
            "المثنى": ["السماوة", "الرميثة", "السوير", "المجد", "الخضر", "الهلال", "النجمي", "الوركاء"],
            "دهوك": ["زاخو", "العمادية", "سميل", "الشيخان", "ئاكرى", "بردرش", "زاويتة", "باتيل"],
            "القادسية": ["الديوانية", "عفك", "الشامية", "الحمزة", "نفر", "غماس", "سومر", "الشنافية"]
        };

        // متغير عام لتخزين السائقين
        let allDrivers = [];

        // عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // تهيئة قوائم المحافظات
            initializeProvinceDropdown();
            
            // تحميل السائقين
            loadDrivers();
            
            // مراقبة حالة المستخدم
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    console.log('تم تسجيل الدخول:', user.uid);
                    loadUserData(user);
                } else {
                    console.log('غير مسجل الدخول');
                    resetUserInterface();
                }
            });
        });

        // دالة تهيئة قائمة المحافظات
        function initializeProvinceDropdown() {
            const provinceSelect = document.getElementById('provinceFilter');
            if (!provinceSelect) return;
            
            // إضافة خيارات المحافظات
            Object.keys(iraqProvinces).forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                provinceSelect.appendChild(option);
            });
        }

        // دالة تحميل المناطق بناءً على المحافظة المختارة
        function loadAreas(province) {
            const areaSelect = document.getElementById('areaFilter');
            if (!areaSelect) return;
            
            // تفريغ القائمة
            areaSelect.innerHTML = '<option value="">كل المناطق</option>';
            
            // تعطيل القائمة إذا لم يتم اختيار محافظة
            if (!province) {
                areaSelect.disabled = true;
                return;
            }
            
            // إضافة المناطق للمحافظة المختارة
            if (iraqProvinces[province]) {
                iraqProvinces[province].forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    areaSelect.appendChild(option);
                });
                
                // تفعيل القائمة
                areaSelect.disabled = false;
            }
        }

        // دالة تحميل السائقين من Firebase
        function loadDrivers() {
            const loadingElement = document.getElementById('loadingDrivers');
            const noDriversMessage = document.getElementById('noDriversMessage');
            const driversListElement = document.getElementById('driversList');
            
            if (loadingElement) loadingElement.style.display = 'block';
            if (noDriversMessage) noDriversMessage.style.display = 'none';
            if (driversListElement) driversListElement.innerHTML = '';
            
            // استدعاء البيانات من Firebase
            firebase.database().ref('drivers').once('value')
                .then(snapshot => {
                    if (loadingElement) loadingElement.style.display = 'none';
                    
                    allDrivers = [];
                    
                    snapshot.forEach(childSnapshot => {
                        const driverId = childSnapshot.key;
                        const driver = childSnapshot.val();
                        
                        // إضافة معرف السائق إلى الكائن
                        driver.id = driverId;
                        
                        // إضافة السائق إلى المصفوفة
                        allDrivers.push(driver);
                    });
                    
                    // تحديث عدد السائقين
                    updateDriversCount(allDrivers.length);
                    
                    // عرض السائقين بعد الفلترة
                    filterDrivers();
                })
                .catch(error => {
                    console.error('Error loading drivers:', error);
                    
                    if (loadingElement) loadingElement.style.display = 'none';
                    if (driversListElement) {
                        driversListElement.innerHTML = `
                            <div class="alert alert-danger text-center">
                                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                <h4>حدث خطأ أثناء تحميل البيانات</h4>
                                <p>${error.message}</p>
                                <button class="btn btn-outline-danger mt-3" onclick="loadDrivers()">
                                    <i class="fas fa-sync me-2"></i> إعادة المحاولة
                                </button>
                            </div>
                        `;
                    }
                });
        }

        // دالة فلترة السائقين
        function filterDrivers() {
            const provinceFilter = document.getElementById('provinceFilter').value;
            const areaFilter = document.getElementById('areaFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchFilter = document.getElementById('searchInput').value.toLowerCase();
            const sortBy = document.getElementById('sortDrivers').value;
            
            const driversListElement = document.getElementById('driversList');
            const noDriversMessage = document.getElementById('noDriversMessage');
            
            if (!driversListElement || !noDriversMessage) return;
            
            // فلترة السائقين حسب المعايير
            let filteredDrivers = allDrivers.filter(driver => {
                // فلترة حسب المحافظة
                if (provinceFilter && (!driver.location || driver.location !== provinceFilter && driver.province !== provinceFilter)) {
                    return false;
                }
                
                // فلترة حسب المنطقة
                if (areaFilter && (!driver.area || driver.area !== areaFilter)) {
                    return false;
                }
                
                // فلترة حسب الحالة
                if (statusFilter) {
                    if (statusFilter === 'active' && (!driver.active || driver.active !== true)) {
                        return false;
                    } else if (statusFilter === 'inactive' && (driver.active || driver.active === true)) {
                        return false;
                    } else if (statusFilter === 'pending' && (!driver.approvalStatus || driver.approvalStatus !== 'pending')) {
                        return false;
                    }
                }
                
                // فلترة حسب البحث
                if (searchFilter) {
                    const nameMatch = driver.name && driver.name.toLowerCase().includes(searchFilter);
                    const carTypeMatch = driver.carType && driver.carType.toLowerCase().includes(searchFilter);
                    const locationMatch = driver.location && driver.location.toLowerCase().includes(searchFilter);
                    
                    if (!nameMatch && !carTypeMatch && !locationMatch) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // ترتيب السائقين
            filteredDrivers.sort((a, b) => {
                switch (sortBy) {
                    case 'rating':
                        return (b.rating || 0) - (a.rating || 0);
                    case 'trips':
                        return (b.trips || 0) - (a.trips || 0);
                    case 'name':
                        return (a.name || '').localeCompare(b.name || '');
                    case 'recent':
                        return (b.createdAt || 0) - (a.createdAt || 0);
                    default:
                        return 0;
                }
            });
            
            // تحديث عدد السائقين بعد الفلترة
            updateDriversCount(filteredDrivers.length);
            
            // عرض النتائج
            if (filteredDrivers.length === 0) {
                driversListElement.innerHTML = '';
                noDriversMessage.style.display = 'block';
            } else {
                noDriversMessage.style.display = 'none';
                driversListElement.innerHTML = filteredDrivers.map(driver => createDriverListItem(driver)).join('');
            }
        }

        // دالة تحديث عدد السائقين
        function updateDriversCount(count) {
            const countElement = document.getElementById('driversCount');
            if (countElement) {
                countElement.textContent = `${count} سائق`;
            }
        }

        // دالة إعادة تعيين الفلاتر
        function resetFilters() {
            document.getElementById('provinceFilter').value = '';
            document.getElementById('areaFilter').value = '';
            document.getElementById('areaFilter').disabled = true;
            document.getElementById('statusFilter').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('sortDrivers').value = 'rating';
            
            filterDrivers();
        }

        // دالة إنشاء عنصر السائق في القائمة
        function createDriverListItem(driver) {
            // التحقق من حالة السائق
            const isApproved = driver.approved === true;
            const isPending = driver.approvalStatus === 'pending';
            const isActive = driver.active === true && isApproved;
            
            // تحديد لون الحالة وصفها
            let statusClass = '';
            let statusText = '';
            
            if (!isApproved) {
                statusClass = isPending ? 'status-pending' : 'status-inactive';
                statusText = isPending ? 'قيد المراجعة' : 'غير مفعل';
            } else {
                statusClass = isActive ? 'status-active' : 'status-inactive';
                statusText = isActive ? 'متاح' : 'مشغول';
            }
            
            // تحديد تأثير عنصر السائق قيد المراجعة
          // تحديد تأثير عنصر السائق قيد المراجعة
            const pendingClass = !isApproved ? 'pendingApproval' : '';
            
            // إنشاء نجوم التقييم
            const rating = driver.rating || 5.0;
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let starsHtml = '';
            
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    starsHtml += '<i class="fas fa-star"></i>';
                } else if (i === fullStars && hasHalfStar) {
                    starsHtml += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    starsHtml += '<i class="far fa-star"></i>';
                }
            }
            
            return `
                <div class="driver-list-item animate__animated animate__fadeIn ${pendingClass}" data-driver-id="${driver.id}">
                    <span class="driver-item-status ${statusClass}">${statusText}</span>
                    <img src="${driver.imageUrl || driver.photoUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" 
                         alt="${driver.name}" 
                         class="driver-avatar"
                         onerror="this.src='https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'">
                    
                    <div class="driver-info">
                        <h4 class="driver-name">${driver.name || 'سائق بدون اسم'}</h4>
                        
                        <div class="driver-rating">
                            ${starsHtml} <span class="ms-1">${rating.toFixed(1)}</span>
                        </div>
                        
                        <div class="driver-meta">
                            <p><i class="fas fa-car me-2" style="color: #FFD700;"></i>${driver.carType || ''} ${driver.carModel || ''}</p>
                            <p><i class="fas fa-map-marker-alt me-2" style="color: #FFD700;"></i>${driver.location || driver.province || 'غير محدد'}</p>
                            <p><i class="fas fa-route me-2" style="color: #FFD700;"></i>الرحلات: ${driver.trips || 0}</p>
                        </div>
                        
                        <div class="driver-actions">
                            <button class="view-btn" onclick="showDriverDetails('${driver.id}')">
                                <i class="fas fa-info-circle"></i>
                                عرض التفاصيل
                            </button>
                            <button class="chat-btn" onclick="openChatWindow('${driver.id}')" ${!isApproved ? 'disabled' : ''}>
                                <i class="fas fa-comment"></i>
                                مراسلة
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // دالة عرض تفاصيل السائق
        function showDriverDetails(driverId) {
            const driver = allDrivers.find(d => d.id === driverId);
            if (!driver) {
                showToast('لم يتم العثور على بيانات السائق', 'error');
                return;
            }
            
            // التحقق من حالة السائق
            const isApproved = driver.approved === true;
            const isPending = driver.approvalStatus === 'pending';
            const isActive = driver.active === true && isApproved;
            
            // تحديد لون الحالة وصفها
            let statusClass = '';
            let statusText = '';
            
            if (!isApproved) {
                statusClass = isPending ? 'bg-warning text-dark' : 'bg-danger';
                statusText = isPending ? 'قيد المراجعة' : 'غير مفعل';
            } else {
                statusClass = isActive ? 'bg-success' : 'bg-danger';
                statusText = isActive ? 'متاح' : 'مشغول';
            }
            
            // تنسيق التاريخ
            const formatDate = (timestamp) => {
                if (!timestamp) return 'غير محدد';
                const date = new Date(timestamp);
                return date.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            };
            
            // إنشاء نجوم التقييم
            const rating = driver.rating || 5.0;
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let starsHtml = '';
            
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    starsHtml += '<i class="fas fa-star"></i>';
                } else if (i === fullStars && hasHalfStar) {
                    starsHtml += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    starsHtml += '<i class="far fa-star"></i>';
                }
            }
            
            // إضافة المستندات إذا كانت موجودة
            let documentsSection = '';
            if (driver.documents) {
                documentsSection = `
                    <div class="info-section">
                        <div class="info-section-title">
                            <i class="fas fa-file-alt"></i>
                            المستندات
                        </div>
                        <div class="row g-3 my-2">
                            ${driver.documents.idCard ? `
                                <div class="col-md-6">
                                    <div class="card bg-dark">
                                        <div class="card-header text-white">هوية الأحوال المدنية</div>
                                        <div class="card-body d-flex gap-2">
                                            ${driver.documents.idCard.front ? `
                                                <a href="${driver.documents.idCard.front}" target="_blank" class="btn btn-sm btn-outline-light">
                                                    <i class="fas fa-id-card me-1"></i> الوجه الأمامي
                                                </a>
                                            ` : ''}
                                            ${driver.documents.idCard.back ? `
                                                <a href="${driver.documents.idCard.back}" target="_blank" class="btn btn-sm btn-outline-light">
                                                    <i class="fas fa-id-card me-1"></i> الوجه الخلفي
                                                </a>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${driver.documents.driverLicense ? `
                                <div class="col-md-6">
                                    <div class="card bg-dark">
                                        <div class="card-header text-white">إجازة السوق</div>
                                        <div class="card-body d-flex gap-2">
                                            ${driver.documents.driverLicense.front ? `
                                                <a href="${driver.documents.driverLicense.front}" target="_blank" class="btn btn-sm btn-outline-light">
                                                    <i class="fas fa-id-card me-1"></i> الوجه الأمامي
                                                </a>
                                            ` : ''}
                                            ${driver.documents.driverLicense.back ? `
                                                <a href="${driver.documents.driverLicense.back}" target="_blank" class="btn btn-sm btn-outline-light">
                                                    <i class="fas fa-id-card me-1"></i> الوجه الخلفي
                                                </a>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // إنشاء محتوى نافذة التفاصيل
            const detailsContent = `
                <div class="driver-cover-photo">
                    <img src="${driver.imageUrl || driver.photoUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" 
                         alt="${driver.name}" 
                         class="driver-big-avatar"
                         onerror="this.src='https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'">
                </div>
                
                <div class="driver-details-header">
                    <h4 class="mb-2">${driver.name || 'سائق بدون اسم'}</h4>
                    <p class="text-muted mb-3">${driver.bio || 'لا توجد معلومات إضافية'}</p>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                    
                    <div class="driver-stats">
                        <div class="stat-item">
                            <div class="stat-value">${rating.toFixed(1)}</div>
                            <div class="stat-label">التقييم</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${driver.trips || 0}</div>
                            <div class="stat-label">الرحلات</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${formatDate(driver.createdAt)}</div>
                            <div class="stat-label">تاريخ التسجيل</div>
                        </div>
                    </div>
                </div>
                
                <div class="driver-details-content">
                    <div class="info-section">
                        <div class="info-section-title">
                            <i class="fas fa-user"></i>
                            المعلومات الشخصية
                        </div>
                        <div class="info-row">
                            <div class="info-label">الاسم</div>
                            <div class="info-value">${driver.name || 'غير محدد'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">رقم الهاتف</div>
                            <div class="info-value">${driver.phone || 'غير محدد'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">البريد الإلكتروني</div>
                            <div class="info-value">${driver.email || 'غير محدد'}</div>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-section-title">
                            <i class="fas fa-car"></i>
                            معلومات المركبة
                        </div>
                        <div class="info-row">
                            <div class="info-label">نوع المركبة</div>
                            <div class="info-value">${driver.carType || 'غير محدد'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">موديل المركبة</div>
                            <div class="info-value">${driver.carModel || 'غير محدد'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">لون المركبة</div>
                            <div class="info-value">${driver.vehicleColor || 'غير محدد'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">رقم المركبة</div>
                            <div class="info-value">${driver.vehicleNumber || 'غير محدد'}</div>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-section-title">
                            <i class="fas fa-map-marker-alt"></i>
                            معلومات الموقع
                        </div>
                        <div class="info-row">
                            <div class="info-label">المحافظة</div>
                            <div class="info-value">${driver.province || driver.location || 'غير محدد'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">المنطقة</div>
                            <div class="info-value">${driver.area || 'غير محدد'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">العنوان</div>
                            <div class="info-value">${driver.address || 'غير محدد'}</div>
                        </div>
                    </div>
                    
                    ${documentsSection}
                    
                    <div class="driver-actions-large">
                        <button class="action-btn-large secondary" onclick="viewDriverLocation('${driver.id}')" ${!driver.coordinates ? 'disabled' : ''}>
                            <i class="fas fa-map-marker-alt"></i>
                            عرض الموقع
                        </button>
                        <button class="action-btn-large primary" onclick="openChatWindow('${driver.id}')" ${!isApproved ? 'disabled' : ''}>
                            <i class="fas fa-comment"></i>
                            مراسلة
                        </button>
                    </div>
                </div>
            `;
            
            // تحديث محتوى النافذة المنبثقة
            const detailsContentElement = document.getElementById('driverDetailsContent');
            if (detailsContentElement) {
                detailsContentElement.innerHTML = detailsContent;
            }
            
            // عرض النافذة المنبثقة
            const modal = new bootstrap.Modal(document.getElementById('driverDetailsModal'));
            modal.show();
        }

        // دالة عرض موقع السائق على الخريطة
        function viewDriverLocation(driverId) {
            const driver = allDrivers.find(d => d.id === driverId);
            if (!driver || !driver.coordinates) {
                showToast('لا يوجد موقع محدد لهذا السائق', 'warning');
                return;
            }
            
            // إغلاق النافذة المنبثقة الحالية إذا كانت مفتوحة
            const currentModal = bootstrap.Modal.getInstance(document.getElementById('driverDetailsModal'));
            if (currentModal) {
                currentModal.hide();
            }
            
            // توجيه المستخدم إلى صفحة الخريطة مع معلمات الموقع
            window.location.href = `map.html?driver=${driverId}&lat=${driver.coordinates.lat}&lng=${driver.coordinates.lng}`;
        }

        // دالة فتح نافذة المحادثة
        function openChatWindow(driverId) {
            const driver = allDrivers.find(d => d.id === driverId);
            if (!driver) {
                showToast('لم يتم العثور على بيانات السائق', 'error');
                return;
            }
            
            // إغلاق النافذة المنبثقة الحالية إذا كانت مفتوحة
            const currentModal = bootstrap.Modal.getInstance(document.getElementById('driverDetailsModal'));
            if (currentModal) {
                currentModal.hide();
            }
            
            // التحقق من حالة السائق
            if (driver.approved !== true) {
                showToast('هذا السائق غير مفعل حالياً', 'warning');
                return;
            }
            
            // الانتقال إلى نافذة المحادثة في الصفحة الرئيسية
            window.location.href = `index.html?chat=${driverId}`;
        }

        // دالة لتوغل الشريط الجانبي
        function toggleSideNav() {
            const sideNav = document.getElementById('sideNav');
            const navBackdrop = document.getElementById('navBackdrop');
            const body = document.body;

            if (sideNav.classList.contains('open')) {
                // إغلاق الشريط الجانبي
                sideNav.classList.remove('open');
                navBackdrop.classList.remove('show');
                body.classList.remove('side-nav-open');
            } else {
                // فتح الشريط الجانبي
                sideNav.classList.add('open');
                navBackdrop.classList.add('show');
                body.classList.add('side-nav-open');
            }
        }

        // دالة إظهار التوست
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `custom-toast animate__animated animate__fadeInRight toast-${type}`;
            
            // تحديد الأيقونة حسب النوع
            let icon;
            switch (type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle text-success"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-times-circle text-danger"></i>';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-exclamation-triangle text-warning"></i>';
                    break;
                case 'info':
                    icon = '<i class="fas fa-info-circle text-info"></i>';
                    break;
                default:
                    icon = '<i class="fas fa-bell"></i>';
            }
            
            toast.innerHTML = `
                ${icon}
                <div class="toast-content">${message}</div>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            const toastContainer = document.getElementById('toastContainer');
            toastContainer.appendChild(toast);
            
            // إزالة التوست بعد 3 ثواني
            setTimeout(() => {
                toast.classList.replace('animate__fadeInRight', 'animate__fadeOutRight');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // دالة تحميل بيانات المستخدم
        async function loadUserData(user) {
            try {
                // التحقق من وجود بيانات في التخزين المحلي أولاً
                const cachedUserData = localStorage.getItem('currentUser');
                if (cachedUserData) {
                    const userData = JSON.parse(cachedUserData);
                    updateUIAfterLogin(userData);
                    return;
                }
                
                // بحث في قاعدة بيانات المستخدمين
                const userSnapshot = await firebase.database().ref(`users/${user.uid}`).once('value');
                const userData = userSnapshot.val();
                
                if (userData) {
                    // تحديث بيانات التخزين المحلي والواجهة
                    localStorage.setItem('currentUser', JSON.stringify(userData));
                    updateUIAfterLogin(userData);
                    return;
                }
                
                // بحث في قاعدة بيانات السائقين
                const driverSnapshot = await firebase.database().ref('drivers').orderByChild('uid').equalTo(user.uid).once('value');
                const driversData = driverSnapshot.val();
                
                if (driversData) {
                    // استخراج بيانات السائق
                    const driverId = Object.keys(driversData)[0];
                    const driverData = driversData[driverId];
                    driverData.userType = 'driver';
                    
                    // تحديث بيانات التخزين المحلي والواجهة
                    localStorage.setItem('currentUser', JSON.stringify(driverData));
                    updateUIAfterLogin(driverData);
                    return;
                }
                
                // إذا لم نجد بيانات، ننشئ بيانات أولية من معلومات المصادقة
                const basicUserData = {
                    uid: user.uid,
                    email: user.email,
                    fullName: user.displayName || 'المستخدم',
                    photoUrl: user.photoURL,
                    userType: 'user'
                };
                
                localStorage.setItem('currentUser', JSON.stringify(basicUserData));
                updateUIAfterLogin(basicUserData);
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('حدث خطأ في تحميل بيانات المستخدم', 'error');
            }
        }

        // دالة تحديث واجهة المستخدم بعد تسجيل الدخول
        function updateUIAfterLogin(userData) {
            // تحديد نوع المستخدم ليظهر في الواجهة
            const userRole = userData.userType === 'driver' ? 'سائق' : 'مستخدم';
            
            // تحديث زر الملف الشخصي في الشريط العلوي
            const profileBtn = document.querySelector('.user-profile-btn');
            if (profileBtn) {
                // استخدام الصورة الشخصية من البيانات
                const userPhoto = userData.photoUrl || userData.imageUrl || 'default-avatar.png';
                const userName = userData.fullName || userData.name || 'المستخدم';
                
                // إزالة خصائص النافذة المنبثقة
                profileBtn.removeAttribute('data-bs-toggle');
                profileBtn.removeAttribute('data-bs-target');
                
                // إضافة معالج النقر لعرض قائمة المستخدم
                profileBtn.setAttribute('onclick', 'showUserMenu(event)');
                
                // تحديث صورة الملف الشخصي
                const userProfileImage = document.getElementById('userProfileImage');
                const defaultProfileIcon = document.getElementById('defaultProfileIcon');
                if (userProfileImage && defaultProfileIcon) {
                    userProfileImage.src = userPhoto;
                    userProfileImage.style.display = 'inline-block';
                    defaultProfileIcon.style.display = 'none';
                }
                
                // تحديث نص الملف الشخصي
                const profileText = document.getElementById('profileText');
                if (profileText) {
                    profileText.textContent = userName;
                }
            }

            // تحديث معلومات المستخدم في الشريط الجانبي
            const sideNavUserInfo = document.querySelector('.side-nav-user-info');
            if (sideNavUserInfo) {
                // استخدام الصورة الشخصية من البيانات
                const userPhoto = userData.photoUrl || userData.imageUrl || 'default-avatar.png';
                const userName = userData.fullName || userData.name || 'المستخدم';
                
                sideNavUserInfo.innerHTML = `
                    <div class="text-center">
                        <img src="${userPhoto}" 
                             alt="${userName}" 
                             class="rounded-circle mb-3"
                             style="width: 80px; height: 80px; object-fit: cover; border: 3px solid #FFD700;">
                        <h6 class="text-white mb-1">${userName}</h6>
                        <span class="badge bg-gold mb-2">${userRole}</span>
                        <p class="text-white-50 small mb-3">${userData.email || ''}</p>
                        <button onclick="handleLogout()" class="btn btn-danger btn-sm w-100">
                            <i class="fas fa-sign-out-alt me-2"></i>
                            تسجيل الخروج
                        </button>
                    </div>
                `;
            }
            
            // إظهار أو إخفاء عناصر واجهة خاصة بالسائقين إذا كان المستخدم سائق
            const driverOnlyElements = document.querySelectorAll('.driver-only');
            driverOnlyElements.forEach(element => {
                element.style.display = userData.userType === 'driver' ? 'block' : 'none';
            });
            
            // إظهار زر تسجيل الخروج
            const logoutBtn = document.querySelector('.logout-btn');
            if (logoutBtn) {
                logoutBtn.style.display = 'flex';
            }
            
            console.log('تم تحديث واجهة المستخدم بنجاح بعد تسجيل الدخول');
        }

        // دالة إعادة تعيين واجهة المستخدم
        function resetUserInterface() {
            // إعادة زر الملف الشخصي إلى حالته الأصلية
            const profileBtn = document.querySelector('.user-profile-btn');
            if (profileBtn) {
                profileBtn.innerHTML = `
                    <i class="fas fa-user-circle" id="defaultProfileIcon" style="color: #FFD700;"></i>
                    <span class="ms-1 d-none d-md-inline" id="profileText">تسجيل الدخول</span>
                `;
                
                // إعادة تعيين خصائص الزر ليفتح نافذة تسجيل الدخول
                profileBtn.setAttribute('data-bs-toggle', 'modal');
                profileBtn.setAttribute('data-bs-target', '#profileModal');
                profileBtn.removeAttribute('onclick');
                
                // إخفاء صورة الملف الشخصي وإظهار الأيقونة الافتراضية
                const userProfileImage = document.getElementById('userProfileImage');
                if (userProfileImage) {
                    userProfileImage.style.display = 'none';
                }
                const defaultProfileIcon = document.getElementById('defaultProfileIcon');
                if (defaultProfileIcon) {
                    defaultProfileIcon.style.display = 'inline-block';
                }
            }
            
            // إعادة تعيين معلومات المستخدم في الشريط الجانبي
            const sideNavUserInfo = document.querySelector('.side-nav-user-info');
            if (sideNavUserInfo) {
                sideNavUserInfo.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-user-circle text-white" style="font-size: 4rem;"></i>
                        <h6 class="text-white mt-3">مرحباً بك</h6>
                        <p class="text-white-50 small">قم بتسجيل الدخول للوصول إلى حسابك</p>
                        <div class="mt-3">
                            <button class="btn btn-gold w-100 mb-2" data-bs-toggle="modal" data-bs-target="#loginModal">
                                تسجيل الدخول
                            </button>
                            <button class="btn btn-outline-light w-100 mb-2" data-bs-toggle="modal" data-bs-target="#userRegistrationModal">
                                إنشاء حساب
                            </button>
                            <button class="btn btn-outline-light w-100" data-bs-toggle="modal" data-bs-target="#addDriverModal">
                                إضافة سائق
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // إخفاء عناصر واجهة خاصة بالسائقين
            const driverOnlyElements = document.querySelectorAll('.driver-only');
            driverOnlyElements.forEach(element => {
                element.style.display = 'none';
            });
            
            // إخفاء زر تسجيل الخروج
            const logoutBtn = document.querySelector('.logout-btn');
            if (logoutBtn) {
                logoutBtn.style.display = 'none';
            }
        }

        // دالة معالجة تسجيل الخروج
        async function handleLogout() {
            try {
                showLoading();
                
                // تسجيل الخروج من Firebase Auth
                await firebase.auth().signOut();
                
                // حذف بيانات المستخدم من التخزين المحلي
                localStorage.removeItem('currentUser');
                
                // إعادة تعيين واجهة المستخدم
                resetUserInterface();
                
                showToast('تم تسجيل الخروج بنجاح', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showToast('حدث خطأ أثناء تسجيل الخروج', 'error');
            } finally {
                hideLoading();
            }
        }

        // دالة عرض قائمة المستخد    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <!-- App Scripts -->
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEMiAI",
            authDomain: "messageemeapp.firebaseapp.com",
            databaseURL: "https://messageemeapp-default-rtdb.firebaseio.com",
            projectId: "messageemeapp",
            storageBucket: "messageemeapp.appspot.com",
            messagingSenderId: "255034474844",
            appId: "1:255034474844:web:5e3b7a6bc4b2fb94cc4199"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();
        const auth = firebase.auth();

        // قاموس المحافظات والمناطق
        const iraqProvinces = {
            "بغداد": ["الكرخ", "الرصافة", "الأعظمية", "الكاظمية", "المنصور", "الدورة", "الشعب", "الكرادة", "زيونة", "الغدير", "البلديات", "الشعلة", "الحرية", "الوشاش", "حي الجامعة", "الصليخ", "بغداد الجديدة", "مدينة الصدر", "الزعفرانية", "العامرية", "الغزالية", "الجادرية", "الحارثية", "الجهاد", "البياع", "الخضراء", "حي الخليج", "التاجي"],
            "البصرة": ["البصرة الجديدة", "الزبير", "أبو الخصيب", "القرنة", "شط العرب", "الفاو", "الهارثة", "الدير", "المدينة", "العشار", "البراضعية", "الخور", "النجيبية", "الفيحاء", "المعقل", "سفوان", "الخصيب", "جبيلة", "القبلة", "ياسين خريبط", "الشعيبة"],
            "نينوى": ["الموصل", "تلعفر", "الحمدانية", "سنجار", "الحضر", "البعاج", "عين سفني", "تلكيف", "القيارة", "مخمور", "شيخان", "الحيدانية", "الشمال", "وانة", "سميل"],
            "أربيل": ["عنكاوا", "شقلاوة", "خبات", "سوران", "جومان", "رواندوز", "ميرگسور", "كوية", "المركز", "دشتي هولير", "خيفتي", "دارتو", "بنصلاوة", "حرير", "سيديكان", "شيروان-مزن", "مخمور", "قوشتبة"],
            "النجف": ["الكوفة", "المناذرة", "المشخاب", "الحيدرية", "العباسية", "القادسية", "الحرية", "النجف القديمة", "الغري", "النصر", "الوفاء", "الزهراء", "الجامعة", "السلام", "الغدير", "المرتضى", "القدس", "الأمير"],
            "كربلاء": ["الحسينية", "الهندية", "عين التمر", "الحر", "الجدول الغربي", "مركز كربلاء", "الخيرات", "الرشيد", "العباس", "الإصلاح", "الحسين", "المخيم", "الأنصار", "باب الخان", "الإسكان"],
            "كركوك": ["دبس", "الحويجة", "داقوق", "تازة", "شوان", "يايجي", "الملتقى", "العروبة", "القادسية", "الواسطي", "المنصور", "النصر", "الرياض", "الرشاد", "الزاب", "الرياض", "الصناعي"],
            "الأنبار": ["الرمادي", "الفلوجة", "هيت", "حديثة", "الخالدية", "الصقلاوية", "كبيسة", "العامرية", "الحبانية", "راوة", "عنه", "الرطبة", "القائم", "البغدادي", "الكرمة", "الوليد", "الحقلانية", "الرحالية"],
            "بابل": ["الحلة", "المسيب", "الهاشمية", "القاسم", "المحاويل", "الكفل", "النيل", "أبو غرق", "المدحتية", "الإسكندرية"],
            "ديالى": ["بعقوبة", "المقدادية", "خانقين", "بلدروز", "كفري", "الخالص", "جلولاء", "قزانية", "مندلي", "قرة تبة"],
            "ذي قار": ["الناصرية", "سوق الشيوخ", "الشطرة", "الرفاعي", "الجبايش", "قلعة سكر", "الغراف"],
            "صلاح الدين": ["تكريت", "سامراء", "بيجي", "بلد", "الدور", "الشرقاط", "طوز خورماتو", "العلم"],
            "واسط": ["الكوت", "النعمانية", "الحي", "بدرة", "الصويرة", "العزيزية", "الموفقية"],
            "ميسان": ["العمارة", "المجر الكبير", "الكحلاء", "علي الغربي", "قلعة صالح", "الميمونة"],
            "المثنى": ["السماوة", "الرميثة", "السوير", "المجد", "الخضر", "الهلال", "النجمي", "الوركاء"],
            "دهوك": ["زاخو", "العمادية", "سميل", "الشيخان", "ئاكرى", "بردرش", "زاويتة", "باتيل"],
            "القادسية": ["الديوانية", "عفك", "الشامية", "الحمزة", "نفر", "غماس", "سومر", "الشنافية"]
        };

        // متغير عام لتخزين السائقين
        let allDrivers = [];

        // عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // تهيئة قوائم المحافظات
            initializeProvinceDropdown();
            
            // تحميل السائقين
            loadDrivers();
            
            // معالجة معلمات URL
            handleUrlParams();
            
            // تهيئة نماذج التسجيل
            initializeRegistrationForms();
            
            // مراقبة حالة المستخدم
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    console.log('تم تسجيل الدخول:', user.uid);
                    loadUserData(user);
                } else {
                    console.log('غير مسجل الدخول');
                    resetUserInterface();
                }
            });
        });
        
        // دالة تهيئة نماذج التسجيل
        function initializeRegistrationForms() {
            // تهيئة قوائم المحافظات في جميع النماذج
            const userProvince = document.getElementById('userProvince');
            const driverLocation = document.getElementById('driverLocation');
            
            if (userProvince) {
                // ملء قائمة المحافظات للمستخدم
                Object.keys(iraqProvinces).forEach(province => {
                    const option = document.createElement('option');
                    option.value = province;
                    option.textContent = province;
                    userProvince.appendChild(option);
                });
            }
            
            if (driverLocation) {
                // ملء قائمة المحافظات للسائق
                Object.keys(iraqProvinces).forEach(province => {
                    const option = document.createElement('option');
                    option.value = province;
                    option.textContent = province;
                    driverLocation.appendChild(option);
                });
            }
            
            // إضافة معالجات الأحداث للنماذج
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            const userRegistrationForm = document.getElementById('userRegistrationForm');
            if (userRegistrationForm) {
                userRegistrationForm.addEventListener('submit', handleUserRegistration);
            }
            
            const addDriverForm = document.getElementById('addDriverForm');
            if (addDriverForm) {
                addDriverForm.addEventListener('submit', handleAddDriver);
            }
        }

        // دالة تهيئة قائمة المحافظات في قسم التصفية
        function initializeProvinceDropdown() {
            const provinceSelect = document.getElementById('provinceFilter');
            if (!provinceSelect) return;
            
            // إضافة خيارات المحافظات
            Object.keys(iraqProvinces).forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                provinceSelect.appendChild(option);
            });
        }

        // دالة تحميل المناطق بناءً على المحافظة المختارة
        function loadAreas(province) {
            // التحقق من وجود القوائم المنسدلة
            const areaFilter = document.getElementById('areaFilter');
            const userArea = document.getElementById('userArea');
            const driverArea = document.getElementById('driverArea');
            
            // تحديث قائمة التصفية للمناطق
            if (areaFilter) {
                updateAreaDropdown(areaFilter, province);
            }
            
            // تحديث قائمة المناطق في نموذج المستخدم
            if (userArea) {
                updateAreaDropdown(userArea, province);
            }
            
            // تحديث قائمة المناطق في نموذج السائق
            if (driverArea) {
                updateAreaDropdown(driverArea, province);
            }
        }
        
        // دالة تحديث قائمة منسدلة للمناطق
        function updateAreaDropdown(selectElement, province) {
            // تفريغ القائمة
            selectElement.innerHTML = '<option value="">كل المناطق</option>';
            
            // تعطيل القائمة إذا لم يتم اختيار محافظة
            if (!province) {
                selectElement.disabled = true;
                return;
            }
            
            // إضافة المناطق للمحافظة المختارة
            if (iraqProvinces[province]) {
                iraqProvinces[province].forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    selectElement.appendChild(option);
                });
                
                // تفعيل القائمة
                selectElement.disabled = false;
            }
        }

        // دالة تحميل السائقين من Firebase
        function loadDrivers() {
            const loadingElement = document.getElementById('loadingDrivers');
            const noDriversMessage = document.getElementById('noDriversMessage');
            const driversListElement = document.getElementById('driversList');
            
            if (loadingElement) loadingElement.style.display = 'block';
            if (noDriversMessage) noDriversMessage.style.display = 'none';
            if (driversListElement) driversListElement.innerHTML = '';
            
            // استدعاء البيانات من Firebase
            firebase.database().ref('drivers').once('value')
                .then(snapshot => {
                    if (loadingElement) loadingElement.style.display = 'none';
                    
                    allDrivers = [];
                    
                    snapshot.forEach(childSnapshot => {
                        const driverId = childSnapshot.key;
                        const driver = childSnapshot.val();
                        
                        // إضافة معرف السائق إلى الكائن
                        driver.id = driverId;
                        
                        // إضافة السائق إلى المصفوفة
                        allDrivers.push(driver);
                    });
                    
                    // تحديث عدد السائقين
                    updateDriversCount(allDrivers.length);
                    
                    // عرض السائقين بعد الفلترة
                    filterDrivers();
                })
                .catch(error => {
                    console.error('Error loading drivers:', error);
                    
                    if (loadingElement) loadingElement.style.display = 'none';
                    if (driversListElement) {
                        driversListElement.innerHTML = `
                            <div class="alert alert-danger text-center">
                                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                <h4>حدث خطأ أثناء تحميل البيانات</h4>
                                <p>${error.message}</p>
                                <button class="btn btn-outline-danger mt-3" onclick="loadDrivers()">
                                    <i class="fas fa-sync me-2"></i> إعادة المحاولة
                                </button>
                            </div>
                        `;
                    }
                });
        }

        // دالة فلترة السائقين
        function filterDrivers() {
            const provinceFilter = document.getElementById('provinceFilter').value;
            const areaFilter = document.getElementById('areaFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchFilter = document.getElementById('searchInput').value.toLowerCase();
            const sortBy = document.getElementById('sortDrivers').value;
            
            const driversListElement = document.getElementById('driversList');
            const noDriversMessage = document.getElementById('noDriversMessage');
            
            if (!driversListElement || !noDriversMessage) return;
            
            // فلترة السائقين حسب المعايير
            let filteredDrivers = allDrivers.filter(driver => {
                // فلترة حسب المحافظة
                if (provinceFilter && (!driver.location || driver.location !== provinceFilter && driver.province !== provinceFilter)) {
                    return false;
                }
                
                // فلترة حسب المنطقة
                if (areaFilter && (!driver.area || driver.area !== areaFilter)) {
                    return false;
                }
                
                // فلترة حسب الحالة
                if (statusFilter) {
                    if (statusFilter === 'active' && (!driver.active || driver.active !== true)) {
                        return false;
                    } else if (statusFilter === 'inactive' && (driver.active || driver.active === true)) {
                        return false;
                    } else if (statusFilter === 'pending' && (!driver.approvalStatus || driver.approvalStatus !== 'pending')) {
                        return false;
                    }
                }
                
                // فلترة حسب البحث
                if (searchFilter) {
                    const nameMatch = driver.name && driver.name.toLowerCase().includes(searchFilter);
                    const carTypeMatch = driver.carType && driver.carType.toLowerCase().includes(searchFilter);
                    const locationMatch = driver.location && driver.location.toLowerCase().includes(searchFilter);
                    
                    if (!nameMatch && !carTypeMatch && !locationMatch) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // ترتيب السائقين
            filteredDrivers.sort((a, b) => {
                switch (sortBy) {
                    case 'rating':
                        return (b.rating || 0) - (a.rating || 0);
                    case 'trips':
                        return (b.trips || 0) - (a.trips || 0);
                    case 'name':
                        return (a.name || '').localeCompare(b.name || '');
                    case 'recent':
                        return (b.createdAt || 0) - (a.createdAt || 0);
                    default:
                        return 0;
                }
            });
            
            // تحديث عدد السائقين بعد الفلترة
            updateDriversCount(filteredDrivers.length);
            
            // عرض النتائج
            if (filteredDrivers.length === 0) {
                driversListElement.innerHTML = '';
                noDriversMessage.style.display = 'block';
            } else {
                noDriversMessage.style.display = 'none';
                driversListElement.innerHTML = filteredDrivers.map(driver => createDriverListItem(driver)).join('');
            }
        }

        // دالة تحديث عدد السائقين
        function updateDriversCount(count) {
            const countElement = document.getElementById('driversCount');
            if (countElement) {
                countElement.textContent = `${count} سائق`;
            }
        }

        // دالة إعادة تعيين الفلاتر
        function resetFilters() {
            document.getElementById('provinceFilter').value = '';
            document.getElementById('areaFilter').value = '';
            document.getElementById('areaFilter').disabled = true;
            document.getElementById('statusFilter').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('sortDrivers').value = 'rating';
            
            filterDrivers();
        }

        // دالة إنشاء عنصر السائق في القائمة
        function createDriverListItem(driver) {
            // التحقق من حالة السائق
            const isApproved = driver.approved === true;
            const isPending = driver.approvalStatus === 'pending';
            const isActive = driver.active === true && isApproved;
            
            // تحديد لون الحالة وصفها
            let statusClass = '';
            let statusText = '';
            
            if (!isApproved) {
                statusClass = isPending ? 'status-pending' : 'status-inactive';
                statusText = isPending ? 'قيد المراجعة' : 'غير مفعل';
            } else {
                statusClass = isActive ? 'status-active' : 'status-inactive';
                statusText = isActive ? 'متاح' : 'مشغول';
            }
            
            // تحديد تأثير عنصر السائق قيد المراجعة
            const pendingClass = !isApproved ? '<!DOCTYPE html>
<html dir="rtl" lang="ar">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="قائمة السائقين في تطبيق تاكسي العراق">
    <meta name="keywords" content="تاكسي العراق، سائقين، سيارات أجرة">
    <meta name="author" content="تاكسي العراق">
    <meta name="theme-color" content="#FFD700">

    <title>قائمة السائقين - تاكسي العراق</title>

    <!-- App Icons -->
    <link rel="icon" type="image/png" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527">
    <link rel="apple-touch-icon" sizes="180x180" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527">

    <!-- External CSS Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <!-- App CSS -->
    <link rel="stylesheet" href="./style.css">

    <style>
        /* أنماط خاصة بصفحة السائقين */
        .drivers-filter-section {
            background-color: #1a1a1a;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .drivers-list-container {
            margin-top: 20px;
        }
        
        .driver-list-item {
            background-color: #1a1a1a;
            border-radius: 10px;
            margin-bottom: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.1);
            position: relative;
        }
        
        .driver-list-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.3);
        }
        
        .driver-item-status {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .status-active {
            background-color: #2ECC40;
            color: #fff;
        }
        
        .status-inactive {
            background-color: #FF4136;
            color: #fff;
        }
        
        .status-pending {
            background-color: #FFD700;
            color: #000;
        }
        
        .driver-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #FFD700;
            margin-left: 15px;
        }
        
        .driver-info {
            flex: 1;
        }
        
        .driver-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
        }
        
        .driver-meta {
            color: #CCCCCC;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .driver-rating {
            color: #FFD700;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .driver-actions {
            display: flex;
            gap: 10px;
        }
        
        .driver-actions button {
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .view-btn {
            background-color: #333;
            color: #FFD700;
            border: 1px solid #FFD700;
        }
        
        .view-btn:hover {
            background-color: #444;
        }
        
        .chat-btn {
            background-color: #FFD700;
            color: #000;
        }
        
        .chat-btn:hover {
            background-color: #e5c100;
        }
        
        .driver-details-modal .modal-content {
            background-color: #1a1a1a;
            color: #FFFFFF;
            border-radius: 15px;
        }
        
        .driver-details-header {
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
            position: relative;
        }
        
        .driver-details-header .status-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .driver-cover-photo {
            height: 150px;
            background-color: #333;
            background-image: linear-gradient(45deg, #333, #222);
            position: relative;
            border-radius: 15px 15px 0 0;
            margin-bottom: 60px;
        }
        
        .driver-big-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid #FFD700;
            object-fit: cover;
            position: absolute;
            bottom: -60px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        
        .driver-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 15px 0;
        }
        
        .stat-item {
            text-align: center;
            border-radius: 10px;
            padding: 10px 15px;
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FFD700;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #CCCCCC;
        }
        
        .driver-details-content {
            padding: 20px;
        }
        
        .info-section {
            margin-bottom: 20px;
        }
        
        .info-section-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-row {
            display: flex;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .info-label {
            min-width: 120px;
            color: #CCCCCC;
            font-weight: bold;
        }
        
        .info-value {
            flex: 1;
            color: #FFFFFF;
        }
        
        .driver-actions-large {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-btn-large {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-weight: bold;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-btn-large.primary {
            background-color: #FFD700;
            color: #000;
        }
        
        .action-btn-large.secondary {
            background-color: #333;
            color: #FFD700;
            border: 1px solid #FFD700;
        }
        
        .action-btn-large:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .no-drivers-message {
            text-align: center;
            padding: 50px 0;
            color: #CCCCCC;
        }
        
        .pendingApproval {
            opacity: 0.7;
            filter: grayscale(50%);
        }
        
        /* نمط للرسوم المتحركة */
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        /* تأثير التمرير السلس */
        html {
            scroll-behavior: smooth;
        }
        
        /* التوافق مع الشاشات الصغيرة */
        @media (max-width: 768px) {
            .driver-list-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .driver-avatar {
                margin-bottom: 15px;
                margin-left: 0;
            }
            
            .driver-actions {
                margin-top: 15px;
                width: 100%;
            }
            
            .driver-actions button {
                flex: 1;
            }
            
            .driver-stats {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .stat-item {
                flex: 1;
                min-width: 80px;
            }
        }
    </style>
</head>

<body>
    <!-- تصميم شريط العنوان -->
    <nav class="navbar app-header fixed-top">
        <div class="container-fluid">
            <div class="header-content">
                <!-- زر فتح الشريط الجانبي -->
                <button class="nav-toggle" onclick="toggleSideNav()">
                    <i class="fas fa-bars" style="color: #FFD700;"></i>
                </button>
                
                <!-- Logo and App Name -->
                <a class="app-logo d-flex align-items-center" href="index.html">
                    <i class="fas fa-taxi me-2" style="color: #FFD700;"></i>
                    <span style="font-size: 0.8rem;">Iraq Taxi</span>
                </a>
                
                <!-- Tools: Search, Notifications, Messages, Profile -->
                <div class="tools d-flex align-items-center">
                    <!-- Search Icon -->
                    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#searchModal">
                        <i class="fas fa-search" style="color: #FFD700;"></i>
                    </a>
                    
                    <!-- Notifications Icon -->
                    <a class="nav-link position-relative" href="#" data-bs-toggle="modal" data-bs-target="#notificationsModal" id="notificationsBtn">
                        <i class="fas fa-bell" style="color: #FFD700;"></i>
                        <span class="notification-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">0</span>
                    </a>
                    
                    <!-- Messages Icon -->
                    <a class="nav-link position-relative" href="#" data-bs-toggle="modal" data-bs-target="#messagesModal">
                        <i class="fas fa-envelope" style="color: #FFD700;"></i>
                        <span class="message-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">0</span>
                    </a>
                    
                    <!-- Profile/Account Icon -->
                    <a class="nav-link user-profile-btn" href="#" data-bs-toggle="modal" data-bs-target="#profileModal">
                        <img id="userProfileImage" src="default-profile.png" alt="Profile" class="rounded-circle" style="width: 35px; height: 35px; object-fit: cover; display: none;">
                        <i class="fas fa-user-circle" id="defaultProfileIcon" style="color: #FFD700;"></i>
                        <span class="ms-1 d-none d-md-inline" id="profileText">تسجيل الدخول</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- الشريط الجانبي -->
    <div class="side-nav" id="sideNav">
        <div class="side-nav-header">
            <h2 class="side-nav-title">تاكسي العراق</h2>
            <button class="side-nav-close" onclick="toggleSideNav()">×</button>
        </div>
        
        <!-- قسم معلومات المستخدم -->
        <div class="side-nav-user-info">
            <div class="text-center">
                <i class="fas fa-user-circle text-white" style="font-size: 4rem;"></i>
                <h6 class="text-white mt-3">مرحباً بك</h6>
                <p class="text-white-50 small">قم بتسجيل الدخول للوصول إلى حسابك</p>
                <div class="mt-3">
                    <button class="btn btn-gold w-100 mb-2" data-bs-toggle="modal" data-bs-target="#loginModal">
                        تسجيل الدخول
                    </button>
                    <button class="btn btn-outline-light w-100 mb-2" data-bs-toggle="modal" data-bs-target="#userRegistrationModal">
                        إنشاء حساب
                    </button>
                    <button class="btn btn-outline-light w-100" data-bs-toggle="modal" data-bs-target="#addDriverModal">
                        إضافة سائق
                    </button>
                </div>
            </div>
        </div>
        
        <div class="side-nav-items">
            <a href="/" class="side-nav-item"><i class="fas fa-home" style="color: #FFD700;"></i> الرئيسية</a>
            <a href="/drivers" class="side-nav-item active"><i class="fas fa-users" style="color: #4CAF50;"></i> السائقين</a>
            <a href="trips.html" class="side-nav-item"><i class="fas fa-car" style="color: #2196F3;"></i> الرحلات</a>
            <a href="map.html" class="side-nav-item"><i class="fas fa-map" style="color: #FF5722;"></i> الخريطة</a>
            <a href="notifications.html" class="side-nav-item"><i class="fas fa-bell" style="color: #9C27B0;"></i> الإشعارات</a>
            <a href="messages.html" class="side-nav-item"><i class="fas fa-envelope" style="color: #FFC107;"></i> الرسائل</a>
            <a href="settings.html" class="side-nav-item"><i class="fas fa-cog" style="color: #607D8B;"></i> الإعدادات</a>
            <a href="#" class="side-nav-item driver-only" style="display: none;"><i class="fas fa-user-plus" style="color: #E91E63;"></i> إضافة سائق</a>
        </div>
        
        <!-- زر تسجيل الخروج في الشريط الجانبي -->
        <div class="side-nav-footer">
            <button onclick="handleLogout()" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
            </button>
        </div>
    </div>

    <!-- خلفية الشريط الجانبي -->
    <div class="nav-backdrop" id="navBackdrop" onclick="toggleSideNav()"></div>

    <!-- المحتوى الرئيسي -->
    <div class="container main-content" style="margin-top: 80px; padding-bottom: 50px;">
        <!-- عنوان الصفحة -->
        <div class="page-header animate__animated animate__fadeIn">
            <h1 class="page-title">
                <i class="fas fa-users" style="color: #4CAF50;"></i>
                قائمة السائقين
            </h1>
            <p class="text-muted">اعثر على السائقين حسب المحافظة والمنطقة</p>
        </div>

        <!-- قسم التصفية -->
        <div class="drivers-filter-section animate__animated animate__fadeIn">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">المحافظة</label>
                    <select class="form-select" id="provinceFilter" onchange="loadAreas(this.value); filterDrivers();">
                        <option value="">كل المحافظات</option>
                        <!-- سيتم تعبئتها بواسطة JavaScript -->
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">المنطقة</label>
                    <select class="form-select" id="areaFilter" onchange="filterDrivers();" disabled>
                        <option value="">كل المناطق</option>
                        <!-- سيتم تعبئتها بواسطة JavaScript بناءً على اختيار المحافظة -->
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">الحالة</label>
                    <select class="form-select" id="statusFilter" onchange="filterDrivers();">
                        <option value="">الكل</option>
                        <option value="active">متاح</option>
                        <option value="inactive">مشغول</option>
                        <option value="pending">قيد المراجعة</option>
                    </select>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-8 mb-3">
                    <label class="form-label">بحث</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="ابحث عن اسم السائق، نوع السيارة..." onkeyup="filterDrivers()">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">ترتيب حسب</label>
                    <select class="form-select" id="sortDrivers" onchange="filterDrivers();">
                        <option value="rating">التقييم (الأعلى أولاً)</option>
                        <option value="trips">عدد الرحلات (الأعلى أولاً)</option>
                        <option value="name">الاسم (أبجدياً)</option>
                        <option value="recent">الأحدث</option>
                    </select>
                </div>
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-sm btn-outline-light" onclick="resetFilters()">
                    <i class="fas fa-sync-alt me-2"></i> إعادة تعيين الفلترة
                </button>
                <span class="mx-3 text-muted" id="driversCount">0 سائق</span>
            </div>
        </div>

        <!-- حاوية قائمة السائقين -->
        <div class="drivers-list-container" id="driversListContainer">
            <div class="text-center py-5" id="loadingDrivers">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">جاري التحميل...</span>
                </div>
                <p class="mt-3 text-muted">جاري تحميل قائمة السائقين...</p>
            </div>
            
            <!-- ستتم تعبئة هذا القسم بواسطة JavaScript -->
            <div id="driversList"></div>
            
            <!-- رسالة عند عدم وجود سائقين -->
            <div class="no-drivers-message" id="noDriversMessage" style="display: none;">
                <i class="fas fa-search fa-3x mb-3" style="color: #555;"></i>
                <h3>لا يوجد سائقين</h3>
                <p class="text-muted">لم يتم العثور على سائقين يطابقون معايير البحث</p>
            </div>
        </div>
    </div>

    <!-- نافذة تفاصيل السائق المنبثقة -->
    <div class="modal fade" id="driverDetailsModal" tabindex="-1" aria-labelledby="driverDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered driver-details-modal">
            <div class="modal-content">
                <div class="modal-body p-0">
                    <!-- ستتم تعبئة هذا القسم بواسطة JavaScript -->
                    <div id="driverDetailsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- نافذة تسجيل الدخول -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تسجيل الدخول</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm" onsubmit="handleLogin(event)">
                        <div class="mb-3">
                            <label class="form-label">البريد الإلكتروني</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">كلمة المرور</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-sign-in-alt me-2"></i>
                                تسجيل الدخول
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تسجيل المستخدم -->
    <div class="modal fade" id="userRegistrationModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="text-center w-100">
                        <img src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527"
                            alt="شعار التطبيق" style="height: 60px;">
                        <h5 class="modal-title mt-2">تسجيل مستخدم جديد</h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userRegistrationForm" class="needs-validation" novalidate>
                        <!-- المعلومات الشخصية -->
                        <div class="registration-section mb-4">
                            <h6 class="section-title">المعلومات الشخصية</h6>
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="text-center mb-3">
                                        <div class="user-photo-upload"
                                            onclick="document.getElementById('userPhoto').click()">
                                            <img id="userPhotoPreview" src="#" alt="">
                                            <div class="upload-placeholder">
                                                <i class="fas fa-camera"></i>
                                                <span>صورة شخصية</span>
                                            </div>
                                        </div>
                                        <input type="file" id="userPhoto" accept="image/*" style="display: none;"
                                            onchange="previewUserPhoto(this)">
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">الاسم الثلاثي</label>
                                    <input type="text" class="form-control" name="fullName" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">البريد الإلكتروني</label>
                                    <input type="email" class="form-control" name="email" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">رقم الهاتف</label>
                                    <input type="tel" class="form-control" name="phone" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">كلمة المرور</label>
                                    <input type="password" class="form-control" name="password" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">تأكيد كلمة المرور</label>
                                    <input type="password" class="form-control" name="confirmPassword" required>
                                </div>
                            </div>
                        </div>

                        <!-- معلومات السكن -->
                        <div class="registration-section mb-4">
                            <h6 class="section-title">معلومات السكن</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">المحافظة</label>
                                    <select class="form-select" name="province" id="userProvince" onchange="loadAreas(this.value)"
                                        required>
                                        <option value="">اختر المحافظة</option>
                                        <!-- سيتم ملء الخيارات عبر JavaScript -->
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">المنطقة</label>
                                    <select class="form-select" name="area" id="userArea" required>
                                        <option value="">اختر المنطقة</option>
                                        <!-- سيتم ملء الخيارات عبر JavaScript -->
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">العنوان التفصيلي</label>
                                    <textarea class="form-control" name="address" rows="2" required></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- الشروط والأحكام -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="terms" id="terms" required>
                            <label class="form-check-label" for="terms">
                                أوافق على <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">الشروط
                                    والأحكام</a>
                            </label>
                        </div>

                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="fas fa-user-plus me-2"></i>
                                تسجيل
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة سائق -->
    <div class="modal fade" id="addDriverModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة سائق جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addDriverForm" onsubmit="handleAddDriver(event)">
                        <div class="mb-4 text-center">
                            <div class="image-upload-container"
                                onclick="document.getElementById('driverImage').click()">
                                <input type="file" id="driverImage" accept="image/*" style="display: none"
                                    onchange="handleImagePreview(event)">
                                <img id="imagePreview" src="#" alt=""
                                    style="display: none; width: 100%; height: 100%; object-fit: cover;">
                                <div class="upload-placeholder">
                                    <i class="fas fa-camera fa-2x mb-2"></i>
                                    <p>انقر لإضافة صورة</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">البريد الإلكتروني</label>
                                <input type="email" class="form-control" id="driverEmail" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">كلمة المرور</label>
                                <input type="password" class="form-control" id="driverPassword" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">إعادة كتابة كلمة المرور</label>
                                <input type="password" class="form-control" id="confirmDriverPassword" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">اسم السائق</label>
                                <input type="text" class="form-control" id="driverName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">رقم الهاتف</label>
                                <input type="tel" class="form-control" id="driverPhone" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">نوع السيارة</label>
                                <input type="text" class="form-control" id="carType" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">موديل السيارة</label>
                                <input type="number" class="form-control" id="carModel" required>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">المحافظة</label>
                                <select class="form-select" id="driverLocation" onchange="loadAreas(this.value)" required>
                                    <option value="">اختر المحافظة</option>
                                    <!-- سيتم ملء الخيارات عبر JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">المنطقة</label>
                                <select class="form-select" id="driverArea" required>
                                    <option value="">اختر المنطقة</option>
                                    <!-- سيتم ملء الخيارات عبر JavaScript -->
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">معلومات إضافية</label>
                                <textarea class="form-control" id="driverBio" rows="3"></textarea>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">موقع السائق</label>
                                <div class="d-flex gap-2 mb-2">
                                    <input type="text" class="form-control" id="driverLatitude" placeholder="خط العرض"
                                        readonly>
                                    <input type="text" class="form-control" id="driverLongitude" placeholder="خط الطول"
                                        readonly>
                                </div>
                                <button type="button" class="btn btn-primary w-100" onclick="captureCurrentLocation()">
                                    <i class="fas fa-location-arrow me-2"></i>
                                    تحديد الموقع الحالي
                                </button>
                            </div>
                        </div>

                        <div class="registration-section mb-4">
                            <h6 class="section-title">المستمسكات الرسمية</h6>

                            <!-- هوية الأحوال المدنية -->
                            <div class="row g-3 mb-4">
                                <div class="col-12">
                                    <label class="form-label">هوية الأحوال المدنية</label>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('idCardFront').click()">
                                        <input type="file" id="idCardFront" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'idCardFrontPreview')" required>
                                        <img id="idCardFrontPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <p>صورة الهوية (الأمامية)</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('idCardBack').click()">
                                        <input type="file" id="idCardBack" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'idCardBackPreview')" required>
                                        <img id="idCardBackPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <p>صورة الهوية (الخلفية)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- إجازة السوق -->
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">إجازة السوق</label>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('licenseFront').click()">
                                        <input type="file" id="licenseFront" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'licenseFrontPreview')" required>
                                        <img id="licenseFrontPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <p>إجازة السوق (الأمامية)</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('licenseBack').click()">
                                        <input type="file" id="licenseBack" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'licenseBackPreview')" required>
                                        <img id="licenseBackPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <p>إجازة السوق (الخلفية)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary w-100">إضافة السائق</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة اختيار نوع الحساب -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 text-center">
                    <h5 class="modal-title w-100">اختر العملية</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body py-4">
                    <div class="row g-4">
                        <!-- زر تسجيل الدخول -->
                        <div class="col-12 mb-3">
                            <div class="account-type-card" onclick="openLoginModal()">
                                <div class="icon-container mb-3">
                                    <i class="fas fa-sign-in-alt fa-3x"></i>
                                </div>
                                <h6>تسجيل الدخول</h6>
                                <p class="small text-muted">لديك حساب بالفعل؟ سجل دخولك</p>
                            </div>
                        </div>
                        <!-- زر انشاء حساب -->
                        <div class="col-12">
                            <div class="account-type-card" onclick="openUserRegistration()">
                                <div class="icon-container mb-3">
                                    <i class="fas fa-user fa-3x"></i>
                                </div>
                                <h6>انشاء حساب</h6>
                                <p class="small text-muted">احجز رحلاتك بسهولة</p>
                            </div>
                        </div>
                        <!-- زر إضافة سائق -->
                        <div class="col-12">
                            <div class="account-type-card" onclick="showAddDriverModal()">
                                <div class="icon-container mb-3">
                                    <i class="fas fa-user-plus fa-3x"></i>
                                </div>
                                <h6>إضافة سائق</h6>
                                <p class="small text-muted">أضف سائق جديد إلى النظام</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة البحث المنبثقة -->
    <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="searchModalLabel">بحث عن سائق</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="search-wrapper">
                        <!-- حقل البحث -->
                        <div class="search-input-wrapper mb-3">
                            <div class="input-group">
                                <input type="text" class="form-control search-input" id="navbarSearchInput"
                                    placeholder="ابحث عن اسم السائق، المنطقة، نوع السيارة..." autofocus>
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                            </div>
                        </div>

                        <!-- خيارات البحث -->
                        <div class="search-options mb-3">
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="searchType" id="searchAll" checked>
                                <label class="btn btn-outline-primary" for="searchAll">الكل</label>

                                <input type="radio" class="btn-check" name="searchType" id="searchName">
                                <label class="btn btn-outline-primary" for="searchName">الاسم</label>

                                <input type="radio" class="btn-check" name="searchType" id="searchLocation">
                                <label class="btn btn-outline-primary" for="searchLocation">المنطقة</label>

                                <input type="radio" class="btn-check" name="searchType" id="searchCar">
                                <label class="btn btn-outline-primary" for="searchCar">السيارة</label>
                            </div>
                        </div>

                        <!-- نتائج البحث -->
                        <div id="searchResults" class="search-results"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <!-- App Scripts -->
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEMiAI",
            authDomain: "messageemeapp.firebaseapp.com",
            databaseURL: "https://messageemeapp-default-rtdb.firebaseio.com",
            projectId: "messageemeapp",
            storageBucket: "messageemeapp.appspot.com",
            messagingSenderId: "255034474844",
            appId: "1:255034474844:web:5e3b7a6bc4b2fb94cc4199"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();
        const auth = firebase.auth();

        // قاموس المحافظات والمناطق
        const iraqProvinces = {
            "بغداد": ["الكرخ", "الرصافة", "الأعظمية", "الكاظمية", "المنصور", "الدورة", "الشعب", "الكرادة", "زيونة", "الغدير", "البلديات", "الشعلة", "الحرية", "الوشاش", "حي الجامعة", "الصليخ", "بغداد الجديدة", "مدينة الصدر", "الزعفرانية", "العامرية", "الغزالية", "الجادرية", "الحارثية", "الجهاد", "البياع", "الخضراء", "حي الخليج", "التاجي"],
            "البصرة": ["البصرة الجديدة", "الزبير", "أبو الخصيب", "القرنة", "شط العرب", "الفاو", "الهارثة", "الدير", "المدينة", "العشار", "البراضعية", "الخور", "النجيبية", "الفيحاء", "المعقل", "سفوان", "الخصيب", "جبيلة", "القبلة", "ياسين خريبط", "الشعيبة"],
            "نينوى": ["الموصل", "تلعفر", "الحمدانية", "سنجار", "الحضر", "البعاج", "عين سفني", "تلكيف", "القيارة", "مخمور", "شيخان", "الحيدانية", "الشمال", "وانة", "سميل"],
            "أربيل": ["عنكاوا", "شقلاوة", "خبات", "سوران", "جومان", "رواندوز", "ميرگسور", "كوية", "المركز", "دشتي هولير", "خيفتي", "دارتو", "بنصلاوة", "حرير", "سيديكان", "شيروان-مزن", "مخمور", "قوشتبة"],
            "النجف": ["الكوفة", "المناذرة", "المشخاب", "الحيدرية", "العباسية", "القادسية", "الحرية", "النجف القديمة", "الغري", "النصر", "الوفاء", "الزهراء", "الجامعة", "السلام", "الغدير", "المرتضى", "القدس", "الأمير"],
            "كربلاء": ["الحسينية", "الهندية", "عين التمر", "الحر", "الجدول الغربي", "مركز كربلاء", "الخيرات", "الرشيد", "العباس", "الإصلاح", "الحسين", "المخيم", "الأنصار", "باب الخان", "الإسكان"],
            "كركوك": ["دبس", "الحويجة", "داقوق", "تازة", "شوان", "يايجي", "الملتقى", "العروبة", "القادسية", "الواسطي", "المنصور", "النصر", "الرياض", "الرشاد", "الزاب", "الرياض", "الصناعي"],
            "الأنبار": ["الرمادي", "الفلوجة", "هيت", "حديثة", "الخالدية", "الصقلاوية", "كبيسة", "العامرية", "الحبانية", "راوة", "عنه", "الرطبة", "القائم", "البغدادي", "الكرمة", "الوليد", "الحقلانية", "الرحالية"],
            "بابل": ["الحلة", "المسيب", "الهاشمية", "القاسم", "المحاويل", "الكفل", "النيل", "أبو غرق", "المدحتية", "الإسكندرية"],
            "ديالى": ["بعقوبة", "المقدادية", "خانقين", "بلدروز", "كفري", "الخالص", "جلولاء", "قزانية", "مندلي", "قرة تبة"],
            "ذي قار": ["الناصرية", "سوق الشيوخ", "الشطرة", "الرفاعي", "الجبايش", "قلعة سكر", "الغراف"],
            "صلاح الدين": ["تكريت", "سامراء", "بيجي", "بلد", "الدور", "الشرقاط", "طوز خورماتو", "العلم"],
            "واسط": ["الكوت", "النعمانية", "الحي", "بدرة", "الصويرة", "العزيزية", "الموفقية"],
            "ميسان": ["العمارة", "المجر الكبير", "الكحلاء", "علي الغربي", "قلعة صالح", "الميمونة"],
            "المثنى": ["السماوة", "الرميثة", "السوير", "المجد", "الخضر", "الهلال", "النجمي", "الوركاء"],
            "دهوك": ["زاخو", "العمادية", "سميل", "الشيخان", "ئاكرى", "بردرش", "زاويتة", "باتيل"],
            "القادسية": ["الديوانية", "عفك", "الشامية", "الحمزة", "نفر", "غماس", "سومر", "الشنافية"]
        };

        // متغير عام لتخزين السائقين
        let allDrivers = [];

        // عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // تهيئة قوائم المحافظات
            initializeProvinceDropdown();
            
            // تحميل السائقين
            loadDrivers();
            
            // مراقبة حالة المستخدم
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    console.log('تم تسجيل الدخول:', user.uid);
                    loadUserData(user);
                } else {
                    console.log('غير مسجل الدخول');
                    resetUserInterface();
                }
            });
        });

        // دالة تهيئة قائمة المحافظات
        function initializeProvinceDropdown() {
            const provinceSelect = document.getElementById('provinceFilter');
            if (!provinceSelect) return;
            
            // إضافة خيارات المحافظات
            Object.keys(iraqProvinces).forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                provinceSelect.appendChild(option);
            });
        }

        // دالة تحميل المناطق بناءً على المحافظة المختارة
        function loadAreas(province) {
            const areaSelect = document.getElementById('areaFilter');
            if (!areaSelect) return;
            
            // تفريغ القائمة
            areaSelect.innerHTML = '<option value="">كل المناطق</option>';
            
            // تعطيل القائمة إذا لم يتم اختيار محافظة
            if (!province) {
                areaSelect.disabled = true;
                return;
            }
            
            // إضافة المناطق للمحافظة المختارة
            if (iraqProvinces[province]) {
                iraqProvinces[province].forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    areaSelect.appendChild(option);
                });
                
                // تفعيل القائمة
                areaSelect.disabled = false;
            }
        }

        // دالة تحميل السائقين من Firebase
        function loadDrivers() {
            const loadingElement = document.getElementById('loadingDrivers');
            const noDriversMessage = document.getElementById('noDriversMessage');
            const driversListElement = document.getElementById('driversList');
            
            if (loadingElement) loadingElement.style.display = 'block';
            if (noDriversMessage) noDriversMessage.style.display = 'none';
            if (driversListElement) driversListElement.innerHTML = '';
            
            // استدعاء البيانات من Firebase
            firebase.database().ref('drivers').once('value')
                .then(snapshot => {
                    if (loadingElement) loadingElement.style.display = 'none';
                    
                    allDrivers = [];
                    
                    snapshot.forEach(childSnapshot => {
                        const driverId = childSnapshot.key;
                        const driver = childSnapshot.val();
                        
                        // إضافة معرف السائق إلى الكائن
                        driver.id = driverId;
                        
                        // إضافة السائق إلى المصفوفة
                        allDrivers.push(driver);
                    });
                    
                    // تحديث عدد السائقين
                    updateDriversCount(allDrivers.length);
                    
                    // عرض السائقين بعد الفلترة
                    filterDrivers();
                })
                .catch(error => {
                    console.error('Error loading drivers:', error);
                    
                    if (loadingElement) loadingElement.style.display = 'none';
                    if (driversListElement) {
                        driversListElement.innerHTML = `
                            <div class="alert alert-danger text-center">
                                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                <h4>حدث خطأ أثناء تحميل البيانات</h4>
                                <p>${error.message}</p>
                                <button class="btn btn-outline-danger mt-3" onclick="loadDrivers()">
                                    <i class="fas fa-sync me-2"></i> إعادة المحاولة
                                </button>
                            </div>
                        `;
                    }
                });
        }

        // دالة فلترة السائقين
        function filterDrivers() {
            const provinceFilter = document.getElementById('provinceFilter').value;
            const areaFilter = document.getElementById('areaFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchFilter = document.getElementById('searchInput').value.toLowerCase();
            const sortBy = document.getElementById('sortDrivers').value;
            
            const driversListElement = document.getElementById('driversList');
            const noDriversMessage = document.getElementById('noDriversMessage');
            
            if (!driversListElement || !noDriversMessage) return;
            
            // فلترة السائقين حسب المعايير
            let filteredDrivers = allDrivers.filter(driver => {
                // فلترة حسب المحافظة
                if (provinceFilter && (!driver.location || driver.location !== provinceFilter && driver.province !== provinceFilter)) {
                    return false;
                }
                
                // فلترة حسب المنطقة
                if (areaFilter && (!driver.area || driver.area !== areaFilter)) {
                    return false;
                }
                
                // فلترة حسب الحالة
                if (statusFilter) {
                    if (statusFilter === 'active' && (!driver.active || driver.active !== true)) {
                        return false;
                    } else if (statusFilter === 'inactive' && (driver.active || driver.active === true)) {
                        return false;
                    } else if (statusFilter === 'pending' && (!driver.approvalStatus || driver.approvalStatus !== 'pending')) {
                        return false;
                    }
                }
                
                // فلترة حسب البحث
                if (searchFilter) {
                    const nameMatch = driver.name && driver.name.toLowerCase().includes(searchFilter);
                    const carTypeMatch = driver.carType && driver.carType.toLowerCase().includes(searchFilter);
                    const locationMatch = driver.location && driver.location.toLowerCase().includes(searchFilter);
                    
                    if (!nameMatch && !carTypeMatch && !locationMatch) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // ترتيب السائقين
            filteredDrivers.sort((a, b) => {
                switch (sortBy) {
                    case 'rating':
                        return (b.rating || 0) - (a.rating || 0);
                    case 'trips':
                        return (b.trips || 0) - (a.trips || 0);
                    case 'name':
                        return (a.name || '').localeCompare(b.name || '');
                    case 'recent':
                        return (b.createdAt || 0) - (a.createdAt || 0);
                    default:
                        return 0;
                }
            });
            
            // تحديث عدد السائقين بعد الفلترة
            updateDriversCount(filteredDrivers.length);
            
            // عرض النتائج
            if (filteredDrivers.length === 0) {
                driversListElement.innerHTML = '';
                noDriversMessage.style.display = 'block';
            } else {
                noDriversMessage.style.display = 'none';
                driversListElement.innerHTML = filteredDrivers.map(driver => createDriverListItem(driver)).join('');
            }
        }

        // دالة تحديث عدد السائقين
        function updateDriversCount(count) {
            const countElement = document.getElementById('driversCount');
            if (countElement) {
                countElement.textContent = `${count} سائق`;
            }
        }

        // دالة إعادة تعيين الفلاتر
        function resetFilters() {
            document.getElementById('provinceFilter').value = '';
            document.getElementById('areaFilter').value = '';
            document.getElementById('areaFilter').disabled = true;
            document.getElementById('statusFilter').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('sortDrivers').value = 'rating';
            
            filterDrivers();
        }

        // دالة إنشاء عنصر السائق في القائمة
        function createDriverListItem(driver) {
            // التحقق من حالة السائق
            const isApproved = driver.approved === true;
            const isPending = driver.approvalStatus === 'pending';
            const isActive = driver.active === true && isApproved;
            
            // تحديد لون الحالة وصفها
            let statusClass = '';
            let statusText = '';
            
            if (!isApproved) {
                statusClass = isPending ? 'status-pending' : 'status-inactive';
                statusText = isPending ? 'قيد المراجعة' : 'غير مفعل';
            } else {
                statusClass = isActive ? 'status-active' : 'status-inactive';
                statusText = isActive ? 'متاح' : 'مشغول';
            }
            
            // تحديد تأثير عنصر السائق قيد المراجعة
            const pendingClass = !isApproved ? 'pendingApproval' : '';
            
            // إنشاء نجوم التقييم
            const rating = driver.rating || 5.0;
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let starsHtml = '';
            
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    starsHtml += '<i class="fas fa-star"></i>';
                } else if (i === fullStars && hasHalfStar) {
                    starsHtml += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    starsHtml += '<i class="far fa-star"></i>';
                }
            }
            
            return `
                <div class="driver-list-item animate__animated animate__fadeIn ${pendingClass}" data-driver-id="${driver.id}">
                    <span class="driver-item-status ${statusClass}">${statusText}</span>
                    <img src="${driver.imageUrl || driver.photoUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" 
                         alt="${driver.name}" 
                         class="driver-avatar"
                         onerror="this.src='https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'">
                    
                    <div class="driver-info">
                        <h4 class="driver-name">${driver.name || 'سائق بدون اسم'}</h4>
                        
                        <div class="driver-rating">
                            ${starsHtml} <span class="ms-1">${rating.toFixed(1)}</span>
                        </div>
                        
                        <div class="driver-meta">
                            <p><i class="fas fa-car me-2" style="color: #FFD700;"></i>${driver.carType || ''} ${driver.carModel || ''}</p>
                            <p><i class="fas fa-map-marker-alt me-2" style="color: #FFD700;"></i>${driver.location || driver.province || 'غير محدد'}</p>
                            <p><i class="fas fa-route me-2" style="color: #FFD700;"></i>الرحلات: ${driver.trips || 0}</p>
                        </div>
                        
                        <div class="driver-actions">
                            <button class="view-btn" onclick="showDriverDetails('${driver.id}')">
                                <i class="fas fa-info-circle"></i>
                                عرض التفاصيل
                            </button>
                            <button class="chat-btn" onclick="openChatWindow('${driver.id}')" ${!isApproved ? 'disabled' : ''}>
                                <i class="fas fa-comment"></i>
                                مراسلة
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // دالة عرض تفاصيل السائق
        function showDriverDetails(driverId) {
            const driver = allDrivers.find(d => d.id === driverId);
            if (!driver) {
                showToast('لم يتم العثور على بيانات السائق', 'error');
                return;
            }
            
            // التحقق من حالة السائق
            const isApproved = driver.approved === true;
            const isPending = driver.approvalStatus === 'pending';
            const isActive = driver.active === true && isApproved;
            
            // تحديد لون الحالة وصفها
            let statusClass = '';
            let statusText = '';
            
            if (!isApproved) {
                statusClass = isPending ? 'bg-warning text-dark' : 'bg-danger';
                statusText = isPending ? 'قيد المراجعة' : 'غير مفعل';
            } else {
                statusClass = isActive ? 'bg-success' : 'bg-danger';
                statusText = isActive ? 'متاح' : 'مشغول';
            }
            
            // تنسيق التاريخ
            const formatDate = (timestamp) => {
                if (!timestamp) return 'غير محدد';
                const date = new Date(timestamp);
                return date.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            };
            
            // إنشاء نجوم التقييم
            const rating = driver.rating || 5.0;
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let starsHtml = '';
            
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    starsHtml += '<i class="fas fa-star"></i>';
                } else if (i === fullStars && hasHalfStar) {
                    starsHtml += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    starsHtml += '<i class="far fa-star"></i>';
                }
            }
            
            // إضافة المستندات إذا كانت موجودة
            let documentsSection = '';
            if (driver.documents) {
                documentsSection = `
                    <div class="info-section">
                        <div class="info-section-title">
                            <i class="fas fa-file-alt"></i>
                            المستندات
                        </div>
                        <div class="row g-3 my-2">
                            ${driver.documents.idCard ? `
                                <div class="col-md-6">
                                    <div class="card bg-dark">
                                        <div class="card-header text-white">هوية الأحوال المدنية</div>
                                        <div class="card-body d-flex gap-2">
                                            ${driver.documents.idCard.front ? `
                                                <a href="${driver.documents.idCard.front}" target="_blank" class="btn btn-sm btn-outline-light">
                                                    <i class="fas fa-id-card me-1"></i> الوجه الأمامي
                                                </a>
                                            ` : ''}
                                            ${driver.documents.idCard.back ? `
                                                <a href="${driver.documents.idCard.back}" target="_blank" class="btn btn-sm btn-outline-light">
                                                    <i class="fas fa-id-card me-1"></i> الوجه الخلفي
                                                </a>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${driver.documents.driverLicense ? `
                                <div class="col-md-6">
                                    <div class="card bg-dark">
                                        <div class="card-header text-white">إجازة السوق</div>
                                        <div class="card-body d-flex gap-2">
                                            ${driver.documents.driverLicense.front ? `
                                                <a href="${driver.documents.driverLicense.front}" target="_blank" class="btn btn-sm btn-outline-light">
                                                    <i class="fas fa-id-card me-1"></i> الوجه الأمامي
                                                </a>
                                            ` : ''}
                                            ${driver.documents.driverLicense.back ? `
                                                <a href="${driver.documents.driverLicense.back}" target="_blank" class="btn btn-sm btn-outline-light">
                                                    <i class="fas fa-id-card me-1"></i> الوجه الخلفي
                                                </a>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // إنشاء محتوى نافذة التفاصيل
            const detailsContent = `
                <div class="driver-cover-photo">
                    <img src="${driver.imageUrl || driver.photoUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" 
                         alt="${driver.name}" 
                         class="driver-big-avatar"
                         onerror="this.src='https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'">
                </div>
                
                <div class="driver-details-header">
                    <h4 class="mb-2">${driver.name || 'سائق بدون اسم'}</h4>
                    <p class="text-muted mb-3">${driver.bio || 'لا توجد معلومات إضافية'}</p>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                    
                    <div class="driver-stats">
                        <div class="stat-item">
                            <div class="stat-value">${rating.toFixed(1)}</div>
                            <div class="stat-label">التقييم</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${driver.trips || 0}</div>
                            <div class="stat-label">الرحلات</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${formatDate(driver.createdAt)}</div>
                            <div class="stat-label">تاريخ التسجيل</div>
                        </div>
                    </div>
                </div>
                
                <div class="driver-details-content">
                    <div class="info-section">
                        <div class="info-section-title">
                            <i class="fas fa-user"></i>
                            المعلومات الشخصية
                        </div>
                        <div class="info-row">
                            <div class="info-label">الاسم</div>
                            <div class="info-value">${driver.name || 'غير محدد'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">رقم الهاتف</div>
                            <div class="info-value">${driver.phone || 'غير محدد'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">البريد الإلكتروني</div>
                            <div class="info-value">${driver.email || 'غير محدد'}</div>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-section-title">
                            <i class="fas fa-car"></i>
                            معلومات المركبة
                        </div>
                        <div class="info-row">
                            <div class="info-label">نوع المركبة</div>
                            <div class="info-value">${driver.carType || 'غير محدد'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">موديل المركبة</div>
                            <div class="info-value">${driver.carModel || 'غير محدد'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">لون المركبة</div>
                            <div class="info-value">${driver.vehicleColor || 'غير محدد'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">رقم المركبة</div>
                            <div class="info-value">${driver.vehicleNumber || 'غير محدد'}</div>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-section-title">
                            <i class="fas fa-map-marker-alt"></i>
                            معلومات الموقع
                        </div>
                        <div class="info-row">
                            <div class="info-label">المحافظة</div>
                            <div class="info-value">${driver.province || driver.location || 'غير محدد'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">المنطقة</div>
                            <div class="info-value">${driver.area || 'غير محدد'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">العنوان</div>
                            <div class="info-value">${driver.address || 'غير محدد'}</div>
                        </div>
                    </div>
                    
                    ${documentsSection}
                    
                    <div class="driver-actions-large">
                        <button class="action-btn-large secondary" onclick="viewDriverLocation('${driver.id}')" ${!driver.coordinates ? 'disabled' : ''}>
                            <i class="fas fa-map-marker-alt"></i>
                            عرض الموقع
                        </button>
                        <button class="action-btn-large primary" onclick="openChatWindow('${driver.id}')" ${!isApproved ? 'disabled' : ''}>
                            <i class="fas fa-comment"></i>
                            مراسلة
                        </button>
                    </div>
                </div>
            `;
            
            // تحديث محتوى النافذة المنبثقة
            const detailsContentElement = document.getElementById('driverDetailsContent');
            if (detailsContentElement) {
                detailsContentElement.innerHTML = detailsContent;
            }
            
            // عرض النافذة المنبثقة
            const modal = new bootstrap.Modal(document.getElementById('driverDetailsModal'));
            modal.show();
        }

        // دالة عرض موقع السائق على الخريطة
        function viewDriverLocation(driverId) {
            const driver = allDrivers.find(d => d.id === driverId);
            if (!driver || !driver.coordinates) {
                showToast('لا يوجد موقع محدد لهذا السائق', 'warning');
                return;
            }
            
            // إغلاق النافذة المنبثقة الحالية إذا كانت مفتوحة
            const currentModal = bootstrap.Modal.getInstance(document.getElementById('driverDetailsModal'));
            if (currentModal) {
                currentModal.hide();
            }
            
            // توجيه المستخدم إلى صفحة الخريطة مع معلمات الموقع
            window.location.href = `map.html?driver=${driverId}&lat=${driver.coordinates.lat}&lng=${driver.coordinates.lng}`;
        }

        // دالة فتح نافذة المحادثة
        function openChatWindow(driverId) {
            const driver = allDrivers.find(d => d.id === driverId);
            if (!driver) {
                showToast('لم يتم العثور على بيانات السائق', 'error');
                return;
            }
            
            // إغلاق النافذة المنبثقة الحالية إذا كانت مفتوحة
            const currentModal = bootstrap.Modal.getInstance(document.getElementById('driverDetailsModal'));
            if (currentModal) {
                currentModal.hide();
            }
            
            // التحقق من حالة السائق
            if (driver.approved !== true) {
                showToast('هذا السائق غير مفعل حالياً', 'warning');
                return;
            }
            
            // الانتقال إلى نافذة المحادثة في الصفحة الرئيسية
            window.location.href = `index.html?chat=${driverId}`;
        }

        // دالة لتوغل الشريط الجانبي
        function toggleSideNav() {
            const sideNav = document.getElementById('sideNav');
            const navBackdrop = document.getElementById('navBackdrop');
            const body = document.body;

            if (sideNav.classList.contains('open')) {
                // إغلاق الشريط الجانبي
                sideNav.classList.remove('open');
                navBackdrop.classList.remove('show');
                body.classList.remove('side-nav-open');
            } else {
                // فتح الشريط الجانبي
                sideNav.classList.add('open');
                navBackdrop.classList.add('show');
                body.classList.add('side-nav-open');
            }
        }

        // دالة إظهار التوست
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `custom-toast animate__animated animate__fadeInRight toast-${type}`;
            
            // تحديد الأيقونة حسب النوع
            let icon;
            switch (type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle text-success"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-times-circle text-danger"></i>';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-exclamation-triangle text-warning"></i>';
                    break;
                case 'info':
                    icon = '<i class="fas fa-info-circle text-info"></i>';
                    break;
                default:
                    icon = '<i class="fas fa-bell"></i>';
            }
            
            toast.innerHTML = `
                ${icon}
                <div class="toast-content">${message}</div>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            const toastContainer = document.getElementById('toastContainer');
            toastContainer.appendChild(toast);
            
            // إزالة التوست بعد 3 ثواني
            setTimeout(() => {
                toast.classList.replace('animate__fadeInRight', 'animate__fadeOutRight');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // دالة تحميل بيانات المستخدم
        async function loadUserData(user) {
            try {
                // التحقق من وجود بيانات في التخزين المحلي أولاً
                const cachedUserData = localStorage.getItem('currentUser');
                if (cachedUserData) {
                    const userData = JSON.parse(cachedUserData);
                    updateUIAfterLogin(userData);
                    return;
                }
                
                // بحث في قاعدة بيانات المستخدمين
                const userSnapshot = await firebase.database().ref(`users/${user.uid}`).once('value');
                const userData = userSnapshot.val();
                
                if (userData) {
                    // تحديث بيانات التخزين المحلي والواجهة
                    localStorage.setItem('currentUser', JSON.stringify(userData));
                    updateUIAfterLogin(userData);
                    return;
                }
                
                // بحث في قاعدة بيانات السائقين
                const driverSnapshot = await firebase.database().ref('drivers').orderByChild('uid').equalTo(user.uid).once('value');
                const driversData = driverSnapshot.val();
                
                if (driversData) {
                    // استخراج بيانات السائق
                    const driverId = Object.keys(driversData)[0];
                    const driverData = driversData[driverId];
                    driverData.userType = 'driver';
                    
                    // تحديث بيانات التخزين المحلي والواجهة
                    localStorage.setItem('currentUser', JSON.stringify(driverData));
                    updateUIAfterLogin(driverData);
                    return;
                }
                
                // إذا لم نجد بيانات، ننشئ بيانات أولية من معلومات المصادقة
                const basicUserData = {
                    uid: user.uid,
                    email: user.email,
                    fullName: user.displayName || 'المستخدم',
                    photoUrl: user.photoURL,
                    userType: 'user'
                };
                
                localStorage.setItem('currentUser', JSON.stringify(basicUserData));
                updateUIAfterLogin(basicUserData);
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('حدث خطأ في تحميل بيانات المستخدم', 'error');
            }
        }

        // دالة تحديث واجهة المستخدم بعد تسجيل الدخول
        function updateUIAfterLogin(userData) {
            // تحديد نوع المستخدم ليظهر في الواجهة
            const userRole = userData.userType === 'driver' ? 'سائق' : 'مستخدم';
            
            // تحديث زر الملف الشخصي في الشريط العلوي
            const profileBtn = document.querySelector('.user-profile-btn');
            if (profileBtn) {
                // استخدام الصورة الشخصية من البيانات
                const userPhoto = userData.photoUrl || userData.imageUrl || 'default-avatar.png';
                const userName = userData.fullName || userData.name || 'المستخدم';
                
                // إزالة خصائص النافذة المنبثقة
                profileBtn.removeAttribute('data-bs-toggle');
                profileBtn.removeAttribute('data-bs-target');
                
                // إضافة معالج النقر لعرض قائمة المستخدم
                profileBtn.setAttribute('onclick', 'showUserMenu(event)');
                
                // تحديث صورة الملف الشخصي
                const userProfileImage = document.getElementById('userProfileImage');
                const defaultProfileIcon = document.getElementById('defaultProfileIcon');
                if (userProfileImage && defaultProfileIcon) {
                    userProfileImage.src = userPhoto;
                    userProfileImage.style.display = 'inline-block';
                    defaultProfileIcon.style.display = 'none';
                }
                
                // تحديث نص الملف الشخصي
                const profileText = document.getElementById('profileText');
                if (profileText) {
                    profileText.textContent = userName;
                }
            }

            // تحديث معلومات المستخدم في الشريط الجانبي
            const sideNavUserInfo = document.querySelector('.side-nav-user-info');
            if (sideNavUserInfo) {
                // استخدام الصورة الشخصية من البيانات
                const userPhoto = userData.photoUrl || userData.imageUrl || 'default-avatar.png';
                const userName = userData.fullName || userData.name || 'المستخدم';
                
                sideNavUserInfo.innerHTML = `
                    <div class="text-center">
                        <img src="${userPhoto}" 
                             alt="${userName}" 
                             class="rounded-circle mb-3"
                             style="width: 80px; height: 80px; object-fit: cover; border: 3px solid #FFD700;">
                        <h6 class="text-white mb-1">${userName}</h6>
                        <span class="badge bg-gold mb-2">${userRole}</span>
                        <p class="text-white-50 small mb-3">${userData.email || ''}</p>
                        <button onclick="handleLogout()" class="btn btn-danger btn-sm w-100">
                            <i class="fas fa-sign-out-alt me-2"></i>
                            تسجيل الخروج
                        </button>
                    </div>
                `;
            }
            
            // إظهار أو إخفاء عناصر واجهة خاصة بالسائقين إذا كان المستخدم سائق
            const driverOnlyElements = document.querySelectorAll('.driver-only');
            driverOnlyElements.forEach(element => {
                element.style.display = userData.userType === 'driver' ? 'block' : 'none';
            });
            
            // إظهار زر تسجيل الخروج
            const logoutBtn = document.querySelector('.logout-btn');
            if (logoutBtn) {
                logoutBtn.style.display = 'flex';
            }
            
            console.log('تم تحديث واجهة المستخدم بنجاح بعد تسجيل الدخول');
        }

        // دالة إعادة تعيين واجهة المستخدم
        function resetUserInterface() {
            // إعادة زر الملف الشخصي إلى حالته الأصلية
            const profileBtn = document.querySelector('.user-profile-btn');
            if (profileBtn) {
                profileBtn.innerHTML = `
                    <i class="fas fa-user-circle" id="defaultProfileIcon" style="color: #FFD700;"></i>
                    <span class="ms-1 d-none d-md-inline" id="profileText">تسجيل الدخول</span>
                `;
                
                // إعادة تعيين خصائص الزر ليفتح نافذة تسجيل الدخول
                profileBtn.setAttribute('data-bs-toggle', 'modal');
                profileBtn.setAttribute('data-bs-target', '#profileModal');
                profileBtn.removeAttribute('onclick');
                
                // إخفاء صورة الملف الشخصي وإظهار الأيقونة الافتراضية
                const userProfileImage = document.getElementById('userProfileImage');
                if (userProfileImage) {
                    userProfileImage.style.display = 'none';
                }
                const defaultProfileIcon = document.getElementById('defaultProfileIcon');
                if (defaultProfileIcon) {
                    defaultProfileIcon.style.display = 'inline-block';
                }
            }
            
            // إعادة تعيين معلومات المستخدم في الشريط الجانبي
            const sideNavUserInfo = document.querySelector('.side-nav-user-info');
            if (sideNavUserInfo) {
                sideNavUserInfo.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-user-circle text-white" style="font-size: 4rem;"></i>
                        <h6 class="text-white mt-3">مرحباً بك</h6>
                        <p class="text-white-50 small">قم بتسجيل الدخول للوصول إلى حسابك</p>
                        <div class="mt-3">
                            <button class="btn btn-gold w-100 mb-2" data-bs-toggle="modal" data-bs-target="#loginModal">
                                تسجيل الدخول
                            </button>
                            <button class="btn btn-outline-light w-100 mb-2" data-bs-toggle="modal" data-bs-target="#userRegistrationModal">
                                إنشاء حساب
                            </button>
                            <button class="btn btn-outline-light w-100" data-bs-toggle="modal" data-bs-target="#addDriverModal">
                                إضافة سائق
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // إخفاء عناصر واجهة خاصة بالسائقين
            const driverOnlyElements = document.querySelectorAll('.driver-only');
            driverOnlyElements.forEach(element => {
                element.style.display = 'none';
            });
            
            // إخفاء زر تسجيل الخروج
            const logoutBtn = document.querySelector('.logout-btn');
            if (logoutBtn) {
                logoutBtn.style.display = 'none';
            }
        }

        // دالة معالجة تسجيل الخروج
        async function handleLogout() {
            try {
                showLoading();
                
                // تسجيل الخروج من Firebase Auth
                await firebase.auth().signOut();
                
                // حذف بيانات المستخدم من التخزين المحلي
                localStorage.removeItem('currentUser');
                
                // إعادة تعيين واجهة المستخدم
                resetUserInterface();
                
                showToast('تم تسجيل الخروج بنجاح', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showToast('حدث خطأ أثناء تسجيل الخروج', 'error');
            } finally {
                hideLoading();
            }
        }

        // دالة عرض قائمة المستخدم
        function showUserMenu(event) {
            event.preventDefault();
            const userData = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!userData) {
                console.error('User data not found.');
                return;
            }
            
            Swal.fire({
                title: `مرحباً ${userData.fullName || userData.name || 'المستخدم'}`,
                html: `
                    <div class="text-center mb-3">
                        <img src="${userData.photoUrl || userData.photoURL || 'default-avatar.png'}" 
                             alt="صورة المستخدم" 
                             class="rounded-circle mb-3"
                             style="width: 100px; height: 100px; object-fit: cover;">
                        <p class="mb-2">${userData.email || ''}</p>
                        <p class="text-muted">${userData.phone || ''}</p>
                    </div>
                `,
                showCancelButton: true,
                showDenyButton: true,
                confirmButtonText: 'الملف الشخصي',
                denyButtonText: 'تسجيل الخروج',
                cancelButtonText: 'إغلاق',
                confirmButtonColor: '#FFD700',
                denyButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            }).then((result) => {
                if (result.isConfirmed) {
                    // نقل المستخدم إلى صفحة الملف الشخصي
                    window.location.href = 'profile.html';
                } else if (result.isDenied) {
                    handleLogout();
                }
            });
        }

        // دالة إظهار مؤشر التحميل
        function showLoading() {
            const loadingSpinner = document.getElementById('loadingSpinner');
            if (loadingSpinner) {
                loadingSpinner.style.display = 'flex';
            }
        }

        // دالة إخفاء مؤشر التحميل
        function hideLoading() {
            const loadingSpinner = document.getElementById('loadingSpinner');
            if (loadingSpinner) {
                loadingSpinner.style.display = 'none';
            }
        }

        // دالة التعامل مع معلمات URL
        function handleUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const province = urlParams.get('province');
            const area = urlParams.get('area');
            const search = urlParams.get('search');
            
            if (province) {
                const provinceFilter = document.getElementById('provinceFilter');
                if (provinceFilter) {
                    provinceFilter.value = province;
                    loadAreas(province);
                }
            }
            
            if (area) {
                setTimeout(() => {
                    const areaFilter = document.getElementById('areaFilter');
                    if (areaFilter) {
                        areaFilter.value = area;
                    }
                }, 300);
            }
            
            if (search) {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.value = search;
                }
            }
            
            // تطبيق الفلاتر إذا كان هناك أي معلمات
            if (province || area || search) {
                setTimeout(filterDrivers, 500);
            }
        }
        
        // تكملة دوال معالجة النوافذ المنبثقة
function openLoginModal() {
    // إغلاق نافذة اختيار نوع الحساب
    const profileModal = bootstrap.Modal.getInstance(document.getElementById('profileModal'));
    if (profileModal) {
        profileModal.hide();
    }

    setTimeout(() => {
        const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
        loginModal.show();
    }, 150);
}

function openUserRegistration() {
    const profileModal = bootstrap.Modal.getInstance(document.getElementById('profileModal'));
    if (profileModal) {
        profileModal.hide();
    }

    setTimeout(() => {
        const userModal = new bootstrap.Modal(document.getElementById('userRegistrationModal'));
        userModal.show();
    }, 150);
}

function showAddDriverModal() {
    const profileModal = bootstrap.Modal.getInstance(document.getElementById('profileModal'));
    if (profileModal) {
        profileModal.hide();
    }

    setTimeout(() => {
        const driverModal = new bootstrap.Modal(document.getElementById('addDriverModal'));
        driverModal.show();
    }, 150);
}

// دالة معالجة تسجيل الدخول
async function handleLogin(event) {
    event.preventDefault();
    showLoading();

    try {
        const formData = new FormData(event.target);
        const email = formData.get('email');
        const password = formData.get('password');

        // التحقق من حقول الإدخال
        if (!email || !password) {
            throw new Error('يرجى إدخال البريد الإلكتروني وكلمة المرور');
        }

        // محاولة تسجيل الدخول باستخدام Firebase
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // البحث عن بيانات المستخدم في قاعدة البيانات
        let userData = null;

        // البحث في جدول المستخدمين أولاً
        const userSnapshot = await firebase.database().ref(`users/${user.uid}`).once('value');
        userData = userSnapshot.val();

        // إذا لم نجد المستخدم في جدول المستخدمين، نبحث في جدول السائقين
        if (!userData) {
            const driverSnapshot = await firebase.database().ref('drivers').orderByChild('uid').equalTo(user.uid).once('value');
            const driversData = driverSnapshot.val();
            
            if (driversData) {
                // استخراج بيانات السائق
                const driverId = Object.keys(driversData)[0];
                userData = driversData[driverId];
                userData.userType = 'driver';
                userData.id = driverId;
            }
        }

        // إذا لم نجد بيانات في قاعدة البيانات، استخدم بيانات المصادقة فقط
        if (!userData) {
            userData = {
                uid: user.uid,
                email: user.email,
                fullName: user.displayName || 'المستخدم',
                photoUrl: user.photoURL,
                userType: 'user'
            };
        }

        // حفظ بيانات المستخدم في التخزين المحلي
        localStorage.setItem('currentUser', JSON.stringify(userData));

        // تحديث واجهة المستخدم
        updateUIAfterLogin(userData);

        // إغلاق نافذة تسجيل الدخول
        const loginModal = document.getElementById('loginModal');
        if (loginModal) {
            const modalInstance = bootstrap.Modal.getInstance(loginModal);
            if (modalInstance) {
                modalInstance.hide();
            }
        }

        // إرسال حدث نجاح تسجيل الدخول
        document.dispatchEvent(new CustomEvent('login-success'));

        showToast('تم تسجيل الدخول بنجاح', 'success');
    } catch (error) {
        console.error('Login error:', error);
        
        let errorMessage = 'فشل تسجيل الدخول';
        
        // ترجمة رسائل خطأ Firebase
        switch (error.code) {
            case 'auth/user-not-found':
                errorMessage = 'البريد الإلكتروني غير مسجل';
                break;
            case 'auth/wrong-password':
                errorMessage = 'كلمة المرور غير صحيحة';
                break;
            case 'auth/invalid-email':
                errorMessage = 'البريد الإلكتروني غير صالح';
                break;
            case 'auth/user-disabled':
                errorMessage = 'تم تعطيل هذا الحساب';
                break;
            case 'auth/too-many-requests':
                errorMessage = 'تم تجاوز عدد محاولات تسجيل الدخول المسموح بها، يرجى المحاولة لاحقاً';
                break;
            default:
                errorMessage = error.message;
        }
        
        showToast(errorMessage, 'error');
    } finally {
        hideLoading();
    }
}

// دالة معالجة تسجيل المستخدم
async function handleUserRegistration(event) {
    event.preventDefault();
    showLoading();

    try {
        const formData = new FormData(event.target);
        const fullName = formData.get('fullName');
        const email = formData.get('email');
        const password = formData.get('password');
        const confirmPassword = formData.get('confirmPassword');
        const phone = formData.get('phone');
        const province = formData.get('province');
        const area = formData.get('area');
        const address = formData.get('address');
        const terms = formData.get('terms');
        
        // التحقق من البيانات
        if (!fullName || !email || !password || !phone || !province || !area || !address) {
            throw new Error('يرجى ملء جميع الحقول المطلوبة');
        }
        
        if (password !== confirmPassword) {
            throw new Error('كلمات المرور غير متطابقة');
        }
        
        if (!terms) {
            throw new Error('يجب الموافقة على الشروط والأحكام');
        }
        
        // إنشاء حساب في Firebase Authentication
        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // رفع الصورة الشخصية إذا وجدت
        let photoUrl = null;
        const photoFile = document.getElementById('userPhoto').files[0];
        if (photoFile) {
            const photoRef = firebase.storage().ref(`users/${user.uid}/${Date.now()}_${photoFile.name}`);
            const uploadTask = await photoRef.put(photoFile);
            photoUrl = await uploadTask.ref.getDownloadURL();
        }
        
        // إنشاء بيانات المستخدم
        const userData = {
            uid: user.uid,
            fullName: fullName,
            email: email,
            phone: phone,
            province: province,
            area: area,
            address: address,
            photoUrl: photoUrl,
            userType: 'user',
            createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        // حفظ البيانات في قاعدة البيانات
        await firebase.database().ref(`users/${user.uid}`).set(userData);
        
        // تحديث الملف الشخصي في Firebase Auth
        await user.updateProfile({
            displayName: fullName,
            photoURL: photoUrl
        });
        
        // حفظ البيانات محلياً
        localStorage.setItem('currentUser', JSON.stringify(userData));
        
        // تحديث واجهة المستخدم
        updateUIAfterLogin(userData);
        
        // إغلاق النافذة المنبثقة
        const modal = bootstrap.Modal.getInstance(document.getElementById('userRegistrationModal'));
        if (modal) {
            modal.hide();
        }
        
        showToast('تم إنشاء الحساب بنجاح', 'success');
        
        // إعادة تعيين النموذج
        event.target.reset();
        document.getElementById('userPhotoPreview').style.display = 'none';
        document.querySelector('#userRegistrationModal .upload-placeholder').style.display = 'flex';
        
    } catch (error) {
        console.error('Registration error:', error);
        
        let errorMessage = 'فشل في إنشاء الحساب';
        
        // ترجمة رسائل خطأ Firebase
        switch (error.code) {
            case 'auth/email-already-in-use':
                errorMessage = 'البريد الإلكتروني مستخدم بالفعل';
                break;
            case 'auth/invalid-email':
                errorMessage = 'البريد الإلكتروني غير صالح';
                break;
            case 'auth/weak-password':
                errorMessage = 'كلمة المرور ضعيفة جداً';
                break;
            default:
                errorMessage = error.message;
        }
        
        showToast(errorMessage, 'error');
    } finally {
        hideLoading();
    }
}

// دالة معالجة إضافة سائق
async function handleAddDriver(event) {
    event.preventDefault();
    showLoading();

    try {
        // التحقق من تطابق كلمات المرور
        const email = document.getElementById('driverEmail').value;
        const password = document.getElementById('driverPassword').value;
        const confirmPassword = document.getElementById('confirmDriverPassword').value;
        const driverName = document.getElementById('driverName').value;
        const driverPhone = document.getElementById('driverPhone').value;
        const carType = document.getElementById('carType').value;
        const carModel = document.getElementById('carModel').value;
        const driverLocation = document.getElementById('driverLocation').value;
        const driverArea = document.getElementById('driverArea').value;
        const driverBio = document.getElementById('driverBio').value;
        const latitude = document.getElementById('driverLatitude').value;
        const longitude = document.getElementById('driverLongitude').value;

        if (!email || !password || !driverName || !driverPhone || !carType || !carModel || !driverLocation || !driverArea) {
            throw new Error('يرجى ملء جميع الحقول المطلوبة');
        }

        if (password !== confirmPassword) {
            throw new Error('كلمات المرور غير متطابقة');
        }

        // التحقق من وجود المستندات المطلوبة
        const requiredDocs = [
            { id: 'driverImage', name: 'صورة السائق الشخصية' },
            { id: 'idCardFront', name: 'صورة الهوية الأمامية' },
            { id: 'idCardBack', name: 'صورة الهوية الخلفية' },
            { id: 'licenseFront', name: 'صورة إجازة السوق الأمامية' },
            { id: 'licenseBack', name: 'صورة إجازة السوق الخلفية' }
        ];

        for (const doc of requiredDocs) {
            const fileInput = document.getElementById(doc.id);
            if (!fileInput.files || !fileInput.files[0]) {
                throw new Error(`الرجاء إضافة ${doc.name}`);
            }
        }

        // إنشاء حساب في Firebase Authentication
        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // رفع الصور إلى Storage
        const uploadImage = async (fileId) => {
            const file = document.getElementById(fileId).files[0];
            const fileRef = firebase.storage().ref(`drivers/${user.uid}/${Date.now()}_${fileId}_${file.name}`);
            const uploadTask = await fileRef.put(file);
            return await uploadTask.ref.getDownloadURL();
        };

        const imageUrl = await uploadImage('driverImage');
        const idCardFrontUrl = await uploadImage('idCardFront');
        const idCardBackUrl = await uploadImage('idCardBack');
        const licenseFrontUrl = await uploadImage('licenseFront');
        const licenseBackUrl = await uploadImage('licenseBack');

        // إنشاء بيانات السائق
        const driverData = {
            uid: user.uid,
            name: driverName,
            email: email,
            phone: driverPhone,
            carType: carType,
            carModel: carModel,
            location: driverLocation,
            area: driverArea,
            bio: driverBio,
            imageUrl: imageUrl,
            coordinates: {
                lat: parseFloat(latitude),
                lng: parseFloat(longitude)
            },
            documents: {
                idCard: {
                    front: idCardFrontUrl,
                    back: idCardBackUrl
                },
                driverLicense: {
                    front: licenseFrontUrl,
                    back: licenseBackUrl
                }
            },
            rating: 5.0,
            trips: 0,
            active: false,
            approved: false,
            approvalStatus: 'pending',
            createdAt: firebase.database.ServerValue.TIMESTAMP
        };

        // حفظ بيانات السائق في قاعدة البيانات
        const newDriverRef = firebase.database().ref('drivers').push();
        await newDriverRef.set(driverData);

        // تحديث ملف تعريف المستخدم
        await user.updateProfile({
            displayName: driverName,
            photoURL: imageUrl
        });

        // إرسال بريد التحقق
        await user.sendEmailVerification();

        // إغلاق النافذة المنبثقة
        const modal = bootstrap.Modal.getInstance(document.getElementById('addDriverModal'));
        if (modal) {
            modal.hide();
        }

        // إظهار رسالة النجاح
        Swal.fire({
            title: 'تم تقديم الطلب بنجاح!',
            html: `
                <div class="success-message">
                    <p>تم إنشاء حساب السائق وإرسال طلبك للمراجعة</p>
                    <p>تم إرسال بريد إلكتروني للتحقق إلى: ${email}</p>
                    <small>سيتم مراجعة طلبك وتفعيل حسابك قريباً</small>
                </div>
            `,
            icon: 'success',
            confirmButtonText: 'حسناً',
            confirmButtonColor: '#FFD700'
        });

        // إعادة تعيين النموذج
        document.getElementById('addDriverForm').reset();
        resetImagePreviews();

    } catch (error) {
        console.error('Error adding driver:', error);
        
        let errorMessage = 'حدث خطأ أثناء إضافة السائق';
        
        // ترجمة رسائل خطأ Firebase
        switch (error.code) {
            case 'auth/email-already-in-use':
                errorMessage = 'البريد الإلكتروني مستخدم بالفعل';
                break;
            case 'auth/invalid-email':
                errorMessage = 'البريد الإلكتروني غير صالح';
                break;
            case 'auth/weak-password':
                errorMessage = 'كلمة المرور ضعيفة جداً';
                break;
            default:
                errorMessage = error.message;
        }
        
        showToast(errorMessage, 'error');
    } finally {
        hideLoading();
    }
}

// دالة معاينة صورة المستخدم
function previewUserPhoto(input) {
    const preview = document.getElementById('userPhotoPreview');
    const placeholder = input.parentElement.querySelector('.upload-placeholder');

    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// دالة معاينة المستندات
function previewDocument(input, previewId) {
    const preview = document.getElementById(previewId);
    const placeholder = input.parentElement.querySelector('.upload-placeholder');

    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// دالة معاينة صورة السائق
function handleImagePreview(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('imagePreview');
    const placeholder = document.querySelector('.upload-placeholder');

    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
        };
        reader.readAsDataURL(file);
    }
}

// دالة إعادة تعيين معاينات الصور
function resetImagePreviews() {
    const previews = document.querySelectorAll('img[id$="Preview"]');
    const placeholders = document.querySelectorAll('.upload-placeholder');

    previews.forEach(preview => {
        preview.src = '#';
        preview.style.display = 'none';
    });

    placeholders.forEach(placeholder => {
        placeholder.style.display = 'flex';
    });
}

// دالة التقاط الموقع الحالي
function captureCurrentLocation() {
    showLoading();
    
    if (!navigator.geolocation) {
        showToast('خدمة تحديد الموقع غير متوفرة في متصفحك', 'error');
        hideLoading();
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        (position) => {
            document.getElementById('driverLatitude').value = position.coords.latitude;
            document.getElementById('driverLongitude').value = position.coords.longitude;
            hideLoading();
            showToast('تم تحديد الموقع بنجاح', 'success');
        },
        (error) => {
            hideLoading();
            let errorMessage;
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'تم رفض الوصول إلى خدمة تحديد الموقع';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = 'معلومات الموقع غير متوفرة';
                    break;
                case error.TIMEOUT:
                    errorMessage = 'انتهت مهلة طلب تحديد الموقع';
                    break;
                default:
                    errorMessage = 'حدث خطأ غير معروف';
            }
            showToast(errorMessage, 'error');
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

// تهيئة كل عناصر الصفحة عند تحميلها
document.addEventListener('DOMContentLoaded', function() {
    // تهيئة قوائم المحافظات
    initializeProvinceDropdown();
    
    // تحميل السائقين
    loadDrivers();
    
    // تهيئة النماذج
    initializeForms();
    
    // مراقبة حالة المستخدم
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            loadUserData(user);
        } else {
            resetUserInterface();
        }
    });
});

// تهيئة النماذج
function initializeForms() {
    // إضافة مستمعات الأحداث للنماذج
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
    }
    
    const userRegistrationForm = document.getElementById('userRegistrationForm');
    if (userRegistrationForm) {
        userRegistrationForm.addEventListener('submit', handleUserRegistration);
    }
    
    const addDriverForm = document.getElementById('addDriverForm');
    if (addDriverForm) {
        addDriverForm.addEventListener('submit', handleAddDriver);
    }
    
    // ملء قوائم المحافظات في النماذج
    populateProvinceSelects();
}

// ملء قوائم المحافظات في النماذج
function populateProvinceSelects() {
    const selects = [
        document.getElementById('userProvince'),
        document.getElementById('driverLocation')
    ];
    
    selects.forEach(select => {
        if (!select) return;
        
        // إضافة المحافظات
        Object.keys(iraqProvinces).forEach(province => {
            const option = document.createElement('option');
            option.value = province;
            option.textContent = province;
            select.appendChild(option);
        });
    });
}