<!DOCTYPE html>
<html dir="rtl" lang="ar">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="تطبيق تاكسي العراق - خدمة حجز سيارات الأجرة الأفضل في العراق">
    <meta name="keywords" content="تاكسي العراق, سيارات أجرة, حجز تاكسي, نقل, مواصلات">
    <meta name="author" content="تاكسي العراق">
    <meta name="theme-color" content="#FFD700">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>تاكسي العراق - خدمة حجز السيارات الأولى في العراق</title>

    <!-- App Icons -->

    <!-- قبل إغلاق وسم head -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/react-leaflet@4.2.1/dist/react-leaflet.min.js"></script>
    <link rel="icon" type="image/png"
        href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527">
    <link rel="apple-touch-icon" sizes="180x180"
        href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527">
    <link rel="apple-touch-startup-image"
        href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527">

    <!-- Web App Manifest -->
    <link rel="manifest" href="./manifest.json">

    <!-- External CSS Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">

    <!-- App CSS -->
    <link rel="stylesheet" href="./style.css">

    <!-- Meta Tags -->
    <meta property="og:title" content="تاكسي العراق">
    <meta property="og:description" content="خدمة حجز سيارات الأجرة الأفضل في العراق">
    <meta property="og:image"
        content="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527">
    <meta property="og:url" content="https://taxi-iraq.com">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="تاكسي العراق">
    <meta name="twitter:description" content="خدمة حجز سيارات الأجرة الأفضل في العراق">
    <meta name="twitter:image"
        content="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527">
<!-- إضافة قبل نهاية وسم head -->
<script src="favorite-drivers.js"></script>
<script>
    // إضافة أنماط CSS للستايل الخاص بالمفضلة
    function addFavoriteStyles() {
        const styleElement = document.createElement('style');
        styleElement.textContent = `
        /* أنماط زر المفضلة في بطاقة السائق */
        .favorite-btn {
            position: absolute;
            top: 10px;
            left: 45px;
            background-color: rgba(255, 215, 0, 0.2);
            color: #FFD700;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .favorite-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }

        .favorite-btn.is-favorite {
            background-color: #FFD700;
            color: #000000;
        }

        /* شارة عدد السائقين المفضلين */
        #favoriteDriversBadge {
            position: absolute;
            right: 10px;
            background-color: #FFD700;
            color: #000000;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }

        /* أنماط النافذة المنبثقة للسائقين المفضلين */
        .favorite-drivers-container {
            max-height: 70vh;
            overflow-y: auto;
            padding: 10px;
        }

        .favorite-drivers-container::-webkit-scrollbar {
            width: 8px;
        }

        .favorite-drivers-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .favorite-drivers-container::-webkit-scrollbar-thumb {
            background: #FFD700;
            border-radius: 4px;
        }

        .favorite-driver-card {
            background-color: #242424;
            border-radius: 15px;
            margin-bottom: 15px;
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 215, 0, 0.1);
        }

        .favorite-driver-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.3);
        }

        .remove-favorite-btn {
            background: rgba(255, 59, 48, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-favorite-btn:hover {
            background: rgba(255, 59, 48, 1);
            transform: rotate(90deg);
        }

        /* زر المفضلة في النافذة المنبثقة */
        .popup-favorite-btn {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            border: 1px dashed #FFD700;
            background-color: transparent;
            color: #FFD700;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.3s ease;
        }

        .popup-favorite-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .popup-favorite-btn[data-is-favorite="true"] {
            background-color: #FFD700;
            color: #000000;
        }

        /* تأثير تمييز عند إضافة أو إزالة من المفضلة */
        @keyframes highlight {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            }
            100% {
                transform: scale(1);
            }
        }

        .favorite-highlight {
            animation: highlight 0.5s ease;
        }
        `;
        document.head.appendChild(styleElement);
    }

    // إضافة رابط السائقين المفضلين في الشريط الجانبي
    function addFavoriteDriversLink() {
        const sideNavItems = document.querySelector('.side-nav-items');
        
        if (sideNavItems) {
            // التحقق مما إذا كان الرابط موجود بالفعل
            if (document.getElementById('favoriteDriversLink')) return;
            
            // إنشاء رابط السائقين المفضلين
            const favoritesLink = document.createElement('a');
            favoritesLink.id = 'favoriteDriversLink';
            favoritesLink.href = 'javascript:void(0)';
            favoritesLink.className = 'side-nav-item';
            favoritesLink.innerHTML = `
                <i class="fas fa-star"></i> السائقين المفضلين
                <span id="favoriteDriversBadge" class="badge" 
                      style="position: absolute; right: 10px; background-color: #FFD700; 
                             color: #000000; border-radius: 50%; width: 20px; height: 20px; 
                             display: none; align-items: center; justify-content: center; 
                             font-size: 0.8rem;">0</span>
            `;
            
            // إضافة معالج الحدث
            favoritesLink.addEventListener('click', function() {
                if (window.favoriteDriversManager) {
                    window.favoriteDriversManager.showFavoriteDriversModal();
                }
                
                // إغلاق الشريط الجانبي إذا كان مفتوحاً
                const sideNav = document.getElementById('sideNav');
                const navBackdrop = document.getElementById('navBackdrop');
                if (sideNav && sideNav.classList.contains('open')) {
                    sideNav.classList.remove('open');
                    if (navBackdrop) navBackdrop.classList.remove('show');
                }
            });
            
            // إدراج الرابط بعد رابط "السائقين"
            const driversLink = Array.from(sideNavItems.querySelectorAll('.side-nav-item')).find(link => 
                link.textContent.trim().includes('السائقين')
            );
            
            if (driversLink) {
                sideNavItems.insertBefore(favoritesLink, driversLink.nextSibling);
            } else {
                // إذا لم يتم العثور على رابط "السائقين"، أضف في البداية
                sideNavItems.insertBefore(favoritesLink, sideNavItems.firstChild);
            }
        }
    }

    // تهيئة ميزة السائقين المفضلين
    document.addEventListener('DOMContentLoaded', function() {
        // إضافة الأنماط
        addFavoriteStyles();
        
        // انتظار تحميل واجهة المستخدم
        setTimeout(function() {
            // إضافة رابط السائقين المفضلين
            addFavoriteDriversLink();
            
            // تحديث شارة عدد السائقين المفضلين
            if (window.favoriteDriversManager) {
                window.favoriteDriversManager.updateFavoriteDriversBadge();
            }
        }, 1000);
    });
// دالة إعادة تعيين واجهة المستخدم
function resetUserInterface() {
    // إعادة زر الملف الشخصي إلى حالته الأصلية
    const profileBtn = document.querySelector('.user-profile-btn');
    if (profileBtn) {
        profileBtn.innerHTML = `
            <i class="fas fa-user-circle me-2" id="defaultProfileIcon"></i>
            <span class="ms-1 d-none d-md-inline" id="profileText">تسجيل الدخول</span>
        `;
        
        // إعادة تعيين خصائص الزر ليفتح نافذة تسجيل الدخول
        profileBtn.setAttribute('data-bs-toggle', 'modal');
        profileBtn.setAttribute('data-bs-target', '#profileModal');
        profileBtn.removeAttribute('onclick');
        
        // إخفاء صورة الملف الشخصي وإظهار الأيقونة الافتراضية
        const userProfileImage = document.getElementById('userProfileImage');
        if (userProfileImage) {
            userProfileImage.style.display = 'none';
        }
        const defaultProfileIcon = document.getElementById('defaultProfileIcon');
        if (defaultProfileIcon) {
            defaultProfileIcon.style.display = 'inline-block';
        }
    }
    
    // إعادة تعيين معلومات المستخدم في الشريط الجانبي
    const sideNavUserInfo = document.querySelector('.side-nav-user-info');
    if (sideNavUserInfo) {
        sideNavUserInfo.innerHTML = `
            <div class="text-center">
                <i class="fas fa-user-circle text-white" style="font-size: 4rem;"></i>
                <h6 class="text-white mt-3">مرحباً بك</h6>
                <p class="text-white-50 small">قم بتسجيل الدخول للوصول إلى حسابك</p>
                <div class="mt-3">
                    <button class="btn btn-gold w-100 mb-2" data-bs-toggle="modal" data-bs-target="#loginModal">
                        تسجيل الدخول
                    </button>
                    <button class="btn btn-outline-light w-100 mb-2" data-bs-toggle="modal" data-bs-target="#userRegistrationModal">
                        إنشاء حساب
                    </button>
                    <button class="btn btn-outline-light w-100" data-bs-toggle="modal" data-bs-target="#addDriverModal">
                        إضافة سائق
                    </button>
                </div>
            </div>
        `;
    }
    
    // إخفاء عناصر واجهة خاصة بالسائقين
    const driverOnlyElements = document.querySelectorAll('.driver-only');
    driverOnlyElements.forEach(element => {
        element.style.display = 'none';
    });
    
    // إخفاء زر تسجيل الخروج
    const logoutBtn = document.querySelector('.logout-btn');
    if (logoutBtn) {
        logoutBtn.style.display = 'none';
    }
    
    // إعادة تعيين شارات الإشعارات والرسائل
    const notificationBadge = document.querySelector('.notification-badge');
    const messageBadge = document.querySelector('.message-badge');
    if (notificationBadge) notificationBadge.style.display = 'none';
    if (messageBadge) messageBadge.style.display = 'none';
    
    // حذف أي تخزين محلي متعلق بالمستخدم
    localStorage.removeItem('currentUser');
    
    console.log('تم إعادة تعيين واجهة المستخدم بنجاح');
}

// دالة تحديث واجهة المستخدم بعد تسجيل الدخول
function updateUIAfterLogin(userData) {
    // تحديد نوع المستخدم ليظهر في الواجهة
    const userRole = userData.userType === 'driver' ? 'سائق' : 'مستخدم';
    
    // تحديث زر الملف الشخصي في الشريط العلوي
    const profileBtn = document.querySelector('.user-profile-btn');
    if (profileBtn) {
        // استخدام الصورة الشخصية من البيانات
        const userPhoto = userData.photoUrl || userData.imageUrl || 'default-avatar.png';
        const userName = userData.fullName || userData.name || 'المستخدم';
        
        // إزالة خصائص النافذة المنبثقة
        profileBtn.removeAttribute('data-bs-toggle');
        profileBtn.removeAttribute('data-bs-target');
        
        // إضافة معالج النقر لعرض قائمة المستخدم
        profileBtn.setAttribute('onclick', 'showUserMenu(event)');
        
        // تحديث صورة الملف الشخصي
        const userProfileImage = document.getElementById('userProfileImage');
        const defaultProfileIcon = document.getElementById('defaultProfileIcon');
        if (userProfileImage && defaultProfileIcon) {
            userProfileImage.src = userPhoto;
            userProfileImage.style.display = 'inline-block';
            defaultProfileIcon.style.display = 'none';
        }
        
        // تحديث نص الملف الشخصي
        const profileText = document.getElementById('profileText');
        if (profileText) {
            profileText.textContent = userName;
        }
    }

    // تحديث معلومات المستخدم في الشريط الجانبي
    const sideNavUserInfo = document.querySelector('.side-nav-user-info');
    if (sideNavUserInfo) {
        // استخدام الصورة الشخصية من البيانات
        const userPhoto = userData.photoUrl || userData.imageUrl || 'default-avatar.png';
        const userName = userData.fullName || userData.name || 'المستخدم';
        
        sideNavUserInfo.innerHTML = `
            <div class="text-center">
                <img src="${userPhoto}" 
                     alt="${userName}" 
                     class="rounded-circle mb-3"
                     style="width: 80px; height: 80px; object-fit: cover; border: 3px solid #FFD700;">
                <h6 class="text-white mb-1">${userName}</h6>
                <span class="badge bg-gold mb-2">${userRole}</span>
                <p class="text-white-50 small mb-3">${userData.email || ''}</p>
            </div>
        `;
    }
    
    // إظهار أو إخفاء عناصر واجهة خاصة بالسائقين إذا كان المستخدم سائق
    const driverOnlyElements = document.querySelectorAll('.driver-only');
    driverOnlyElements.forEach(element => {
        element.style.display = userData.userType === 'driver' ? 'block' : 'none';
    });
    
    // إظهار زر تسجيل الخروج
    const logoutBtn = document.querySelector('.logout-btn');
    if (logoutBtn) {
        logoutBtn.style.display = 'flex';
    }
    
    console.log('تم تحديث واجهة المستخدم بنجاح بعد تسجيل الدخول');
}

// دالة عرض قائمة المستخدم
function showUserMenu(event) {
    event.preventDefault();
    const userData = JSON.parse(localStorage.getItem('currentUser'));
    
    if (!userData) {
        console.error('User data not found.');
        return;
    }
    
    Swal.fire({
        title: `مرحباً ${userData.fullName || userData.name || 'المستخدم'}`,
        html: `
            <div class="text-center mb-3">
                <img src="${userData.photoUrl || userData.photoURL || 'default-avatar.png'}" 
                     alt="صورة المستخدم" 
                     class="rounded-circle mb-3"
                     style="width: 100px; height: 100px; object-fit: cover;">
                <p class="mb-2">${userData.email || ''}</p>
                <p class="text-muted">${userData.phone || ''}</p>
            </div>
        `,
        showCancelButton: true,
        showDenyButton: true,
        confirmButtonText: 'الملف الشخصي',
        denyButtonText: 'تسجيل الخروج',
        cancelButtonText: 'إغلاق',
        confirmButtonColor: '#FFD700',
        denyButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d'
    }).then((result) => {
        if (result.isConfirmed) {
            // نقل المستخدم إلى صفحة الملف الشخصي
            // window.location.href = 'profile.html';
            showToast('سيتم إضافة صفحة الملف الشخصي قريباً', 'info');
        } else if (result.isDenied) {
            handleLogout();
        }
    });
}

<!-- كود الـ Backdrop للشريط الجانبي -->
<div class="nav-backdrop" id="navBackdrop" onclick="toggleSideNav()"></div>
</script>
<!-- في حالة عدم وجود مكتبة Sweetalert2، قم بإضافة هذا الكود -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>


<!-- Content will be here -->

<!-- External Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://unpkg.com/babel-standalone/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
<!-- Primero jQuery (si es necesario para tu versión de Bootstrap) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Luego Bootstrap Bundle (incluye Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Finalmente tus scripts personalizados -->
<script src="modal.js"></script>

<!-- App Scripts -->

<!-- إضافة المزيد من الأصوات -->
<audio id="notificationSound" src="notification-sound.mp3" preload="auto"></audio>
<audio id="messageSound" src="message-sound.mp3" preload="auto"></audio>

<!-- إضافة الملفات الجديدة -->
<audio id="notificationSound" src="https://github.com/AlQasimMall/taxialpasha/raw/main/%D8%A7%D9%84%D9%87%D8%A7%D8%AA%D9%81-%D8%A7%D9%84%D8%AB%D8%A7%D8%A8%D8%AA.mp3" preload="auto"></audio>
<script type="module" src="user-auth-notifications.js"></script>
<script type="module" src="notifications-manager.js"></script>
<script src="firebase-config.js"></script>
<!-- قبل إغلاق body -->
<script src="nearby-drivers-map.js"></script>



<!-- Application CSS -->
<style>
 
</style>
</head>

<body>
<!-- تصميم محسن لشريط العنوان -->
<nav class="navbar app-header fixed-top">
    <div class="container-fluid">
        <div class="header-content"></div>
            <!-- زر فتح الشريط الجانبي -->
            <button class="nav-toggle" onclick="toggleSideNav()">
                <i class="fas fa-bars" style="color: #FFD700;"></i>
            </button>
            
            <!-- Logo and App Name -->
            <a class="app-logo d-flex align-items-center" href="map.html">
                <i class="fas fa-taxi me-2" style="color: #FFD700;"></i>
                <span style="font-size: 0.8rem;">Iraq Taxi</span>
            </a>
            <!-- Tools: Search, Notifications, Messages, Profile -->
            <div class="tools d-flex align-items-center">
                <!-- Search Icon -->
                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#searchModal">
                    <i class="fas fa-search" style="color: #FFD700;"></i>
                </a>
                
                <!-- Notifications Icon -->
                <a class="nav-link position-relative" href="#" data-bs-toggle="modal" data-bs-target="#notificationsModal" id="notificationsBtn">
                    <i class="fas fa-bell" style="color: #FFD700;"></i>
                    <span class="notification-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">0</span>
                </a>
                
                <!-- Messages Icon -->
                <a class="nav-link position-relative" href="#" data-bs-toggle="modal" data-bs-target="#messagesModal">
                    <i class="fas fa-envelope" style="color: #FFD700;"></i>
                    <span class="message-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">0</span>
                </a>
                
                <!-- Profile/Account Icon -->
                <a class="nav-link user-profile-btn" href="#" data-bs-toggle="modal" data-bs-target="#profileModal">
                    <img id="userProfileImage" src="default-profile.png" alt="Profile" class="rounded-circle" style="width: 35px; height: 35px; object-fit: cover; display: none;">
                    <i class="fas fa-user-circle" id="defaultProfileIcon" style="color: #FFD700;"></i>
                    <span class="ms-1 d-none d-md-inline" id="profileText">تسجيل الدخول</span>
                </a>
            </div>
        </div>
    </div>
</nav>

<!-- تحديث الشريط الجانبي ليشمل قسم معلومات المستخدم -->
<div class="side-nav" id="sideNav">
    <div class="side-nav-header">
        <h2 class="side-nav-title">تاكسي العراق</h2>
        <button class="side-nav-close" onclick="toggleSideNav()">×</button>
    </div>
    
    <!-- إضافة قسم معلومات المستخدم -->
    <div class="side-nav-user-info">
        <div class="text-center">
            <i class="fas fa-user-circle text-white" style="font-size: 4rem;"></i>
            <h6 class="text-white mt-3">مرحباً بك</h6>
            <p class="text-white-50 small">قم بتسجيل الدخول للوصول إلى حسابك</p>
            <div class="mt-3">
                <button class="btn btn-gold w-100 mb-2" data-bs-toggle="modal" data-bs-target="#loginModal">
                    تسجيل الدخول
                </button>
                <button class="btn btn-outline-light w-100 mb-2" data-bs-toggle="modal" data-bs-target="#userRegistrationModal">
                    إنشاء حساب
                </button>
                <button class="btn btn-outline-light w-100" data-bs-toggle="modal" data-bs-target="#addDriverModal">
                    إضافة سائق
                </button>
            </div>
        </div>
    </div>
    
    <div class="side-nav-items">
        <a href="/" class="side-nav-item"><i class="fas fa-home" style="color: #FFD700;"></i> الرئيسية</a>
        <a href="drivers.html" class="side-nav-item"><i class="fas fa-users" style="color: #4CAF50;"></i> السائقين</a>
        <a href="trip1s.html" class="side-nav-item"><i class="fas fa-car" style="color: #2196F3;"></i> الرحلات</a>
        <a href="map.html" class="side-nav-item"><i class="fas fa-map" style="color: #FF5722;"></i> الخريطة</a>
        <a href="notifications.html" class="side-nav-item"><i class="fas fa-bell" style="color: #9C27B0;"></i> الإشعارات</a>
        <a href="messages.html" class="side-nav-item"><i class="fas fa-envelope" style="color: #FFC107;"></i> الرسائل</a>
        <a href="settings.html" class="side-nav-item"><i class="fas fa-cog" style="color: #607D8B;"></i> الإعدادات</a>
        <a href="#" class="side-nav-item driver-only" style="display: none;"><i class="fas fa-user-plus" style="color: #E91E63;"></i> إضافة سائق</a>
    </div>
    <!-- إضافة زر تسجيل الخروج في الشريط الجانبي -->
    <div class="side-nav-footer">
        <button onclick="handleLogout()" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
        </button>
    </div>
</div>
    </div>
        <!-- شريط الأدوات السفلي -->
        <div class="bottom-nav">
            <a href="/" class="bottom-nav-item">
                <i class="fas fa-home"></i>
                <span>الرئيسية</span>
            </a>
            <a href="/explore" class="bottom-nav-item">
                <i class="fas fa-compass"></i>
                <span>استكشاف</span>
            </a>
            <a href="/favorites" class="bottom-nav-item">
                <i class="fas fa-star"></i>
                <span>المفضلة</span>
            </a>
            <a href="/trips" class="bottom-nav-item">
                <i class="fas fa-car"></i>
                <span>الرحلات</span>
            </a>
        </div>
        <!-- كود الـ Backdrop للشريط الجانبي -->
        <div class="nav-backdrop" id="navBackdrop" onclick="toggleSideNav()"></div>
    </nav>

    <script>
        function updateProfileIcon(user) {
            const profileImage = document.getElementById('userProfileImage');
            const defaultIcon = document.getElementById('defaultProfileIcon');
            const profileText = document.getElementById('profileText');

            if (user && user.photoURL) {
                profileImage.src = user.photoURL;
                profileImage.style.display = 'block';
                defaultIcon.style.display = 'none';
                profileText.style.display = 'none';
            } else {
                profileImage.style.display = 'none';
                defaultIcon.style.display = 'block';
                profileText.style.display = 'block';
            }
        }

        // Example usage after user login
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                updateProfileIcon(user);
            }
        });
        function updateProfileIcon(user) {
            const profileImage = document.getElementById('userProfileImage');
            const defaultIcon = document.getElementById('defaultProfileIcon');
            const profileText = document.getElementById('profileText');

            if (user && user.photoURL) {
                profileImage.src = user.photoURL;
                profileImage.style.display = 'block';
                defaultIcon.style.display = 'none';
                profileText.style.display = 'none';
            } else {
                profileImage.style.display = 'none';
                defaultIcon.style.display = 'block';
                profileText.style.display = 'block';
            }
        }

        // Example usage after user login
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                updateProfileIcon(user);
            }
        });
        function updateProfileIcon(user) {
            const profileImage = document.getElementById('userProfileImage');
            const defaultIcon = document.getElementById('defaultProfileIcon');
            const profileText = document.getElementById('profileText');

            if (user && user.photoURL) {
                profileImage.src = user.photoURL;
                profileImage.style.display = 'block';
                defaultIcon.style.display = 'none';
                profileText.style.display = 'none';
            } else {
                profileImage.style.display = 'none';
                defaultIcon.style.display = 'block';
                profileText.style.display = 'block';
            }
        }

        // Example usage after user login
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                updateProfileIcon(user);
            }
        });
        const messagesButton = document.getElementById('messagesButton');
        const messagesContainer = document.getElementById('messagesContainer');
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendMessageButton = document.getElementById('sendMessageButton');
        const unreadMessagesBadge = document.getElementById('unreadMessagesBadge');

        // Load messages when the modal is shown
        messagesButton.addEventListener('click', function () {
            // Load messages from the server or database
            fetchMessages();
        });

        // Open chat modal when a message is clicked
        messagesContainer.addEventListener('click', function (event) {
            if (event.target.classList.contains('message-item')) {
                const messageId = event.target.dataset.messageId;
                openChat(messageId);
            }
        });

        // Send message
        sendMessageButton.addEventListener('click', function () {
            const message = messageInput.value;
            if (message.trim() !== '') {
                // Send the message to the server or database
                sendMessage(message);
                messageInput.value = ''; // Clear the input
            }
        });

        // Example functions to load messages and send messages
        function fetchMessages() {
            // Fetch messages from the server or database
            // Example:
            // fetch('/api/messages')
            //     .then(response => response.json())
            //     .then(messages => {
            //         messagesContainer.innerHTML = messages.map(msg => `
            //             <div class="message-item" data-message-id="${msg.id}">
            //                 <img src="${msg.senderImage}" alt="${msg.senderName}" class="sender-image">
            //                 <span>${msg.senderName}</span>
            //                 <span class="message-preview">${msg.preview}</span>
            //                 ${msg.unread ? '<span class="badge bg-danger">جديد</span>' : ''}
            //             </div>
            //         `).join('');
            //         updateUnreadMessagesBadge(messages.filter(msg => msg.unread).length);
            //     });
        }

        function openChat(messageId) {
            // Load chat messages from the server or database
            // Example:
            // fetch(`/api/messages/${messageId}`)
            //     .then(response => response.json())
            //     .then(messages => {
            //         chatContainer.innerHTML = messages.map(msg => `
            //             <div class="message-bubble ${msg.sender === 'user' ? 'sent' : 'received'}">
            //                 ${msg.text}
            //                 <div class="timestamp">${msg.timestamp}</div>
            //             </div>
            //         `).join('');
            //         const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
            //         chatModal.show();
            //     });
        }

        function sendMessage(message) {
            // Send the message to the server or database
            // Example:
            // fetch('/api/messages', {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json'
            //     },
            //     body: JSON.stringify({ message })
            // });
        }

        function updateUnreadMessagesBadge(count) {
            if (count > 0) {
                unreadMessagesBadge.textContent = count;
                unreadMessagesBadge.style.display = 'block';
            } else {
                unreadMessagesBadge.style.display = 'none';
            }
        }

        // Example function to check for new messages periodically
        function checkForNewMessages() {
            // Example:
            // setInterval(() => {
            //     fetch('/api/messages/unread-count')
            //         .then(response => response.json())
            //         .then(count => {
            //             updateUnreadMessagesBadge(count);
            //         });
            // }, 60000); // Check every minute
        }

        // Start checking for new messages
        checkForNewMessages();
    </script>

    </nav>

    </a>
    </div>
    </div>
    </nav>

    </a>
    </li>
    </ul>
    </div>
    </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Map View -->
        <div id="map"></div>

        <!-- Location Filter -->
        <div class="location-filter">
            <div class="location-chips" id="locationFilter">
                <span class="location-chip active" data-location="all">
                    <i class="fas fa-globe"></i>
                    الكل
                </span>
                <span class="location-chip" data-location="بغداد">
                    <i class="fas fa-map-marker-alt"></i>
                    بغداد
                </span>
                <span class="location-chip" data-location="الكرخ">
                    <i class="fas fa-map-marker-alt"></i>
                    الكرخ
                </span>
                <span class="location-chip" data-location="الرصافة">
                    <i class="fas fa-map-marker-alt"></i>
                    الرصافة
                </span>
                <span class="location-chip" data-location="البصرة">
                    <i class="fas fa-map-marker-alt"></i>
                    البصرة
                </span>
                <span class="location-chip" data-location="نينوى">
                    <i class="fas fa-map-marker-alt"></i>
                    نينوى
                </span>
                <span class="location-chip" data-location="الموصل">
                    <i class="fas fa-map-marker-alt"></i>
                    الموصل
                </span>
                <span class="location-chip" data-location="النجف">
                    <i class="fas fa-map-marker-alt"></i>
                    النجف
                </span>
                <span class="location-chip" data-location="الكوفة">
                    <i class="fas fa-map-marker-alt"></i>
                    الكوفة
                </span>
                <span class="location-chip" data-location="كربلاء">
                    <i class="fas fa-map-marker-alt"></i>
                    كربلاء
                </span>
                <span class="location-chip" data-location="الحسينية">
                    <i class="fas fa-map-marker-alt"></i>
                    الحسينية
                </span>
                <span class="location-chip" data-location="أربيل">
                    <i class="fas fa-map-marker-alt"></i>
                    أربيل
                </span>
                <span class="location-chip" data-location="كركوك">
                    <i class="fas fa-map-marker-alt"></i>
                    كركوك
                </span>
                <span class="location-chip" data-location="الأنبار">
                    <i class="fas fa-map-marker-alt"></i>
                    الأنبار
                </span>
                <span class="location-chip" data-location="الرمادي">
                    <i class="fas fa-map-marker-alt"></i>
                    الرمادي
                </span>
                <span class="location-chip" data-location="الفلوجة">
                    <i class="fas fa-map-marker-alt"></i>
                    الفلوجة
                </span>
                <span class="location-chip" data-location="بابل">
                    <i class="fas fa-map-marker-alt"></i>
                    بابل
                </span>
                <span class="location-chip" data-location="الحلة">
                    <i class="fas fa-map-marker-alt"></i>
                    الحلة
                </span>
                <span class="location-chip" data-location="المسيب">
                    <i class="fas fa-map-marker-alt"></i>
                    المسيب
                </span>
                <span class="location-chip" data-location="الهاشمية">
                    <i class="fas fa-map-marker-alt"></i>
                    الهاشمية
                </span>
                <span class="location-chip" data-location="القاسم">
                    <i class="fas fa-map-marker-alt"></i>
                    القاسم
                </span>
                <span class="location-chip" data-location="ديالى">
                    <i class="fas fa-map-marker-alt"></i>
                    ديالى
                </span>
                <span class="location-chip" data-location="بعقوبة">
                    <i class="fas fa-map-marker-alt"></i>
                    بعقوبة
                </span>
                <span class="location-chip" data-location="ذي قار">
                    <i class="fas fa-map-marker-alt"></i>
                    ذي قار
                </span>
                <span class="location-chip" data-location="الناصرية">
                    <i class="fas fa-map-marker-alt"></i>
                    الناصرية
                </span>
                <span class="location-chip" data-location="السليمانية">
                    <i class="fas fa-map-marker-alt"></i>
                    السليمانية
                </span>
                <span class="location-chip" data-location="صلاح الدين">
                    <i class="fas fa-map-marker-alt"></i>
                    صلاح الدين
                </span>
                <span class="location-chip" data-location="تكريت">
                    <i class="fas fa-map-marker-alt"></i>
                    تكريت
                </span>
                <span class="location-chip" data-location="واسط">
                    <i class="fas fa-map-marker-alt"></i>
                    واسط
                </span>
                <span class="location-chip" data-location="الكوت">
                    <i class="fas fa-map-marker-alt"></i>
                    الكوت
                </span>
                <span class="location-chip" data-location="ميسان">
                    <i class="fas fa-map-marker-alt"></i>
                    ميسان
                </span>
                <span class="location-chip" data-location="العمارة">
                    <i class="fas fa-map-marker-alt"></i>
                    العمارة
                </span>
                <span class="location-chip" data-location="المثنى">
                    <i class="fas fa-map-marker-alt"></i>
                    المثنى
                </span>
                <span class="location-chip" data-location="السماوة">
                    <i class="fas fa-map-marker-alt"></i>
                    السماوة
                </span>
                <span class="location-chip" data-location="دهوك">
                    <i class="fas fa-map-marker-alt"></i>
                    دهوك
                </span>
                <span class="location-chip" data-location="القادسية">
                    <i class="fas fa-map-marker-alt"></i>
                    القادسية
                </span>
                <span class="location-chip" data-location="الديوانية">
                    <i class="fas fa-map-marker-alt"></i>
                    الديوانية
                </span>

            </div>

        </div>

        <!-- Drivers Grid -->
        <div class="drivers-grid" id="driversGrid"></div>
    </div>



    <!-- Add Driver زر اضافة السائقين من قبل الادمنModal -->
    <div class="modal fade" id="addDriverModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة سائق جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">

                    <form id="addDriverForm" onsubmit="handleAddDriver(event)">
                        <div class="mb-4 text-center">
                            <div class="image-upload-container"
                                onclick="document.getElementById('driverImage').click()">
                                <input type="file" id="driverImage" accept="image/*" style="display: none"
                                    onchange="handleImagePreview(event)">
                                <img id="imagePreview" src="#" alt=""
                                    style="display: none; width: 100%; height: 100%; object-fit: cover;">
                                <div class="upload-placeholder">
                                    <i class="fas fa-camera fa-2x mb-2"></i>
                                    <p>انقر لإضافة صورة</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="location-capture-section">
                                <label class="form-label">موقع السائق</label>
                                <div class="d-flex gap-2 mb-2">
                                    <input type="text" class="form-control" id="driverLatitude" placeholder="خط العرض"
                                        readonly>
                                    <input type="text" class="form-control" id="driverLongitude" placeholder="خط الطول"
                                        readonly>
                                </div>
                                <button type="button" class="btn btn-primary w-100" onclick="captureCurrentLocation()">
                                    <i class="fas fa-location-arrow me-2"></i>
                                    تحديد الموقع الحالي
                                </button>
                            </div>
                        </div>
                        <div class="registration-section mb-4">
                            <h6 class="section-title">المستمسكات الرسمية</h6>

                            <!-- هوية الأحوال المدنية -->
                            <div class="row g-3 mb-4">
                                <div class="col-12">
                                    <label class="form-label">هوية الأحوال المدنية</label>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('idCardFront').click()">
                                        <input type="file" id="idCardFront" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'idCardFrontPreview')" required>
                                        <img id="idCardFrontPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <p>صورة الهوية (الأمامية)</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('idCardBack').click()">
                                        <input type="file" id="idCardBack" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'idCardBackPreview')" required>
                                        <img id="idCardBackPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <p>صورة الهوية (الخلفية)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- بطاقة السكن -->
                            <div class="row g-3 mb-4">
                                <div class="col-12">
                                    <label class="form-label">بطاقة السكن</label>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('residenceFront').click()">
                                        <input type="file" id="residenceFront" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'residenceFrontPreview')" required>
                                        <img id="residenceFrontPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-home"></i>
                                            <p>بطاقة السكن (الأمامية)</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('residenceBack').click()">
                                        <input type="file" id="residenceBack" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'residenceBackPreview')" required>
                                        <img id="residenceBackPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-home"></i>
                                            <p>بطاقة السكن (الخلفية)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- إجازة السوق -->
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">إجازة السوق</label>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('licenseFront').click()">
                                        <input type="file" id="licenseFront" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'licenseFrontPreview')" required>
                                        <img id="licenseFrontPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <p>إجازة السوق (الأمامية)</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('licenseBack').click()">
                                        <input type="file" id="licenseBack" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'licenseBackPreview')" required>
                                        <img id="licenseBackPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <p>إجازة السوق (الخلفية)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- New Fields for Email and Password -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">البريد الإلكتروني</label>
                                <input type="email" class="form-control" id="driverEmail" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">الرمز السري</label>
                                <input type="password" class="form-control" id="driverPassword" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">إعادة كتابة الرمز السري</label>
                                <input type="password" class="form-control" id="confirmDriverPassword" required>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">اسم السائق</label>
                                    <input type="text" class="form-control" id="driverName" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">رقم الهاتف</label>
                                    <input type="tel" class="form-control" id="driverPhone" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">نوع السيارة</label>
                                    <input type="text" class="form-control" id="carType" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">موديل السيارة</label>
                                    <input type="number" class="form-control" id="carModel" required>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">المنطقة</label>
                                    <select class="form-control" id="driverLocation" onchange="loadAreas(this.value)" required>
                                        <option value="">اختر المحافظة</option>
                                        <option value="بغداد">بغداد</option>
                                        <option value="الكرخ">الكرخ</option>
                                        <option value="الرصافة">الرصافة</option>
                                        <option value="البصرة">البصرة</option>
                                        <option value="نينوى">نينوى</option>
                                        <option value="الموصل">الموصل</option>
                                        <option value="النجف">النجف</option>
                                        <option value="الكوفة">الكوفة</option>
                                        <option value="كربلاء">كربلاء</option>
                                        <option value="الحسينية">الحسينية</option>
                                        <option value="أربيل">أربيل</option>
                                        <option value="كركوك">كركوك</option>
                                        <option value="الأنبار">الأنبار</option>
                                        <option value="الرمادي">الرمادي</option>
                                        <option value="الفلوجة">الفلوجة</option>
                                        <option value="بابل">بابل</option>
                                        <option value="الحلة">الحلة</option>
                                        <option value="المسيب">المسيب</option>
                                        <option value="الهاشمية">الهاشمية</option>
                                        <option value="القاسم">القاسم</option>
                                        <option value="ديالى">ديالى</option>
                                        <option value="بعقوبة">بعقوبة</option>
                                        <option value="ذي قار">ذي قار</option>
                                        <option value="الناصرية">الناصرية</option>
                                        <option value="السليمانية">السليمانية</option>
                                        <option value="صلاح الدين">صلاح الدين</option>
                                        <option value="تكريت">تكريت</option>
                                        <option value="واسط">واسط</option>
                                        <option value="الكوت">الكوت</option>
                                        <option value="ميسان">ميسان</option>
                                        <option value="العمارة">العمارة</option>
                                        <option value="المثنى">المثنى</option>
                                        <option value="السماوة">السماوة</option>
                                        <option value="دهوك">دهوك</option>
                                        <option value="القادسية">القادسية</option>
                                        <option value="الديوانية">الديوانية</option>
                                    </select>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">المنطقة</label>
                                    <select class="form-control" id="driverArea" required>
                                        <option value="">اختر المنطقة</option>
                                    </select>
                                </div>



                                <div class="col-12">
                                    <label class="form-label">معلومات إضافية</label>
                                    <textarea class="form-control" id="driverBio" rows="3"></textarea>
                                </div>
                            </div>

                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary w-100">إضافة السائق</button>
                            </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
    </div>
    <!-- نافذة تعديل بيانات السائق -->
    <div class="modal fade" id="editDriverModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تعديل بيانات السائق</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editDriverForm" onsubmit="handleEditDriver(event)">
                        <input type="hidden" id="editDriverId">

                        <div class="mb-4 text-center">
                            <div class="image-upload-container"
                                onclick="document.getElementById('editDriverImage').click()">
                                <input type="file" id="editDriverImage" accept="image/*" style="display: none"
                                    onchange="handleEditImagePreview(event)">
                                <img id="editImagePreview" src="#" alt=""
                                    style="display: none; width: 100%; height: 200px; object-fit: cover; border-radius: 10px;">
                                <div class="upload-placeholder">
                                    <i class="fas fa-camera fa-2x mb-2"></i>
                                    <p>انقر لتغيير الصورة</p>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">اسم السائق</label>
                                <input type="text" class="form-control" id="editDriverName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">رقم الهاتف</label>
                                <input type="tel" class="form-control" id="editDriverPhone" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">نوع السيارة</label>
                                <input type="text" class="form-control" id="editCarType" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">موديل السيارة</label>
                                <input type="number" class="form-control" id="editCarModel" required>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">المنطقة</label>
                                <select class="form-control" id="editDriverLocation" required>
                                    <option value="">اختر المحافظة</option>
                                    <option value="بغداد">بغداد</option>
                                    <option value="الكرخ">الكرخ</option>
                                    <option value="الرصافة">الرصافة</option>
                                    <option value="البصرة">البصرة</option>
                                    <option value="نينوى">نينوى</option>
                                    <option value="الموصل">الموصل</option>
                                    <option value="النجف">النجف</option>
                                    <option value="الكوفة">الكوفة</option>
                                    <option value="كربلاء">كربلاء</option>
                                    <option value="الحسينية">الحسينية</option>
                                    <option value="أربيل">أربيل</option>
                                    <option value="كركوك">كركوك</option>
                                    <option value="الأنبار">الأنبار</option>
                                    <option value="الرمادي">الرمادي</option>
                                    <option value="الفلوجة">الفلوجة</option>
                                    <option value="بابل">بابل</option>
                                    <option value="الحلة">الحلة</option>
                                    <option value="المسيب">المسيب</option>
                                    <option value="الهاشمية">الهاشمية</option>
                                    <option value="القاسم">القاسم</option>
                                    <option value="ديالى">ديالى</option>
                                    <option value="بعقوبة">بعقوبة</option>
                                    <option value="ذي قار">ذي قار</option>
                                    <option value="الناصرية">الناصرية</option>
                                    <option value="السليمانية">السليمانية</option>
                                    <option value="صلاح الدين">صلاح الدين</option>
                                    <option value="تكريت">تكريت</option>
                                    <option value="واسط">واسط</option>
                                    <option value="الكوت">الكوت</option>
                                    <option value="ميسان">ميسان</option>
                                    <option value="العمارة">العمارة</option>
                                    <option value="المثنى">المثنى</option>
                                    <option value="السماوة">السماوة</option>
                                    <option value="دهوك">دهوك</option>
                                    <option value="القادسية">القادسية</option>
                                    <option value="الديوانية">الديوانية</option>
                                    <!-- إضافة باقي المدن -->
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">معلومات إضافية</label>
                                <textarea class="form-control" id="editDriverBio" rows="3"></textarea>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary w-100">حفظ التغييرات</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="notificationStatus" class="mt-2 small text-muted"></div>
    </div>

    <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="searchModalLabel">بحث عن سائق</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="search-wrapper">
                        <!-- حقل البحث -->
                        <div class="search-input-wrapper mb-3">
                            <div class="input-group">
                                <input type="text" class="form-control search-input" id="navbarSearchInput"
                                    placeholder="ابحث عن اسم السائق، المنطقة، نوع السيارة..." autofocus>
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                            </div>
                        </div>

                        <!-- خيارات البحث -->
                        <div class="search-options mb-3">
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="searchType" id="searchAll" checked>
                                <label class="btn btn-outline-primary" for="searchAll">الكل</label>

                                <input type="radio" class="btn-check" name="searchType" id="searchName">
                                <label class="btn btn-outline-primary" for="searchName">الاسم</label>

                                <input type="radio" class="btn-check" name="searchType" id="searchLocation">
                                <label class="btn btn-outline-primary" for="searchLocation">المنطقة</label>

                                <input type="radio" class="btn-check" name="searchType" id="searchCar">
                                <label class="btn btn-outline-primary" for="searchCar">السيارة</label>
                            </div>
                        </div>

                        <!-- نتائج البحث -->
                        <div id="searchResults" class="search-results"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- نافذة الرسائل المنبثقة -->
    <div class="modal fade" id="messagesModal" tabindex="-1" aria-labelledby="messagesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="messagesModalLabel">الرسائل</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="messagesContainer">
                        <!-- قائمة الرسائل ستظهر هنا -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة المحادثة -->
    <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content chat-window">
                <!-- رأس النافذة مع صورة واسم السائق -->
                <div class="modal-header chat-header">
                    <img id="driverImage"
                        src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527"
                        alt="صورة السائق" class="rounded-circle me-2" style="width: 60px; height: 60px;">
                    <div>
                        <h5 class="modal-title" id="driverName">اسم السائق</h5>
                        <small id="driverCardInfo" style="color: #ffffff;">بطاقة السائق</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>

                </div>
                <!-- اختيار المشوار -->
                <div class="modal-body chat-body">
                    <div id="tripSelection" class="mb-3">
                        <small id="driverCardInfo" style="color: #ffffff;"> عدد الـــمشــوار </small>
                        <input type="number" id="tripCount" class="form-control mb-2" placeholder="أدخل عدد المشاوير"
                            min="1">

                        <small id="driverCardInfo" style="color: #ffffff;"> نوع الواجــــهة</small>

                        <input type="text" id="tripDestination" class="form-control mb-2" placeholder="أدخل الوجهة">

                        <small id="driverCardInfo" style="color: #ffffff;"> نوع الرحـــله</small>
                        <select id="tripType" class="form-control mb-3">
                            <option value="ذهاب">ذهاب</option>
                            <option value="ذهاب وعودة">ذهاب وعودة</option>
                        </select>

                        <button class="btn btn-success w-100" onclick="confirmTrip()">تأكيد المشوار</button>
                    </div>
                    <!-- منطقة الرسائل -->
                    <div id="chatMessages" class="chat-messages d-none"></div>
                </div>
                <!-- شريط الإدخال -->
                <div class="modal-footer chat-footer d-none">
                    <div class="input-group">
                        <input type="text" id="chatInput" class="form-control chat-input"
                            placeholder="اكتب رسالتك هنا...">
                        <button class="btn btn-primary send-btn" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- تعديل نافذة اختيار نوع الحساب -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 text-center">
                    <h5 class="modal-title w-100">اختر العملية</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body py-4">
                    <div class="row g-4">
                        <!-- زر تسجيل الدخول -->
                        <div class="col-12 mb-3">
                            <div class="account-type-card" onclick="openLoginModal()">
                                <div class="icon-container mb-3">
                                    <i class="fas fa-sign-in-alt fa-3x"></i>
                                </div>
                                <h6>تسجيل الدخول</h6>
                                <p class="small text-muted">لديك حساب بالفعل؟ سجل دخولك</p>
                            </div>
                        </div>
                        <!-- زر انشاء حساب -->
                        <div class="col-12">
                            <div class="account-type-card" onclick="openUserRegistration()">
                                <div class="icon-container mb-3">
                                    <i class="fas fa-user fa-3x"></i>
                                </div>
                                <h6>انشاء حساب</h6>
                                <p class="small text-muted">احجز رحلاتك بسهولة</p>
                            </div>
                        </div>
                        <!-- زر إضافة سائق -->
                        <div class="col-12">
                            <div class="account-type-card" onclick="showAddDriverModal()">
                                <div class="icon-container mb-3">
                                    <i class="fas fa-user-plus fa-3x"></i>
                                </div>
                                <h6>إضافة سائق</h6>
                                <p class="small text-muted">أضف سائق جديد إلى النظام</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تسجيل الدخول -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تسجيل الدخول</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm" onsubmit="handleLogin(event)">
                        <div class="mb-3">
                            <label class="form-label">البريد الإلكتروني</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">كلمة المرور</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-sign-in-alt me-2"></i>
                                تسجيل الدخول
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تسجيل السائق -->
    <div class="modal fade" id="driverRegistrationModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="text-center w-100">
                        <img src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527"
                            alt="شعار التطبيق" style="height: 60px;">
                        <h5 class="modal-title mt-2">تسجيل سائق جديد</h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="driverRegistrationForm" class="needs-validation" novalidate>
                        <!-- المعلومات الشخصية -->
                        <div class="registration-section mb-4">
                            <h6 class="section-title">المعلومات الشخصية</h6>
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="text-center mb-3">
                                        <div class="driver-photo-upload"
                                            onclick="document.getElementById('driverPhoto').click()">
                                            <img id="driverPhotoPreview" src="#" alt="">
                                            <div class="upload-placeholder">
                                                <i class="fas fa-camera"></i>
                                                <span>صورة شخصية</span>
                                            </div>
                                        </div>
                                        <input type="file" id="driverPhoto" accept="image/*" style="display: none;"
                                            onchange="previewDriverPhoto(this)">
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">الاسم الثلاثي</label>
                                    <input type="text" class="form-control" name="fullName" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">العمر</label>
                                    <input type="number" class="form-control" name="age" min="18" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">رقم الهاتف</label>
                                    <input type="tel" class="form-control" name="phone" required>
                                </div>
                            </div>
                        </div>

                        <!-- معلومات المركبة -->
                        <div class="registration-section mb-4">
                            <h6 class="section-title">معلومات المركبة</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">نوع المركبة</label>
                                    <select class="form-select" name="vehicleType" required>
                                        <option value="">اختر نوع المركبة</option>
                                        <option value="أجرة">أجرة</option>
                                        <option value="خصوصي">خصوصي</option>
                                        <option value="باص">باص</option>
                                        <option value="صالون">صالون</option>
                                        <option value="تحميل">تحميل</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">موديل المركبة</label>
                                    <input type="number" class="form-control" name="vehicleModel" min="1990" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">رقم المركبة</label>
                                    <input type="text" class="form-control" name="vehicleNumber" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">لون المركبة</label>
                                    <input type="text" class="form-control" name="vehicleColor" required>
                                </div>
                            </div>
                        </div>

                        <!-- المستمسكات -->
                        <div class="registration-section mb-4">
                            <h6 class="section-title">المستمسكات</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">صورة الهوية الوجه الأمامي</label>
                                    <div class="document-upload" onclick="document.getElementById('idFront').click()">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <span>اضغط للرفع</span>
                                        </div>
                                        <img id="idFrontPreview" src="#" alt="">
                                    </div>
                                    <input type="file" id="idFront" accept="image/*" style="display: none;"
                                        onchange="previewDocument(this, 'idFrontPreview')" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">صورة الهوية الوجه الخلفي</label>
                                    <div class="document-upload" onclick="document.getElementById('idBack').click()">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <span>اضغط للرفع</span>
                                        </div>
                                        <img id="idBackPreview" src="#" alt="">
                                    </div>
                                    <input type="file" id="idBack" accept="image/*" style="display: none;"
                                        onchange="previewDocument(this, 'idBackPreview')" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">إجازة السوق الوجه الأمامي</label>
                                    <div class="document-upload"
                                        onclick="document.getElementById('licenseFront').click()">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <span>اضغط للرفع</span>
                                        </div>
                                        <img id="licenseFrontPreview" src="#" alt="">
                                    </div>
                                    <input type="file" id="licenseFront" accept="image/*" style="display: none;"
                                        onchange="previewDocument(this, 'licenseFrontPreview')" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">إجازة السوق الوجه الخلفي</label>
                                    <div class="document-upload"
                                        onclick="document.getElementById('licenseBack').click()">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <span>اضغط للرفع</span>
                                        </div>
                                        <img id="licenseBackPreview" src="#" alt="">
                                    </div>
                                    <input type="file" id="licenseBack" accept="image/*" style="display: none;"
                                        onchange="previewDocument(this, 'licenseBackPreview')" required>
                                </div>
                            </div>
                        </div>

                        <!-- معلومات السكن -->
                        <div class="registration-section mb-4">
                            <h6 class="section-title">معلومات السكن</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">المحافظة</label>
                                    <select class="form-select" name="province" onchange="loadAreas(this.value)"
                                        required>
                                        <option value="">اختر المحافظة</option>
                                        <!-- سيتم ملء الخيارات بواسطة JavaScript -->
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">المنطقة</label>
                                    <select class="form-select" name="area" required>
                                        <option value="">اختر المنطقة</option>
                                        <!-- سيتم ملء الخيارات بواسطة JavaScript -->
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">العنوان التفصيلي</label>
                                    <textarea class="form-control" name="address" rows="2" required></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="fas fa-user-plus me-2"></i>
                                تسجيل
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
  
    <div id="locationOptions">
        <!-- other elements -->
    </div>
    <!-- نافذة تسجيل المستخدم -->
    <div class="modal fade" id="userRegistrationModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="text-center w-100">
                        <img src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527"
                            alt="شعار التطبيق" style="height: 60px;">
                        <h5 class="modal-title mt-2">تسجيل مستخدم جديد</h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userRegistrationForm" class="needs-validation" novalidate>
                        <!-- المعلومات الشخصية -->
                        <div class="registration-section mb-4">
                            <h6 class="section-title">المعلومات الشخصية</h6>
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="text-center mb-3">
                                        <div class="user-photo-upload"
                                            onclick="document.getElementById('userPhoto').click()">
                                            <img id="userPhotoPreview" src="#" alt="">
                                            <div class="upload-placeholder">
                                                <i class="fas fa-camera"></i>
                                                <span>صورة شخصية</span>
                                            </div>
                                        </div>
                                        <input type="file" id="userPhoto" accept="image/*" style="display: none;"
                                            onchange="previewUserPhoto(this)">
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">الاسم الثلاثي</label>
                                    <input type="text" class="form-control" name="fullName" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">البريد الإلكتروني</label>
                                    <input type="email" class="form-control" name="email" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">رقم الهاتف</label>
                                    <input type="tel" class="form-control" name="phone" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">كلمة المرور</label>
                                    <input type="password" class="form-control" name="password" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">تأكيد كلمة المرور</label>
                                    <input type="password" class="form-control" name="confirmPassword" required>
                                </div>
                            </div>
                        </div>

                        <!-- معلومات السكن -->
                        <div class="registration-section mb-4">
                            <h6 class="section-title">معلومات السكن</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">المحافظة</label>
                                    <select class="form-select" name="province" onchange="loadAreas(this.value)"
                                        required>
                                        <option value="">اختر المحافظة</option>
                                        <!-- سيتم ملء الخيارات عبر JavaScript -->
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">المنطقة</label>
                                    <select class="form-select" name="area" required>
                                        <option value="">اختر المنطقة</option>
                                        <!-- سيتم ملء الخيارات عبر JavaScript -->
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">العنوان التفصيلي</label>
                                    <textarea class="form-control" name="address" rows="2" required></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- الشروط والأحكام -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="terms" id="terms" required>
                            <label class="form-check-label" for="terms">
                                أوافق على <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">الشروط
                                    والأحكام</a>
                            </label>
                        </div>

                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="fas fa-user-plus me-2"></i>
                                تسجيل
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- إضافة قبل نهاية div#map -->
    <button id="nearbySearchBtn" class="nearby-search-btn" title="البحث عن السائقين في الجوار">
        <i class="fas fa-search"></i>
    </button>

    <div class="radius-control" style="display: none;">
        <label>نطاق البحث: <span id="radiusValue">5</span> كم</label>
        <input type="range" id="radiusSlider" min="1" max="20" value="5">
    </div>
    <div id="nearbyResults" class="nearby-results" style="display: none;">
        <div class="nearby-results-header">
            <h3>السائقين في الجوار</h3>
            <button class="close-results">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="nearby-results-content"></div>
    </div>


    <!-- إضافة هذا الجزء في نهاية الملف قبل إغلاق وسم body -->

    <!-- نافذة المحادثة المحسنة للسائق -->
    <div class="modal fade" id="driverChatModal" tabindex="-1" aria-labelledby="driverChatModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content chat-window">
                <!-- رأس النافذة مع صورة واسم المستخدم -->
                <div class="modal-header chat-header">
                    <img id="userImage"
                        src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527"
                        alt="صورة المستخدم" class="rounded-circle me-2" style="width: 50px; height: 50px;">
                    <div>
                        <h5 class="modal-title" id="userName">اسم المستخدم</h5>
                        <small id="userInfo" style="color: #ffffff;">معلومات إضافية</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                </div>

                <!-- منطقة المحادثة -->
                <div class="modal-body chat-body" id="driverChatBody">
                    <!-- ستتم إضافة الرسائل هنا بشكل ديناميكي -->
                    <div class="no-messages">لا توجد رسائل سابقة</div>
                </div>

                <!-- شريط الإدخال -->
                <div class="modal-footer chat-footer">
                    <div class="input-group w-100">
                        <input type="text" id="driverChatInput" class="form-control chat-input"
                            placeholder="اكتب رسالتك هنا...">
                        <button class="btn send-btn" id="driverSendMessageBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة قائمة المحادثات -->
    <div class="modal fade" id="chatListModal" tabindex="-1" aria-labelledby="chatListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chatListModalLabel">قائمة المحادثات</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                </div>
                <div class="modal-body">
                    <div class="driver-chats-container" id="driverChatsList">
                        <!-- ستتم إضافة المحادثات هنا بشكل ديناميكي -->
                        <div class="no-chats-message">لا توجد محادثات بعد</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- إضافة عناصر الصوت للإشعارات -->
    <audio id="messageSound"
        src="https://github.com/AlQasimMall/taxialpasha/raw/main/%D8%A7%D9%84%D9%87%D8%A7%D8%AA%D9%81-%D8%A7%D9%84%D8%AB%D8%A7%D8%A8%D8%AA.mp3"
        preload="auto"></audio>



    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>



    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>

    <script>


        const firebaseConfig = {
            apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEMiAI",
            authDomain: "messageemeapp.firebaseapp.com",
            databaseURL: "https://messageemeapp-default-rtdb.firebaseio.com",
            projectId: "messageemeapp",
            storageBucket: "messageemeapp.appspot.com",
            messagingSenderId: "255034474844",
            appId: "1:255034474844:web:5e3b7a6bc4b2fb94cc4199"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        const database = firebase.database();
        const storage = firebase.storage();
        const messaging = firebase.messaging();

        // Request notification permission
        // Enhanced notification handling
        class NotificationHandler {
            constructor() {
                this.messaging = firebase.messaging();
                this.hasPermission = false;
            }

            async initialize() {
                try {
                    // محاولة تسجيل Service Worker
                    // يجب تحديث جميع المسارات لتتضمن /Al-Pasha/
                    // مثلاً في ملف firebase-messaging-sw.js
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.register('https://alqasimmall.github.io/taxialpasha/firebase-messaging-sw.js', {
                            scope: 'https://alqasimmall.github.io/taxialpasha/firebase-messaging-sw.js'
                        })
                    }

                    await this.checkNotificationSupport();
                    await this.requestPermission();
                    await this.setupMessaging();
                } catch (error) {
                    console.error('Notification initialization error:', error);
                    this.handlePermissionError(error);
                }
            }

            async checkNotificationSupport() {
                if (!('Notification' in window)) {
                    throw new Error('This browser does not support notifications');
                }
            }

            async requestPermission() {
                try {
                    const permission = await Notification.requestPermission();

                    if (permission === 'granted') {
                        this.hasPermission = true;
                        return true;
                    } else if (permission === 'denied') {
                        throw new Error('notification_blocked');
                    } else {
                        throw new Error('notification_dismissed');
                    }
                } catch (error) {
                    throw error;
                }
            }

            async setupMessaging() {
                if (!this.hasPermission) return;

                try {
                    // استخدام Service Worker المسجل
                    await this.messaging.getToken({
                        vapidKey: 'BI9cpoewcZa1ftyZ_bGjO0GYa4_cT0HNja4YFd6FwLwHg5c0gQ5iSj_MJZRhMxKdgJ0-d-_rEXcpSQ_cx7GqCSc',
                        serviceWorkerRegistration: this.swRegistration
                    });

                    // إعداد معالج الرسائل
                    this.messaging.onMessage((payload) => {
                        console.log('Received foreground message:', payload);
                        this.showNotification(payload);
                    });
                } catch (error) {
                    console.error('Error setting up messaging:', error);
                    throw error;
                }
            }

            async saveTokenToDatabase(token) {
                if (!userId) return;

                try {
                    await database.ref('tokens/' + userId).set({ token: token });
                } catch (error) {
                    console.error('Error saving token:', error);
                }
            }

            setupMessageHandler() {
                this.messaging.onMessage((payload) => {
                    this.showNotification(payload);
                });
            }

            showNotification(payload) {
                if (!this.hasPermission) return;

                try {
                    // Try using the Notification API
                    new Notification(payload.notification.title, {
                        body: payload.notification.body,
                        icon: payload.notification.icon || '/default-icon.png',
                        badge: '/badge-icon.png',
                        tag: payload.data?.notificationId || 'default',
                        data: payload.data
                    });
                } catch (error) {
                    // Fallback to custom toast notification
                    this.showCustomToast(payload.notification);
                }
            }

            showCustomToast(notification) {
                const toast = document.createElement('div');
                toast.className = 'notification-toast animate__animated animate__fadeInRight';
                toast.innerHTML = `
          <div class="notification-content">
              <h4>${notification.title}</h4>
              <p>${notification.body}</p>
          </div>
          <button onclick="this.parentElement.remove()" class="close-btn">&times;</button>
      `;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.classList.replace('animate__fadeInRight', 'animate__fadeOutRight');
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            }

            handlePermissionError(error) {
                let message;

                switch (error.message) {
                    case 'notification_blocked':
                        message = 'التنبيهات محظورة. يرجى تفعيلها من إعدادات المتصفح';
                        this.showPermissionInstructions();
                        break;
                    case 'notification_dismissed':
                        message = 'لم يتم منح إذن التنبيهات. يمكنك تفعيلها لاحقاً من الإعدادات';
                        break;
                    default:
                        message = 'حدث خطأ في إعداد التنبيهات';
                }

                showToast(message, 'warning');
            }

            showPermissionInstructions() {
                Swal.fire({
                    title: 'تفعيل التنبيهات',
                    html: `
              <div class="permission-instructions">
                  <p>لتلقي التنبيهات، يرجى اتباع الخطوات التالية:</p>
                  <ol>
                      <li>انقر على أيقونة القفل في شريط العنوان</li>
                      <li>ابحث عن إعدادات "التنبيهات"</li>
                      <li>قم بتغيير الإعداد إلى "السماح"</li>
                  </ol>
              </div>
          `,
                    icon: 'info',
                    confirmButtonText: 'فهمت'
                });
            }
        }

        // Initialize notifications
        const notificationHandler = new NotificationHandler();
        notificationHandler.initialize().catch(console.error);


        // Initialize user ID
        let userId;
        if (!localStorage.getItem('userId')) {
            userId = generateUUID();
            localStorage.setItem('userId', userId);
        } else {
            userId = localStorage.getItem('userId');
        }

        // Generate unique user ID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                const r = (Math.random() * 16) | 0,
                    v = c === 'x' ? r : (r & 0x3) | 0x8;
                return v.toString(16);
            });
        }

        // Other application-specific logic
        let map;
        let markers = [];
        let userMarker;
        let userLocation = null;
        let markerLayer;
        let isLoadingDrivers = false; // للتحكم في حالة تحميل البيانات
        let isViewingDriverLocation = false; // لتعطيل تحديث موقع المستخدم عند عرض موقع السائق
        let currentDriverId = null;
        let currentChatDriverId = null;

        // Example: Fetch drivers from database
        function fetchDrivers() {
            if (isLoadingDrivers) return;
            isLoadingDrivers = true;

            database.ref('drivers').once('value', (snapshot) => {
                const drivers = snapshot.val();
                console.log(drivers);
                isLoadingDrivers = false;
            });
        }

        fetchDrivers(); // Load drivers on page load



        let currentDriverImage = ''; // متغير لصورة السائق
        let currentDriverName = '';  // متغير لاسم السائق
        let currentDriverCard = '';  // متغير لبطاقة السائق

       // تحديث دالة فتح نافذة المحادثة
function openChatWindow(driverId, driverImage, driverName, driverCard) {
    currentChatDriverId = driverId;
    currentDriverImage = driverImage;
    currentDriverName = driverName;
    currentDriverCard = driverCard;

    // تحديث بيانات السائق في النافذة
    document.getElementById('driverImage').src = driverImage;
    document.getElementById('driverName').innerText = driverName;
    document.getElementById('driverCardInfo').innerText = `بطاقة: ${driverCard}`;

    // إعادة ضبط النافذة: إظهار إدخال الرحلة
    document.getElementById('tripSelection').classList.remove('d-none');
    document.querySelector('.chat-footer').classList.add('d-none');
    document.getElementById('chatMessages').classList.add('d-none');

    // إظهار النافذة
    const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
    chatModal.show();
}

// تحديث دالة عرض المحادثة بعد تأكيد الرحلة
function showChatInterface() {
    // إخفاء قسم اختيار الرحلة
    document.getElementById('tripSelection').classList.add('d-none');
    
    // إظهار واجهة الدردشة
    document.querySelector('.chat-footer').classList.remove('d-none');
    document.getElementById('chatMessages').classList.remove('d-none');
    
    // تحديث شريط إدخال المحادثة ليشمل زر مشاركة الموقع
    const chatFooter = document.querySelector('.chat-footer');
    if (chatFooter) {
        chatFooter.innerHTML = `
            <div class="input-group w-100">
                <button class="location-btn" id="shareLocationBtn" title="مشاركة الموقع" style="width: 40px; height: 40px; border-radius: 50%; background: #333; color: #FFD700; border: none; cursor: pointer;">
                    <i class="fas fa-map-marker-alt"></i>
                </button>
                <input type="text" id="chatInput" class="form-control chat-input" placeholder="اكتب رسالتك هنا...">
                <button class="btn send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        `;
        
        // إضافة مستمع الحدث لزر مشاركة الموقع
        const shareLocationBtn = document.getElementById('shareLocationBtn');
        if (shareLocationBtn) {
            shareLocationBtn.addEventListener('click', shareUserLocation);
        }
    }
    
    // تحميل الرسائل السابقة
    loadMessages();
}

// تحديث دالة تأكيد الرحلة لتستدعي showChatInterface
function confirmTrip() {
    const tripCount = document.getElementById('tripCount').value;
    const tripDestination = document.getElementById('tripDestination').value;
    const tripType = document.getElementById('tripType').value;
    const tripDays = ["الأحد", "الإثنين", "الثلاثاء"];

    if (tripCount > 0 && tripDestination) {
        const tripData = {
            tripCount: tripCount,
            tripDestination: tripDestination,
            tripType: tripType,
            tripDays: tripDays,
            timestamp: Date.now()
        };

        // إضافة بيانات الرحلة
        database.ref(`chats/${userId}/${currentChatDriverId}/trips`).push(tripData)
            .then(() => {
                // تحديث عدد الرحلات للسائق
                return database.ref(`drivers/${currentChatDriverId}`).transaction((driver) => {
                    if (driver) {
                        driver.trips = (driver.trips || 0) + 1;
                    }
                    return driver;
                });
            })
            .then(() => {
                showToast('تم تأكيد الرحلة بنجاح!', 'success');
                
                // عرض واجهة المحادثة
                showChatInterface();
                
                // تحديث بطاقة السائق
                loadDrivers();
            })
            .catch((error) => {
                console.error("Error saving trip:", error);
                showToast('حدث خطأ في تأكيد الرحلة', 'error');
            });
    } else {
        showToast('يرجى إدخال جميع البيانات بشكل صحيح', 'warning');
    }
}

     // تحديث دالة تأكيد الرحلة لدعم الموقع
function confirmTrip() {
    const tripCount = document.getElementById('tripCount').value;
    const tripDestination = document.getElementById('tripDestination').value;
    const tripType = document.getElementById('tripType').value;
    const tripDays = ["الأحد", "الإثنين", "الثلاثاء"];

    if (tripCount > 0 && tripDestination) {
        const tripData = {
            tripCount: tripCount,
            tripDestination: tripDestination,
            tripType: tripType,
            tripDays: tripDays,
            timestamp: Date.now()
        };

        // إضافة بيانات الرحلة
        database.ref(`chats/${userId}/${currentChatDriverId}/trips`).push(tripData)
            .then(() => {
                // تحديث عدد الرحلات للسائق
                return database.ref(`drivers/${currentChatDriverId}`).transaction((driver) => {
                    if (driver) {
                        driver.trips = (driver.trips || 0) + 1;
                    }
                    return driver;
                });
            })
            .then(() => {
                showToast('تم تأكيد الرحلة بنجاح!', 'success');
                document.getElementById('tripSelection').classList.add('d-none');
                document.querySelector('.chat-footer').classList.remove('d-none');
                document.getElementById('chatMessages').classList.remove('d-none');
                
                // إضافة مستمع الحدث لزر مشاركة الموقع
                const shareLocationBtn = document.getElementById('shareLocationBtn');
                if (shareLocationBtn) {
                    shareLocationBtn.addEventListener('click', shareUserLocation);
                }
                
                loadMessages(); // تحميل الرسائل
                loadDrivers(); // تحديث بطاقة السائق
            })
            .catch((error) => {
                console.error("Error saving trip:", error);
                showToast('حدث خطأ أثناء تأكيد الرحلة', 'error');
            });
    } else {
        showToast('يرجى إدخال جميع البيانات بشكل صحيح', 'warning');
    }
}



// دالة الانتقال إلى الموقع على الخريطة مع رسم خط السير
async function navigateToLocation(lat, lng, messageId) {
    // إغلاق نافذة المحادثة
    const currentSwalInstance = Swal.getPopup();
    if (currentSwalInstance) {
        Swal.close();
    }

    // إظهار رسالة جاري الانتقال إلى الموقع
    showToast('جاري الانتقال إلى الموقع...', 'info');
    
    try {
        // الحصول على موقع المستخدم الحالي
        const userPosition = await getCurrentPositionPromise();
        const userLat = userPosition.coords.latitude;
        const userLng = userPosition.coords.longitude;
        
        // تحريك الخريطة إلى مركز بين النقطتين
        const centerLat = (userLat + parseFloat(lat)) / 2;
        const centerLng = (userLng + parseFloat(lng)) / 2;
        
        // حساب المسافة لتحديد مستوى التكبير المناسب
        const distance = calculateDistance(userLat, userLng, parseFloat(lat), parseFloat(lng));
        const zoomLevel = getZoomLevelByDistance(distance);
        
        // تحريك الخريطة للعرض المناسب
        map.flyTo([centerLat, centerLng], zoomLevel, {
            animate: true,
            duration: 1.5
        });
        
        // مسح الطبقات الحالية
        markerLayer.clearLayers();
        
        // إضافة علامة موقع المستخدم
        const userMarker = L.marker([userLat, userLng], {
            icon: L.divIcon({
                html: `
                    <div style="position: relative; width: 100%; height: 100%;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; background: rgba(0, 123, 255, 0.3); border-radius: 50%; animation: pulse 2s infinite;"></div>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 30px; height: 30px; background: #007bff; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); z-index: 2; border: 2px solid #fff;">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                `,
                className: 'user-location-marker',
                iconSize: [50, 50],
                iconAnchor: [25, 50]
            })
        }).addTo(markerLayer);
        
        // إضافة علامة الموقع المشترك
        const sharedLocationMarker = L.marker([parseFloat(lat), parseFloat(lng)], {
            icon: L.divIcon({
                html: `
                    <div style="position: relative; width: 100%; height: 100%;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; background: rgba(255, 215, 0, 0.3); border-radius: 50%; animation: pulse 2s infinite;"></div>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 30px; height: 30px; background: #FFD700; color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); z-index: 2; border: 2px solid #000;">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                    </div>
                `,
                className: 'shared-location-marker',
                iconSize: [50, 50],
                iconAnchor: [25, 50]
            })
        }).addTo(markerLayer);
        
        // رسم خط السير بين النقطتين
        const routeLine = L.polyline([
            [userLat, userLng],
            [parseFloat(lat), parseFloat(lng)]
        ], {
            color: '#FFD700',
            weight: 5,
            opacity: 0.7,
            dashArray: '10, 10',
            lineCap: 'round',
            lineJoin: 'round',
            className: 'animated-route'
        }).addTo(markerLayer);
        
        // الحصول على معلومات إضافية عن الموقع باستخدام خدمة Nominatim
        const locationInfo = await getLocationInfo(lat, lng);
        
        // تقدير المسافة والوقت
        const distanceInKm = calculateDistance(userLat, userLng, parseFloat(lat), parseFloat(lng));
        const estimatedTime = Math.ceil((distanceInKm * 60) / 40); // بافتراض سرعة متوسطة 40 كم/ساعة
        
        // إضافة نافذة معلومات مفصلة للموقع
        sharedLocationMarker.bindPopup(createDetailedLocationPopup(lat, lng, locationInfo, distanceInKm, estimatedTime, messageId), {
            className: 'custom-popup',
            maxWidth: 300,
            minWidth: 250
        }).openPopup();
        
        // تعليم رسالة الموقع كمقروءة
        markLocationMessageAsRead(messageId);
        
    } catch (error) {
        console.error('Error navigating to location:', error);
        
        // إذا تعذر الحصول على موقع المستخدم، نكتفي بعرض الموقع المشترك فقط
        map.flyTo([parseFloat(lat), parseFloat(lng)], 15, {
            animate: true,
            duration: 1.5
        });
        
        markerLayer.clearLayers();
        
        // إضافة علامة الموقع المشترك فقط
        const sharedLocationMarker = L.marker([parseFloat(lat), parseFloat(lng)], {
            icon: L.divIcon({
                html: `
                    <div style="position: relative; width: 100%; height: 100%;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; background: rgba(255, 215, 0, 0.3); border-radius: 50%; animation: pulse 2s infinite;"></div>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 30px; height: 30px; background: #FFD700; color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); z-index: 2; border: 2px solid #000;">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                    </div>
                `,
                className: 'shared-location-marker',
                iconSize: [50, 50],
                iconAnchor: [25, 50]
            })
        }).addTo(markerLayer);
        
        // محاولة الحصول على معلومات الموقع
        try {
            const locationInfo = await getLocationInfo(lat, lng);
            sharedLocationMarker.bindPopup(createDetailedLocationPopup(lat, lng, locationInfo, null, null, messageId), {
                className: 'custom-popup',
                maxWidth: 300,
                minWidth: 250
            }).openPopup();
        } catch (infoError) {
            // إذا تعذر الحصول على معلومات الموقع، نكتفي بعرض الإحداثيات فقط
            sharedLocationMarker.bindPopup(`
                <div style="text-align: center; padding: 10px;">
                    <h6 style="color: #FFD700; margin-bottom: 10px;">الموقع المشترك</h6>
                    <p style="display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 10px;">
                        <i class="fas fa-map-pin" style="color: #FFD700;"></i>
                        <span>${parseFloat(lat).toFixed(6)}, ${parseFloat(lng).toFixed(6)}</span>
                    </p>
                    <button onclick="window.open('https://www.google.com/maps?q=${lat},${lng}', '_blank')" 
                            style="background: #FFD700; color: #000; border: none; padding: 5px 10px; border-radius: 5px; font-weight: bold; display: flex; align-items: center; gap: 5px; margin: 0 auto;">
                        <i class="fas fa-external-link-alt"></i>
                        فتح في خرائط Google
                    </button>
                </div>
            `, {
                className: 'custom-popup'
            }).openPopup();
        }
        
        // تعليم رسالة الموقع كمقروءة
        markLocationMessageAsRead(messageId);
        
        showToast('تعذر الحصول على موقعك الحالي، تم عرض الموقع المشترك فقط', 'warning');
    }
}



// دالة للحصول على موقع المستخدم باستخدام Promise
function getCurrentPositionPromise() {
    return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        });
    });
}

// دالة حساب المسافة بين نقطتين
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // نصف قطر الأرض بالكيلومترات
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const distance = R * c;
    
    return Math.round(distance * 10) / 10; // تقريب إلى أقرب 0.1 كم
}

// تحويل الدرجات إلى راديان
function toRad(degrees) {
    return degrees * Math.PI / 180;
}


// دالة للحصول على الاتجاهات إلى الموقع باستخدام OSRM
async function getDirectionsToLocation(destLat, destLng) {
    try {
        showToast('جاري الحصول على الاتجاهات...', 'info');
        
        // الحصول على موقع المستخدم الحالي
        const position = await getCurrentPositionPromise();
        const sourceLat = position.coords.latitude;
        const sourceLng = position.coords.longitude;
        
        // بناء رابط الطلب إلى خدمة OSRM
        const apiUrl = `https://router.project-osrm.org/route/v1/driving/${sourceLng},${sourceLat};${destLng},${destLat}?overview=full&geometries=geojson&steps=true`;
        
        // إجراء الطلب
        const response = await fetch(apiUrl);
        if (!response.ok) {
            throw new Error('فشل في الحصول على بيانات المسار');
        }
        
        const data = await response.json();
        
        if (data.code !== 'Ok' || !data.routes || !data.routes[0]) {
            throw new Error('لم يتم العثور على مسار');
        }
        
        // الحصول على بيانات المسار
        const route = data.routes[0];
        const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
        
        // تحديث الخريطة
        markerLayer.clearLayers();
        
        // إضافة علامات البداية والنهاية
        const startMarker = L.marker([sourceLat, sourceLng], {
            icon: L.divIcon({
                html: `
                    <div style="position: relative; width: 100%; height: 100%;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 30px; height: 30px; background: #007bff; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); z-index: 2; border: 2px solid #fff;">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                `,
                className: 'user-location-marker',
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            })
        }).addTo(markerLayer);
        
        const endMarker = L.marker([destLat, destLng], {
            icon: L.divIcon({
                html: `
                    <div style="position: relative; width: 100%; height: 100%;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 30px; height: 30px; background: #FFD700; color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); z-index: 2; border: 2px solid #000;">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                    </div>
                `,
                className: 'destination-location-marker',
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            })
        }).addTo(markerLayer);
        
        // رسم خط المسار
        const routeLine = L.polyline(coordinates, {
            color: '#4a89dc',
            weight: 5,
            opacity: 0.8,
            lineCap: 'round',
            lineJoin: 'round'
        }).addTo(markerLayer);
        
        // تكبير الخريطة لتناسب المسار
        map.fitBounds(routeLine.getBounds(), {
            padding: [30, 30]
        });
        
        // إضافة معلومات المسار
        const distance = (route.distance / 1000).toFixed(1); // المسافة بالكيلومترات
        const duration = Math.round(route.duration / 60); // الوقت بالدقائق
        
        // إنشاء مربع معلومات المسار
        const routeInfoControl = L.control({ position: 'bottomleft' });
        routeInfoControl.onAdd = function() {
            const div = L.DomUtil.create('div', 'route-info-box');
            div.innerHTML = `
                <div style="background: rgba(0,0,0,0.8); color: #fff; padding: 15px; border-radius: 10px; border: 2px solid #FFD700; margin: 10px; min-width: 200px; max-width: 300px; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
                    <h6 style="color: #FFD700; margin-bottom: 10px; text-align: center; font-weight: bold; border-bottom: 1px solid rgba(255,215,0,0.3); padding-bottom: 8px;">
                        <i class="fas fa-directions"></i> معلومات المسار
                    </h6>
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-route" style="color: #FFD700; margin-left: 10px; font-size: 1.1rem;"></i>
                        <div>
                            <span style="color: #ccc;">المسافة:</span>
                            <span style="color: #fff; font-weight: bold; margin-right: 5px;">${distance} كم</span>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-clock" style="color: #FFD700; margin-left: 10px; font-size: 1.1rem;"></i>
                        <div>
                            <span style="color: #ccc;">الوقت التقريبي:</span>
                            <span style="color: #fff; font-weight: bold; margin-right: 5px;">${duration} دقيقة</span>
                        </div>
                    </div>
                    <button onclick="clearRoute()" style="width: 100%; background: #FFD700; color: #000; border: none; padding: 8px; border-radius: 5px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer; transition: all 0.3s ease; margin-top: 10px;">
                        <i class="fas fa-times"></i>
                        إغلاق المسار
                    </button>
                </div>
            `;
            return div;
        };
        routeInfoControl.addTo(map);
        
        // حفظ التحكم في متغير عالمي للإزالة لاحقاً
        window.currentRouteInfoControl = routeInfoControl;
        
        showToast('تم عرض المسار بنجاح', 'success');
        
    } catch (error) {
        console.error('Error getting directions:', error);
        showToast('تعذر الحصول على المسار. يرجى المحاولة مرة أخرى.', 'error');
    }
}

// دالة لتغيير حالة السائق
function toggleDriverAvailability() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
        showToast('يرجى تسجيل الدخول أولاً', 'warning');
        return;
    }

    const driverId = currentUser.uid;
    const driverRef = database.ref(`drivers/${driverId}`);

    driverRef.once('value').then(snapshot => {
        const driverData = snapshot.val();
        if (driverData) {
            const newStatus = driverData.status === 'available' ? 'busy' : 'available';
            driverRef.update({ status: newStatus }).then(() => {
                showToast(`تم تغيير الحالة إلى ${newStatus === 'available' ? 'متاح' : 'مشغول'}`, 'success');
                updateDriverStatusIcon(newStatus);
            }).catch(error => {
                console.error('Error updating status:', error);
                showToast('حدث خطأ في تحديث الحالة', 'error');
            });
        }
    }).catch(error => {
        console.error('Error fetching driver data:', error);
        showToast('حدث خطأ في جلب بيانات السائق', 'error');
    });
}

// دالة لتحديث أيقونة حالة السائق
function updateDriverStatusIcon(status) {
    const statusIcon = document.getElementById('driverStatusIcon');
    if (statusIcon) {
        statusIcon.className = status === 'available' ? 'fas fa-check-circle text-success' : 'fas fa-times-circle text-danger';
    }
}

// إضافة زر تغيير حالة السائق في نافذة المحادثة
function openChatWindow(driverId, driverImage, driverName, driverCard) {
    currentChatDriverId = driverId;
    currentDriverImage = driverImage;
    currentDriverName = driverName;
    currentDriverCard = driverCard;

    // تحديث بيانات السائق في النافذة
    document.getElementById('driverImage').src = driverImage;
    document.getElementById('driverName').innerText = driverName;
    document.getElementById('driverCardInfo').innerText = `بطاقة: ${driverCard}`;

    // إضافة زر تغيير حالة السائق
    const statusButton = document.createElement('button');
    statusButton.className = 'btn btn-secondary';
    statusButton.innerHTML = '<i id="driverStatusIcon" class="fas fa-check-circle text-success"></i>';
    statusButton.onclick = toggleDriverAvailability;
    document.querySelector('.chat-header').appendChild(statusButton);

    // إعادة ضبط النافذة: إظهار إدخال الرحلة
    document.getElementById('tripSelection').classList.remove('d-none');
    document.querySelector('.chat-footer').classList.add('d-none');
    document.getElementById('chatMessages').classList.add('d-none');

    // إظهار النافذة
    const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
    chatModal.show();
}

// دالة لمسح المسار وعناصر التحكم
function clearRoute() {
    // إزالة عنصر التحكم بمعلومات المسار
    if (window.currentRouteInfoControl) {
        map.removeControl(window.currentRouteInfoControl);
        window.currentRouteInfoControl = null;
    }
    
    // مسح طبقة العلامات
    markerLayer.clearLayers();
    
    showToast('تم مسح المسار', 'info');
}


        function addRating(driverId) {
            database.ref(`drivers/${driverId}`).transaction((driver) => {
                if (driver) {
                    // زيادة التقييم تدريجياً
                    const currentRating = driver.rating || 5;
                    const tripsCount = driver.trips || 0;

                    // معادلة لحساب التقييم الجديد
                    // كلما زاد عدد الرحلات، زاد التقييم بشكل أبطأ
                    const newRating = Math.min(5, currentRating + (0.1 / Math.sqrt(tripsCount + 1)));

                    driver.rating = parseFloat(newRating.toFixed(1));
                }
                return driver;
            }).then(() => {
                showToast('تم إضافة التقييم بنجاح');
                loadDrivers(); // تحديث بطاقة السائق
            }).catch((error) => {
                console.error('Error updating rating:', error);
                showToast('حدث خطأ في تحديث التقييم', 'error');
            });
        }

        function loadTrips() {
            const tripsContainer = document.getElementById('tripsList');
            tripsContainer.innerHTML = ''; // مسح الرحلات السابقة

            database.ref(`chats/${userId}/${currentChatDriverId}/trips`).on('child_added', (snapshot) => {
                const trip = snapshot.val();
                const tripDiv = document.createElement('div');
                tripDiv.className = 'trip-details';
                tripDiv.innerHTML = `
            <p>عدد المشاوير: ${trip.tripCount}</p>
            <p>الوجهة: ${trip.tripDestination}</p>
            <p>نوع الرحلة: ${trip.tripType}</p>
            <p>الأيام: ${trip.tripDays.join(', ')}</p>
            <p>التاريخ: ${new Date(trip.timestamp).toLocaleString()}</p>
        `;
                tripsContainer.appendChild(tripDiv);
            });
        }

// تحديث دالة إرسال الرسالة
function sendMessage() {
    const messageInput = document.getElementById('chatInput');
    const messageText = messageInput.value.trim();

    if (messageText) {
        const message = {
            sender: userId,
            type: 'text', // تحديد النوع كنص
            text: messageText,
            timestamp: Date.now(),
            read: false
        };

        database.ref(`chats/${userId}/${currentChatDriverId}/messages`).push(message);
        messageInput.value = ''; // تفريغ حقل الإدخال
    }
}


        function loadMessages() {
            const chatBox = document.getElementById('chatMessages');
            chatBox.innerHTML = '';

            database.ref(`chats/${userId}/${currentChatDriverId}/messages`).on('child_added', (snapshot) => {
                const message = snapshot.val();
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = `
            <div class="message-bubble ${message.sender === userId ? 'sent' : 'received'}">
                <p>${message.text}</p>
                <span class="timestamp">${new Date(message.timestamp).toLocaleTimeString()}</span>
            </div>
        `;
                chatBox.appendChild(messageDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }


        // استدعاء نافذة المحادثة مع تحديث اسم وصورة السائق
        // استدعاء نافذة المحادثة مع تحديث اسم وصورة السائق
        function openChatWindow(driverId) {
            console.log('Opening chat for driver:', driverId); // للتأكد من وصول معرف السائق
            currentChatDriverId = driverId;
            showLoading();

            database.ref(`drivers/${driverId}`).once('value')
                .then(snapshot => {
                    const driverData = snapshot.val();
                    console.log('Driver Data:', driverData); // للتأكد من البيانات المستلمة

                    if (driverData) {
                        // الوصول المباشر إلى الصورة من البيانات الرئيسية
                        const imageUrl = driverData.imageUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527';
                        // الوصول إلى الاسم من coordinates
                        const name = driverData?.name || 'اسم غير متوفر';
                        // معلومات السيارة من البيانات الرئيسية
                        const carInfo = `${driverData.carType || ''} - ${driverData.carModel || ''}`;

                        // تحديث واجهة المستخدم
                        const chatModal = document.getElementById('chatModal');
                        if (chatModal) {
                            const driverImageElement = chatModal.querySelector('#driverImage');
                            const driverNameElement = chatModal.querySelector('#driverName');
                            const driverCardInfoElement = chatModal.querySelector('#driverCardInfo');

                            if (driverImageElement) {
                                driverImageElement.src = imageUrl;
                                console.log('Setting image URL:', imageUrl); // للتأكد من الرابط
                            }
                            if (driverNameElement) driverNameElement.textContent = name;
                            if (driverCardInfoElement) driverCardInfoElement.textContent = carInfo;

                            // إعادة تعيين حالة المحادثة
                            const tripSelection = chatModal.querySelector('#tripSelection');
                            const chatFooter = chatModal.querySelector('.chat-footer');
                            const chatMessages = chatModal.querySelector('#chatMessages');

                            if (tripSelection) tripSelection.classList.remove('d-none');
                            if (chatFooter) chatFooter.classList.add('d-none');
                            if (chatMessages) {
                                chatMessages.classList.add('d-none');
                                chatMessages.innerHTML = '';
                            }

                            // تعديل شريط إدخال المحادثة في نافذة الدردشة
                            // أضف هذا في دالة openChatWindow

                            if (chatFooter) {
                                chatFooter.innerHTML = `
    <div class="input-group w-100">
        <button class="btn location-btn" id="shareLocationBtn" title="مشاركة الموقع">
            <i class="fas fa-map-marker-alt"></i>
        </button>
        <input type="text" id="chatInput" class="form-control chat-input" placeholder="اكتب رسالتك هنا...">
        <button class="btn send-btn" onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
    `;

                                // إضافة مستمع الحدث لزر المشاركة
                                const shareLocationBtn = document.getElementById('shareLocationBtn');
                                if (shareLocationBtn) {
                                    shareLocationBtn.addEventListener('click', shareUserLocation);
                                }
                            }

                            // إظهار النافذة المنبثقة
                            const modalInstance = new bootstrap.Modal(chatModal);
                            modalInstance.show();
                        }
                    } else {
                        showToast('لم يتم العثور على بيانات السائق', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error fetching driver data:', error);
                    showToast('حدث خطأ في تحميل بيانات السائق', 'error');
                })
                .finally(() => {
                    hideLoading();
                });
        }






// دالة مشاركة موقع المستخدم
async function shareUserLocation() {
    try {
        // عرض مؤشر التحميل
        showToast('جاري تحديد موقعك...', 'info');
        
        // الحصول على الموقع الحالي
        const position = await getCurrentPositionPromise();
        const { latitude, longitude } = position.coords;
        
        // إنشاء بيانات رسالة الموقع
        const locationMessage = {
            sender: userId, // معرف المستخدم الحالي
            type: 'location',
            location: {
                lat: latitude,
                lng: longitude,
                accuracy: position.coords.accuracy
            },
            timestamp: Date.now(),
            read: false
        };
        
        // إرسال رسالة الموقع للسائق
        const messageRef = await database.ref(`chats/${userId}/${currentChatDriverId}/messages`).push(locationMessage);
        
        // إضافة الرسالة الجديدة إلى نافذة المحادثة
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message sent';
            messageElement.innerHTML = createLocationMessageView(locationMessage, messageRef.key, true);
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // إصدار صوت الإرسال
        playMessageSound();
        
        // عرض رسالة نجاح
        showToast('تم مشاركة موقعك بنجاح', 'success');
        
    } catch (error) {
        console.error('Error sharing location:', error);
        
        let errorMessage = 'حدث خطأ في مشاركة الموقع';
        if (error.code === 1) { // PERMISSION_DENIED
            errorMessage = 'تم رفض الوصول إلى الموقع. يرجى السماح للتطبيق باستخدام خدمة الموقع';
        } else if (error.code === 2) { // POSITION_UNAVAILABLE
            errorMessage = 'معلومات الموقع غير متوفرة حالياً';
        } else if (error.code === 3) { // TIMEOUT
            errorMessage = 'انتهت مهلة تحديد الموقع';
        }
        
        showToast(errorMessage, 'error');
    }
}

// دالة تشغيل صوت الرسالة
function playMessageSound() {
    const messageSound = document.getElementById('messageSound');
    if (messageSound) {
        messageSound.play().catch(error => {
            console.log('Could not play message sound:', error);
        });
    }
}
// تحديث دالة loadMessages لدعم رسائل الموقع
function loadMessages() {
    const chatBox = document.getElementById('chatMessages');
    chatBox.innerHTML = '';

    database.ref(`chats/${userId}/${currentChatDriverId}/messages`).on('child_added', (snapshot) => {
        const message = snapshot.val();
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message';
        messageDiv.classList.add(message.sender === userId ? 'sent' : 'received');
        
        // التحقق من نوع الرسالة
        if (message.type === 'location') {
            // إنشاء عرض لرسالة الموقع
            messageDiv.innerHTML = createLocationMessageView(message, snapshot.key);
        } else {
            // إنشاء عرض لرسالة نصية عادية
            messageDiv.innerHTML = `
                <div class="message-bubble ${message.sender === userId ? 'sent' : 'received'}">
                    <p>${message.text}</p>
                    <span class="timestamp">${new Date(message.timestamp).toLocaleTimeString()}</span>
                </div>
            `;
        }
        
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    });
}

// دالة إنشاء عرض لرسالة الموقع
function createLocationMessageView(message, messageId) {
    const { lat, lng } = message.location;
    const isSentByUser = message.sender === userId;
    
    // إنشاء رابط ستاتيك للخريطة (صورة مصغرة للموقع)
    const staticMapUrl = `https://api.mapbox.com/styles/v1/mapbox/dark-v10/static/pin-s+ffd700(${lng},${lat})/${lng},${lat},14,0/300x120?access_token=YOUR_MAPBOX_TOKEN`;
    
    return `
        <div class="message-bubble ${isSentByUser ? 'sent' : 'received'}">
            <div class="location-message" onclick="navigateToLocation(${lat}, ${lng}, '${messageId}')">
                <div class="location-message-header">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>موقع ${isSentByUser ? 'مشترك' : 'السائق'}</span>
                </div>
                <div class="location-message-preview">
                    <img src="${staticMapUrl}" alt="خريطة الموقع" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                <div class="location-message-action">
                    انقر للانتقال إلى الموقع على الخريطة
                </div>
            </div>
            <span class="timestamp">${new Date(message.timestamp).toLocaleTimeString()}</span>
        </div>
    `;
}


// دالة تعليم رسالة الموقع كمقروءة
function markLocationMessageAsRead(messageId) {
    // البحث عن المحادثة التي تحتوي على هذه الرسالة
    database.ref(`chats`).once('value')
        .then(snapshot => {
            const allChats = snapshot.val() || {};
            
            // البحث عن الرسالة في جميع المحادثات
            Object.keys(allChats).forEach(userId => {
                Object.keys(allChats[userId] || {}).forEach(driverId => {
                    const messages = allChats[userId][driverId]?.messages || {};
                    
                    if (messages[messageId]) {
                        // وجدنا الرسالة، نعلمها كمقروءة
                        database.ref(`chats/${userId}/${driverId}/messages/${messageId}`).update({
                            read: true
                        });
                    }
                });
            });
        });
}

// دالة تعليم رسالة الموقع كمقروءة
function markLocationMessageAsRead(messageId) {
    database.ref(`chats/${userId}/${currentChatDriverId}/messages/${messageId}`).update({
        read: true
    });
}

// دالة إعادة فتح المحادثة مع تمييز رسالة معينة
function reopenChatWithMessage(messageId) {
    // إغلاق النافذة المنبثقة الحالية
    const currentPopup = document.querySelector('.leaflet-popup');
    if (currentPopup) {
        const closeButton = currentPopup.querySelector('.leaflet-popup-close-button');
        if (closeButton) {
            closeButton.click();
        }
    }
    
    // مسح المسار على الخريطة
    clearRoute();
    
    // إعادة فتح نافذة المحادثة
    if (currentChatDriverId) {
        // فتح المحادثة للمستخدم العادي
        const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
        chatModal.show();
        
        // إظهار واجهة المحادثة
        document.getElementById('tripSelection').classList.add('d-none');
        document.querySelector('.chat-footer').classList.remove('d-none');
        document.getElementById('chatMessages').classList.remove('d-none');
        
        // تحميل الرسائل
        loadMessages();
        
        // تمييز الرسالة المحددة بعد فترة وجيزة
        setTimeout(() => {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                messageElement.style.animation = 'highlight 2s ease';
            }
        }, 500);
    } else {
        // للسائق: إعادة فتح محادثة المستخدم
        const userId = findUserIdByMessageId(messageId);
        if (userId) {
            openDriverChatWindow(getCurrentDriverId(), userId);
        } else {
            showToast('تعذر العثور على المحادثة', 'error');
        }
    }
}

// دالة للبحث عن معرف المستخدم باستخدام معرف الرسالة
function findUserIdByMessageId(messageId) {
    // هذه الدالة تحتاج إلى تنفيذ يعتمد على هيكل البيانات الخاص بك
    // يمكنك تنفيذها باستخدام Firebase بطريقة أسنكرونية
    // هنا نقدم نموذجًا بسيطًا للتوضيح
    
    let foundUserId = null;
    
    // هنا يمكنك البحث في الذاكرة المؤقتة أو استدعاء Firebase
    // للبحث عن المستخدم الذي يملك هذه الرسالة
    
    // إرجاع معرف المستخدم أو null إذا لم يتم العثور عليه
    return foundUserId;
}

// دالة للحصول على معرف السائق الحالي
function getCurrentDriverId() {
    // الحصول على بيانات المستخدم المسجل
    const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
    
    // التحقق من أن المستخدم الحالي هو سائق
    if (currentUser.role === 'driver' && currentUser.uid) {
        return currentUser.uid;
    }
    
    return null;
}


// دالة لحفظ رسائل الموقع المشتركة في التخزين المحلي
function saveSharedLocations(messageId, lat, lng, sender, timestamp) {
    try {
        // الحصول على قائمة المواقع الحالية
        let sharedLocations = JSON.parse(localStorage.getItem('sharedLocations')) || [];
        
        // إضافة الموقع الجديد
        sharedLocations.push({
            messageId,
            lat,
            lng,
            sender,
            timestamp,
            driverId: currentChatDriverId || getCurrentDriverId()
        });
        
        // الاحتفاظ بأحدث 20 موقع فقط
        if (sharedLocations.length > 20) {
            sharedLocations = sharedLocations.slice(-20);
        }
        
        // حفظ القائمة
        localStorage.setItem('sharedLocations', JSON.stringify(sharedLocations));
    } catch (error) {
        console.error('Error saving shared locations:', error);
    }
}

// دالة لتحميل آخر المواقع المشتركة
function loadSharedLocations() {
    try {
        return JSON.parse(localStorage.getItem('sharedLocations')) || [];
    } catch (error) {
        console.error('Error loading shared locations:', error);
        return [];
    }
}

// دالة لإضافة خيار عرض آخر المواقع المشتركة
function addRecentLocationsControl() {
    // إنشاء زر في الخريطة
    const recentLocationsControl = L.control({ position: 'topright' });
    recentLocationsControl.onAdd = function() {
        const div = L.DomUtil.create('div', 'recent-locations-control');
        div.innerHTML = `
            <button title="آخر المواقع المشتركة" style="width: 40px; height: 40px; border-radius: 5px; background: #FFD700; color: #000; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); margin: 10px;">
                <i class="fas fa-history"></i>
            </button>
        `;
        
        // إضافة مستمع الحدث
        div.firstChild.addEventListener('click', showRecentLocations);
        
        return div;
    };
    recentLocationsControl.addTo(map);
}

// دالة لعرض آخر المواقع المشتركة
function showRecentLocations() {
    const locations = loadSharedLocations();
    
    if (locations.length === 0) {
        showToast('لا توجد مواقع مشتركة حديثة', 'info');
        return;
    }
    
    // إنشاء قائمة المواقع للعرض
    let locationsHTML = '';
    locations.forEach((location, index) => {
        locationsHTML += `
            <div class="recent-location-item" onclick="navigateToLocation(${location.lat}, ${location.lng}, '${location.messageId}')" style="background: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s ease; border: 1px solid #444;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <div style="color: #FFD700; font-weight: bold;">
                        <i class="fas fa-map-marker-alt"></i> موقع ${location.sender === 'user' ? 'المستخدم' : 'السائق'}
                    </div>
                    <div style="color: #ccc; font-size: 0.8rem;">
                        ${formatRelativeTime(location.timestamp)}
                    </div>
                </div>
                <div style="font-size: 0.8rem; color: #ddd; margin-top: 5px;">
                    <i class="fas fa-map-pin"></i> ${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}
                </div>
            </div>
        `;
    });
    
    Swal.fire({
        title: 'آخر المواقع المشتركة',
        html: `
            <div style="max-height: 300px; overflow-y: auto; padding: 10px;">
                ${locationsHTML}
            </div>
        `,
        background: '#1a1a1a',
        color: '#FFFFFF',
        showConfirmButton: false,
        showCloseButton: true,
        customClass: {
            popup: 'dark-popup',
            title: 'text-white'
        }
    });
}

// دالة تنسيق الوقت النسبي
function formatRelativeTime(timestamp) {
    const now = Date.now();
    const diffMs = now - timestamp;
    
    const seconds = Math.floor(diffMs / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (days > 0) {
        return `منذ ${days} ${days === 1 ? 'يوم' : 'أيام'}`;
    } else if (hours > 0) {
        return `منذ ${hours} ${hours === 1 ? 'ساعة' : 'ساعات'}`;
    } else if (minutes > 0) {
        return `منذ ${minutes} ${minutes === 1 ? 'دقيقة' : 'دقائق'}`;
    } else {
        return 'الآن';
    }
}








        function createDriverCard(driver, driverId) {
            return `
        <div class="driver-card">
            <div class="driver-image-container">
                <img src="${driver.imageUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" class="driver-image">
            </div>
            <div class="driver-info">
                <h3 class="driver-name">${driver.name || 'اسم غير متوفر'}</h3>
                <button class="btn btn-primary" onclick="openChatWindow('${driverId}')">فتح المحادثة</button>
            </div>
        </div>
    `;
        }

        function viewDriverLocation(driverId) {
            database.ref(`drivers/${driverId}`).once('value', (snapshot) => {
                const driver = snapshot.val();
                if (driver && driver.coordinates) {
                    // التحقق من حالة الموافقة
                    const isApproved = driver.approved === true;
                    const isPending = driver.approvalStatus === 'pending';
                    const { lat, lng } = driver.coordinates;

                    map.flyTo([lat, lng], 15, {
                        animate: true,
                        duration: 1.5
                    });

                    markerLayer.clearLayers();

                    // تعديل مظهر العلامة حسب حالة الموافقة
                    const driverMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            html: `
                        <div style="position: relative; text-align: center;" class="${isApproved ? 'approved' : (isPending ? 'pending' : 'not-approved')}">
                            <img src="${driver.imageUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" 
                                 alt="صورة السائق" 
                                 style="width: 50px; height: 50px; border: 3px solid #FFD700; 
                                 border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                                 filter: ${!isApproved ? 'grayscale(100%)' : 'none'};
                                 opacity: ${!isApproved ? '0.7' : '1'};">
                            <i class="fas fa-taxi" 
                               style="position: absolute; bottom: -5px; right: 50%; transform: translateX(50%); 
                               color: ${isApproved ? '#FFD700' : '#999'}; font-size: 1.5rem;"></i>
                            ${!isApproved ? `
                            <div class="status-badge" style="position: absolute; top: -10px; right: -10px; 
                                 background: ${isPending ? '#FFD700' : '#dc3545'}; color: ${isPending ? '#000' : '#fff'};
                                 padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold;">
                                ${isPending ? 'قيد المراجعة' : 'غير مفعل'}
                            </div>` : ''}
                        </div>
                    `,
                            className: 'driver-marker',
                            iconSize: [60, 60],
                        }),
                    }).addTo(markerLayer);

                    // تحديث محتوى النافذة المنبثقة
                    const popupContent = `
                <div style="text-align: center; font-family: 'Segoe UI', sans-serif; min-width: 200px; 
                     background: #000000; border-radius: 10px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                    ${!isApproved ? `
                    <div class="status-banner" style="background: ${isPending ? '#FFD700' : '#dc3545'}; 
                         color: ${isPending ? '#000' : '#fff'}; padding: 5px; margin: -15px -15px 15px -15px; 
                         border-radius: 10px 10px 0 0; font-weight: bold;">
                        ${isPending ? 'هذا السائق قيد المراجعة' : 'هذا السائق غير مفعل حالياً'}
                    </div>
                    ` : ''}
                    
                    <div class="driver-popup-header" style="margin-bottom: 10px;">
                        <img src="${driver.imageUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" 
                             alt="صورة السائق" 
                             style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #FFD700; 
                             margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
                             filter: ${!isApproved ? 'grayscale(100%)' : 'none'};">
                        <h5 style="color: #FFFFFF; font-weight: bold; margin: 8px 0;">${driver.name}</h5>
                    </div>
                    
                    <div class="driver-popup-stats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 15px;">
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #FFD700;">
                                <i class="fas fa-star"></i> ${driver.rating ? driver.rating.toFixed(1) : '5.0'}
                            </div>
                            <div style="font-size: 0.8rem; color: #FFFFFF;">التقييم</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #FFD700;">
                                <i class="fas fa-route"></i> ${driver.trips || 0}
                            </div>
                            <div style="font-size: 0.8rem; color: #FFFFFF;">الرحلات</div>
                        </div>
                    </div>
                    
                    <div class="driver-popup-info" style="margin-bottom: 15px; text-align: right; color: #FFFFFF;">
                        <p style="margin: 5px 0;">
                            <i class="fas fa-car" style="color: #FFD700; margin-left: 5px;"></i>
                            ${driver.carType} - ${driver.carModel}
                        </p>
                        <p style="margin: 5px 0;">
                            <i class="fas fa-map-marker-alt" style="color: #FFD700; margin-left: 5px;"></i>
                            ${driver.location}
                        </p>
                        <p style="margin: 5px 0;">
                            <i class="fas fa-phone" style="color: #FFD700; margin-left: 5px;"></i>
                            ${driver.phone}
                        </p>
                    </div>
            
                    <div class="driver-popup-actions" style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                        <button onclick="openChatWindow('${driverId}')" 
                                style="background: #FFD700; color: #333; border: none; padding: 8px 15px; 
                                border-radius: 20px; cursor: ${isApproved ? 'pointer' : 'not-allowed'}; 
                                font-weight: bold; display: flex; align-items: center; justify-content: center; 
                                gap: 5px; transition: all 0.3s ease; opacity: ${isApproved ? '1' : '0.5'};"
                                ${!isApproved ? 'disabled' : ''}>
                            <i class="fas fa-comment"></i>
                            ${isApproved ? 'مراسلة السائق' : 'غير متاح حالياً'}
                        </button>
                    </div>
                </div>
            `;

                    driverMarker.bindPopup(popupContent, {
                        maxWidth: 300,
                        className: 'custom-popup'
                    }).openPopup();

                    scrollToMap();

                    // تعديل رسالة التأكيد حسب حالة الموافقة
                    if (isApproved) {
                        Swal.fire({
                            title: '🚖 تم تحديد موقع السائق!',
                            html: `
                        <p style="font-size: 1rem; color: #555;">
                            السائق <b>${driver.name}</b> بانتظارك.
                        </p>
                        <p style="color: #666;">هل ترغب بمراسلته الآن؟</p>
                    `,
                            icon: 'success',
                            showCancelButton: true,
                            confirmButtonColor: '#FFD700',
                            cancelButtonColor: '#6c757d',
                            confirmButtonText: '📨 نعم، مراسلة السائق',
                            cancelButtonText: '❌ إغلاق',
                        }).then((result) => {
                            if (result.isConfirmed) {
                                openChatWindow(driverId);
                            }
                        });
                    } else {
                        Swal.fire({
                            title: 'تنبيه!',
                            html: `
                        <p style="font-size: 1rem; color: #555;">
                            السائق <b>${driver.name}</b> ${isPending ? 'قيد المراجعة' : 'غير مفعل حالياً'}.
                        </p>
                        <p style="color: #666;">لا يمكن التواصل مع السائق حتى يتم تفعيل حسابه.</p>
                    `,
                            icon: 'warning',
                            confirmButtonColor: '#6c757d',
                            confirmButtonText: 'حسناً'
                        });
                    }
                } else {
                    showToast('لم يتم العثور على موقع السائق.', 'error');
                }
            });
        }

    // تهيئة الخريطة
    function initMap() {
        const defaultLocation = [33.3152, 44.3661]; // بغداد

        map = L.map('map', {
            center: defaultLocation,
            zoom: 8,
            zoomControl: false
        });

        // تعريف طبقات الخريطة المختلفة
        const layers = {
            street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri',
                maxZoom: 19
            }),
            dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '© CartoDB',
                maxZoom: 19
            })
        };

        // إضافة الطبقة الافتراضية
        layers.street.addTo(map);

        // إضافة زر التحكم بالطبقات
        L.control.layers({
            "خريطة الشوارع": layers.street,
            "قمر صناعي": layers.satellite,
            "خريطة داكنة": layers.dark
        }, null, {
            position: 'topleft',
            collapsed: true
        }).addTo(map);

        // إضافة زر موقع المستخدم
        const locationButton = L.control({ position: 'bottomright' });
        locationButton.onAdd = function () {
            const btn = L.DomUtil.create('button', 'user-location-btn');
            btn.innerHTML = '<i class="fas fa-location-arrow"></i>';
            btn.title = 'تحديد موقعك الحالي';
            btn.onclick = function () {
                getCurrentLocation();
            };
            return btn;
        };
        locationButton.addTo(map);

        // إضافة زر التكبير/التصغير
        L.control.zoom({
            position: 'bottomright',
            zoomInTitle: 'تكبير',
            zoomOutTitle: 'تصغير'
        }).addTo(map);

        // إضافة مقياس المسافة
        L.control.scale({
            position: 'bottomleft',
            metric: true,
            imperial: false,
            maxWidth: 200
        }).addTo(map);
        
        // إضافة زر آخر المواقع المشتركة
        addRecentLocationsControl();

        // إضافة طبقات الخريطة
        markerLayer = L.layerGroup().addTo(map);
        routeLayer = L.layerGroup().addTo(map);

        // إضافة مستمع لتغيير الطبقة
        map.on('baselayerchange', function (e) {
            console.log('تم تغيير نوع الخريطة إلى:', e.name);
            // يمكنك إضافة أي منطق إضافي هنا عند تغيير نوع الخريطة
        });
    }

        // دالة تحديد موقع المستخدم محسنة
        async function getCurrentLocation() {
            if (!navigator.geolocation) {
                showToast('خدمة تحديد الموقع غير متوفرة في متصفحك', 'error');
                return;
            }

            try {
                showLoading();
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });

                const { latitude: userLat, longitude: userLng } = position.coords;

                // الحصول على العنوان التقريبي باستخدام Nominatim
                const addressResponse = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?lat=${userLat}&lon=${userLng}&format=json&accept-language=ar`
                );
                const addressData = await addressResponse.json();

                // إنشاء أيقونة محسنة للموقع
                const userIcon = L.divIcon({
                    html: `
                <div class="user-marker-container">
                    <i class="fas fa-user-circle"></i>
                    <div class="pulse"></div>
                </div>
            `,
                    className: 'user-marker',
                    iconSize: [40, 40]
                });

                // إنشاء محتوى النافذة المنبثقة المحسن
                const popupContent = `
            <div class="location-popup">
                <div class="location-header">
                    <i class="fas fa-map-marker-alt"></i>
                    <h6>موقعك الحالي</h6>
                </div>
                <div class="location-details">
                    <div class="location-address">
                        <i class="fas fa-map"></i>
                        <span>${addressData.display_name || 'العنوان غير متوفر'}</span>
                    </div>
                    <div class="location-accuracy">
                        <i class="fas fa-crosshairs"></i>
                        <span>دقة تحديد الموقع: ${Math.round(position.coords.accuracy)} متر</span>
                    </div>
                </div>
            </div>
        `;

                // تحديث أو إنشاء علامة الموقع
                if (userMarker) {
                    userMarker.setLatLng([userLat, userLng]);
                    userMarker.setPopupContent(popupContent);
                } else {
                    userMarker = L.marker([userLat, userLng], {
                        icon: userIcon,
                        zIndexOffset: 1000
                    })
                        .bindPopup(popupContent)
                        .addTo(map);
                }

                // تحريك الخريطة بتأثير حركي
                map.flyTo([userLat, userLng], 16, {
                    duration: 1.5,
                    easeLinearity: 0.25
                });

                hideLoading();
                showToast('تم تحديد موقعك بنجاح', 'success');

                // تحديث الإحداثيات في النموذج إذا كان موجوداً
                const latInput = document.getElementById('driverLatitude');
                const lngInput = document.getElementById('driverLongitude');
                if (latInput && lngInput) {
                    latInput.value = userLat;
                    lngInput.value = userLng;
                }

                return { lat: userLat, lng: userLng };
            } catch (error) {
                hideLoading();
                handleLocationError(error);
                return null;
            }
        }

        // دالة رسم المسار محدثة لاستخدام OSRM
        async function drawRoute(fromLocation, toLocation) {
            try {
                routeLayer.clearLayers();

                const start = `${fromLocation.lng},${fromLocation.lat}`;
                const end = `${toLocation.lng},${toLocation.lat}`;

                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/${start};${end}?overview=full&geometries=geojson`
                );

                const data = await response.json();

                if (data.code === 'Ok' && data.routes && data.routes[0]) {
                    const route = data.routes[0];
                    const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);

                    // رسم المسار مع تأثيرات حركية
                    const routeLine = L.polyline(coordinates, {
                        color: '#FFD700',
                        weight: 5,
                        opacity: 0.8,
                        lineCap: 'round',
                        lineJoin: 'round',
                        className: 'animated-route'
                    }).addTo(routeLayer);

                    // إضافة علامات البداية والنهاية مع تصميم محسن
                    const markers = {
                        start: {
                            latlng: [fromLocation.lat, fromLocation.lng],
                            icon: createMarkerIcon('start'),
                            popup: createPopupContent('نقطة الانطلاق', route.duration, 0)
                        },
                        end: {
                            latlng: [toLocation.lat, toLocation.lng],
                            icon: createMarkerIcon('end'),
                            popup: createPopupContent('نقطة الوصول', route.duration, route.distance)
                        }
                    };

                    // إضافة العلامات للخريطة
                    Object.values(markers).forEach(marker => {
                        L.marker(marker.latlng, { icon: marker.icon })
                            .bindPopup(marker.popup)
                            .addTo(routeLayer);
                    });

                    // تحريك الخريطة لإظهار المسار كاملاً
                    map.fitBounds(routeLine.getBounds(), {
                        padding: [50, 50],
                        animate: true,
                        duration: 1
                    });

                    // إضافة معلومات الرحلة
                    addRouteInfo({
                        distance: route.distance,
                        duration: route.duration,
                        startLocation: fromLocation,
                        endLocation: toLocation
                    });

                    return {
                        distance: route.distance,
                        duration: route.duration,
                        coordinates: coordinates
                    };
                }

                throw new Error('لم يتم العثور على مسار');
            } catch (error) {
                console.error('Error drawing route:', error);
                showToast('حدث خطأ في رسم المسار', 'error');
                return null;
            }
        }

        // دالة إنشاء أيقونة العلامة
        function createMarkerIcon(type) {
            const colors = {
                start: '#28a745',
                end: '#dc3545'
            };

            const icons = {
                start: 'map-marker-alt',
                end: 'flag-checkered'
            };

            return L.divIcon({
                html: `
            <div class="marker-icon ${type}-marker">
                <i class="fas fa-${icons[type]}" style="color: ${colors[type]}"></i>
            </div>
        `,
                className: '',
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });
        }

        // دالة إنشاء محتوى النافذة المنبثقة
        function createPopupContent(title, duration, distance) {
            return `
        <div class="route-popup">
            <h6>${title}</h6>
            <p><i class="fas fa-clock"></i> ${formatDuration(duration)}</p>
            ${distance ? `<p><i class="fas fa-road"></i> ${formatDistance(distance)}</p>` : ''}
        </div>
    `;
        }

        // دالة إضافة معلومات المسار
        function addRouteInfo(info) {
            const container = document.createElement('div');
            container.className = 'route-info-container';
            container.innerHTML = `
        <div class="route-info">
            <h6>معلومات الرحلة</h6>
            <div class="info-item">
                <i class="fas fa-road"></i>
                <span>المسافة: ${formatDistance(info.distance)}</span>
            </div>
            <div class="info-item">
                <i class="fas fa-clock"></i>
                <span>الوقت المتوقع: ${formatDuration(info.duration)}</span>
            </div>
            <div class="info-item">
                <i class="fas fa-money-bill-wave"></i>
                <span>التكلفة التقريبية: ${calculateFare(info.distance)} د.ع</span>
            </div>
        </div>
    `;

            // إضافة المعلومات للخريطة
            const control = L.control({ position: 'bottomleft' });
            control.onAdd = () => container;
            control.addTo(map);




        }

        // دوال مساعدة لتنسيق المسافة والوقت
        function formatDistance(meters) {
            return meters >= 1000
                ? `${(meters / 1000).toFixed(1)} كم`
                : `${Math.round(meters)} متر`;
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);

            if (hours > 0) {
                return `${hours} ساعة ${minutes} دقيقة`;
            }
            return `${minutes} دقيقة`;
        }

        // دالة حساب التكلفة التقريبية
        function calculateFare(distance) {
            const baseRate = 5000; // السعر الأساسي
            const ratePerKm = 1000; // السعر لكل كيلومتر
            const distanceInKm = distance / 1000;

            return Math.round(baseRate + (distanceInKm * ratePerKm)).toLocaleString();
        }

        // دالة معالجة أخطاء تحديد الموقع
        function handleLocationError(error) {
            let message = 'حدث خطأ في تحديد الموقع';

            switch (error.code) {
                case error.PERMISSION_DENIED:
                    message = 'تم رفض الوصول إلى خدمة تحديد الموقع';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'معلومات الموقع غير متوفرة';
                    break;
                case error.TIMEOUT:
                    message = 'انتهت مهلة طلب تحديد الموقع';
                    break;
            }

            showToast(message, 'error');
        }
        function updateUserLocation(position) {
            const newLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
            };

            // تحقق إذا تغير الموقع بما يكفي لتحديث الخريطة
            if (!userLocation || Math.abs(newLocation.lat - userLocation.lat) > 0.0001 || Math.abs(newLocation.lng - userLocation.lng) > 0.0001) {
                userLocation = newLocation;

                // تحديث علامة المستخدم فقط إذا تغير الموقع
                const userIcon = L.divIcon({
                    html: '<i class="fas fa-user-circle fa-5x" style="color: #007bff;"></i>',
                    className: 'user-marker',
                    iconSize: [30, 30],
                });

                if (!userMarker) {
                    userMarker = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon })
                        .bindPopup('موقعك الحالي')
                        .addTo(map);
                } else {
                    userMarker.setLatLng([userLocation.lat, userLocation.lng]);
                }

                // تحديث الخريطة مرة واحدة فقط
                map.setView([userLocation.lat, userLocation.lng], 13);

                // تحميل السائقين إذا كان الموقع جديدًا
                loadDrivers();
            }
        }

        async function updateUserLocation(position) {
            try {
                const newLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };

                // تحقق من التغير الكبير في الموقع
                const hasSignificantChange = !userLocation ||
                    Math.abs(newLocation.lat - userLocation.lat) > 0.0001 ||
                    Math.abs(newLocation.lng - userLocation.lng) > 0.0001;

                if (hasSignificantChange) {
                    userLocation = newLocation;

                    // تحديث أيقونة المستخدم مع تأثيرات حركية
                    const userIcon = L.divIcon({
                        html: `
                        <div class="user-location-marker">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="accuracy-circle" style="width: ${newLocation.accuracy}px; height: ${newLocation.accuracy}px;"></div>
                            <div class="pulse-circle"></div>
                        </div>
                    `,
                        className: 'user-location-icon',
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    });

                    // محاولة الحصول على العنوان التقريبي
                    let addressInfo = 'جاري تحديد العنوان...';
                    try {
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/reverse?lat=${newLocation.lat}&lon=${newLocation.lng}&format=json&accept-language=ar`
                        );
                        const data = await response.json();
                        addressInfo = data.display_name || 'العنوان غير متوفر';
                    } catch (error) {
                        console.error('Error fetching address:', error);
                        addressInfo = 'تعذر تحديد العنوان';
                    }

                    // إنشاء محتوى النافذة المنبثقة
                    const popupContent = `
                    <div class="user-location-popup">
                        <div class="location-header">
                            <i class="fas fa-location-arrow"></i>
                            <h6>موقعك الحالي</h6>
                        </div>
                        <div class="location-info">
                            <div class="info-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${addressInfo}</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-compass"></i>
                                <span>دقة التحديد: ${Math.round(newLocation.accuracy)} متر</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-clock"></i>
                                <span>آخر تحديث: ${new Date().toLocaleTimeString('ar-IQ')}</span>
                            </div>
                        </div>
                    </div>
                `;

                    // تحديث أو إنشاء علامة الموقع
                    if (!userMarker) {
                        userMarker = L.marker([userLocation.lat, userLocation.lng], {
                            icon: userIcon,
                            zIndexOffset: 1000
                        })
                            .bindPopup(popupContent)
                            .addTo(map);
                    } else {
                        userMarker.setIcon(userIcon);
                        userMarker.setLatLng([userLocation.lat, userLocation.lng]);
                        userMarker.getPopup().setContent(popupContent);
                    }

                    // تحريك الخريطة بتأثير سلس
                    map.flyTo([userLocation.lat, userLocation.lng], 16, {
                        duration: 1.5,
                        easeLinearity: 0.25
                    });

                    // تحديث قائمة السائقين
                    await loadDrivers();

                    // عرض إشعار نجاح التحديث
                    showToast('تم تحديث موقعك بنجاح', 'success');
                }
            } catch (error) {
                console.error('Error updating location:', error);
                showToast('حدث خطأ في تحديث الموقع', 'error');
            }
        }
        function calculateDistance(userLocation, driverLocation) {
            // التحقق من وجود الإحداثيات
            if (!userLocation || !driverLocation || !userLocation.lat || !userLocation.lng || !driverLocation.lat || !driverLocation.lng) {
                return null;
            }

            const R = 6371; // نصف قطر الأرض بالكيلومترات
            const dLat = toRad(driverLocation.lat - userLocation.lat);
            const dLon = toRad(driverLocation.lng - userLocation.lng);
            const lat1 = toRad(userLocation.lat);
            const lat2 = toRad(driverLocation.lat);

            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1) * Math.cos(lat2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;

            return Math.round(distance * 10) / 10; // تقريب إلى أقرب 0.1 كم
        }

        function toRad(degrees) {
            return degrees * Math.PI / 180;
        }

        // قاموس يحتوي على إحداثيات المحافظات والمناطق العراقية
        const locationCoordinates = {
            "بغداد": { lat: 33.3152, lng: 44.3661 },
            "الكرخ": { lat: 33.3024, lng: 44.3937 },
            "الرصافة": { lat: 33.3319, lng: 44.4445 },
            "البصرة": { lat: 30.5085, lng: 47.7804 },
            "نينوى": { lat: 36.3359, lng: 43.1194 },
            "الموصل": { lat: 36.3359, lng: 43.1194 },
            "النجف": { lat: 31.9892, lng: 44.3405 },
            "الكوفة": { lat: 32.0343, lng: 44.4019 },
            "كربلاء": { lat: 32.6101, lng: 44.0241 },
            "الحسينية": { lat: 32.6239, lng: 44.0179 },
            "أربيل": { lat: 36.1901, lng: 44.0091 },
            "كركوك": { lat: 35.4681, lng: 44.3923 },
            "الأنبار": { lat: 33.3784, lng: 43.1441 },
            "الرمادي": { lat: 33.4250, lng: 43.3001 },
            "الفلوجة": { lat: 33.3538, lng: 43.7789 },
            "بابل": { lat: 32.4680, lng: 44.4491 },
            "الحلة": { lat: 32.4689, lng: 44.4217 },
            "المسيب": { lat: 32.8471, lng: 44.2907 },
            "الهاشمية": { lat: 32.2482, lng: 44.6027 },
            "القاسم": { lat: 32.2973, lng: 44.5907 },
            "ديالى": { lat: 33.7752, lng: 44.6451 },
            "بعقوبة": { lat: 33.7474, lng: 44.6537 },
            "ذي قار": { lat: 31.0529, lng: 46.2590 },
            "الناصرية": { lat: 31.0529, lng: 46.2590 },
            "السليمانية": { lat: 35.5556, lng: 45.4350 },
            "صلاح الدين": { lat: 34.6108, lng: 43.6782 },
            "تكريت": { lat: 34.6707, lng: 43.6789 },
            "واسط": { lat: 32.5141, lng: 45.8206 },
            "الكوت": { lat: 32.5141, lng: 45.8206 },
            "ميسان": { lat: 31.8389, lng: 47.1451 },
            "العمارة": { lat: 31.8389, lng: 47.1451 },
            "المثنى": { lat: 31.3289, lng: 45.2792 },
            "السماوة": { lat: 31.3199, lng: 45.2847 },
            "دهوك": { lat: 36.8695, lng: 42.9505 },
            "القادسية": { lat: 31.9889, lng: 44.9252 },
            "الديوانية": { lat: 31.9889, lng: 44.9252 }
        };

        function getCoordinatesForLocation(location) {
            // تحقق من وجود الموقع في القاموس
            if (locationCoordinates[location]) {
                return locationCoordinates[location];
            }

            // إذا لم يتم العثور على الموقع، نرجع إحداثيات بغداد كقيمة افتراضية
            console.warn(`لم يتم العثور على إحداثيات لـ ${location}، سيتم استخدام إحداثيات بغداد`);
            return locationCoordinates["بغداد"];
        }

        async function handleAddDriver(event) {
    event.preventDefault();
    showLoading();

    try {
        // التحقق من تطابق كلمات المرور
        const email = document.getElementById('driverEmail').value;
        const password = document.getElementById('driverPassword').value;
        const confirmPassword = document.getElementById('confirmDriverPassword').value;

        if (!email || !password) {
            throw new Error('يرجى إدخال البريد الإلكتروني وكلمة المرور');
        }

        if (password !== confirmPassword) {
            throw new Error('كلمات المرور غير متطابقة');
        }

        // التحقق من تحميل جميع المستندات المطلوبة
        const requiredFiles = {
            'idCardFront': 'صورة الهوية الأمامية',
            'idCardBack': 'صورة الهوية الخلفية',
            'residenceFront': 'صورة بطاقة السكن الأمامية',
            'residenceBack': 'صورة بطاقة السكن الخلفية',
            'licenseFront': 'صورة إجازة السوق الأمامية',
            'licenseBack': 'صورة إجازة السوق الخلفية',
            'driverImage': 'الصورة الشخصية'
        };

        const uploadedFiles = {};
        for (const [fileId, description] of Object.entries(requiredFiles)) {
            const fileInput = document.getElementById(fileId);
            if (!fileInput.files || !fileInput.files[0]) {
                throw new Error(`الرجاء تحميل ${description}`);
            }
            uploadedFiles[fileId] = fileInput.files[0];
        }

        // الحصول على الإحداثيات
        const latitude = parseFloat(document.getElementById('driverLatitude').value);
        const longitude = parseFloat(document.getElementById('driverLongitude').value);

        if (!latitude || !longitude) {
            throw new Error('يرجى تحديد موقع السائق أولاً');
        }

        // 1. إنشاء حساب المستخدم في Firebase Authentication
        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
        const uid = userCredential.user.uid;

        // رفع جميع الملفات إلى Firebase Storage
        const uploadPromises = {};
        for (const [fileId, file] of Object.entries(uploadedFiles)) {
            const fileRef = storage.ref(`drivers/documents/${uid}/${Date.now()}_${fileId}_${file.name}`);
            uploadPromises[fileId] = fileRef.put(file).then(snapshot => snapshot.ref.getDownloadURL());
        }

        const uploadedUrls = await Promise.all(Object.values(uploadPromises));
        const documentUrls = {};
        Object.keys(uploadPromises).forEach((key, index) => {
            documentUrls[key] = uploadedUrls[index];
        });

        // تجهيز بيانات السائق
        const driverData = {
            uid: uid, // إضافة معرف المستخدم من Authentication
            email: email, // إضافة البريد الإلكتروني
            name: document.getElementById('driverName').value,
            phone: document.getElementById('driverPhone').value,
            carType: document.getElementById('carType').value,
            carModel: document.getElementById('carModel').value,
            location: document.getElementById('driverLocation').value,
            coordinates: {
                lat: latitude,
                lng: longitude
            },
            bio: document.getElementById('driverBio').value,
            imageUrl: documentUrls.driverImage,
            documents: {
                idCard: {
                    front: documentUrls.idCardFront,
                    back: documentUrls.idCardBack
                },
                residenceCard: {
                    front: documentUrls.residenceFront,
                    back: documentUrls.residenceBack
                },
                driverLicense: {
                    front: documentUrls.licenseFront,
                    back: documentUrls.licenseBack
                }
            },
            rating: 5,
            trips: 0,
            approved: false,
            approvalStatus: 'pending',
            active: false,
            registrationDate: firebase.database.ServerValue.TIMESTAMP,
            lastUpdate: firebase.database.ServerValue.TIMESTAMP,
            role: 'driver' // إضافة دور المستخدم
        };

        // 2. حفظ البيانات في قاعدة البيانات الرئيسية
        await database.ref(`drivers/${uid}`).set(driverData);

        // 3. حفظ المعلومات في قسم المستخدمين أيضًا للتحقق من الأدوار
        await database.ref(`users/${uid}`).set({
            uid: uid,
            email: email,
            name: driverData.name,
            phone: driverData.phone,
            imageUrl: driverData.imageUrl,
            role: 'driver',
            registrationDate: firebase.database.ServerValue.TIMESTAMP
        });

        // 4. تحديث ملف تعريف المستخدم في Authentication
        await userCredential.user.updateProfile({
            displayName: driverData.name,
            photoURL: driverData.imageUrl
        });

        // 5. إرسال إشعار إلى نظام الإشعارات حول السائق الجديد
        sendNotificationToAllUsers({
            type: 'new_driver',
            title: 'سائق جديد في منطقتك',
            message: `انضم السائق ${driverData.name} إلى منطقة ${driverData.location}`,
            icon: driverData.imageUrl,
            driverId: uid,
            timestamp: Date.now(),
            location: driverData.location
        });

        // إرسال بريد تأكيد الحساب
        await userCredential.user.sendEmailVerification();

        // إغلاق النافذة المنبثقة
        const modal = bootstrap.Modal.getInstance(document.getElementById('addDriverModal'));
        modal.hide();

        // إعادة تعيين النموذج
        document.getElementById('addDriverForm').reset();

        // إعادة تعيين معاينات الصور
        resetImagePreviews();

        // عرض رسالة نجاح
        Swal.fire({
            title: 'تم تقديم الطلب بنجاح!',
            html: `
                <div class="success-message">
                    <p>تم إنشاء حساب السائق وإرسال طلبك للمراجعة</p>
                    <p>تم إرسال بريد إلكتروني للتحقق إلى: ${email}</p>
                    <p>معرف السائق: ${uid}</p>
                    <small>سيتم مراجعة طلبك وتفعيل حسابك قريباً</small>
                </div>
            `,
            icon: 'success',
            confirmButtonText: 'حسناً',
            confirmButtonColor: '#FFD700'
        });

        // تحديث قائمة السائقين
        loadDrivers();

    } catch (error) {
        console.error('Error adding driver:', error);
        let errorMessage = error.message;

        // تحسين رسائل خطأ Firebase Authentication
        if (error.code === 'auth/email-already-in-use') {
            errorMessage = 'البريد الإلكتروني مستخدم بالفعل';
        } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'البريد الإلكتروني غير صالح';
        } else if (error.code === 'auth/weak-password') {
            errorMessage = 'كلمة المرور ضعيفة جدًا، يرجى استخدام كلمة مرور أقوى';
        }

        showToast(errorMessage, 'error');
    } finally {
        hideLoading();
    }
}

// دالة إرسال إشعار إلى جميع المستخدمين في منطقة محددة
function sendNotificationToAllUsers(notification) {
    // الحصول على قائمة المستخدمين
    database.ref('users').once('value').then(snapshot => {
        const users = snapshot.val();
        
        // إذا لم يكن هناك مستخدمين، الخروج
        if (!users) return;
        
        // إضافة الإشعار لكل مستخدم
        Object.keys(users).forEach(userId => {
            // التحقق مما إذا كان المستخدم في نفس المنطقة
            const userLocation = users[userId].location;
            
            // إذا لم يكن هناك معلومات عن الموقع أو المستخدم في نفس المنطقة
            if (!userLocation || isUserInSameLocation(userLocation, notification.location)) {
                // إضافة الإشعار لهذا المستخدم
                database.ref(`users/${userId}/notifications`).push(notification);
            }
        });
    });
}

// التحقق مما إذا كان المستخدم في نفس المنطقة
function isUserInSameLocation(userLocation, driverLocation) {
    // تحويل المواقع إلى نصوص للمقارنة
    const userLocationStr = typeof userLocation === 'string' ? 
        userLocation.toLowerCase() : JSON.stringify(userLocation).toLowerCase();
    const driverLocationStr = driverLocation.toLowerCase();
    
    // التحقق من وجود تطابق في الاسم
    return userLocationStr.includes(driverLocationStr) || 
           driverLocationStr.includes(userLocationStr);
}

        // دالة معاينة المستندات
        function previewDocument(input, previewId) {
            const preview = document.getElementById(previewId);
            const placeholder = input.parentElement.querySelector('.upload-placeholder');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // دالة إعادة تعيين معاينات الصور
        function resetImagePreviews() {
            const previews = document.querySelectorAll('img[id$="Preview"]');
            const placeholders = document.querySelectorAll('.upload-placeholder');

            previews.forEach(preview => {
                preview.src = '#';
                preview.style.display = 'none';
            });

            placeholders.forEach(placeholder => {
                placeholder.style.display = 'flex';
            });
        }

        function handleLocationError(error) {
            // التعامل مع خطأ في الموقع الجغرافي
            console.error('خطأ في تحديد الموقع:', error);
            showToast('تعذر الوصول إلى موقعك الحالي. الرجاء التحقق من إعدادات الموقع.', 'error');
        }




        // تحديث دالة createDriverCard لتشمل حالة الموافقة
        function createDriverMarkerPopup(driver, driverId) {
            // التحقق من حالة الموافقة
            const isApproved = driver.approved === true;
            const isPending = driver.approvalStatus === 'pending';
            const statusText = isApproved ? 'مفعل' : (isPending ? 'قيد المراجعة' : 'غير مفعل');
            const statusColor = isApproved ? '#2ECC40' : (isPending ? '#FFD700' : '#FF4136');

            return `
        <div class="driver-popup ${isApproved ? 'approved' : (isPending ? 'pending' : 'not-approved')}">
            <div class="driver-popup-header">
                <div class="popup-status" style="background-color: ${statusColor}; color: ${isApproved ? '#fff' : '#000'}">
                    ${statusText}
                </div>
                <img src="${driver.imageUrl || 'default-driver.png'}" 
                     alt="${driver.name}"
                     style="filter: ${!isApproved ? 'grayscale(100%)' : 'none'}; 
                            opacity: ${!isApproved ? '0.7' : '1'}">
                <h4>${driver.name}</h4>
                <div class="driver-rating">
                    <i class="fas fa-star"></i> ${driver.rating ? driver.rating.toFixed(1) : '5.0'}
                </div>
            </div>
            
            <div class="driver-popup-info">
                <p><i class="fas fa-car"></i> ${driver.carType} ${driver.carModel}</p>
                <p><i class="fas fa-map-marker-alt"></i> ${driver.location}</p>
                <p><i class="fas fa-phone"></i> ${driver.phone}</p>
            </div>

            <div class="driver-popup-actions">
                <button onclick="openChatWindow('${driverId}')" 
                        class="chat-btn ripple"
                        ${!isApproved ? 'disabled' : ''}>
                    <i class="fas fa-comment"></i>
                    مراسلة
                </button>
                <button onclick="bookDriver('${driverId}')"
                        class="book-btn ripple"
                        ${!isApproved ? 'disabled' : ''}>
                    <i class="fas fa-taxi"></i>
                    حجز
                </button>
            </div>

            ${!isApproved ? `
                <div class="approval-notice">
                    ${isPending ?
                        'هذا السائق قيد المراجعة. سيتم تفعيل الحساب قريباً.' :
                        'هذا الحساب غير مفعل. يرجى انتظار الموافقة.'}
                </div>
            ` : ''}
        </div>
    `;
        }


        // دالة تحديث عرض بطاقة السائق
        function createDriverCard(driver, key) {
            // التحقق من حالة الموافقة
            const isApproved = driver.approved === true;
            const isPending = driver.approvalStatus === 'pending';

            // تحديد الحالة وتصميم البطاقة
            const cardStatus = isApproved ? 'approved' : (isPending ? 'pending' : 'not-approved');
            const statusText = isApproved ? 'مفعل' : (isPending ? 'قيد المراجعة' : 'غير مفعل');
            const cardOpacity = isApproved ? '1' : '0.7';

            return `
        <div class="driver-card ${cardStatus}" data-driver-id="${key}" style="opacity: ${cardOpacity}">
            <!-- شريط الحالة -->
            <div class="status-banner ${cardStatus}">
                ${statusText}
            </div>

            <!-- صورة السائق -->
            <div class="driver-image-container">
                <img src="${driver.imageUrl || 'default-avatar.png'}" alt="${driver.name}" class="driver-image">
            </div>

            <!-- معلومات السائق -->
            <div class="driver-info">
                <h5 class="driver-name">${driver.name}</h5>
                <div class="driver-stats">
                    <div class="stat-item">
                        <div class="stat-value">
                            <i class="fas fa-star"></i> ${driver.rating ? driver.rating.toFixed(1) : '5.0'}
                        </div>
                        <div class="stat-label">التقييم</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">
                            <i class="fas fa-route"></i> ${driver.trips || 0}
                        </div>
                        <div class="stat-label">الرحلات</div>
                    </div>
                </div>
                <div class="driver-details">
                    <p><i class="fas fa-car"></i> ${driver.carType} - ${driver.carModel}</p>
                    <p><i class="fas fa-map-marker-alt"></i> ${driver.location}</p>
                </div>

                <!-- أزرار التفاعل -->
                <div class="driver-actions" ${!isApproved ? 'style="pointer-events: none; opacity: 0.7;"' : ''}>
                    <button class="action-btn primary" onclick="viewDriverLocation('${key}')" ${!isApproved ? 'disabled' : ''}>
                        <i class="fas fa-map-marker-alt"></i> الموقع
                    </button>
                    <button class="action-btn secondary" onclick="openChatWindow('${key}')" ${!isApproved ? 'disabled' : ''}>
                        <i class="fas fa-comment"></i> مراسلة
                    </button>
                </div>
            </div>
        </div>
    `;
        }

        // دالة مساعدة لتحويل الدرجات إلى راديان
        function toRad(degrees) {
            return degrees * Math.PI / 180;
        }

        function bookDriver(driverId) {
            showLoading();
            database.ref(`drivers/${driverId}`).once('value', (snapshot) => {
                const driver = snapshot.val();
                if (driver && driver.active) {
                    setTimeout(() => {
                        hideLoading();
                        database.ref(`drivers/${driverId}`).update({
                            active: false // تعيين الحالة إلى "مشغول"
                        }).then(() => {
                            showToast(`تم إرسال طلب الحجز إلى ${driver.name}`);
                            window.location.href = `tel:${driver.phone}`;
                            loadDrivers(); // تحديث حالة السائقين في الواجهة
                        });
                    }, 1500);
                } else {
                    hideLoading();
                    showToast('السائق غير متاح حالياً', 'error');
                }
            });
        }









        function scrollToMap() {
            const mapElement = document.getElementById('map');
            if (mapElement) {
                mapElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }




        function updateRequiredTrips(driverId, count) {
            const tripCount = parseInt(count, 10);
            if (isNaN(tripCount) || tripCount < 0) {
                showToast('الرجاء إدخال عدد صحيح للمشاوير', 'error');
                return;
            }

            database.ref(`drivers/${driverId}`).update({
                requiredTrips: tripCount
            }).then(() => {
                showToast('تم تحديث عدد المشاوير بنجاح');
            }).catch((error) => {
                console.error('Error updating required trips:', error);
                showToast('حدث خطأ أثناء تحديث عدد المشاوير', 'error');
            });
        }


        function setTripCount(driverId) {
            const modal = new bootstrap.Modal(document.getElementById('tripCountModal'));
            modal.show();

            document.getElementById('tripCountForm').onsubmit = async (event) => {
                event.preventDefault();
                const tripCount = document.getElementById('tripCount').value;

                try {
                    await database.ref(`drivers/${driverId}`).update({
                        tripsRequired: parseInt(tripCount)
                    });
                    showToast('تم تحديث عدد المشاوير بنجاح');
                    modal.hide();
                } catch (error) {
                    console.error('Error updating trip count:', error);
                    showToast('حدث خطأ أثناء تحديث عدد المشاوير', 'error');
                }
            };
        }
        // تحسين دالة حساب المسافة
        function calculateDistance(point1, point2) {
            if (!point1 || !point2 || !point1.lat || !point1.lng || !point2.lat || !point2.lng) {
                return null;
            }

            // تحويل الإحداثيات إلى راديان
            const lat1 = toRadians(point1.lat);
            const lon1 = toRadians(point1.lng);
            const lat2 = toRadians(point2.lat);
            const lon2 = toRadians(point2.lng);

            // صيغة هافرساين لحساب المسافة
            const R = 6371; // نصف قطر الأرض بالكيلومترات
            const dLat = lat2 - lat1;
            const dLon = lon2 - lon1;

            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1) * Math.cos(lat2) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;

            return distance;
        }

        // تحويل الدرجات إلى راديان
        function toRadians(degrees) {
            return degrees * (Math.PI / 180);
        }

        // تنسيق عرض المسافة
        function formatDistance(distance) {
            if (distance === null) return 'غير متوفر';
            if (distance < 1) {
                return `${Math.round(distance * 1000)} متر`;
            }
            return `${distance.toFixed(1)} كم`;
        }

        // تحديث دالة إنشاء بطاقة السائق مع المسافة المحسنة
        function createDriverCard(driver, key) {
            let distanceDisplay = 'غير متوفر';
            let distanceValue = null;

            if (userLocation && driver.coordinates) {
                distanceValue = calculateDistance(userLocation, driver.coordinates);
                distanceDisplay = formatDistance(distanceValue);
            }

            // ترتيب السائقين حسب المسافة
            const distanceClass = distanceValue !== null ?
                (distanceValue < 1 ? 'distance-near' :
                    distanceValue < 5 ? 'distance-medium' : 'distance-far') : '';

            return `
        <div class="driver-card ${distanceClass}" data-driver-id="${key}" data-distance="${distanceValue || 999999}">
            <div class="driver-image-container">
                <img src="${driver.imageUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" alt="${driver.name}" class="driver-image">
                <div class="driver-status ${driver.active ? 'status-active' : 'status-inactive'}">
                    ${driver.active ? 'متاح' : 'مشغول'}
                </div>
                <div class="distance-badge ${distanceClass}">
                    <i class="fas fa-map-marker-alt"></i>
                    ${distanceDisplay}
                </div>
            </div>
            <div class="driver-info">
                <h5 class="driver-name">${driver.name}</h5>
                <div class="driver-stats">
                    <div class="stat-item">
                        <div class="stat-value">
                            <i class="fas fa-star"></i>
                            ${driver.rating ? driver.rating.toFixed(1) : '5.0'}
                        </div>
                        <div class="stat-label">التقييم</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">
                            <i class="fas fa-route"></i>
                            ${driver.trips || 0}
                        </div>
                        <div class="stat-label">الرحلات</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">
                            ${distanceDisplay}
                        </div>
                        <div class="stat-label">المسافة</div>
                    </div>
                </div>
                <div class="text-muted">
                    <p class="mb-2">
                        <i class="fas fa-car me-2"></i>
                        ${driver.carType} ${driver.carModel}
                    </p>
                    <p class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        ${driver.location}
                    </p>
                </div>
            </div>
            <div class="driver-actions">
                <button class="action-btn primary" onclick="viewDriverLocation('${key}')">
                    <i class="fas fa-map-marker-alt"></i>
                    عرض الموقع
                </button>
                <button class="action-btn secondary" onclick="openChatWindow('${key}')">
                    <i class="fas fa-comment"></i>
                    مراسلة
                </button>
            </div>
        </div>
    `;
        }


        // تحديث دالة تحميل السائقين
        function loadDrivers(location = 'all') {
            if (isLoadingDrivers) return;
            isLoadingDrivers = true;
            showLoading();

            database.ref('drivers').once('value')
                .then((snapshot) => {
                    const driversGrid = document.getElementById('driversGrid');
                    driversGrid.innerHTML = '';
                    markerLayer.clearLayers();

                    snapshot.forEach((childSnapshot) => {
                        const driver = childSnapshot.val();
                        const driverId = childSnapshot.key;

                        if (location === 'all' || driver.location === location) {
                            // إضافة بطاقة السائق
                            const driverCard = createDriverCard(driver, driverId);
                            driversGrid.appendChild(driverCard);

                            // إضافة علامة السائق على الخريطة
                            if (driver.coordinates) {
                                const { lat, lng } = driver.coordinates;
                                const marker = createDriverMarker(driver, driverId, [lat, lng]);
                                marker.bindPopup(createDriverMarkerPopup(driver, driverId));
                                marker.addTo(markerLayer);
                            }
                        }
                    });
                })
                .catch((error) => {
                    console.error('Error loading drivers:', error);
                    showToast('حدث خطأ في تحميل بيانات السائقين', 'error');
                })
                .finally(() => {
                    hideLoading();
                    isLoadingDrivers = false;
                });
        }



        // تحديث CSS للعناصر المقيدة
        const style = document.createElement('style');
        style.textContent = `
    .driver-card.not-approved {
        opacity: 0.7;
        filter: grayscale(100%);
    }

    .driver-card.pending {
        opacity: 0.85;
        filter: grayscale(30%);
    }

    .driver-card.not-approved .driver-actions button,
    .driver-card.pending .driver-actions button {
        pointer-events: none;
        opacity: 0.5;
        cursor: not-allowed;
    }

    .approval-notice {
        background: rgba(255, 0, 0, 0.1);
        color: #FF4136;
        padding: 10px;
        margin-top: 10px;
        border-radius: 5px;
        text-align: center;
        font-size: 0.9rem;
    }

    .driver-popup.not-approved img,
    .driver-popup.pending img {
        filter: grayscale(100%);
        opacity: 0.7;
    }

    .driver-popup.not-approved button,
    .driver-popup.pending button {
        opacity: 0.5;
        cursor: not-allowed;
    }
`;
        document.head.appendChild(style);
        function toRad(degrees) {
            return degrees * Math.PI / 180;
        }

        function loadDrivers(location = 'all') {
            if (isLoadingDrivers) return;
            isLoadingDrivers = true;

            showLoading();
            const driversRef = database.ref('drivers');

            driversRef.once('value')
                .then((snapshot) => {
                    const driversGrid = document.getElementById('driversGrid');
                    driversGrid.innerHTML = '';
                    markerLayer.clearLayers();

                    snapshot.forEach((childSnapshot) => {
                        const driver = childSnapshot.val();
                        if (location === 'all' || driver.location === location) {
                            driversGrid.innerHTML += createDriverCard(driver, childSnapshot.key);

                            if (driver.coordinates) {
                                const { lat, lng } = driver.coordinates;

                                // إنشاء العلامة بمعلومات السائق
                                const driverMarker = L.marker([lat, lng], {
                                    icon: L.divIcon({
                                        html: `<img src="${driver.imageUrl}" 
                                              alt="صورة السائق" 
                                              style="width: 35px; height: 35px; border-radius: 50%; border: 2px solid #FFD700;">`,
                                        className: 'driver-marker',
                                        iconSize: [40, 40],
                                    }),
                                }).addTo(markerLayer);

                                // تحديث النافذة المنبثقة
                                driverMarker.bindPopup(`
                            <div style="text-align: center;">
                                <div style="margin-bottom: 10px;">
                                    <img src="${driver.imageUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" 
                                         alt="صورة السائق" 
                                         style="width: 70px; height: 70px; border-radius: 50%; border: 3px solid #FFD700; margin-bottom: 10px;">
                                    <h6 style="margin: 5px 0; font-weight: bold;">${driver.name}</h6>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                                    <div>
                                        <i class="fas fa-star" style="color: #FFD700;"></i>
                                        ${driver.rating ? driver.rating.toFixed(1) : '5.0'}
                                    </div>
                                    <div>
                                        <i class="fas fa-route"></i>
                                        ${driver.trips || 0}
                                    </div>
                                </div>

                                <div style="margin-bottom: 10px;">
                                    <p style="margin: 5px 0;">🚗 ${driver.carType} - ${driver.carModel}</p>
                                    <p style="margin: 5px 0;">📍 ${driver.location}</p>
                                </div>

                                <button onclick="openChatWindow('${childSnapshot.key}')" 
                                        style="background: #FFD700; color: #333; border: none; 
                                               padding: 8px 15px; border-radius: 20px; width: 100%;
                                               cursor: pointer; display: flex; align-items: center; 
                                               justify-content: center; gap: 5px; font-weight: bold;"
                                        ${!driver.approved ? 'disabled' : ''}>
                                    <i class="fas fa-comment"></i>
                                    مراسلة السائق
                                </button>
                            </div>
                        `, {
                                    maxWidth: 250
                                });
                            }
                        }
                    });

                    hideLoading();
                })
                .catch((error) => {
                    console.error('Error loading drivers:', error);
                    showToast('حدث خطأ في تحميل بيانات السائقين', 'error');
                })
                .finally(() => {
                    isLoadingDrivers = false;
                });
        }

        // تعديل دالة createDriverCard هذه الاكواد الخاصه بالمراسله بين بطاقه السائق والمستخدم تتحكم هذه الاكواد في الواجهيه بالبطاقه السائق وعملها في المراسله واستقبال الرسائل بين المستخدم والسابق
        function createDriverCard(driver, key) {
            // التحقق من حالة الموافقة والنشاط
            const isApproved = driver.approved === true;
            const isPending = driver.approvalStatus === 'pending';
            const isActive = driver.active && isApproved;

            // تحديد نص وألوان الحالة
            const statusText = !isApproved ? (isPending ? 'قيد المراجعة' : 'غير مفعل') :
            (isActive ? 'متاح' : 'مشغول');
            const statusColor = !isApproved ? '#FFD700' :
            (isActive ? '#2ECC40' : '#FF4136');

            // تحديد حالة التعتيم للبطاقة
            const cardOpacity = isApproved ? '1' : '0.7';

            // الحصول على معلومات المستخدم المسجل حالياً
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
            const isCurrentDriver = currentUser.uid === key && currentUser.role === 'driver';

            // إضافة عداد الرسائل غير المقروءة للسائق فقط
            let unreadMessagesCount = 0;
            let unreadMessagesHtml = '';

            // إذا كان المستخدم الحالي هو السائق، نضيف عداد الرسائل
            if (isCurrentDriver) {
            unreadMessagesHtml = `
            <span class="message-badge position-absolute top-0 end-0 translate-middle badge rounded-pill bg-danger d-none">
            0
            </span>
        `;

            // هنا سنقوم بتحديث عداد الرسائل لاحقاً من خلال دالة getUnreadMessagesCount
            updateDriverMessageBadge(key);
            }

            return `
        <div class="driver-card animate__animated animate__fadeIn" 
             data-driver-id="${key}"
             style="background-color: #1a1a1a; color: #FFFFFF; border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); overflow: hidden; 
            opacity: ${cardOpacity}; position: relative;">
            
            ${!isApproved ? `
            <div style="position: absolute; top: 10px; right: -30px; transform: rotate(45deg);
               background: ${isPending ? '#FFD700' : '#dc3545'}; color: ${isPending ? '#000' : '#fff'};
               padding: 5px 35px; z-index: 10; font-weight: bold;">
            ${statusText}
            </div>
            ` : ''}
            <div class="driver-image-container" style="position: relative; height: 200px;">
            <img src="${driver.imageUrl}" alt="${driver.name}" 
             class="driver-image" style="width: 100%; height: 100%; object-fit: cover; 
             border-bottom: 3px solid #FFD700; ${!isApproved ? 'filter: grayscale(50%);' : ''}">
            ${isApproved ? `
            <div class="driver-status ${isActive ? 'status-active' : 'status-inactive'}" 
             style="position: absolute; top: 10px; right: 10px; padding: 5px 10px; 
            border-radius: 20px; background: rgba(255, 255, 255, 0.8); 
            font-weight: bold; color: ${statusColor};">
            ${isActive ? 'متاح' : 'مشغول'}
            </div>
            ` : ''}
            </div>

            <div class="driver-info" style="padding: 15px;">
            <h5 class="driver-name" style="font-size: 1.2rem; font-weight: bold; 
                 margin-bottom: 10px; color: #FFD700;">
            ${driver.name}
            </h5>
            
            <div class="driver-stats" style="display: flex; justify-content: space-between; 
                   margin-bottom: 15px;">
            <div class="stat-item" style="text-align: center;">
            <div class="stat-value" style="font-weight: bold; color: #FFD700;">
            <i class="fas fa-star"></i> ${driver.rating ? driver.rating.toFixed(1) : '5.0'}
            </div>
            <div class="stat-label" style="font-size: 0.8rem; color: #FFFFFF;">التقييم</div>
            </div>
            <div class="stat-item" style="text-align: center;">
            <div class="stat-value" style="font-weight: bold; color: #FFFFFF;">
            <i class="fas fa-route"></i> ${driver.trips || 0}
            </div>
            <div class="stat-label" style="font-size: 0.8rem; color: #FFFFFF;">الرحلات</div>
            </div>
            <div class="stat-item" style="text-align: center;">
            <div class="stat-value" style="font-weight: bold; color: #FFFFFF;">
            ${driver.distance ? `${driver.distance.toFixed(1)} كم` : '--'}
            </div>
            <div class="stat-label" style="font-size: 0.8rem; color: #FFFFFF;">المسافة</div>
            </div>
            </div>

            <div class="text-muted" style="color: #FFFFFF; margin-bottom: 15px;">
            <p class="mb-2">
            <i class="fas fa-car me-2" style="color: #FFD700;"></i>
            ${driver.carType} ${driver.carModel}
            </p>
            <p class="mb-0">
            <i class="fas fa-map-marker-alt me-2" style="color: #FFD700;"></i>
            ${driver.location}
            </p>
            </div>
            </div>

            <div class="driver-actions" style="display: flex; justify-content: space-between; 
                 padding: 10px; ${!isApproved ? 'pointer-events: none; opacity: 0.7;' : ''}">
            <button class="action-btn primary" onclick="viewDriverLocation('${key}')">
            <i class="fas fa-map-marker-alt"></i>
            عرض الموقع
            </button>
            
            <button class="action-btn secondary position-relative" 
            onclick="${isCurrentDriver ? `showDriverMessages('${key}')` : `openChatWindow('${key}')`}"
            style="background: #333; color: #FFD700; padding: 10px 20px; 
               border-radius: 20px; border: 1px solid #FFD700; 
               cursor: pointer; font-weight: bold; transition: all 0.3s;"
            ${!isApproved ? 'disabled' : ''}>
            <i class="fas fa-comment"></i> ${isCurrentDriver ? 'الرسائل' : 'مراسلة'}
            ${isCurrentDriver ? unreadMessagesHtml : ''}
            </button>
            
            ${isCurrentDriver ? `
            <button class="action-btn toggle-status-btn" 
            onclick="toggleDriverStatus('${key}', ${isActive})"
            style="background: ${isActive ? '#FF4136' : '#2ECC40'}; color: #FFFFFF; padding: 10px 20px; 
               border-radius: 20px; border: none; cursor: pointer; font-weight: bold; transition: all 0.3s;">
            ${isActive ? 'تعطيل' : 'تفعيل'}
            </button>
            ` : ''}
            </div>

            <button class="action-btn favorite-btn" 
            onclick="addToFavorites('${key}')"
            style="position: absolute; top: 10px; left: 10px; background: #FFD700; color: #000; padding: 5px 10px; 
               border-radius: 20px; border: none; cursor: pointer; font-weight: bold; transition: all 0.3s;">
            <i class="fas fa-star"></i> مفضلة
            </button>
        </div>
        `;
        }

        // دالة لإضافة السائق إلى المفضلة
        function addToFavorites(driverId) {
            const driverCard = document.querySelector(`[data-driver-id="${driverId}"]`);
            if (driverCard) {
            const favoritesContainer = document.getElementById('favoritesContainer');
            const clonedCard = driverCard.cloneNode(true);
            favoritesContainer.appendChild(clonedCard);
            showToast('تمت إضافة السائق إلى المفضلة', 'success');
            }
        }




        // دالة لعرض رسائل السائق (عندما يكون السائق هو المسجل الدخول)
        function showDriverMessages(driverId) {
            showLoading();

            // جلب جميع المحادثات للسائق الحالي
            database.ref(`chats`).once('value')
                .then(snapshot => {
                    const allChats = snapshot.val() || {};
                    const driverChats = [];

                    // تجميع المحادثات التي للسائق المحدد
                    Object.keys(allChats).forEach(userId => {
                        if (allChats[userId] && allChats[userId][driverId]) {
                            driverChats.push({
                                userId: userId,
                                chatData: allChats[userId][driverId],
                                lastMessageTime: getLastMessageTime(allChats[userId][driverId])
                            });
                        }
                    });

                    // ترتيب المحادثات حسب آخر رسالة
                    driverChats.sort((a, b) => b.lastMessageTime - a.lastMessageTime);

                    // إنشاء قائمة المحادثات
                    let chatListHtml = '';
                    if (driverChats.length > 0) {
                        driverChats.forEach(chat => {
                            // بيانات المستخدم
                            const userName = getUserName(chat.userId);
                            const lastMessage = getLastMessage(chat.chatData);
                            const unreadCount = getUnreadCount(chat.chatData, driverId);

                            chatListHtml += `
                        <div class="chat-user-item ${unreadCount > 0 ? 'unread' : ''}" 
                             onclick="openDriverChatWindow('${driverId}', '${chat.userId}')">
                            <div class="chat-user-avatar">
                                <img src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527" alt="${userName}">
                            </div>
                            <div class="chat-user-info">
                                <h6>${userName}</h6>
                                <p>${lastMessage.text ? lastMessage.text.substring(0, 30) + (lastMessage.text.length > 30 ? '...' : '') : 'لا توجد رسائل'}</p>
                                <small>${formatMessageTime(lastMessage.timestamp)}</small>
                            </div>
                            ${unreadCount > 0 ? `
                                <div class="chat-unread-badge">${unreadCount}</div>
                            ` : ''}
                        </div>
                    `;
                        });
                    } else {
                        chatListHtml = '<div class="no-chats-message">لا توجد محادثات بعد</div>';
                    }

                    // إظهار نافذة المحادثات
                    Swal.fire({
                        title: 'الرسائل الواردة',
                        html: `
                    <div class="driver-chats-container">
                        ${chatListHtml}
                    </div>
                `,
                        width: '500px',
                        padding: '20px',
                        background: '#1a1a1a',
                        color: '#FFFFFF',
                        showConfirmButton: false,
                        showCloseButton: true,
                        customClass: {
                            popup: 'dark-popup',
                            title: 'text-white'
                        }
                    });

                    // تحديث حالة الرسائل كمقروءة بعد عرضها
                    updateMessagesReadStatus(driverId);

                    hideLoading();
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    hideLoading();
                    showToast('حدث خطأ في تحميل الرسائل', 'error');
                });
        }


     // فتح نافذة المحادثة بين السائق والمستخدم
function openDriverChatWindow(driverId, userId) {
    showLoading();

    // جلب معلومات المستخدم
    Promise.all([
        database.ref(`users/${userId}`).once('value'),
        database.ref(`chats/${userId}/${driverId}/messages`).once('value')
    ])
        .then(([userSnapshot, messagesSnapshot]) => {
            // استخراج بيانات المستخدم مع التحقق من جميع الحقول المحتملة
            const userData = userSnapshot.val() || {};
            
            // استخدام الاسم الكامل من عدة حقول محتملة
            const userName = userData.fullName || userData.name || `مستخدم ${userId.substring(0, 6)}`;
            
            // استخدام صورة الملف الشخصي من عدة حقول محتملة
            const userPhoto = userData.photoUrl || userData.profilePicture || userData.imageUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/user-photos%2F1741376568952_default-avatar.png?alt=media&token=ad672ccf-c8e1-4788-a252-52de6c3ceedd';
            
            const messages = messagesSnapshot.val() || {};

            // تحويل المفاتيح إلى مصفوفة
            const messagesList = Object.keys(messages).map(key => ({
                id: key,
                ...messages[key]
            })).sort((a, b) => a.timestamp - b.timestamp);

            // تجهيز HTML للرسائل
            let messagesHtml = '';
            messagesList.forEach(msg => {
                const isFromDriver = msg.sender === driverId;
                
                // التحقق من نوع الرسالة
                if (msg.type === 'location') {
                    // إنشاء عرض لرسالة الموقع
                    messagesHtml += createLocationMessageView(msg, msg.id, isFromDriver);
                } else {
                    // إنشاء عرض لرسالة نصية عادية
                    messagesHtml += `
                        <div class="message ${isFromDriver ? 'sent' : 'received'}">
                            <div class="message-bubble ${isFromDriver ? 'sent' : 'received'}">
                                <p>${msg.text || ''}</p>
                                <div class="timestamp">${formatMessageTime(msg.timestamp)}</div>
                            </div>
                        </div>
                    `;
                }
            });

            // إنشاء نافذة المحادثة مع بيانات المستخدم المحدثة
            Swal.fire({
                title: userName,
                html: `
                    <div class="chat-container">
                        <div class="chat-header" style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #FFD700;">
                            <img src="${userPhoto}" alt="${userName}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover;">
                            <div>
                                <h5 style="margin: 0; color: #FFFFFF;">${userName}</h5>
                                ${userData.email ? `<small style="color: #CCCCCC;">${userData.email}</small>` : ''}
                            </div>
                        </div>
                        <div class="chat-body" id="chatBody" style="flex-grow: 1; overflow-y: auto; padding: 15px; background-color: #1a1a1a;">
                            ${messagesHtml || '<div class="no-messages">لا توجد رسائل سابقة</div>'}
                        </div>
                        <div class="chat-footer" style="padding: 10px; display: flex; gap: 10px; background-color: #242424; border-top: 1px solid #FFD700;">
                            <button class="location-btn" id="shareLocationBtn" title="مشاركة الموقع" style="width: 40px; height: 40px; border-radius: 50%; background: #333; color: #FFD700; border: none; cursor: pointer;">
                                <i class="fas fa-map-marker-alt"></i>
                            </button>
                            <input type="text" id="driverMessageInput" class="chat-input" placeholder="اكتب رسالتك هنا..." style="flex-grow: 1; border-radius: 20px; padding: 8px 15px; background: #333; color: #FFF; border: 1px solid #FFD700;">
                            <button class="send-btn" onclick="sendDriverMessage('${driverId}', '${userId}')" style="width: 40px; height: 40px; border-radius: 50%; background: #FFD700; color: #000; border: none; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                `,
                width: '90%',
                padding: '0',
                background: '#1a1a1a',
                color: '#FFFFFF',
                showConfirmButton: false,
                showCloseButton: true,
                didOpen: () => {
                    // تمرير للأسفل ليظهر آخر رسالة
                    const chatBody = document.getElementById('chatBody');
                    if (chatBody) {
                        chatBody.scrollTop = chatBody.scrollHeight;
                    }

                    // إضافة مستمع الحدث لمفتاح Enter
                    const messageInput = document.getElementById('driverMessageInput');
                    if (messageInput) {
                        messageInput.addEventListener('keypress', function (e) {
                            if (e.key === 'Enter') {
                                sendDriverMessage(driverId, userId);
                            }
                        });
                        messageInput.focus();
                    }

                    // إضافة مستمع الحدث لزر مشاركة الموقع
                    const shareLocationBtn = document.getElementById('shareLocationBtn');
                    if (shareLocationBtn) {
                        shareLocationBtn.addEventListener('click', function() {
                            shareDriverLocation(driverId, userId);
                        });
                    }

                    // تعليم جميع رسائل هذا المستخدم كمقروءة
                    markConversationAsRead(driverId, userId);
                },
                customClass: {
                    popup: 'dark-popup chat-window',
                    title: 'text-white chat-header',
                    closeButton: 'chat-close-btn'
                }
            });

            hideLoading();
        })
        .catch(error => {
            console.error('Error opening chat:', error);
            hideLoading();
            showToast('حدث خطأ في فتح المحادثة', 'error');
        });
}


// دالة مشاركة موقع السائق
async function shareDriverLocation(driverId, userId) {
    try {
        // عرض مؤشر التحميل
        showToast('جاري تحديد موقعك...', 'info');
        
        // الحصول على الموقع الحالي
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        });
        
        const { latitude, longitude } = position.coords;
        
        // إنشاء بيانات رسالة الموقع
        const locationMessage = {
            sender: driverId, // معرف السائق
            type: 'location',
            location: {
                lat: latitude,
                lng: longitude,
                accuracy: position.coords.accuracy
            },
            timestamp: Date.now(),
            read: false
        };
        
        // إرسال رسالة الموقع للمستخدم
        await database.ref(`chats/${userId}/${driverId}/messages`).push(locationMessage);
        
        // إضافة الرسالة الجديدة إلى نافذة المحادثة
        const chatBody = document.getElementById('chatBody');
        if (chatBody) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message sent';
            messageElement.innerHTML = createLocationMessageView(locationMessage, Date.now().toString(), true);
            chatBody.appendChild(messageElement);
            chatBody.scrollTop = chatBody.scrollHeight;
        }
        
        // عرض رسالة نجاح
        showToast('تم مشاركة موقعك بنجاح', 'success');
        
    } catch (error) {
        console.error('Error sharing location:', error);
        
        let errorMessage = 'حدث خطأ في مشاركة الموقع';
        if (error.code === 1) { // PERMISSION_DENIED
            errorMessage = 'تم رفض الوصول إلى الموقع. يرجى السماح للتطبيق باستخدام خدمة الموقع';
        } else if (error.code === 2) { // POSITION_UNAVAILABLE
            errorMessage = 'معلومات الموقع غير متوفرة حالياً';
        } else if (error.code === 3) { // TIMEOUT
            errorMessage = 'انتهت مهلة تحديد الموقع';
        }
        
        showToast(errorMessage, 'error');
    }
}


// تكملة دالة إنشاء عرض لرسالة الموقع
function createLocationMessageView(message, messageId, isFromDriver) {
    const { lat, lng } = message.location;
    
    return `
        <div class="message-bubble ${isFromDriver ? 'sent' : 'received'}" style="background: rgba(255, 215, 0, 0.1); border: 1px solid #FFD700; padding: 10px; border-radius: 10px; margin: 5px 0; width: 220px;">
            <div class="location-message" data-message-id="${messageId}" data-lat="${lat}" data-lng="${lng}" onclick="navigateToLocation(${lat}, ${lng}, '${messageId}')" style="cursor: pointer; transition: all 0.3s ease;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                    <i class="fas fa-map-marker-alt" style="color: #FFD700; font-size: 1.2rem;"></i>
                    <span style="color: #FFFFFF; font-weight: bold;">موقع ${isFromDriver ? 'السائق' : 'المستخدم'}</span>
                </div>
                <div style="width: 100%; height: 120px; border-radius: 8px; border: 1px solid #555; background: #242424; overflow: hidden; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; position: relative;">
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); z-index: 2;">
                        <i class="fas fa-map" style="color: #FFD700; font-size: 2rem; margin-bottom: 5px;"></i>
                        <div style="color: #FFFFFF; text-align: center; font-size: 0.8rem; padding: 0 10px;">
                            ${lat.toFixed(6)}, ${lng.toFixed(6)}
                        </div>
                    </div>
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: url('https://api.mapbox.com/styles/v1/mapbox/dark-v10/static/pin-s+ffd700(${lng},${lat})/${lng},${lat},14,0/220x120?access_token=pk.eyJ1IjoiZXhhbXBsZXVzZXIiLCJhIjoiY2syMDNwdjZ6MDZwcTNpcDUyeW92bTBociJ9.example') center/cover; opacity: 0.5; filter: grayscale(30%);"></div>
                </div>
                <div style="text-align: center; color: #FFD700; font-size: 0.8rem;">
                    <i class="fas fa-info-circle"></i> انقر للانتقال إلى الموقع على الخريطة
                </div>
            </div>
            <div class="timestamp" style="text-align: right; font-size: 0.7rem; color: #999; margin-top: 5px;">${formatMessageTime(message.timestamp)}</div>
        </div>
    `;
}

        // إرسال رسالة من السائق إلى المستخدم
        function sendDriverMessage(driverId, userId) {
            const messageInput = document.getElementById('driverMessageInput');
            const messageText = messageInput.value.trim();

            if (!messageText) return;

            // تجهيز بيانات الرسالة
            const message = {
                sender: driverId,
                text: messageText,
                timestamp: Date.now(),
                read: false
            };

            // حفظ الرسالة في قاعدة البيانات
            database.ref(`chats/${userId}/${driverId}/messages`).push(message)
                .then(() => {
                    messageInput.value = '';

                    // إضافة الرسالة الجديدة إلى نافذة المحادثة
                    const chatBody = document.getElementById('chatBody');
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message sent';
                    messageElement.innerHTML = `
                <div class="message-bubble sent">
                    <p>${messageText}</p>
                    <div class="timestamp">${formatMessageTime(message.timestamp)}</div>
                </div>
            `;
                    chatBody.appendChild(messageElement);
                    chatBody.scrollTop = chatBody.scrollHeight;
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                    showToast('حدث خطأ في إرسال الرسالة', 'error');
                });
        }


        // تعليم المحادثة كمقروءة
        function markConversationAsRead(driverId, userId) {
            database.ref(`chats/${userId}/${driverId}/messages`).once('value')
                .then(snapshot => {
                    const messages = snapshot.val();
                    if (!messages) return;

                    // تحديث كل رسالة غير مقروءة ومرسلة من المستخدم
                    const updates = {};
                    Object.keys(messages).forEach(key => {
                        if (!messages[key].read && messages[key].sender === userId) {
                            updates[`chats/${userId}/${driverId}/messages/${key}/read`] = true;
                        }
                    });

                    if (Object.keys(updates).length > 0) {
                        database.ref().update(updates);
                        // تحديث عداد الرسائل بعد التعليم كمقروءة
                        updateDriverMessageBadge(driverId);
                    }
                });
        }


        // تحديث عداد الرسائل غير المقروءة للسائق
        function updateDriverMessageBadge(driverId) {
            database.ref(`chats`).once('value')
                .then(snapshot => {
                    const allChats = snapshot.val() || {};
                    let totalUnread = 0;

                    // حساب إجمالي الرسائل غير المقروءة
                    Object.keys(allChats).forEach(userId => {
                        if (allChats[userId] && allChats[userId][driverId]) {
                            const chatData = allChats[userId][driverId];
                            totalUnread += getUnreadCount(chatData, driverId);
                        }
                    });

                    // تحديث العداد في جميع بطاقات السائق المعروضة
                    const driverCards = document.querySelectorAll(`.driver-card[data-driver-id="${driverId}"]`);
                    driverCards.forEach(card => {
                        const badge = card.querySelector('.message-badge');
                        if (badge) {
                            badge.textContent = totalUnread;
                            if (totalUnread > 0) {
                                badge.classList.remove('d-none');
                            } else {
                                badge.classList.add('d-none');
                            }
                        }
                    });
                });
        }

    // تحديث دالة حساب عدد الرسائل غير المقروءة
function getUnreadCount(chatData, driverId) {
    if (!chatData || !chatData.messages) return 0;

    let count = 0;
    const messages = chatData.messages;

    Object.keys(messages).forEach(key => {
        // تحقق من أن الرسالة غير مقروءة وأنها ليست من السائق نفسه
        if (!messages[key].read && messages[key].sender !== driverId) {
            count++;
        }
    });

    return count;
}


        // تحديث حالة جميع الرسائل كمقروءة
        function updateMessagesReadStatus(driverId) {
            database.ref(`chats`).once('value')
                .then(snapshot => {
                    const allChats = snapshot.val();
                    if (!allChats) return;

                    const updates = {};

                    Object.keys(allChats).forEach(userId => {
                        if (allChats[userId] && allChats[userId][driverId] && allChats[userId][driverId].messages) {
                            const messages = allChats[userId][driverId].messages;

                            Object.keys(messages).forEach(messageId => {
                                if (!messages[messageId].read && messages[messageId].sender !== driverId) {
                                    updates[`chats/${userId}/${driverId}/messages/${messageId}/read`] = true;
                                }
                            });
                        }
                    });

                    if (Object.keys(updates).length > 0) {
                        database.ref().update(updates);
                        // تحديث عداد الرسائل
                        updateDriverMessageBadge(driverId);
                    }
                });
        }



        // الحصول على آخر وقت للرسائل في محادثة
        function getLastMessageTime(chatData) {
            if (!chatData || !chatData.messages) return 0;

            let latestTime = 0;
            const messages = chatData.messages;

            Object.keys(messages).forEach(key => {
                if (messages[key].timestamp > latestTime) {
                    latestTime = messages[key].timestamp;
                }
            });

            return latestTime;
        }



        // الحصول على آخر رسالة في محادثة
        function getLastMessage(chatData) {
            if (!chatData || !chatData.messages) return { text: 'لا توجد رسائل', timestamp: Date.now() };

            let latestTime = 0;
            let latestMessage = null;
            const messages = chatData.messages;

            Object.keys(messages).forEach(key => {
                if (messages[key].timestamp > latestTime) {
                    latestTime = messages[key].timestamp;
                    latestMessage = messages[key];
                }
            });

            return latestMessage || { text: 'لا توجد رسائل', timestamp: Date.now() };
        }

        // الحصول على اسم المستخدم من معرفه
        async function getUserName(userId) {
            try {
                const userSnapshot = await database.ref(`users/${userId}`).once('value');
                const userData = userSnapshot.val();
                return userData && userData.fullName ? userData.fullName : `مستخدم ${userId.substring(0, 6)}`;
            } catch (error) {
                console.error('Error fetching user name:', error);
                return `مستخدم ${userId.substring(0, 6)}`;
            }
        }

        // الحصول على اسم المستخدم المسجل الدخول
        async function getLoggedInUserName() {
            try {
                const user = firebase.auth().currentUser;
                if (user) {
                    const userId = user.uid;
                    return await getUserName(userId);
                } else {
                    throw new Error('No user is logged in');
                }
            } catch (error) {
                console.error('Error fetching logged-in user name:', error);
                return 'مستخدم غير معروف';
            }
        }

        // مثال على استخدام الدالة بعد تسجيل الدخول
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                const userName = await getLoggedInUserName();
                console.log('Logged-in user name:', userName);
            }
        });

        // تنسيق وقت الرسالة
        function formatMessageTime(timestamp) {
            if (!timestamp) return '';

            const date = new Date(timestamp);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                // اليوم
                return date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays === 1) {
                // الأمس
                return `الأمس ${date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}`;
            } else if (diffDays < 7) {
                // هذا الأسبوع
                const days = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                return `${days[date.getDay()]} ${date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}`;
            } else {
                // أكثر من أسبوع
                return date.toLocaleDateString('ar-SA');
            }
        }
        //هذه الاكواد الخاصه بالمراسله بين بطاقه السائق والمستخدم تتحكم هذه الاكواد في الواجهيه بالبطاقه السائق وعملها في المراسله واستقبال الرسائل بين المستخدم والسابق




        function toggleDriverStatus(driverId, isActive) {
            const newStatus = !isActive;
            database.ref(`drivers/${driverId}`).update({
                active: newStatus
            }).then(() => {
                showToast(`تم ${newStatus ? 'تفعيل' : 'تعطيل'} السائق بنجاح`, 'success');
                loadDrivers(); // تحديث العرض
            }).catch((error) => {
                console.error('Error updating driver status:', error);
                showToast('حدث خطأ أثناء تحديث حالة السائق', 'error');
            });
        }



        function startDriverLocationTracking(driverId) {
            // ... الكود السابق ...

            // تحديث حالة التتبع في البطاقة
            const driverCard = document.querySelector(`[data-driver-id="${driverId}"]`);
            if (driverCard) {
                driverCard.setAttribute('data-tracking', 'true');
                const indicator = driverCard.querySelector('.tracking-indicator');
                if (indicator) {
                    indicator.classList.add('active');
                }
            }

            showToast('تم تفعيل تتبع الموقع بنجاح', 'success');
        }

        function stopDriverLocationTracking() {
            // ... الكود السابق ...

            // إزالة حالة التتبع من جميع البطاقات
            document.querySelectorAll('.driver-card').forEach(card => {
                card.setAttribute('data-tracking', 'false');
                const indicator = card.querySelector('.tracking-indicator');
                if (indicator) {
                    indicator.classList.remove('active');
                }
            });
        }



        // دالة تأكيد الحذف مع نافذة تأكيد محسنة
        function confirmDeleteDriver(driverId) {
            // استخدام نافذة تأكيد محسنة
            Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا السائق؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء'
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteDriver(driverId); // استدعاء دالة الحذف إذا وافق المستخدم
                }
            });
        }

        // دالة حذف السائق
        async function deleteDriver(driverId) {
            try {
                // عرض مؤشر التحميل
                showLoading();

                // الوصول إلى مرجع بيانات السائق
                const driverRef = database.ref(`drivers/${driverId}`);
                const snapshot = await driverRef.once('value');
                const driverData = snapshot.val();

                if (!driverData) {
                    // إذا لم يتم العثور على بيانات السائق
                    showToast('لم يتم العثور على السائق', 'error');
                    return;
                }

                // حذف الصورة من التخزين إذا كانت موجودة
                if (driverData.imageUrl) {
                    try {
                        const imageRef = storage.refFromURL(driverData.imageUrl);
                        await imageRef.delete();
                    } catch (error) {
                        console.error('Error deleting image:', error);
                        showToast('حدث خطأ أثناء حذف صورة السائق', 'error');
                    }
                }

                // حذف بيانات السائق من قاعدة البيانات
                await driverRef.remove();

                // إزالة بطاقة السائق من الواجهة
                const card = document.querySelector(`[data-driver-id="${driverId}"]`);
                if (card) {
                    // إضافة تأثير حذف قبل الإزالة
                    card.classList.add('animate__fadeOut');
                    setTimeout(() => card.remove(), 300);
                }

                // عرض رسالة نجاح
                showToast('تم حذف السائق بنجاح', 'success');
            } catch (error) {
                console.error('Error deleting driver:', error);
                showToast('حدث خطأ أثناء حذف السائق', 'error');
            } finally {
                // إخفاء مؤشر التحميل
                hideLoading();
            }
        }


        // دالة إظهار نافذة التعديل
        function showEditDriverModal(driverId) {
            database.ref(`drivers/${driverId}`).once('value')
                .then(snapshot => {
                    const driver = snapshot.val();
                    if (driver) {
                        document.getElementById('editDriverId').value = driverId;
                        document.getElementById('editDriverName').value = driver.name;
                        document.getElementById('editDriverPhone').value = driver.phone;
                        document.getElementById('editCarType').value = driver.carType;
                        document.getElementById('editCarModel').value = driver.carModel;
                        document.getElementById('editDriverLocation').value = driver.location;

                        if (driver.imageUrl) {
                            document.getElementById('editImagePreview').src = driver.imageUrl;
                            document.getElementById('editImagePreview').style.display = 'block';
                        }

                        const editModal = new bootstrap.Modal(document.getElementById('editDriverModal'));
                        editModal.show();
                    }
                })
                .catch(error => {
                    console.error('Error fetching driver data:', error);
                    showToast('حدث خطأ في تحميل بيانات السائق', 'error');
                });
        }

        // دالة معالجة تعديل البيانات
        async function handleEditDriver(event) {
            event.preventDefault();
            showLoading();

            try {
                const driverId = document.getElementById('editDriverId').value;
                const imageFile = document.getElementById('editDriverImage').files[0];
                let updates = {
                    name: document.getElementById('editDriverName').value,
                    phone: document.getElementById('editDriverPhone').value,
                    carType: document.getElementById('editCarType').value,
                    carModel: document.getElementById('editCarModel').value,
                    location: document.getElementById('editDriverLocation').value
                };

                if (imageFile) {
                    const imageRef = storage.ref(`drivers/${Date.now()}_${imageFile.name}`);
                    const uploadTask = await imageRef.put(imageFile);
                    updates.imageUrl = await uploadTask.ref.getDownloadURL();
                }

                await database.ref(`drivers/${driverId}`).update(updates);

                const modal = bootstrap.Modal.getInstance(document.getElementById('editDriverModal'));
                modal.hide();

                showToast('تم تحديث بيانات السائق بنجاح');
                loadDrivers();
            } catch (error) {
                console.error('Error updating driver:', error);
                showToast('حدث خطأ أثناء تحديث البيانات', 'error');
            } finally {
                hideLoading();
            }
        }

        // دوال إضافية للحذف والتعديل
        function confirmDeleteDriver(driverId) {
            Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا السائق؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء'
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteDriver(driverId);
                }
            });
        }

        async function deleteDriver(driverId) {
            try {
                showLoading();

                // حذف بيانات السائق من قاعدة البيانات
                const driverRef = database.ref(`drivers/${driverId}`);
                const driverSnapshot = await driverRef.once('value');
                const driverData = driverSnapshot.val();

                if (driverData && driverData.imageUrl) {
                    // حذف الصورة من التخزين
                    const imageRef = storage.refFromURL(driverData.imageUrl);
                    await imageRef.delete();
                }

                // حذف البيانات
                await driverRef.remove();

                // حذف البطاقة من الواجهة مع تأثير حركي
                const driverCard = document.querySelector(`[data-driver-id="${driverId}"]`);
                if (driverCard) {
                    driverCard.classList.add('animate__fadeOut');
                    setTimeout(() => driverCard.remove(), 300);
                }

                showToast('تم حذف السائق بنجاح');
            } catch (error) {
                console.error('Error deleting driver:', error);
                showToast('حدث خطأ أثناء حذف السائق', 'error');
            } finally {
                hideLoading();
            }
        }


        function showEditDriverModal(driverId) {
            database.ref(`drivers/${driverId}`).once('value')
                .then(snapshot => {
                    const driver = snapshot.val();
                    if (driver) {
                        // ملء النموذج ببيانات السائق الحالية
                        document.getElementById('editDriverId').value = driverId;
                        document.getElementById('editDriverName').value = driver.name;
                        document.getElementById('editDriverPhone').value = driver.phone;
                        document.getElementById('editCarType').value = driver.carType;
                        document.getElementById('editCarModel').value = driver.carModel;
                        document.getElementById('editDriverLocation').value = driver.location;
                        document.getElementById('editDriverBio').value = driver.bio || '';

                        if (driver.imageUrl) {
                            document.getElementById('editImagePreview').src = driver.imageUrl;
                            document.getElementById('editImagePreview').style.display = 'block';
                            document.querySelector('#editDriverModal .upload-placeholder').style.display = 'none';
                        }

                        // عرض النافذة المنبثقة
                        const editModal = new bootstrap.Modal(document.getElementById('editDriverModal'));
                        editModal.show();
                    }
                })
                .catch(error => {
                    console.error('Error fetching driver data:', error);
                    showToast('حدث خطأ في تحميل بيانات السائق', 'error');
                });
        }

        async function handleEditDriver(event) {
            event.preventDefault();
            showLoading();

            const driverId = document.getElementById('editDriverId').value;
            const imageFile = document.getElementById('editDriverImage').files[0];

            try {
                let imageUrl;
                if (imageFile) {
                    const imageRef = storage.ref(`drivers/${Date.now()}_${imageFile.name}`);
                    const uploadTask = await imageRef.put(imageFile);
                    imageUrl = await uploadTask.ref.getDownloadURL();
                }

                const updates = {
                    name: document.getElementById('editDriverName').value,
                    phone: document.getElementById('editDriverPhone').value,
                    carType: document.getElementById('editCarType').value,
                    carModel: document.getElementById('editCarModel').value,
                    location: document.getElementById('editDriverLocation').value,
                    bio: document.getElementById('editDriverBio').value
                };

                if (imageUrl) {
                    updates.imageUrl = imageUrl;
                }

                await database.ref(`drivers/${driverId}`).update(updates);

                // إغلاق النافذة المنبثقة
                const modal = bootstrap.Modal.getInstance(document.getElementById('editDriverModal'));
                modal.hide();

                showToast('تم تحديث بيانات السائق بنجاح');
                loadDrivers(); // تحديث عرض السائقين
            } catch (error) {
                console.error('Error updating driver:', error);
                showToast('حدث خطأ أثناء تحديث البيانات', 'error');
            } finally {
                hideLoading();
            }
        }

        function handleEditImagePreview(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('editImagePreview');
                    const placeholder = document.querySelector('#editDriverModal .upload-placeholder');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                }
                reader.readAsDataURL(file);
            }
        }


        function handleImagePreview(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('imagePreview');
                    const placeholder = document.querySelector('.upload-placeholder');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                }
                reader.readAsDataURL(file);
            }
        }

        function bookDriver(driverId) {
            showLoading();
            database.ref(`drivers/${driverId}`).once('value', (snapshot) => {
                const driver = snapshot.val();
                if (driver && driver.active) {
                    setTimeout(() => {
                        hideLoading();
                        database.ref(`drivers/${driverId}`).update({
                            active: false // تعيين الحالة إلى "مشغول"
                        }).then(() => {
                            showToast(`تم إرسال طلب الحجز إلى ${driver.name}`);
                            window.location.href = `tel:${driver.phone}`;
                            loadDrivers(); // تحديث حالة السائقين في الواجهة
                        });
                    }, 1500);
                } else {
                    hideLoading();
                    showToast('السائق غير متاح حالياً', 'error');
                }
            });
        }


        function messageDriver(driverId) {
            database.ref(`drivers/${driverId}`).once('value', (snapshot) => {
                const driver = snapshot.val();
                if (driver) {
                    const phoneNumber = driver.phone.replace(/[^0-9]/g, '');
                    window.open(`https://wa.me/${phoneNumber}`, '_blank');
                }
            });
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `custom-toast animate__animated animate__fadeInRight`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle text-success' : 'fa-exclamation-circle text-danger'} me-2"></i>
                <div>${message}</div>
            `;

            document.getElementById('toastContainer').appendChild(toast);

            setTimeout(() => {
                toast.classList.replace('animate__fadeInRight', 'animate__fadeOutRight');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        function messageDriver(driverId) {
            database.ref(`drivers/${driverId}`).once('value', (snapshot) => {
                const driver = snapshot.val();

                if (driver) {
                    // تحديد السائق الحالي للدردشة
                    currentChatDriverId = driverId;

                    // فتح نافذة الدردشة
                    const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
                    document.getElementById('chatMessages').innerHTML = ''; // تفريغ الرسائل السابقة
                    loadMessages(); // تحميل الرسائل السابقة بين المستخدم والسائق
                    chatModal.show();
                } else {
                    showToast('عذراً، لا يمكن العثور على معلومات السائق.', 'error');
                }
            });
        }

        // دالة مساعدة للتحقق من صلاحيات الموقع
        function checkLocationPermission() {
            if (navigator.permissions) {
                navigator.permissions.query({ name: 'geolocation' })
                    .then(permission => {
                        if (permission.state === 'denied') {
                            showToast('يرجى تفعيل خدمة الموقع للحصول على أفضل تجربة.', 'error');
                        }
                    });
            }
        }

        // تحديث دالة updateUserLocation لتخزين الموقع الأخير
        function updateUserLocation(position) {
            userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            if (!userMarker) {
                const userIcon = L.divIcon({
                    html: '<i class="fas fa-user-circle fa-2x" style="color: #007bff;"></i>',
                    className: 'user-marker',
                    iconSize: [30, 30]
                });

                userMarker = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon })
                    .bindPopup('موقعك الحالي')
                    .addTo(map);
            } else {
                userMarker.setLatLng([userLocation.lat, userLocation.lng]);
            }

            // تحديث مركز الخريطة
            map.setView([userLocation.lat, userLocation.lng], map.getZoom());
        }

        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }
        // دالة لعرض نافذة إضافة السائق
        function showAddDriverModal() {
            // إغلاق نافذة اختيار العملية أولاً
            const profileModal = bootstrap.Modal.getInstance(document.getElementById('profileModal'));
            if (profileModal) {
                profileModal.hide();
            }

            // انتظار قليلاً قبل فتح النافذة الجديدة
            setTimeout(() => {
                // إظهار نافذة إضافة السائق
                const addDriverModal = new bootstrap.Modal(document.getElementById('addDriverModal'));
                addDriverModal.show();
            }, 150); // تأخير بسيط للحصول على انتقال سلس
        }

        // دالة لعرض نافذة تسجيل الدخول
        function openLoginModal() {
            const profileModal = bootstrap.Modal.getInstance(document.getElementById('profileModal'));
            if (profileModal) {
                profileModal.hide();
            }

            setTimeout(() => {
                const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
                loginModal.show();
            }, 150);
        }

        // دالة لفتح نافذة تسجيل المستخدم
        function openUserRegistration() {
            const profileModal = bootstrap.Modal.getInstance(document.getElementById('profileModal'));
            if (profileModal) {
                profileModal.hide();
            }

            setTimeout(() => {
                const userModal = new bootstrap.Modal(document.getElementById('userRegistrationModal'));
                userModal.show();
            }, 150);
        }


        // دالة البحث الرئيسية
        function searchDrivers(searchTerm, searchType = 'all') {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';

            if (!searchTerm.trim()) {
                resultsContainer.innerHTML = '';
                return;
            }

            const driversRef = database.ref('drivers');
            driversRef.once('value')
                .then((snapshot) => {
                    const results = [];
                    snapshot.forEach((childSnapshot) => {
                        const driver = childSnapshot.val();
                        const driverId = childSnapshot.key;

                        const searchLower = searchTerm.toLowerCase();
                        let match = false;

                        switch (searchType) {
                            case 'name':
                                match = driver.name.toLowerCase().includes(searchLower);
                                break;
                            case 'location':
                                match = driver.location.toLowerCase().includes(searchLower);
                                break;
                            case 'car':
                                match = driver.carType.toLowerCase().includes(searchLower) ||
                                    driver.carModel.toString().includes(searchLower);
                                break;
                            default:
                                match = driver.name.toLowerCase().includes(searchLower) ||
                                    driver.location.toLowerCase().includes(searchLower) ||
                                    driver.carType.toLowerCase().includes(searchLower) ||
                                    driver.carModel.toString().includes(searchLower);
                        }

                        if (match) {
                            results.push({ ...driver, id: driverId });
                        }
                    });

                    displaySearchResults(results, searchTerm);
                })
                .catch((error) => {
                    console.error("Error searching:", error);
                    resultsContainer.innerHTML = '<div class="no-results">حدث خطأ في البحث</div>';
                });
        }

        // دالة عرض نتائج البحث
        function displaySearchResults(results, searchTerm) {
            const resultsContainer = document.getElementById('searchResults');

            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">لا توجد نتائج للبحث</div>';
                return;
            }

            resultsContainer.innerHTML = results.map(driver => `
        <div class="search-result-item" onclick="handleDriverSelect('${driver.id}')">
            <div class="driver-info">
                <img src="${driver.imageUrl}" alt="${driver.name}" class="driver-image">
                <div class="driver-details">
                    <div class="driver-name">${highlightText(driver.name, searchTerm)}</div>
                    <div class="driver-meta">
                        <i class="fas fa-map-marker-alt"></i> 
                        ${highlightText(driver.location, searchTerm)}
                    </div>
                    <div class="driver-meta">
                        <i class="fas fa-car"></i> 
                        ${highlightText(driver.carType, searchTerm)} ${highlightText(driver.carModel.toString(), searchTerm)}
                    </div>
                </div>
                <div class="driver-status ${driver.active ? 'text-success' : 'text-danger'}">
                    <i class="fas fa-circle"></i>
                </div>
            </div>
        </div>
    `).join('');
        }

        // دالة تمييز نص البحث
        function highlightText(text, searchTerm) {
            if (!searchTerm) return text;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // دالة معالجة اختيار السائق
        function handleDriverSelect(driverId) {
            viewDriverLocation(driverId);
            const modal = bootstrap.Modal.getInstance(document.getElementById('searchModal'));
            modal.hide();
        }

        // إعداد مستمعي الأحداث
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('navbarSearchInput');
            const searchTypeInputs = document.querySelectorAll('input[name="searchType"]');
            let searchTimeout;

            // مستمع حدث البحث
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const searchType = document.querySelector('input[name="searchType"]:checked').id.replace('search', '').toLowerCase();
                    searchDrivers(e.target.value, searchType);
                }, 300);
            });

            // مستمع حدث تغيير نوع البحث
            searchTypeInputs.forEach(input => {
                input.addEventListener('change', () => {
                    if (searchInput.value) {
                        const searchType = input.id.replace('search', '').toLowerCase();
                        searchDrivers(searchInput.value, searchType);
                    }
                });
            });

            // تنظيف البحث عند إغلاق النافذة المنبثقة
            document.getElementById('searchModal').addEventListener('hidden.bs.modal', () => {
                searchInput.value = '';
                document.getElementById('searchResults').innerHTML = '';
                document.getElementById('searchAll').checked = true;
            });
        });



        function filterDrivers(searchTerm) {
            const driverCards = document.querySelectorAll('.driver-card');
            searchTerm = searchTerm.toLowerCase();

            driverCards.forEach(card => {
                const driverName = card.querySelector('.driver-name').textContent.toLowerCase();
                const driverLocation = card.querySelector('.text-muted').textContent.toLowerCase();

                if (driverName.includes(searchTerm) || driverLocation.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize map if not already initialized
            if (!window.mapInitialized) {
                window.mapInitialized = true;
                initMap();
            }

            // Add click handlers for location chips
            const locationChips = document.querySelectorAll('.location-chip');
            locationChips.forEach((chip) => {
                chip.addEventListener('click', () => {
                    locationChips.forEach((c) => c.classList.remove('active'));
                    chip.classList.add('active');
                    const location = chip.dataset.location;
                    loadDrivers(location);
                });
            });

            // Set initial active state for 'all' chip
            const allChip = document.querySelector('.location-chip[data-location="all"]');
            if (allChip) {
                allChip.classList.add('active');
            }

            // Load all drivers immediately
            loadDrivers('all');

            // Also load drivers when Firebase is ready
            firebase.database().ref().once('value')
                .then(() => {
                    loadDrivers('all');
                })
                .catch(error => {
                    console.error('Error initializing Firebase:', error);
                });
        });

        const locationChips = document.querySelectorAll('.location-chip');
        locationChips.forEach((chip) => {
            chip.addEventListener('click', () => {
                locationChips.forEach((c) => c.classList.remove('active'));
                chip.classList.add('active');
                const location = chip.dataset.location;
                loadDrivers(location);
            });
        });

        loadDrivers(); // استدعاء التحميل الأولي للسائقين.

// قائمة المحافظات والمناطق في العراق
const iraqProvinces = {
    "بغداد": ["الكرخ", "الرصافة", "الأعظمية", "الكاظمية", "المنصور", "الدورة", "الشعب", "الكرادة", "زيونة", "الغدير", "البلديات", "الشعلة", "الحرية", "الوشاش", "حي الجامعة", "الصليخ", "بغداد الجديدة", "مدينة الصدر", "الزعفرانية", "العامرية", "الغزالية", "الجادرية", "الحارثية", "الجهاد", "البياع", "الخضراء", "حي الخليج", "التاجي"],
    "البصرة": ["البصرة الجديدة", "الزبير", "أبو الخصيب", "القرنة", "شط العرب", "الفاو", "الهارثة", "الدير", "المدينة", "العشار", "البراضعية", "الخور", "النجيبية", "الفيحاء", "المعقل", "سفوان", "الخصيب", "جبيلة", "القبلة", "ياسين خريبط", "الشعيبة"],
    "نينوى": ["الموصل", "تلعفر", "الحمدانية", "سنجار", "الحضر", "البعاج", "عين سفني", "تلكيف", "القيارة", "مخمور", "شيخان", "الحيدانية", "الشمال", "وانة", "سميل"],
    "أربيل": ["عنكاوا", "شقلاوة", "خبات", "سوران", "جومان", "رواندوز", "ميرگسور", "كوية", "المركز", "دشتي هولير", "خيفتي", "دارتو", "بنصلاوة", "حرير", "سيديكان", "شيروان-مزن", "مخمور", "قوشتبة"],
    "النجف": ["الكوفة", "المناذرة", "المشخاب", "الحيدرية", "العباسية", "القادسية", "الحرية", "النجف القديمة", "الغري", "النصر", "الوفاء", "الزهراء", "الجامعة", "السلام", "الغدير", "المرتضى", "القدس", "الأمير"],
    "كربلاء": ["الحسينية", "الهندية", "عين التمر", "الحر", "الجدول الغربي", "مركز كربلاء", "الخيرات", "الرشيد", "العباس", "الإصلاح", "الحسين", "المخيم", "الأنصار", "باب الخان", "الإسكان"],
    "كركوك": ["دبس", "الحويجة", "داقوق", "تازة", "شوان", "يايجي", "الملتقى", "العروبة", "القادسية", "الواسطي", "المنصور", "النصر", "الرياض", "الرشاد", "الزاب", "الرياض", "الصناعي"],
    "الأنبار": ["الرمادي", "الفلوجة", "هيت", "حديثة", "الخالدية", "الصقلاوية", "كبيسة", "العامرية", "الحبانية", "راوة", "عنه", "الرطبة", "القائم", "البغدادي", "الكرمة", "الوليد", "الحقلانية", "الرحالية"],
    "بابل": ["الحلة", "المسيب", "الهاشمية", "القاسم", "المحاويل", "الكفل", "النيل", "أبو غرق", "المدحتية", "الإسكندرية", "جرف الصخر", "الأمين", "بابل الجديدة", "الكرار", "الجامعة", "القاضية", "المدينة القديمة", "نادر", "الطهمازية", "الإمام", "المصطفى", "الشوملي"],
    "ديالى": ["بعقوبة", "المقدادية", "خانقين", "بلدروز", "كفري", "الخالص", "جلولاء", "قزانية", "مندلي", "قرة تبة", "السد العظيم", "بهرز", "كنعان", "هبهب", "أبو صيدا", "الوجيهية", "السلام", "العظيم", "بني سعد"],
    "ذي قار": ["الناصرية", "سوق الشيوخ", "الشطرة", "الرفاعي", "الجبايش", "قلعة سكر", "الغراف", "البطحاء", "النصر", "الإصلاح", "الفجر", "الدواية", "سيد دخيل", "الفضلية", "النهروان", "الإسكان", "الصدرين", "الحبوبي", "المنتظر"],
    "السليمانية": ["جمجمال", "حلبجة", "رانية", "دوكان", "قلعة دزة", "بازيان", "بكرجو", "سرجنار", "سيتك", "تانجرو", "سيد صادق", "بينجوين", "قرداغ", "شهرزور", "سيروان", "عربت", "دوكان", "ماوت"],
    "صلاح الدين": ["تكريت", "سامراء", "بيجي", "بلد", "الدور", "الشرقاط", "طوز خورماتو", "العلم", "يثرب", "الدجيل", "عين الفرس", "سليمان بيك", "الفارس", "صلاح الدين الجديد", "آمرلي", "الحويش", "الأسحاقي", "القادسية", "الدبس"],
    "واسط": ["الكوت", "النعمانية", "الحي", "بدرة", "الصويرة", "العزيزية", "الموفقية", "الشحيمية", "الزبيدية", "تاج الدين", "الدبوني", "جصان", "الأحرار", "الدجيلة", "الزهراء", "الفلاحية", "الكرامة", "الرميلة"],
    "ميسان": ["العمارة", "المجر الكبير", "الكحلاء", "علي الغربي", "قلعة صالح", "الميمونة", "الكميت", "السلام", "العدل", "الخير", "الرحمة", "المشرح", "الطيب", "البتيرة", "آل بوشامة", "المناذرة", "المزرعة"],
    "المثنى": ["السماوة", "الرميثة", "السوير", "المجد", "الخضر", "الهلال", "النجمي", "الوركاء", "الدراجي", "بصية", "السلمان", "آل بدير", "أم راكبة", "الإسلام", "البساتين", "الغدير", "المثنى الجديدة"],
    "دهوك": ["زاخو", "العمادية", "سميل", "الشيخان", "ئاكرى", "بردرش", "زاويتة", "باتيل", "كاني ماسي", "ديرلوك", "دهوك المركز", "سرسنك", "الدوسكي", "بامرني", "بيبوز", "مانكيش", "فايدة", "شاريا"],
    "القادسية": ["الديوانية", "عفك", "الشامية", "الحمزة", "نفر", "غماس", "سومر", "الشنافية", "الدغارة", "السنية", "الشافعية", "الجمهوري", "الإسكان", "الفرات", "الزهراء", "المهناوية", "البدير", "سيد الشهداء", "الجزائر", "الصدرين"]
};

/**
 * تهيئة قوائم المحافظات في كل أنحاء التطبيق
 * هذه الدالة تبحث عن كل قوائم المحافظات وتملأها بالمحافظات
 */
function initializeProvinceSelects() {
    // العثور على جميع قوائم المحافظات في الصفحة
    const provinceSelects = document.querySelectorAll('select[name="province"], #driverProvince, #driverLocation, select[id*="province"]');
    
    // التحقق من وجود قوائم
    if (provinceSelects.length === 0) {
        console.warn('لم يتم العثور على قوائم محافظات لتهيئتها');
        return;
    }
    
    // ملء كل قائمة بالمحافظات
    provinceSelects.forEach(select => {
        // حفظ الخيار الحالي إذا كان موجوداً
        const currentValue = select.value;
        
        // تفريغ القائمة مع الاحتفاظ بالخيار الافتراضي
        const defaultOption = select.querySelector('option[value=""]');
        select.innerHTML = '';
        
        // إعادة إضافة الخيار الافتراضي
        if (defaultOption) {
            select.appendChild(defaultOption);
        } else {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'اختر المحافظة';
            select.appendChild(option);
        }
        
        // إضافة المحافظات
        Object.keys(iraqProvinces).forEach(province => {
            const option = document.createElement('option');
            option.value = province;
            option.textContent = province;
            select.appendChild(option);
        });
        
        // استعادة القيمة السابقة إذا كانت موجودة
        if (currentValue) {
            select.value = currentValue;
            
            // تحديث قائمة المناطق المرتبطة إذا كانت موجودة
            const areaSelect = getRelatedAreaSelect(select);
            if (areaSelect) {
                loadAreasToSelect(currentValue, areaSelect);
            }
        }
        
        // إضافة مستمع حدث لتحديث قائمة المناطق عند تغيير المحافظة
        select.addEventListener('change', function() {
            const province = this.value;
            const areaSelect = getRelatedAreaSelect(this);
            
            if (areaSelect) {
                loadAreasToSelect(province, areaSelect);
            }
        });
    });
    
    console.log(`تم تهيئة ${provinceSelects.length} قائمة محافظات`);
}

/**
 * الحصول على قائمة المناطق المرتبطة بقائمة المحافظات
 */
function getRelatedAreaSelect(provinceSelect) {
    // البحث في عناصر الأشقاء
    const parentContainer = provinceSelect.closest('.row, .form-row, .modal-body, form');
    
    if (!parentContainer) return null;
    
    // استراتيجيات متعددة للعثور على قائمة المناطق
    let areaSelect = null;
    
    // 1. البحث عن قائمة بالقرب من قائمة المحافظة مع معرف أو اسم يحتوي على "area"
    areaSelect = parentContainer.querySelector('#driverArea, select[name="area"], select[id*="area"]');
    
    // 2. إذا لم يتم العثور على قائمة، ابحث عن قائمة تالية في نفس الصف
    if (!areaSelect) {
        const row = provinceSelect.closest('.row, .col');
        if (row) {
            const nextCol = row.nextElementSibling;
            if (nextCol) {
                areaSelect = nextCol.querySelector('select');
            }
        }
    }
    
    // 3. ابحث عن أي قائمة منسدلة بعد قائمة المحافظة
    if (!areaSelect) {
        const allSelects = Array.from(parentContainer.querySelectorAll('select'));
        const currentIndex = allSelects.indexOf(provinceSelect);
        
        if (currentIndex !== -1 && currentIndex < allSelects.length - 1) {
            areaSelect = allSelects[currentIndex + 1];
        }
    }
    
    return areaSelect;
}

/**
 * تحميل المناطق إلى قائمة منسدلة بناءً على المحافظة المختارة
 */
function loadAreasToSelect(province, areaSelect) {
    // التحقق من صحة المعلمات
    if (!areaSelect || !province) return;
    
    // تفريغ القائمة وإضافة الخيار الافتراضي
    const defaultOption = areaSelect.querySelector('option[value=""]');
    areaSelect.innerHTML = '';
    
    // إعادة إضافة الخيار الافتراضي
    if (defaultOption) {
        areaSelect.appendChild(defaultOption);
    } else {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'اختر المنطقة';
        areaSelect.appendChild(option);
    }
    
    // إضافة مناطق المحافظة المختارة
    if (iraqProvinces[province]) {
        iraqProvinces[province].forEach(area => {
            const option = document.createElement('option');
            option.value = area;
            option.textContent = area;
            areaSelect.appendChild(option);
        });
        
        // تفعيل قائمة المناطق
        areaSelect.disabled = false;
    } else {
        // تعطيل قائمة المناطق إذا لم يتم العثور على المحافظة
        areaSelect.disabled = true;
        console.warn(`المحافظة "${province}" غير موجودة في قاعدة البيانات`);
    }
}

/**
 * دالة متعددة الاستخدام لتحميل المناطق (للتوافق مع الكود الموجود)
 */
function loadAreas(province) {
    // المسار القديم: البحث عن عناصر محددة
    const userAreaSelect = document.querySelector('select[name="area"]');
    const driverAreaSelect = document.getElementById('driverArea');
    
    // تحديث قائمة المناطق للمستخدم العادي
    if (userAreaSelect) {
        loadAreasToSelect(province, userAreaSelect);
    }
    
    // تحديث قائمة المناطق للسائق
    if (driverAreaSelect) {
        loadAreasToSelect(province, driverAreaSelect);
    }
    
    // المسار الجديد: محاولة العثور على قائمة مناطق مرتبطة
    const provinceSelect = document.querySelector(`select[value="${province}"]`);
    if (provinceSelect) {
        const areaSelect = getRelatedAreaSelect(provinceSelect);
        if (areaSelect) {
            loadAreasToSelect(province, areaSelect);
        }
    }
}

// تهيئة قوائم المحافظات عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    // تهيئة قوائم المحافظات
    initializeProvinceSelects();
    
    // إضافة مستمع الحدث للنموذج لضمان تحميل المناطق عند تقديم النموذج
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function(event) {
            // التحقق من قوائم المحافظات والمناطق
            const provinceSelects = form.querySelectorAll('select[name="province"], #driverProvince, #driverLocation');
            
            provinceSelects.forEach(provinceSelect => {
                if (provinceSelect.value) {
                    const areaSelect = getRelatedAreaSelect(provinceSelect);
                    if (areaSelect && !areaSelect.value && !areaSelect.disabled) {
                        event.preventDefault();
                        showToast('الرجاء اختيار المنطقة', 'warning');
                        areaSelect.focus();
                    }
                }
            });
        });
    });
});


        // دالة معاينة الصورة الشخصية
        function previewDriverPhoto(input) {
            const preview = document.getElementById('driverPhotoPreview');
            const placeholder = input.parentElement.querySelector('.upload-placeholder');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // دالة معاينة المستندات
        function previewDocument(input, previewId) {
            const preview = document.getElementById(previewId);
            const placeholder = input.parentElement.querySelector('.upload-placeholder');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // تحديث دالة معالجة تسجيل السائق
        async function handleDriverRegistration(event) {
            event.preventDefault();
            showLoading();

            try {
                const formData = new FormData(event.target);
                const success = await authManager.handleRegistration(formData, 'سائق');

                if (success) {
                    event.target.reset();
                    showToast('تم التسجيل بنجاح!');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showToast(error.message, 'error');
            } finally {
                hideLoading();
            }
        }


        // تحديث دالة معالجة تسجيل المستخدم
        async function handleUserRegistration(event) {
            event.preventDefault();
            showLoading();

            try {
                const formData = new FormData(event.target);
                const success = await authManager.handleRegistration(formData, 'مستخدم');

                if (success) {
                    event.target.reset();
                    showToast('تم التسجيل بنجاح!');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showToast(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // دالة التحقق من صحة المستندات
        function validateDocuments() {
            const requiredDocuments = ['idFront', 'idBack', 'licenseFront', 'licenseBack'];
            const missingDocs = [];

            for (const docId of requiredDocuments) {
                const input = document.getElementById(docId);
                if (!input || !input.files || !input.files[0]) {
                    missingDocs.push(docId);
                }
            }

            if (missingDocs.length > 0) {
                throw new Error(`يرجى رفع المستندات التالية: ${missingDocs.join(', ')}`);
            }

            return true;
        }


        // دوال معالجة النماذج
        async function handleRegistrationForm(event, type) {
            event.preventDefault();
            const loadingOverlay = document.querySelector('.loading-spinner');

            try {
                if (loadingOverlay) loadingOverlay.style.display = 'flex';

                const formData = new FormData(event.target);
                const success = await authManager.handleRegistration(formData, type);

                if (success) {
                    event.target.reset();
                    showToast(`تم التسجيل بنجاح ك${type}!`);
                }
            } catch (error) {
                console.error('Registration error:', error);
                showToast(error.message || 'حدث خطأ أثناء التسجيل', 'error');
            } finally {
                if (loadingOverlay) loadingOverlay.style.display = 'none';
            }
        }

        // ربط النماذج بدوال المعالجة
        document.addEventListener('DOMContentLoaded', function () {
            const driverForm = document.getElementById('driverRegistrationForm');
            if (driverForm) {
                driverForm.addEventListener('submit', (e) => handleRegistrationForm(e, 'سائق'));
            }

            const userForm = document.getElementById('userRegistrationForm');
            if (userForm) {
                userForm.addEventListener('submit', (e) => handleRegistrationForm(e, 'مستخدم'));
            }

            // معالجة إغلاق النوافذ المنبثقة
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('hidden.bs.modal', function () {
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                });
            });
        });



        // دالة إعادة تعيين معاينات الصور
        function resetPreviews() {
            const previews = document.querySelectorAll('img[id$="Preview"]');
            const placeholders = document.querySelectorAll('.upload-placeholder');

            previews.forEach(preview => {
                preview.src = '#';
                preview.style.display = 'none';
            });

            placeholders.forEach(placeholder => {
                placeholder.style.display = 'flex';
            });
        }

        // دوال فتح نوافذ التسجيل
        function openDriverRegistration() {
            const profileModal = bootstrap.Modal.getInstance(document.getElementById('profileModal'));
            profileModal.hide();

            const driverModal = new bootstrap.Modal(document.getElementById('driverRegistrationModal'));
            driverModal.show();
        }

        function openUserRegistration() {
            // يمكن إضافة نافذة تسجيل المستخدم هنا
            showToast('سيتم إضافة تسجيل المستخدمين قريباً');
        }

        // تهيئة عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', initializeForms);

        function generateDriverQR(driverData) {
            try {
                // استخدام رقم الطلب فقط لإنشاء الباركود
                const requestId = driverData.id; // مثال: DR1734725935436

                const qrContainer = document.createElement('div');
                new QRCode(qrContainer, {
                    text: requestId, // استخدام رقم الطلب فقط
                    width: 128,
                    height: 128,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.L, // مستوى تصحيح منخفض لأن البيانات بسيطة
                    quietZone: 10,
                    quietZoneColor: "#ffffff"
                });

                const qrImage = qrContainer.querySelector('img');
                if (!qrImage || !qrImage.src) {
                    throw new Error('فشل في إنشاء صورة QR');
                }

                return qrImage.src;
            } catch (error) {
                console.error('خطأ في إنشاء QR code:', error);
                throw new Error('فشل في إنشاء رمز QR');
            }
        }

        // تحديث دالة عرض نافذة النجاح
        function showSuccessModal(driverData, qrCodeUrl) {
            Swal.fire({
                title: '<strong>تم تقديم طلبك بنجاح!</strong>',
                html: `
            <div class="success-registration-modal">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="registration-details">
                    <p class="lead">شكراً لك، ${driverData.fullName}</p>
                    <p>تم استلام طلبك وسيتم مراجعته من قبل فريقنا.</p>
                    <p>رقم الطلب: <strong>${driverData.id}</strong></p>
                </div>
                <div class="qr-code-section">
                    <p>الباركود الخاص بطلبك:</p>
                    <img src="${qrCodeUrl}" alt="رمز QR" class="qr-code-image">
                    <button class="download-qr-btn" onclick="downloadQRCode('${qrCodeUrl}', '${driverData.id}')">
                        <i class="fas fa-download"></i>
                        تحميل الباركود
                    </button>
                </div>
                <div class="note-section">
                    <p>* يرجى الاحتفاظ برقم الطلب والباركود للمراجعة</p>
                    <p>* يمكنك استخدام هذا الباركود لتتبع حالة طلبك</p>
                </div>
            </div>
        `,
                icon: 'success',
                confirmButtonText: 'تم',
                confirmButtonColor: '#FFD700',
                allowOutsideClick: false,
                customClass: {
                    popup: 'success-registration-popup'
                }
            });
        }

        // دالة للتحقق من صحة الباركود
        function validateQRCode(qrCodeUrl) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => reject(new Error('فشل في إنشاء الباركود'));
                img.src = qrCodeUrl;
            });
        }


        // دالة تحميل الباركود كصورة
        function downloadQRCode(dataUrl, driverId) {
            const link = document.createElement('a');
            link.download = `driver-qr-${driverId}.png`;
            link.href = dataUrl;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // دالة عرض نافذة النجاح
        function showSuccessModal(driverData, qrCodeUrl) {
            Swal.fire({
                title: '<strong>تم تقديم طلبك بنجاح!</strong>',
                html: `
            <div class="success-registration-modal">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="registration-details">
                    <p class="lead">شكراً لك، ${driverData.fullName}</p>
                    <p>تم استلام طلبك وسيتم مراجعته من قبل فريقنا.</p>
                    <p>رقم الطلب: <strong>${driverData.id}</strong></p>
                </div>
                <div class="qr-code-section">
                    <p>الباركود الخاص بك:</p>
                    <img src="${qrCodeUrl}" alt="رمز QR" class="qr-code-image">
                    <button class="download-qr-btn" onclick="downloadQRCode('${qrCodeUrl}', '${driverData.id}')">
                        <i class="fas fa-download"></i>
                        تحميل الباركود
                    </button>
                </div>
                <div class="note-section">
                    <p>* يرجى الاحتفاظ برقم الطلب والباركود للمراجعة</p>
                </div>
            </div>
        `,
                icon: 'success',
                confirmButtonText: 'تم',
                confirmButtonColor: '#FFD700',
                allowOutsideClick: false,
                customClass: {
                    popup: 'success-registration-popup'
                }
            });
        }

        function generateDriverQR(driverData) {
            // استخدام مكتبة QRCode.js بشكل صحيح
            const qrContainer = document.createElement('div');
            new QRCode(qrContainer, {
                text: JSON.stringify({
                    id: driverData.id,
                    name: driverData.fullName,
                    phone: driverData.phone
                }),
                width: 256,
                height: 256
            });
            return qrContainer.firstChild.toDataURL();
        }
        function submitDriverRegistration() {
            const form = document.getElementById('driverRegistrationForm');

            // التحقق من صحة البيانات أولاً
            if (!validateForm(form)) {
                return;
            }

            // معالجة التسجيل
            processRegistration(new FormData(form));
        }

        async function processRegistration(formData) {
            try {
                // معالجة البيانات على مراحل
                const basicInfo = await saveBasicInfo(formData);
                const documents = await saveDocuments(formData);

                await finalizeRegistration(basicInfo, documents);

                showSuccessMessage();
            } catch (error) {
                showErrorMessage(error);
            }
        }
        function optimizeImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // تقليل حجم الصورة
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 600;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', 0.7);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }



        function displayAllDrivers() {
            const drivers = getAllDrivers(); // قم باستدعاء البيانات
            const grid = document.getElementById('driversGrid');
            grid.innerHTML = ''; // تنظيف الشبكة
            drivers.forEach(driver => {
                const card = createDriverCard(driver); // قم بإنشاء البطاقة
                grid.appendChild(card);
            });
        }
        document.addEventListener('DOMContentLoaded', function () {
            // التأكد من تحميل Firebase
            if (typeof firebase !== 'undefined') {
                // تهيئة Firebase
                firebase.initializeApp(firebaseConfig);

                // بدء تحميل البيانات
                loadDrivers();

                // تهيئة الخريطة
                if (!window.mapInitialized) {
                    window.mapInitialized = true;
                    initMap();
                }
            } else {
                console.error('Firebase not loaded');
            }
        });




        document.addEventListener('DOMContentLoaded', function () {
            displayAllDrivers(); // استدعاء الدالة التي تعرض جميع السائقين
            document.querySelector('.location-chip[data-location="all"]').classList.add('active'); // تفعيل فلتر "الكل"
        });
        function displayAllDrivers() {
            const drivers = getAllDrivers(); // استدعاء البيانات
            const grid = document.getElementById('driversGrid');
            grid.innerHTML = ''; // تنظيف المحتوى
            drivers.forEach(driver => {
                const card = createDriverCard(driver); // إنشاء بطاقة لكل سائق
                grid.appendChild(card);
            });
        }
        document.querySelectorAll('.location-chip').forEach(chip => {
            chip.addEventListener('click', function () {
                document.querySelectorAll('.location-chip').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                const location = this.getAttribute('data-location');
                if (location === 'all') {
                    displayAllDrivers(); // عرض كل السائقين
                } else {
                    filterDrivers(location); // تصفية السائقين بناءً على الموقع
                }
            });
        });

        function toggleSideNav() {
            const sideNav = document.getElementById('sideNav');
            const navBackdrop = document.getElementById('navBackdrop');
            const body = document.body;

            // Toggle الشريط الجانبي
            sideNav.classList.toggle('open');
            navBackdrop.classList.toggle('show');
            body.classList.toggle('side-nav-open'); // إضافة/إزالة تعطيل التمرير
        }
        function openUserRegistration() {
            const profileModal = bootstrap.Modal.getInstance(document.getElementById('profileModal'));
            profileModal.hide();

            const userModal = new bootstrap.Modal(document.getElementById('userRegistrationModal'));
            userModal.show();
        }

        // دالة معاينة الصورة الشخصية
        function previewUserPhoto(input) {
            const preview = document.getElementById('userPhotoPreview');
            const placeholder = input.parentElement.querySelector('.upload-placeholder');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // دالة معالجة تسجيل المستخدم
        async function handleUserRegistration(event) {
            event.preventDefault();
            showLoading();

            try {
                const formData = new FormData(event.target);

                // التحقق من تطابق كلمات المرور
                if (formData.get('password') !== formData.get('confirmPassword')) {
                    throw new Error('كلمات المرور غير متطابقة');
                }

                // التحقق من الموافقة على الشروط والأحكام
                if (!formData.get('terms')) {
                    throw new Error('يجب الموافقة على الشروط والأحكام');
                }

                // إنشاء معرف فريد للمستخدم
                const userId = `USER${Date.now()}`;

                // رفع الصورة الشخصية
                let photoUrl = null;
                const photoFile = document.getElementById('userPhoto').files[0];
                if (photoFile) {
                    const imageRef = storage.ref(`users/${userId}/${Date.now()}_${photoFile.name}`);
                    const uploadTask = await imageRef.put(photoFile);
                    photoUrl = await uploadTask.ref.getDownloadURL();
                }

                // إعداد بيانات المستخدم
                const userData = {
                    id: userId,
                    fullName: formData.get('fullName'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    province: formData.get('province'),
                    area: formData.get('area'),
                    address: formData.get('address'),

                    photoUrl: photoUrl,
                    userType: userType,
                    createdAt: firebase.database.ServerValue.TIMESTAMP


                };

                // حفظ البيانات في Firebase
                await database.ref('users').child(userId).set(userData);

                // إغلاق النافذة وإظهار رسالة النجاح
                const modal = bootstrap.Modal.getInstance(document.getElementById('userRegistrationModal'));
                modal.hide();

                Swal.fire({
                    title: 'تم التسجيل بنجاح!',
                    text: 'مرحباً بك في تطبيق تاكسي العراق',
                    icon: 'success',
                    confirmButtonColor: '#FFD700',
                    confirmButtonText: 'تم'
                });

            } catch (error) {
                console.error('Registration error:', error);
                Swal.fire({
                    title: 'خطأ!',
                    text: error.message || 'حدث خطأ أثناء التسجيل',
                    icon: 'error',
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'حسناً'
                });
            } finally {
                hideLoading();
            }
        }

        // إضافة مستمع الحدث لنموذج التسجيل
        document.addEventListener('DOMContentLoaded', function () {
            const userRegistrationForm = document.getElementById('userRegistrationForm');
            if (userRegistrationForm) {
                userRegistrationForm.addEventListener('submit', handleUserRegistration);
            }
        });
        //اعدادات التنبيه بن السائق في الجوار

        class LocationNotificationSystem {
            constructor() {
                this.database = firebase.database();
                this.NOTIFICATION_DISTANCE = 500; // المسافة بالأمتار التي عندها يتم إرسال الإشعار
                this.notificationSent = new Set(); // لتجنب تكرار الإشعارات
                this.activeWatches = new Map(); // لتتبع مراقبة المواقع النشطة
            }

            // حساب المسافة بين نقطتين
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // نصف قطر الأرض بالأمتار
                const φ1 = lat1 * Math.PI / 180;
                const φ2 = lat2 * Math.PI / 180;
                const Δφ = (lat2 - lat1) * Math.PI / 180;
                const Δλ = (lon2 - lon1) * Math.PI / 180;

                const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

                return R * c;
            }

            // تحديث موقع السائق
            async updateDriverLocation(driverId, latitude, longitude) {
                try {
                    const locationUpdate = {
                        latitude,
                        longitude,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };

                    // تحديث موقع السائق في قاعدة البيانات
                    await this.database.ref(`drivers/${driverId}/location`).set(locationUpdate);

                    // تحديث موقع السائق على الخريطة إذا كان موجوداً
                    if (window.map && window.markerLayer) {
                        const driverMarker = window.markerLayer.getLayers().find(
                            layer => layer.options.driverId === driverId
                        );

                        if (driverMarker) {
                            driverMarker.setLatLng([latitude, longitude]);
                        }
                    }

                    // التحقق من الرحلات النشطة
                    this.checkActiveTrips(driverId, { latitude, longitude });
                } catch (error) {
                    console.error('Error updating driver location:', error);
                    showToast('حدث خطأ في تحديث الموقع', 'error');
                }
            }

            // التحقق من الرحلات النشطة
            async checkActiveTrips(driverId, driverLocation) {
                try {
                    const tripsRef = this.database.ref('trips');
                    const activeTrips = await tripsRef
                        .orderByChild('driverId')
                        .equalTo(driverId)
                        .once('value');

                    activeTrips.forEach(snapshot => {
                        const trip = snapshot.val();
                        if (trip.status === 'active' && trip.pickupLocation) {
                            const distance = this.calculateDistance(
                                driverLocation.latitude,
                                driverLocation.longitude,
                                trip.pickupLocation.latitude,
                                trip.pickupLocation.longitude
                            );

                            if (distance <= this.NOTIFICATION_DISTANCE && !this.notificationSent.has(trip.id)) {
                                this.sendArrivalNotification(trip.userId, trip.id, driverId);
                                this.notificationSent.add(trip.id);
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error checking active trips:', error);
                }
            }

            // إرسال إشعار الوصول
            async sendArrivalNotification(userId, tripId, driverId) {
                try {
                    // الحصول على معلومات السائق
                    const driverSnapshot = await this.database.ref(`drivers/${driverId}`).once('value');
                    const driver = driverSnapshot.val();

                    // الحصول على token المستخدم
                    const userTokenSnapshot = await this.database.ref(`users/${userId}/notificationToken`).once('value');
                    const userToken = userTokenSnapshot.val();

                    if (userToken) {
                        const notification = {
                            title: "السائق في انتظارك!",
                            body: `${driver.name} وصل إلى موقعك وهو في انتظارك الآن.`,
                            icon: driver.imageUrl || '/default-driver-icon.png'
                        };

                        // تحديث حالة الرحلة
                        await this.database.ref(`trips/${tripId}`).update({
                            driverArrived: true,
                            arrivalTime: firebase.database.ServerValue.TIMESTAMP
                        });

                        // إظهار الإشعار في واجهة المستخدم
                        this.showInAppNotification(notification);

                        // إرسال إشعار عبر FCM إذا كان متاحاً
                        if (firebase.messaging && userToken) {
                            try {
                                const message = {
                                    token: userToken,
                                    notification: notification,
                                    data: {
                                        tripId: tripId,
                                        driverId: driverId,
                                        type: 'driver_arrival'
                                    }
                                };

                                await firebase.messaging().send(message);
                            } catch (fcmError) {
                                console.error('Error sending FCM notification:', fcmError);
                            }
                        }

                        // محاولة إرسال إشعار محلي
                        if ('Notification' in window && Notification.permission === 'granted') {
                            new Notification(notification.title, {
                                body: notification.body,
                                icon: notification.icon
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error sending arrival notification:', error);
                }
            }

            // إظهار إشعار في واجهة المستخدم
            showInAppNotification(notification) {
                const toast = document.createElement('div');
                toast.className = 'notification-toast animate__animated animate__fadeInRight';
                toast.innerHTML = `
        <div class="notification-content">
            <div class="notification-title">${notification.title}</div>
            <div class="notification-body">${notification.body}</div>
        </div>
        <button class="notification-close" onclick="this.parentElement.remove()">×</button>
    `;

                document.body.appendChild(toast);

                // تشغيل صوت الإشعار
                const audio = new Audio('/https://github.com/AlQasimMall/taxialpasha/blob/main/%D8%A7%D9%84%D9%87%D8%A7%D8%AA%D9%81-%D8%A7%D9%84%D8%AB%D8%A7%D8%A8%D8%AA.mp3');
                audio.play().catch(error => console.log('Could not play notification sound:', error));

                // إزالة الإشعار بعد 5 ثواني
                setTimeout(() => {
                    toast.classList.replace('animate__fadeInRight', 'animate__fadeOutRight');
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            }

            // بدء تتبع موقع السائق
            startDriverLocationUpdates(driverId) {
                if (!navigator.geolocation) {
                    showToast('خدمة تحديد الموقع غير متوفرة في متصفحك', 'error');
                    return null;
                }

                const watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        this.updateDriverLocation(
                            driverId,
                            position.coords.latitude,
                            position.coords.longitude
                        );
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        showToast('حدث خطأ في تحديد موقعك', 'error');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );

                this.activeWatches.set(driverId, watchId);
                return watchId;
            }

            // إيقاف تتبع موقع السائق
            stopDriverLocationUpdates(driverId) {
                const watchId = this.activeWatches.get(driverId);
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    this.activeWatches.delete(driverId);
                }
            }
        }

        // إنشاء نسخة عامة من نظام الإشعارات
        const locationNotificationSystem = new LocationNotificationSystem();

        // نظام الإشعارات المحسن
        // نظام الإشعارات المحسن
        class NotificationSystem {
            constructor() {
                this.container = this.createContainer();
                this.notifications = new Set();
                this.initialize();
            }

            // تهيئة نظام الإشعارات
            initialize() {
                this.checkNotificationSupport()
                    .then(() => this.requestPermission())
                    .catch(error => {
                        console.error('Notification initialization error:', error);
                    });
            }

            // إنشاء حاوية الإشعارات
            createContainer() {
                const container = document.createElement('div');
                container.className = 'notification-container';
                document.body.appendChild(container);
                return container;
            }

            // التحقق من دعم الإشعارات
            async checkNotificationSupport() {
                if (!('Notification' in window)) {
                    throw new Error('المتصفح لا يدعم الإشعارات');
                }
            }

            // طلب إذن الإشعارات
            async requestPermission() {
                if (Notification.permission === 'default') {
                    this.showPermissionDialog();
                } else if (Notification.permission === 'granted') {
                    this.show('مرحباً بك!', 'تم تفعيل الإشعارات بنجاح', 'success');
                }
            }

            // عرض نافذة طلب الإذن
            showPermissionDialog() {
                const dialog = document.createElement('div');
                dialog.className = 'permission-dialog';
                dialog.innerHTML = `
            <div class="permission-dialog-icon">
                <i class="fas fa-bell"></i>
            </div>
            <h3 class="permission-dialog-title">تفعيل الإشعارات</h3>
            <p class="permission-dialog-message">
                نود إرسال إشعارات لإبقائك على اطلاع بآخر التحديثات والعروض.
                هل تود تفعيل الإشعارات؟
            </p>
            <div class="permission-dialog-buttons">
                <button class="permission-button allow">نعم، تفعيل الإشعارات</button>
                <button class="permission-button deny">لا، شكراً</button>
            </div>
        `;

                document.body.appendChild(dialog);

                dialog.querySelector('.allow').addEventListener('click', async () => {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        this.show('تم!', 'تم تفعيل الإشعارات بنجاح', 'success');
                    }
                    dialog.remove();
                });

                dialog.querySelector('.deny').addEventListener('click', () => {
                    dialog.remove();
                    this.show('تم الإلغاء', 'يمكنك تفعيل الإشعارات لاحقاً من الإعدادات', 'info');
                });
            }

            // عرض إشعار
            show(title, message, type = 'info', duration = 3000) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
            <div class="notification-icon">
                ${this.getIconForType(type)}
            </div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
            <button class="notification-close">&times;</button>
            <div class="notification-progress"></div>
        `;

                const closeBtn = notification.querySelector('.notification-close');
                closeBtn.addEventListener('click', () => this.close(notification));

                this.container.appendChild(notification);
                this.notifications.add(notification);

                setTimeout(() => this.close(notification), duration);

                return notification;
            }

            // إغلاق إشعار
            close(notification) {
                if (!this.notifications.has(notification)) return;

                notification.style.animation = 'slideOut 0.5s ease forwards';

                setTimeout(() => {
                    notification.remove();
                    this.notifications.delete(notification);
                }, 500);
            }

            // الحصول على أيقونة الإشعار حسب النوع
            getIconForType(type) {
                const icons = {
                    success: '<i class="fas fa-check-circle"></i>',
                    error: '<i class="fas fa-times-circle"></i>',
                    warning: '<i class="fas fa-exclamation-circle"></i>',
                    info: '<i class="fas fa-info-circle"></i>'
                };
                return icons[type] || icons.info;
            }
        }

        // إنشاء نسخة عامة من نظام الإشعارات
        const notificationSystem = new NotificationSystem();

        // دالة مختصرة لعرض الإشعارات
        function showNotification(title, message, type = 'info') {
            notificationSystem.show(title, message, type);
        }

        // مثال على الاستخدام عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            // إشعار ترحيبي
            setTimeout(() => {
                showNotification(
                    'مرحباً بك في تاكسي العراق!',
                    'نحن سعداء بانضمامك إلينا',
                    'info'
                );
            }, 1000);

            // التحقق من حالة الاتصال
            if (navigator.onLine) {
                showNotification(
                    'متصل بالإنترنت',
                    'يمكنك الآن استخدام جميع خدمات التطبيق',
                    'success'
                );
            } else {
                showNotification(
                    'غير متصل',
                    'يرجى التحقق من اتصال الإنترنت',
                    'error'
                );
            }
        });

        // مراقبة حالة الاتصال
        window.addEventListener('online', () => {
            showNotification(
                'تم استعادة الاتصال',
                'يمكنك الآن استخدام جميع خدمات التطبيق',
                'success'
            );
        });

        window.addEventListener('offline', () => {
            showNotification(
                'انقطع الاتصال',
                'يرجى التحقق من اتصال الإنترنت',
                'error'
            );
        });
        // إضافة هذا الكود في ملف app.js
        class NotificationTester {
            constructor() {
                this.messaging = firebase.messaging();
                this.initialized = false;
            }

            async testNotifications() {
                try {
                    // التحقق من دعم الإشعارات
                    if (!('Notification' in window)) {
                        throw new Error('المتصفح لا يدعم الإشعارات');
                    }

                    // طلب الإذن
                    const permission = await Notification.requestPermission();
                    console.log('حالة إذن الإشعارات:', permission);

                    if (permission !== 'granted') {
                        throw new Error('لم يتم منح إذن الإشعارات');
                    }

                    // الحصول على التوكن
                    const token = await this.messaging.getToken({
                        vapidKey: 'BI9cpoewcZa1ftyZ_bGjO0GYa4_cT0HNja4YFd6FwLwHg5c0gQ5iSj_MJZRhMxKdgJ0-d-_rEXcpSQ_cx7GqCSc'
                    });

                    console.log('تم الحصول على التوكن:', token);

                    // حفظ التوكن في قاعدة البيانات
                    await this.saveTokenToDatabase(token);

                    // إرسال إشعار تجريبي
                    this.showTestNotification();

                    return {
                        success: true,
                        token: token,
                        message: 'تم إعداد الإشعارات بنجاح'
                    };

                } catch (error) {
                    console.error('خطأ في اختبار الإشعارات:', error);
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }

            async saveTokenToDatabase(token) {
                try {
                    const userId = localStorage.getItem('userId') || 'anonymous';
                    await firebase.database().ref(`fcm_tokens/${userId}`).set({
                        token: token,
                        lastUpdated: firebase.database.ServerValue.TIMESTAMP,
                        device: {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform
                        }
                    });
                    console.log('تم حفظ التوكن في قاعدة البيانات');
                } catch (error) {
                    console.error('خطأ في حفظ التوكن:', error);
                }
            }

            showTestNotification() {
                const notification = new Notification('اختبار الإشعارات', {
                    body: 'هذا إشعار تجريبي للتأكد من عمل النظام',
                    icon: '/pngwing.com.png',
                    badge: '/pngwing.com.png'
                });

                notification.onclick = () => {
                    console.log('تم النقر على الإشعار التجريبي');
                    window.focus();
                    notification.close();
                };
            }
        }



        // إضافة في نهاية الملف
        function showNearbyDriversMap() {
            // إغلاق القائمة الجانبية
            toggleSideNav();

            // عرض نافذة منبثقة تحتوي على الخريطة
            Swal.fire({
                title: 'السائقين في الجوار',
                html: '<div id="nearbyDriversMap"></div>',
                width: '90%',
                padding: '0',
                background: '#1a1a1a',
                showConfirmButton: false,
                showCloseButton: true,
                customClass: {
                    popup: 'dark-popup',
                    title: 'text-white',
                    htmlContainer: 'p-0'
                },
                didOpen: () => {
                    // تهيئة الخريطة
                    const mapContainer = document.getElementById('nearbyDriversMap');
                    const root = ReactDOM.createRoot(mapContainer);
                    root.render(React.createElement(NearbyDriversMap));
                }
            });
        }

        // تحديث دالة إنشاء مؤشر السائق
        function createDriverMarker(driver) {
            // حساب حالة السائق ولون المؤشر
            const isActive = driver.active;
            const statusColor = isActive ? '#2ECC40' : '#FF4136';

            // إنشاء أيقونة مخصصة مع تأثيرات متحركة
            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: `
            <div class="driver-marker ${isActive ? 'active' : 'inactive'}">
                <div class="marker-pulse" style="border-color: ${statusColor}"></div>
                <div class="marker-container">
                    <img src="${driver.imageUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" 
                         alt="${driver.name}"
                         onerror="this.classList.add('error')">
                    <div class="marker-status" style="background-color: ${statusColor}">
                        <i class="fas fa-taxi"></i>
                    </div>
                </div>
            </div>
        `,
                iconSize: [60, 60],
                iconAnchor: [30, 30]
            });

            // إنشاء المؤشر مع معلومات إضافية
            const marker = L.marker([driver.coordinates.lat, driver.coordinates.lng], {
                icon: icon,
                title: driver.name,
                riseOnHover: true,
                zIndexOffset: isActive ? 1000 : 0
            });

            // إضافة النافذة المنبثقة المحسنة
            marker.bindPopup(`
        <div class="driver-popup">
            <div class="driver-popup-header">
                <div class="popup-status ${isActive ? 'active' : 'inactive'}">
                    ${isActive ? 'متاح الآن' : 'مشغول'}
                </div>
                <img src="${driver.imageUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" 
                     alt="${driver.name}"
                     onerror="this.src='https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'">
                <h4>${driver.name}</h4>
                <div class="driver-rating">
                    ${generateRatingStars(driver.rating || 5.0)}
                </div>
            </div>
            <div class="driver-popup-info">
                <div class="info-row">
                    <i class="fas fa-car"></i>
                    <span>${driver.carType} - ${driver.carModel}</span>
                </div>
                <div class="info-row">
                    <i class="fas fa-route"></i>
                    <span>${driver.distance?.toFixed(1) || '0.0'} كم</span>
                </div>
                <div class="info-row">
                    <i class="fas fa-clock"></i>
                    <span>${calculateArrivalTime(driver.distance)} دقيقة للوصول</span>
                </div>
            </div>
            <div class="driver-popup-actions">
                <button onclick="openChatWindow('${driver.id}')" class="chat-btn ripple">
                    <i class="fas fa-comment"></i>
                    <span>مراسلة</span>
                </button>
                <button onclick="bookDriver('${driver.id}')" class="book-btn ripple" 
                        ${!isActive ? 'disabled' : ''}>
                    <i class="fas fa-taxi"></i>
                    <span>حجز</span>
                </button>
            </div>
            ${!isActive ? '<div class="booking-notice">السائق مشغول حالياً</div>' : ''}
        </div>
    `, {
                className: `custom-popup ${isActive ? 'active' : 'inactive'}`,
                minWidth: 280,
                maxWidth: 320,
                autoClose: false,
                closeButton: true
            });

            // إضافة مستمعي الأحداث للتفاعل
            marker.on('mouseover', function () {
                this.getElement().classList.add('marker-hover');
            });

            marker.on('mouseout', function () {
                this.getElement().classList.remove('marker-hover');
            });

            return marker;
        }

        // دالة مساعدة لإنشاء نجوم التقييم
        function generateRatingStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let starsHtml = '';

            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    starsHtml += '<i class="fas fa-star"></i>';
                } else if (i === fullStars && hasHalfStar) {
                    starsHtml += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    starsHtml += '<i class="far fa-star"></i>';
                }
            }

            return `<div class="stars-container">${starsHtml}</div>`;
        }

        // دالة لحساب وقت الوصول التقريبي
        function calculateArrivalTime(distance) {
            // افتراض متوسط سرعة 40 كم/ساعة
            if (!distance) return '--';
            const timeInMinutes = Math.ceil((distance * 60) / 40);
            return timeInMinutes;
        }

        // تحسين معالج أخطاء الصور
        document.addEventListener('error', function (e) {
            if (e.target.tagName.toLowerCase() === 'img') {
                const defaultImage = 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527';
                if (e.target.src !== defaultImage) {
                    e.target.src = defaultImage;
                    e.target.classList.add('error');
                    console.warn(`Failed to load image for driver, using default avatar`);
                }
            }
        }, true);

        // إضافة تأثير Ripple للأزرار
        document.addEventListener('click', function (e) {
            const rippleButton = e.target.closest('.ripple');
            if (rippleButton && !rippleButton.disabled) {
                const rect = rippleButton.getBoundingClientRect();
                const ripple = document.createElement('div');
                ripple.className = 'ripple-effect';
                ripple.style.left = `${e.clientX - rect.left}px`;
                ripple.style.top = `${e.clientY - rect.top}px`;
                rippleButton.appendChild(ripple);
                setTimeout(() => ripple.remove(), 1000);
            }
        });
        function captureCurrentLocation() {
            // إنشاء وعد لمعالجة تحديد الموقع
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    Swal.fire({
                        icon: 'error',
                        title: 'خطأ!',
                        text: 'متصفحك لا يدعم تحديد الموقع'
                    });
                    reject('Geolocation not supported');
                    return;
                }

                // عرض مؤشر التحميل
                const loadingAlert = Swal.fire({
                    title: 'جاري تحديد موقعك...',
                    text: 'يرجى الانتظار',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // إغلاق مؤشر التحميل فوراً
                        loadingAlert.close();

                        // تحديث حقول الإحداثيات
                        document.getElementById('driverLatitude').value = position.coords.latitude;
                        document.getElementById('driverLongitude').value = position.coords.longitude;

                        // عرض رسالة النجاح لفترة قصيرة
                        Swal.fire({
                            icon: 'success',
                            title: 'تم!',
                            text: 'تم تحديد موقعك بنجاح',
                            timer: 1500,
                            showConfirmButton: false
                        });

                        resolve(position);
                    },
                    (error) => {
                        // إغلاق مؤشر التحميل
                        loadingAlert.close();

                        let errorMessage = 'حدث خطأ في تحديد الموقع';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'تم رفض الوصول إلى الموقع. يرجى السماح للتطبيق باستخدام خدمة الموقع';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'معلومات الموقع غير متوفرة';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'انتهت مهلة طلب الموقع';
                                break;
                        }

                        Swal.fire({
                            icon: 'error',
                            title: 'خطأ!',
                            text: errorMessage
                        });

                        reject(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }


        // تشغيل الاختبار عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', addTestButton);
        // إضافة متغير عالمي لتخزين معرف المراقبة
        let locationWatchId = null;

        // دالة بدء تتبع موقع السائق
        function startDriverLocationTracking(driverId) {
            if (!navigator.geolocation) {
                showToast('متصفحك لا يدعم خدمة تحديد الموقع', 'error');
                return;
            }

            // إيقاف أي تتبع سابق إذا كان موجوداً
            if (locationWatchId) {
                stopDriverLocationTracking();
            }

            // بدء مراقبة الموقع
            locationWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    updateDriverLocation(driverId, position);
                },
                (error) => {
                    handleLocationError(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );

            // تخزين معرف السائق في localStorage
            localStorage.setItem('activeDriverId', driverId);

            showToast('تم تفعيل تتبع الموقع بنجاح', 'success');
        }

        // دالة إيقاف تتبع موقع السائق
        function stopDriverLocationTracking() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
                localStorage.removeItem('activeDriverId');
                showToast('تم إيقاف تتبع الموقع', 'info');
            }
        }

        // دالة تحديث موقع السائق
        async function updateDriverLocation(driverId, position) {
            try {
                const locationUpdate = {
                    coordinates: {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    },
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                };

                // تحديث الموقع في قاعدة البيانات
                await database.ref(`drivers/${driverId}`).update(locationUpdate);

                // تحديث موقع السائق على الخريطة
                updateDriverMarkerOnMap(driverId, locationUpdate.coordinates);
            } catch (error) {
                console.error('Error updating driver location:', error);
                showToast('حدث خطأ في تحديث الموقع', 'error');
            }
        }

        // دالة تحديث موقع السائق على الخريطة
        function updateDriverMarkerOnMap(driverId, coordinates) {
            if (!map || !markerLayer) return;

            // البحث عن علامة السائق الحالية
            let driverMarker = markerLayer.getLayers().find(
                layer => layer.options.driverId === driverId
            );

            if (driverMarker) {
                // تحديث موقع العلامة الحالية
                driverMarker.setLatLng([coordinates.lat, coordinates.lng]);
            } else {
                // إنشاء علامة جديدة للسائق
                database.ref(`drivers/${driverId}`).once('value')
                    .then(snapshot => {
                        const driver = snapshot.val();
                        if (driver) {
                            driverMarker = L.marker([coordinates.lat, coordinates.lng], {
                                icon: L.divIcon({
                                    html: `
                                <div style="position: relative; text-align: center;">
                                    <img src="${driver.imageUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" 
                                         alt="صورة السائق" 
                                         style="width: 35px; height: 35px; border-radius: 50%; border: 2px solid #FFD700;">
                                    <i class="fas fa-taxi" 
                                       style="position: absolute; bottom: -5px; right: 50%; transform: translateX(50%); 
                                       color: #FFD700; font-size: 1.2rem;"></i>
                                </div>
                            `,
                                    className: 'driver-marker',
                                    iconSize: [40, 40]
                                }),
                                driverId: driverId
                            }).addTo(markerLayer);

                            // إضافة النافذة المنبثقة
                            driverMarker.bindPopup(`
                        <div style="text-align: center;">
                            <h6>${driver.name}</h6>
                            <p>${driver.carType} - ${driver.carModel}</p>
                            <button class="btn btn-sm btn-primary" onclick="openChatWindow('${driverId}')">
                                <i class="fas fa-comment"></i> مراسلة
                            </button>
                        </div>
                    `);
                        }
                    });
            }
        }


        
        // دالة فتح نافذة تسجيل الدخول
        function openLoginModal() {
            // إغلاق نافذة اختيار نوع الحساب
            const profileModal = bootstrap.Modal.getInstance(document.getElementById('profileModal'));
            profileModal.hide();

            // فتح نافذة تسجيل الدخول
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
        }

        // دالة معالجة تسجيل الدخول
        async function handleLogin(event) {
            event.preventDefault();
            showLoading();

            try {
                const formData = new FormData(event.target);
                const email = formData.get('email');
                const password = formData.get('password');

                // البحث عن المستخدم في قاعدة البيانات
                const usersRef = firebase.database().ref('users');
                const snapshot = await usersRef.orderByChild('email').equalTo(email).once('value');
                const users = snapshot.val();

                if (!users) {
                    throw new Error('البريد الإلكتروني أو كلمة المرور غير صحيحة');
                }

                const userId = Object.keys(users)[0];
                const user = users[userId];

                // التحقق من كلمة المرور (في الواقع يجب استخدام Firebase Auth)
                if (password !== user.password) {
                    throw new Error('البريد الإلكتروني أو كلمة المرور غير صحيحة');
                }

                // حفظ بيانات المستخدم
                localStorage.setItem('currentUser', JSON.stringify(user));

                // تحديث واجهة المستخدم
                updateUIAfterLogin(user);

                // إغلاق نافذة تسجيل الدخول
                const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                loginModal.hide();

                // إظهار رسالة نجاح
                showToast('تم تسجيل الدخول بنجاح');

            } catch (error) {
                console.error('Login error:', error);
                showToast(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // دالة معالجة تسجيل الخروج
        function handleLogout() {
            // إزالة بيانات المستخدم من التخزين المحلي
            localStorage.removeItem('currentUser');

            // إعادة تعيين واجهة المستخدم
            resetUserInterface();

            // عرض رسالة نجاح
            showToast('تم تسجيل الخروج بنجاح', 'success');
        }

        // دالة تحديث واجهة المستخدم بعد تسجيل الدخول
        function updateUIAfterLogin(user) {
            // إخفاء زر تسجيل من الشريط العلوي
            const registrationBtn = document.querySelector('[data-bs-target="#profileModal"]');
            if (registrationBtn) {
                registrationBtn.style.display = 'none';
            }

            // تحديث زر الملف الشخصي
            const profileBtn = document.querySelector('.user-profile-btn');
            if (profileBtn) {
                profileBtn.innerHTML = `
            <img src="${user.photo || 'default-avatar.png'}" 
                 alt="${user.name}" 
                 class="rounded-circle me-2" 
                 style="width: 35px; height: 35px; object-fit: cover;">
            <span class="d-none d-md-inline">${user.name}</span>
        `;

                // تحديث القائمة المنسدلة
                const dropdownMenu = document.createElement('div');
                dropdownMenu.className = 'dropdown-menu dropdown-menu-end';
                dropdownMenu.innerHTML = `
            <a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>الملف الشخصي</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item text-danger" href="#" onclick="handleLogout()">
                <i class="fas fa-sign-out-alt me-2"></i>تسجيل الخروج
            </a>
        `;
                profileBtn.parentElement.appendChild(dropdownMenu);
            }

            // تحديث معلومات المستخدم في الشريط الجانبي
            const sideNavUserInfo = document.querySelector('.side-nav-user-info');
            if (sideNavUserInfo) {
                sideNavUserInfo.innerHTML = `
            <div class="text-center p-4">
                <img src="${user.photo || 'default-avatar.png'}" 
                     alt="${user.name}" 
                     class="rounded-circle mb-3"
                     style="width: 80px; height: 80px; object-fit: cover;">
                <h6 class="text-white mb-1">${user.name}</h6>
                <span class="badge bg-primary mb-3">${user.userType}</span>
                <button onclick="handleLogout()" 
                        class="btn btn-danger btn-sm w-100">
                    <i class="fas fa-sign-out-alt me-2"></i>تسجيل الخروج
                </button>
            </div>
        `;
            }
        }
        async function approveDriver(driverId) {
            try {
                await database.ref(`drivers/${driverId}`).update({
                    approved: true,
                    status: 'approved',
                    active: true
                });

                showToast('تم تفعيل السائق بنجاح', 'success');
                loadDrivers(); // تحديث العرض
            } catch (error) {
                console.error('Error approving driver:', error);
                showToast('حدث خطأ أثناء تفعيل السائق', 'error');
            }
        }

        // دالة فحص حالة الموافقة على السائق
        function checkDriverApprovalStatus(driverId) {
            return new Promise((resolve, reject) => {
                database.ref(`drivers/${driverId}`).once('value')
                    .then(snapshot => {
                        const driver = snapshot.val();
                        if (!driver) {
                            reject(new Error('لم يتم العثور على السائق'));
                            return;
                        }
                        resolve({
                            isApproved: driver.approved === true,
                            isPending: driver.approvalStatus === 'pending',
                            status: driver.approvalStatus || 'not_approved'
                        });
                    })
                    .catch(error => reject(error));
            });
        }

        // دالة لتحديث أيقونة التسجيل عند تسجيل الدخول
        function updateUserProfileIcon(user) {
            const userProfile = document.getElementById('userProfile');
            const userProfileImg = userProfile.querySelector('img');
            userProfileImg.src = user.photoURL || 'default-profile.png'; // استخدم صورة المستخدم أو صورة افتراضية
            userProfile.classList.remove('d-none');
        }

        // مثال على كيفية استخدام الدالة عند تسجيل الدخول
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                updateUserProfileIcon(user);
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            // Proporcionar una configuración explícita
            const modalOptions = {
                backdrop: true, // o 'static' para que no cierre al hacer clic fuera
                keyboard: true,
                focus: true
            };

            // Usar try-catch para manejar errores
            try {
                // Inicializar modales existentes en la página
                const modalTriggers = document.querySelectorAll('[data-bs-toggle="modal"]');
                modalTriggers.forEach(trigger => {
                    const targetSelector = trigger.getAttribute('data-bs-target');
                    const modalElement = document.querySelector(targetSelector);

                    if (modalElement) {
                        const modalInstance = new bootstrap.Modal(modalElement, modalOptions);

                        // Opcional: Evitar el comportamiento predeterminado
                        trigger.addEventListener('click', function (event) {
                            event.preventDefault();
                            modalInstance.show();
                        });
                    }
                });
            } catch (error) {
                console.error('Error inicializando modales:', error);
            }
        });
// دالة للحصول على موقع المستخدم باستخدام Promise
function getCurrentPositionPromise() {
    return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        });
    });
}

// دالة حساب المسافة بين نقطتين
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // نصف قطر الأرض بالكيلومترات
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const distance = R * c;
    
    return Math.round(distance * 10) / 10; // تقريب إلى أقرب 0.1 كم
}

// تحويل الدرجات إلى راديان
function toRad(degrees) {
    return degrees * Math.PI / 180;
}

// تحديد مستوى التكبير المناسب حسب المسافة
function getZoomLevelByDistance(distance) {
    if (distance < 0.5) return 16;
    if (distance < 1) return 15;
    if (distance < 3) return 14;
    if (distance < 7) return 13;
    if (distance < 15) return 12;
    if (distance < 30) return 11;
    if (distance < 60) return 10;
    return 9;
}

// الحصول على معلومات الموقع باستخدام خدمة Nominatim
async function getLocationInfo(lat, lng) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=ar`);
        if (!response.ok) {
            throw new Error('فشل في الحصول على معلومات الموقع');
        }
        return await response.json();
    } catch (error) {
        console.error('Error fetching location info:', error);
        throw error;
    }
}






// إنشاء نافذة معلومات مفصلة للموقع
function createDetailedLocationPopup(lat, lng, locationInfo, distance, time, messageId) {
    // تنسيق العنوان بشكل أفضل
    const formatAddress = (info) => {
        if (!info || !info.address) return 'عنوان غير معروف';
        
        const addr = info.address;
        const parts = [];
        
        // ترتيب عناصر العنوان من الأصغر إلى الأكبر
        if (addr.road) parts.push(addr.road);
        if (addr.suburb) parts.push(addr.suburb);
        if (addr.city_district) parts.push(addr.city_district);
        if (addr.city) parts.push(addr.city);
        if (addr.state) parts.push(addr.state);
        if (addr.country) parts.push(addr.country);
        
        return parts.join('، ') || info.display_name || 'عنوان غير معروف';
    };
    
    // تحديد نوع الموقع
    const getLocationType = (info) => {
        if (!info || !info.address) return 'موقع';
        
        const addr = info.address;
        
        if (addr.amenity) return addr.amenity;
        if (addr.shop) return 'متجر ' + addr.shop;
        if (addr.building) return 'مبنى';
        if (addr.highway) return 'طريق';
        if (addr.leisure) return 'منطقة ترفيهية';
        
        return 'موقع';
    };
    
    // إعداد محتوى النافذة المنبثقة
    let popupContent = `
        <div class="location-detailed-popup">
            <h5 style="color: #FFD700; text-align: center; margin-bottom: 15px; font-weight: bold; border-bottom: 1px solid rgba(255, 215, 0, 0.3); padding-bottom: 10px;">
                <i class="fas fa-map-marked-alt me-2"></i>
                تفاصيل الموقع
            </h5>
            
            <div style="margin-bottom: 15px;">
                <div style="display: flex; align-items: flex-start; margin-bottom: 8px;">
                    <i class="fas fa-map-pin" style="color: #FFD700; margin-top: 3px; margin-left: 8px; min-width: 16px;"></i>
                    <div>
                        <strong style="color: #FFFFFF;">العنوان:</strong>
                        <p style="margin: 0; color: #CCCCCC;">${formatAddress(locationInfo)}</p>
                    </div>
                </div>
                
                <div style="display: flex; align-items: flex-start; margin-bottom: 8px;">
                    <i class="fas fa-info-circle" style="color: #FFD700; margin-top: 3px; margin-left: 8px; min-width: 16px;"></i>
                    <div>
                        <strong style="color: #FFFFFF;">نوع الموقع:</strong>
                        <p style="margin: 0; color: #CCCCCC;">${getLocationType(locationInfo)}</p>
                    </div>
                </div>
                
                <div style="display: flex; align-items: flex-start; margin-bottom: 8px;">
                    <i class="fas fa-map-marker-alt" style="color: #FFD700; margin-top: 3px; margin-left: 8px; min-width: 16px;"></i>
                    <div>
                        <strong style="color: #FFFFFF;">الإحداثيات:</strong>
                        <p style="margin: 0; color: #CCCCCC; font-family: monospace;">${parseFloat(lat).toFixed(6)}, ${parseFloat(lng).toFixed(6)}</p>
                    </div>
                </div>
    `;
    
    // إضافة معلومات المسافة والوقت إذا كانت متوفرة
    if (distance !== null && time !== null) {
        popupContent += `
                <div style="display: flex; align-items: flex-start; margin-bottom: 8px;">
                    <i class="fas fa-route" style="color: #FFD700; margin-top: 3px; margin-left: 8px; min-width: 16px;"></i>
                    <div>
                        <strong style="color: #FFFFFF;">المسافة:</strong>
                        <p style="margin: 0; color: #CCCCCC;">${distance} كم</p>
                    </div>
                </div>
                
                <div style="display: flex; align-items: flex-start; margin-bottom: 8px;">
                    <i class="fas fa-clock" style="color: #FFD700; margin-top: 3px; margin-left: 8px; min-width: 16px;"></i>
                    <div>
                        <strong style="color: #FFFFFF;">الوقت التقريبي:</strong>
                        <p style="margin: 0; color: #CCCCCC;">${time} دقيقة</p>
                    </div>
                </div>
        `;
    }
    
    // إضافة أزرار التفاعل
    popupContent += `
            </div>
            
            <div style="display: flex; gap: 8px; margin-top: 15px;">
                <button onclick="getDirectionsToLocation(${lat}, ${lng})" style="flex: 1; background: #FFD700; color: #000; border: none; padding: 8px; border-radius: 5px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer; transition: all 0.3s ease;">
                    <i class="fas fa-directions"></i>
                    الاتجاهات
                </button>
                
                <button onclick="window.open('https://www.google.com/maps?q=${lat},${lng}', '_blank')" style="flex: 1; background: #333; color: #FFD700; border: 1px solid #FFD700; padding: 8px; border-radius: 5px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer; transition: all 0.3s ease;">
                    <i class="fas fa-external-link-alt"></i>
                    Google Maps
                </button>
            </div>
            
            <div style="margin-top: 15px; text-align: center;">
                <button onclick="reopenChatWithMessage('${messageId}')" style="width: 100%; background: transparent; color: #FFD700; border: 1px dashed #FFD700; padding: 8px; border-radius: 5px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer; transition: all 0.3s ease;">
                    <i class="fas fa-comment-alt"></i>
                    العودة للمحادثة
                </button>
            </div>
        </div>
    `;
    
    return popupContent;
}









document.addEventListener('DOMContentLoaded', function() {
    // إضافة الحدث لتوغل الشريط الجانبي
    const navToggle = document.querySelector('.nav-toggle');
    if (navToggle) {
        navToggle.addEventListener('click', toggleSideNav);
    }
    
    // تهيئة حالة المستخدم المسجل
    initializeUserState();
    
    // إضافة مستمع الحدث لزر تسجيل الخروج
    const logoutBtn = document.querySelector('.logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
    }
    
    // إضافة مستمعات الأحداث للنوافذ المنبثقة
    initializeModals();
});

// دالة توغل الشريط الجانبي
function toggleSideNav() {
    const sideNav = document.getElementById('sideNav');
    const navBackdrop = document.getElementById('navBackdrop');
    const body = document.body;

    if (sideNav.classList.contains('open')) {
        // إغلاق الشريط الجانبي
        sideNav.classList.remove('open');
        navBackdrop.classList.remove('show');
        body.classList.remove('side-nav-open');
    } else {
        // فتح الشريط الجانبي
        sideNav.classList.add('open');
        navBackdrop.classList.add('show');
        body.classList.add('side-nav-open');
    }
}

// دالة تهيئة حالة المستخدم المسجل من التخزين المحلي
function initializeUserState() {
    const currentUser = localStorage.getItem('currentUser');
    
    if (currentUser) {
        try {
            const userData = JSON.parse(currentUser);
            
            // تحديث واجهة المستخدم إذا كان لدينا بيانات صالحة
            if (userData && userData.uid) {
                updateUIAfterLogin(userData);
            } else {
                // إعادة تعيين الواجهة إذا كانت البيانات غير صالحة
                resetUserInterface();
            }
        } catch (error) {
            console.error('Error parsing user data:', error);
            resetUserInterface();
        }
    } else {
        // إعادة تعيين الواجهة إذا لم نجد بيانات مستخدم
        resetUserInterface();
    }
}

// دالة تهيئة النوافذ المنبثقة
function initializeModals() {
    // تهيئة نافذة تسجيل الدخول
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
    }
    
    // تهيئة نافذة تسجيل المستخدم
    const userRegistrationForm = document.getElementById('userRegistrationForm');
    if (userRegistrationForm) {
        userRegistrationForm.addEventListener('submit', handleUserRegistration);
    }
    
    // تهيئة نافذة إضافة السائق
    const addDriverForm = document.getElementById('addDriverForm');
    if (addDriverForm) {
        addDriverForm.addEventListener('submit', handleAddDriver);
    }
    
    // مستمع الحدث لإغلاق النوافذ المنبثقة بعد تسجيل الدخول
    document.addEventListener('login-success', function() {
        // إغلاق جميع النوافذ المنبثقة المفتوحة
        const openModals = document.querySelectorAll('.modal.show');
        openModals.forEach(modal => {
            const modalInstance = bootstrap.Modal.getInstance(modal);
            if (modalInstance) {
                modalInstance.hide();
            }
        });
        
        // إزالة طبقات الخلفية المتبقية
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        
        // إزالة نمط modal-open من الجسم
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    });
}

// دالة عرض رسائل التوست
function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer');
    
    if (!toastContainer) {
        // إنشاء حاوية التوست إذا لم تكن موجودة
        const newContainer = document.createElement('div');
        newContainer.id = 'toastContainer';
        newContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(newContainer);
        return showToast(message, type); // إعادة استدعاء الدالة بعد إنشاء الحاوية
    }
    
    // إنشاء عنصر التوست
    const toast = document.createElement('div');
    toast.className = `custom-toast animate__animated animate__fadeInRight ${type}`;
    
    // اختيار الأيقونة المناسبة حسب النوع
    let icon = '';
    switch (type) {
        case 'success':
            icon = '<i class="fas fa-check-circle text-success"></i>';
            break;
        case 'error':
            icon = '<i class="fas fa-times-circle text-danger"></i>';
            break;
        case 'warning':
            icon = '<i class="fas fa-exclamation-triangle text-warning"></i>';
            break;
        case 'info':
            icon = '<i class="fas fa-info-circle text-info"></i>';
            break;
        default:
            icon = '<i class="fas fa-check-circle text-success"></i>';
    }
    
    // إضافة محتوى التوست
    toast.innerHTML = `
        <div class="toast-header">
            ${icon}
            <strong class="me-auto ms-2">${message}</strong>
            <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    // إضافة التوست إلى الحاوية
    toastContainer.appendChild(toast);
    
    // إزالة التوست بعد 3 ثوانٍ
    setTimeout(() => {
        toast.classList.replace('animate__fadeInRight', 'animate__fadeOutRight');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
}

// دالة معالجة تسجيل الدخول
async function handleLogin(event) {
    event.preventDefault();
    showLoading();
    
    try {
        const formData = new FormData(event.target);
        const email = formData.get('email');
        const password = formData.get('password');

        // تحقق من حقول الإدخال
        if (!email || !password) {
            throw new Error('يرجى إدخال البريد الإلكتروني وكلمة المرور');
        }

        // محاولة تسجيل الدخول باستخدام Firebase
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // البحث عن بيانات المستخدم في قاعدة البيانات
        let userData = null;

        // البحث في جدول المستخدمين أولاً
        const userSnapshot = await firebase.database().ref(`users/${user.uid}`).once('value');
        userData = userSnapshot.val();

        // إذا لم نجد المستخدم في جدول المستخدمين، نبحث في جدول السائقين
        if (!userData) {
            const driverSnapshot = await firebase.database().ref(`drivers`).orderByChild('uid').equalTo(user.uid).once('value');
            const driversData = driverSnapshot.val();
            
            if (driversData) {
                // استخراج بيانات السائق
                const driverId = Object.keys(driversData)[0];
                userData = driversData[driverId];
                userData.userType = 'driver';
            }
        }

        // إذا لم نجد بيانات في قاعدة البيانات، استخدم بيانات المصادقة فقط
        if (!userData) {
            userData = {
                uid: user.uid,
                email: user.email,
                fullName: user.displayName || 'المستخدم',
                photoUrl: user.photoURL,
                userType: 'user'
            };
        }

        // حفظ بيانات المستخدم في التخزين المحلي
        localStorage.setItem('currentUser', JSON.stringify(userData));

        // تحديث واجهة المستخدم
        updateUIAfterLogin(userData);

        // إغلاق نافذة تسجيل الدخول
        const loginModal = document.getElementById('loginModal');
        if (loginModal) {
            const modalInstance = bootstrap.Modal.getInstance(loginModal);
            if (modalInstance) {
                modalInstance.hide();
            }
        }

        // إرسال حدث نجاح تسجيل الدخول
        document.dispatchEvent(new CustomEvent('login-success'));

        showToast('تم تسجيل الدخول بنجاح', 'success');
    } catch (error) {
        console.error('Login error:', error);
        
        let errorMessage = 'فشل تسجيل الدخول';
        
        // ترجمة رسائل خطأ Firebase
        switch (error.code) {
            case 'auth/user-not-found':
                errorMessage = 'البريد الإلكتروني غير مسجل';
                break;
            case 'auth/wrong-password':
                errorMessage = 'كلمة المرور غير صحيحة';
                break;
            case 'auth/invalid-email':
                errorMessage = 'البريد الإلكتروني غير صالح';
                break;
            case 'auth/user-disabled':
                errorMessage = 'تم تعطيل هذا الحساب';
                break;
            case 'auth/too-many-requests':
                errorMessage = 'تم تجاوز عدد محاولات تسجيل الدخول المسموح بها، يرجى المحاولة لاحقاً';
                break;
            default:
                errorMessage = error.message;
        }
        
        showToast(errorMessage, 'error');
    } finally {
        hideLoading();
    }
}

// دالة إظهار مؤشر التحميل
function showLoading() {
    const loadingSpinner = document.getElementById('loadingSpinner');
    if (loadingSpinner) {
        loadingSpinner.style.display = 'flex';
    } else {
        // إنشاء مؤشر التحميل إذا لم يكن موجوداً
        const spinner = document.createElement('div');
        spinner.id = 'loadingSpinner';
        spinner.className = 'loading-spinner';
        spinner.innerHTML = '<div class="spinner"></div>';
        document.body.appendChild(spinner);
    }
    
    // تعطيل التفاعل مع الصفحة أثناء التحميل
    document.body.style.pointerEvents = 'none';
}




    </script>
    </main>
    <!-- ربط ملف الجافا سكريبت -->
    <!-- قبل إغلاق body -->
    <script src="nearby-drivers.js"></script>
    <script src="auth.js"></script>
    <script src="modal.js"></script>
    <script src="favorite-drivers.js"></script>
    <script src="notifications-manager.js"></script>


    <script src="auth-check.js"></script>






</body>

</html>

1234567890-