<!DOCTYPE html>
<html dir="rtl" lang="ar">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="قائمة سائقي تاكسي العراق - خدمة حجز سيارات الأجرة الأفضل في العراق">
    <meta name="keywords" content="تاكسي العراق, سائقين, سيارات أجرة, حجز تاكسي, نقل, مواصلات">
    <meta name="author" content="تاكسي العراق">
    <meta name="theme-color" content="#FFD700">

    <title>سائقين تاكسي العراق - خدمة حجز السيارات الأولى في العراق</title>

    <!-- Content will be here -->
<!-- قبل إغلاق وسم head -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/react-leaflet@4.2.1/dist/react-leaflet.min.js"></script>
<link rel="icon" type="image/png"
    href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527">
<link rel="apple-touch-icon" sizes="180x180"
    href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527">
<link rel="apple-touch-startup-image"
    href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527">

<!-- Web App Manifest -->
<link rel="manifest" href="./manifest.json">

<!-- External CSS Libraries -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.rtl.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">

<!-- App CSS -->
<link rel="stylesheet" href="./style.css">

<!-- Meta Tags -->
<meta property="og:title" content="تاكسي العراق">
<meta property="og:description" content="خدمة حجز سيارات الأجرة الأفضل في العراق">
<meta property="og:image"
    content="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527">
<meta property="og:url" content="https://taxi-iraq.com">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="تاكسي العراق">
<meta name="twitter:description" content="خدمة حجز سيارات الأجرة الأفضل في العراق">
<meta name="twitter:image"
    content="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527">
<!-- إضافة قبل نهاية وسم head -->
<script src="favorite-drivers.js"></script>
<!-- External Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://unpkg.com/babel-standalone/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
<!-- Primero jQuery (si es necesario para tu versión de Bootstrap) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Luego Bootstrap Bundle (incluye Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Finalmente tus scripts personalizados -->
<script src="modal.js"></script>

<!-- App Scripts -->

<!-- إضافة المزيد من الأصوات -->
<audio id="notificationSound" src="notification-sound.mp3" preload="auto"></audio>
<audio id="messageSound" src="message-sound.mp3" preload="auto"></audio>

<!-- إضافة الملفات الجديدة -->
<audio id="notificationSound" src="https://github.com/AlQasimMall/taxialpasha/raw/main/%D8%A7%D9%84%D9%87%D8%A7%D8%AA%D9%81-%D8%A7%D9%84%D8%AB%D8%A7%D8%A8%D8%AA.mp3" preload="auto"></audio>
<script type="module" src="user-auth-notifications.js"></script>
<script type="module" src="notifications-manager.js"></script>
<script src="firebase-config.js"></script>
<!-- قبل إغلاق body -->
<script src="nearby-drivers-map.js"></script>


    <!-- App Icons -->
    <link rel="icon" type="image/png" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527">
    <link rel="apple-touch-icon" sizes="180x180" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527">

    <!-- External CSS Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <!-- App CSS -->
    <link rel="stylesheet" href="./style.css">

    <style>
        /* أنماط خاصة بصفحة السائقين */
        .drivers-header {
            padding: 15px 0;
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .drivers-header h1 {
            color: #FFD700;
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .drivers-header p {
            color: #ccc;
            font-size: 0.9rem;
        }
        
        .filters-container {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .filters-container select,
        .filters-container input {
            background-color: #1a1a1a;
            color: #fff;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 8px 12px;
            width: 100%;
        }
        
        .filters-container select:focus,
        .filters-container input:focus {
            border-color: #FFD700;
            box-shadow: 0 0 0 0.2rem rgba(255, 215, 0, 0.25);
            outline: none;
        }
        
        .filters-container .filter-actions {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .drivers-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .driver-list-item {
            display: flex;
            background: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 215, 0, 0.1);
            position: relative;
        }
        
        .driver-list-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.3);
        }
        
        .driver-list-item .driver-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-left: 3px solid #FFD700;
        }
        
        .driver-list-item .driver-info {
            padding: 15px;
            flex: 1;
        }
        
        .driver-list-item .driver-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .driver-list-item .driver-details {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .driver-list-item .detail-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            font-size: 0.8rem;
        }
        
        .driver-list-item .detail-item i {
            color: #FFD700;
        }
        
        .driver-list-item .driver-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .driver-list-item .action-btn {
            padding: 5px 15px;
            border-radius: 20px;
            border: none;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .driver-list-item .view-btn {
            background: #FFD700;
            color: #000;
        }
        
        .driver-list-item .chat-btn {
            background: transparent;
            color: #FFD700;
            border: 1px solid #FFD700;
        }
        
        .driver-list-item .call-btn {
            background: #4CAF50;
            color: white;
        }
        
        .driver-list-item .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .driver-list-item .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .driver-status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .status-available {
            background: rgba(46, 204, 64, 0.2);
            color: #2ECC40;
            border: 1px solid #2ECC40;
        }
        
        .status-busy {
            background: rgba(255, 65, 54, 0.2);
            color: #FF4136;
            border: 1px solid #FF4136;
        }
        
        .status-pending {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
            border: 1px solid #FFD700;
        }
        
        .driver-rating {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #FFD700;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .favorite-toggle {
            position: absolute;
            left: 10px;
            top: 10px;
            background: transparent;
            border: none;
            color: #ccc;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .favorite-toggle:hover, 
        .favorite-toggle.active {
            color: #FFD700;
            transform: scale(1.2);
        }
        
        .driver-details-modal .modal-content {
            background-color: #1a1a1a;
            color: #fff;
            border: 1px solid #333;
        }
        
        .driver-details-modal .modal-header {
            border-bottom: 1px solid #333;
        }
        
        .driver-details-modal .modal-footer {
            border-top: 1px solid #333;
        }
        
        .driver-profile-header {
            position: relative;
            margin-bottom: 20px;
        }
        
        .driver-profile-header .profile-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 10px;
        }
        
        .driver-profile-header .profile-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0));
            padding: 20px;
            border-radius: 0 0 10px 10px;
        }
        
        .driver-profile-header .profile-name {
            color: #FFD700;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .info-card .card-icon {
            font-size: 2rem;
            color: #FFD700;
            margin-bottom: 10px;
        }
        
        .info-card .card-title {
            font-size: 0.8rem;
            color: #ccc;
            margin-bottom: 5px;
        }
        
        .info-card .card-value {
            font-size: 1.1rem;
            color: #fff;
            font-weight: bold;
        }
        
        .documents-section {
            margin-bottom: 20px;
        }
        
        .documents-section h5 {
            color: #FFD700;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .document-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .document-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
        }
        
        .document-item .document-icon {
            font-size: 2rem;
            color: #FFD700;
            margin-bottom: 10px;
        }
        
        .document-item .document-name {
            font-size: 0.9rem;
            color: #fff;
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-buttons .btn {
            flex: 1;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 50px 0;
            text-align: center;
        }
        
        .empty-state i {
            font-size: 3rem;
            color: #FFD700;
            margin-bottom: 20px;
        }
        
        .empty-state h3 {
            color: #FFD700;
            margin-bottom: 10px;
        }
        
        .empty-state p {
            color: #ccc;
            max-width: 600px;
            margin: 0 auto 20px;
        }
        
        /* للشاشات الصغيرة */
        @media (max-width: 768px) {
            .driver-list-item {
                flex-direction: column;
            }
            
            .driver-list-item .driver-image {
                width: 100%;
                height: 180px;
                border-left: none;
                border-bottom: 3px solid #FFD700;
            }
            
            .info-cards {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .filters-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* تحسينات الأداء للهواتف المحمولة */
        @media (max-width: 480px) {
            .filters-container select,
            .filters-container input {
                font-size: 14px;
            }
            
            .driver-list-item .driver-actions {
                flex-direction: column;
            }
            
            .driver-list-item .action-btn {
                width: 100%;
            }
            
            .document-items {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* إضافة حالة تحميل البيانات */
        .skeleton-loader {
            background: linear-gradient(90deg, #222 25%, #333 50%, #222 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            height: 100%;
            width: 100%;
        }
        
        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        
        .skeleton-card {
            display: flex;
            background: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: 120px;
            margin-bottom: 15px;
        }
        
        .skeleton-image {
            width: 120px;
            height: 120px;
        }
        
        .skeleton-content {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .skeleton-title {
            height: 24px;
            width: 50%;
        }
        
        .skeleton-details {
            display: flex;
            gap: 10px;
        }
        
        .skeleton-detail {
            height: 20px;
            width: 100px;
        }
        
        .skeleton-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .skeleton-button {
            height: 34px;
            width: 120px;
            border-radius: 20px;
        }
        
        /* لحظات التحميل */
        .skeleton-wave {
            animation: skeleton-wave 1.6s linear 0.5s infinite;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.05), 
                transparent);
            background-size: 200px 100%;
            background-repeat: no-repeat;
            background-position: left -200px top 0;
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        @keyframes skeleton-wave {
            0% {
                background-position: left -200px top 0;
            }
            100% {
                background-position: right -200px top 0;
            }
        }
    </style>
</head>

<body>
    <!-- تصميم شريط العنوان -->
    <nav class="navbar app-header fixed-top">
        <div class="container-fluid">
            <div class="header-content">
                <!-- زر فتح الشريط الجانبي -->
                <button class="nav-toggle" onclick="toggleSideNav()">
                    <i class="fas fa-bars" style="color: #FFD700;"></i>
                </button>
                
                <!-- Logo and App Name -->
                <a class="app-logo d-flex align-items-center" href="index.html">
                    <i class="fas fa-taxi me-2" style="color: #FFD700;"></i>
                    <span style="font-size: 0.8rem;">Iraq Taxi</span>
                </a>
                
                <!-- Tools: Search, Notifications, Messages, Profile -->
                <div class="tools d-flex align-items-center">
                    <!-- Search Icon -->
                    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#searchModal">
                        <i class="fas fa-search" style="color: #FFD700;"></i>
                    </a>
                    
                    <!-- Notifications Icon -->
                    <a class="nav-link position-relative" href="#" data-bs-toggle="modal" data-bs-target="#notificationsModal" id="notificationsBtn">
                        <i class="fas fa-bell" style="color: #FFD700;"></i>
                        <span class="notification-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">0</span>
                    </a>
                    
                    <!-- Messages Icon -->
                    <a class="nav-link position-relative" href="#" data-bs-toggle="modal" data-bs-target="#messagesModal">
                        <i class="fas fa-envelope" style="color: #FFD700;"></i>
                        <span class="message-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">0</span>
                    </a>
                 
                </div>
            </div>
        </div>
    </nav>

    <!-- الشريط الجانبي (نفس الشريط الموجود في index.html) -->
    <div class="side-nav" id="sideNav">
        <div class="side-nav-header">
            <h2 class="side-nav-title">تاكسي العراق</h2>
            <button class="side-nav-close" onclick="toggleSideNav()">×</button>
        </div>
        
        <!-- قسم معلومات المستخدم -->
        <div class="side-nav-user-info">
            <div class="text-center">
                <i class="fas fa-user-circle text-white" style="font-size: 4rem;"></i>
                <h6 class="text-white mt-3">مرحباً بك</h6>
                <p class="text-white-50 small">قم بتسجيل الدخول للوصول إلى حسابك</p>
                <div class="mt-3">
                    <button class="btn btn-gold w-100 mb-2" data-bs-toggle="modal" data-bs-target="#loginModal">
                        تسجيل الدخول
                    </button>
                    <button class="btn btn-outline-light w-100 mb-2" data-bs-toggle="modal" data-bs-target="#userRegistrationModal">
                        إنشاء حساب
                    </button>
                    <button class="btn btn-outline-light w-100" data-bs-toggle="modal" data-bs-target="#addDriverModal">
                        إضافة سائق
                    </button>
                </div>
            </div>
        </div>
        
        <div class="side-nav-items">
            <a href="/" class="side-nav-item"><i class="fas fa-home" style="color: #FFD700;"></i> الرئيسية</a>
            <a href="drivers.html" class="side-nav-item active"><i class="fas fa-users" style="color: #4CAF50;"></i> السائقين</a>
            <a href="trips.html" class="side-nav-item"><i class="fas fa-car" style="color: #2196F3;"></i> الرحلات</a>
            <a href="map.html" class="side-nav-item"><i class="fas fa-map" style="color: #FF5722;"></i> الخريطة</a>
            <a href="notifications.html" class="side-nav-item"><i class="fas fa-bell" style="color: #9C27B0;"></i> الإشعارات</a>
            <a href="messages.html" class="side-nav-item"><i class="fas fa-envelope" style="color: #FFC107;"></i> الرسائل</a>
            <a href="settings.html" class="side-nav-item"><i class="fas fa-cog" style="color: #607D8B;"></i> الإعدادات</a>
            <a href="#" class="side-nav-item driver-only" style="display: none;"><i class="fas fa-user-plus" style="color: #E91E63;"></i> إضافة سائق</a>
            <a href="#" id="favoriteDriversLink" class="side-nav-item">
                <i class="fas fa-star" style="color: #FFD700;"></i> السائقين المفضلين
                <span id="favoriteDriversBadge" class="badge" style="position: absolute; right: 10px; background-color: #FFD700; color: #000000; border-radius: 50%; width: 20px; height: 20px; display: none; align-items: center; justify-content: center; font-size: 0.8rem;">0</span>
            </a>
        </div>
        
        <!-- زر تسجيل الخروج في الشريط الجانبي -->
        <div class="side-nav-footer">
            <button onclick="handleLogout()" class="logout-btn" style="display: none;">
                <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
            </button>
        </div>
    </div>

    <!-- كود الـ Backdrop للشريط الجانبي -->
    <div class="nav-backdrop" id="navBackdrop" onclick="toggleSideNav()"></div>

    <!-- المحتوى الرئيسي -->
    <main class="container" style="margin-top: 80px; padding-bottom: 60px;">
        <div class="drivers-header">
            <h1>السائقين المتاحين</h1>
            <p>اختر سائقك المفضل من القائمة أدناه</p>
        </div>
        
        <div class="filters-container">
            <!-- فلاتر البحث المحسنة -->
            <div class="filter-group">
                <label for="provinceFilter" class="form-label text-white-50">المحافظة</label>
                <select id="provinceFilter" class="form-select" onchange="loadAreas(this.value); filterDrivers();">
                    <option value="">جميع المحافظات</option>
                    <!-- سيتم ملء هذه القائمة عبر JavaScript -->
                </select>
            </div>
            
            <div class="filter-group">
                <label for="areaFilter" class="form-label text-white-50">المنطقة</label>
                <select id="areaFilter" class="form-select" disabled onchange="filterDrivers();">
                    <option value="">جميع المناطق</option>
                    <!-- سيتم ملء هذه القائمة عبر JavaScript -->
                </select>
            </div>
            
            <div class="filter-group">
                <label for="statusFilter" class="form-label text-white-50">الحالة</label>
                <select id="statusFilter" class="form-select" onchange="filterDrivers();">
                    <option value="">جميع الحالات</option>
                    <option value="available">متاح</option>
                    <option value="busy">مشغول</option>
                    <option value="pending">قيد المراجعة</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="carTypeFilter" class="form-label text-white-50">نوع السيارة</label>
                <select id="carTypeFilter" class="form-select" onchange="filterDrivers();">
                    <option value="">جميع الأنواع</option>
                    <!-- سيتم ملء هذه القائمة ديناميكياً من البيانات المتاحة -->
                </select>
            </div>
            
            <div class="filter-group">
                <label for="searchFilter" class="form-label text-white-50">بحث</label>
                <input type="text" id="searchFilter" class="form-control" placeholder="اسم السائق أو رقم الهاتف..." oninput="filterDrivers();">
            </div>
            
            <div class="filter-actions">
                <button class="btn btn-primary w-100" onclick="resetFilters()">
                    <i class="fas fa-redo-alt me-2"></i>إعادة ضبط
                </button>
            </div>
        </div>
        
        <!-- حالة اللوحة الفارغة -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="fas fa-taxi"></i>
            <h3>لا يوجد سائقين</h3>
            <p>لم يتم العثور على سائقين متطابقين مع معايير البحث الخاصة بك. يرجى تغيير عوامل التصفية أو المحاولة لاحقاً.</p>
            <button class="btn btn-primary" onclick="resetFilters()">
                <i class="fas fa-redo-alt me-2"></i>إعادة ضبط الفلاتر
            </button>
        </div>
        
        <!-- لوحة هيكلية لحالة التحميل -->
        <div id="loadingState" class="drivers-list" style="display: none;">
            <!-- سيتم إنشاء بطاقات التحميل الهيكلية هنا -->
        </div>
        
        <!-- قائمة السائقين الفعلية -->
        <div id="driversList" class="drivers-list">
            <!-- سيتم إضافة بطاقات السائقين هنا -->
        </div>
    </main>

    <!-- نافذة تفاصيل السائق -->
    <div class="modal fade driver-details-modal" id="driverDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تفاصيل السائق</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="driverDetailsContent">
                    <!-- سيتم ملء هذا المحتوى ديناميكياً -->
                    <div class="text-center py-4">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                        <p class="mt-2">جاري تحميل البيانات...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة البحث المتقدم -->
    <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background-color: #1a1a1a; color: white;">
                <div class="modal-header">
                    <h5 class="modal-title" id="searchModalLabel">بحث متقدم</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="advancedSearch" class="form-label">البحث</label>
                        <input type="text" class="form-control" id="advancedSearch" placeholder="ابحث عن اسم السائق، رقم الهاتف، نوع السيارة...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">نطاق التقييم</label>
                        <div class="d-flex align-items-center">
                            <input type="range" class="form-range" id="ratingRange" min="1" max="5" step="0.5" value="1">
                            <span id="ratingValue" class="ms-2">1.0+</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="availableOnly" checked>
                            <label class="form-check-label" for="availableOnly">
                                عرض المتاحين فقط
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="applyAdvancedSearch()">بحث</button>
                </div>
            </div>
        </div>
    </div>

    <!-- شريط أدوات سفلي للهواتف المحمولة -->
    <div class="bottom-nav">
        <a href="/" class="bottom-nav-item">
            <i class="fas fa-home"></i>
            <span>الرئيسية</span>
        </a>
        <a href="/drivers" class="bottom-nav-item active">
            <i class="fas fa-users"></i>
            <span>السائقين</span>
        </a>
        <a href="/trips" class="bottom-nav-item">
            <i class="fas fa-car"></i>
            <span>الرحلات</span>
        </a>
        <a href="/favorites" class="bottom-nav-item">
            <i class="fas fa-star"></i>
            <span>المفضلة</span>
        </a>
    </div>

    <!-- حاوية الـ Toast -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- مؤشر التحميل -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
    </div>



    <!-- تصميم محسن لشريط العنوان -->
<nav class="navbar app-header fixed-top">
    <div class="container-fluid">
        <div class="header-content"></div>
            <!-- زر فتح الشريط الجانبي -->
            <button class="nav-toggle" onclick="toggleSideNav()">
                <i class="fas fa-bars" style="color: #FFD700;"></i>
            </button>
            
            <!-- Logo and App Name -->
            <a class="app-logo d-flex align-items-center" href="map.html">
                <i class="fas fa-taxi me-2" style="color: #FFD700;"></i>
                <span style="font-size: 0.8rem;">Iraq Taxi</span>
            </a>
            <!-- Tools: Search, Notifications, Messages, Profile -->
            <div class="tools d-flex align-items-center">
                <!-- Search Icon -->
                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#searchModal">
                    <i class="fas fa-search" style="color: #FFD700;"></i>
                </a>
                
                <!-- Notifications Icon -->
                <a class="nav-link position-relative" href="#" data-bs-toggle="modal" data-bs-target="#notificationsModal" id="notificationsBtn">
                    <i class="fas fa-bell" style="color: #FFD700;"></i>
                    <span class="notification-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">0</span>
                </a>
                
                <!-- Messages Icon -->
                <a class="nav-link position-relative" href="#" data-bs-toggle="modal" data-bs-target="#messagesModal">
                    <i class="fas fa-envelope" style="color: #FFD700;"></i>
                    <span class="message-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">0</span>
                </a>
                
                <!-- Profile/Account Icon -->
                <a class="nav-link user-profile-btn" href="#" data-bs-toggle="modal" data-bs-target="#profileModal">
                    <img id="userProfileImage" src="default-profile.png" alt="Profile" class="rounded-circle" style="width: 35px; height: 35px; object-fit: cover; display: none;">
                    <i class="fas fa-user-circle" id="defaultProfileIcon" style="color: #FFD700;"></i>
                    <span class="ms-1 d-none d-md-inline" id="profileText">تسجيل الدخول</span>
                </a>
            </div>
        </div>
    </div>
</nav>

<!-- تحديث الشريط الجانبي ليشمل قسم معلومات المستخدم -->
<div class="side-nav" id="sideNav">
    <div class="side-nav-header">
        <h2 class="side-nav-title">تاكسي العراق</h2>
        <button class="side-nav-close" onclick="toggleSideNav()">×</button>
    </div>
    
    <!-- إضافة قسم معلومات المستخدم -->
    <div class="side-nav-user-info">
        <div class="text-center">
            <i class="fas fa-user-circle text-white" style="font-size: 4rem;"></i>
            <h6 class="text-white mt-3">مرحباً بك</h6>
            <p class="text-white-50 small">قم بتسجيل الدخول للوصول إلى حسابك</p>
            <div class="mt-3">
                <button class="btn btn-gold w-100 mb-2" data-bs-toggle="modal" data-bs-target="#loginModal">
                    تسجيل الدخول
                </button>
                <button class="btn btn-outline-light w-100 mb-2" data-bs-toggle="modal" data-bs-target="#userRegistrationModal">
                    إنشاء حساب
                </button>
                <button class="btn btn-outline-light w-100" data-bs-toggle="modal" data-bs-target="#addDriverModal">
                    إضافة سائق
                </button>
            </div>
        </div>
    </div>
    
    <div class="side-nav-items">
        <a href="/" class="side-nav-item"><i class="fas fa-home" style="color: #FFD700;"></i> الرئيسية</a>
        <a href="/drivers" class="side-nav-item"><i class="fas fa-users" style="color: #4CAF50;"></i> السائقين</a>
        <a href="trips.html" class="side-nav-item"><i class="fas fa-car" style="color: #2196F3;"></i> الرحلات</a>
        <a href="map.html" class="side-nav-item"><i class="fas fa-map" style="color: #FF5722;"></i> الخريطة</a>
        <a href="notifications.html" class="side-nav-item"><i class="fas fa-bell" style="color: #9C27B0;"></i> الإشعارات</a>
        <a href="messages.html" class="side-nav-item"><i class="fas fa-envelope" style="color: #FFC107;"></i> الرسائل</a>
        <a href="settings.html" class="side-nav-item"><i class="fas fa-cog" style="color: #607D8B;"></i> الإعدادات</a>
        <a href="#" class="side-nav-item driver-only" style="display: none;"><i class="fas fa-user-plus" style="color: #E91E63;"></i> إضافة سائق</a>
    </div>
    <!-- إضافة زر تسجيل الخروج في الشريط الجانبي -->
    <div class="side-nav-footer">
        <button onclick="handleLogout()" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
        </button>
    </div>
</div>
    </div>
        <!-- شريط الأدوات السفلي -->
        <div class="bottom-nav">
            <a href="/" class="bottom-nav-item">
                <i class="fas fa-home"></i>
                <span>الرئيسية</span>
            </a>
            <a href="/explore" class="bottom-nav-item">
                <i class="fas fa-compass"></i>
                <span>استكشاف</span>
            </a>
            <a href="/favorites" class="bottom-nav-item">
                <i class="fas fa-star"></i>
                <span>المفضلة</span>
            </a>
            <a href="/trips" class="bottom-nav-item">
                <i class="fas fa-car"></i>
                <span>الرحلات</span>
            </a>
        </div>
        <!-- كود الـ Backdrop للشريط الجانبي -->
        <div class="nav-backdrop" id="navBackdrop" onclick="toggleSideNav()"></div>
    </nav>

    <script>
        function updateProfileIcon(user) {
            const profileImage = document.getElementById('userProfileImage');
            const defaultIcon = document.getElementById('defaultProfileIcon');
            const profileText = document.getElementById('profileText');

            if (user && user.photoURL) {
                profileImage.src = user.photoURL;
                profileImage.style.display = 'block';
                defaultIcon.style.display = 'none';
                profileText.style.display = 'none';
            } else {
                profileImage.style.display = 'none';
                defaultIcon.style.display = 'block';
                profileText.style.display = 'block';
            }
        }

        // Example usage after user login
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                updateProfileIcon(user);
            }
        });
        function updateProfileIcon(user) {
            const profileImage = document.getElementById('userProfileImage');
            const defaultIcon = document.getElementById('defaultProfileIcon');
            const profileText = document.getElementById('profileText');

            if (user && user.photoURL) {
                profileImage.src = user.photoURL;
                profileImage.style.display = 'block';
                defaultIcon.style.display = 'none';
                profileText.style.display = 'none';
            } else {
                profileImage.style.display = 'none';
                defaultIcon.style.display = 'block';
                profileText.style.display = 'block';
            }
        }

        // Example usage after user login
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                updateProfileIcon(user);
            }
        });
        function updateProfileIcon(user) {
            const profileImage = document.getElementById('userProfileImage');
            const defaultIcon = document.getElementById('defaultProfileIcon');
            const profileText = document.getElementById('profileText');

            if (user && user.photoURL) {
                profileImage.src = user.photoURL;
                profileImage.style.display = 'block';
                defaultIcon.style.display = 'none';
                profileText.style.display = 'none';
            } else {
                profileImage.style.display = 'none';
                defaultIcon.style.display = 'block';
                profileText.style.display = 'block';
            }
        }

        // Example usage after user login
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                updateProfileIcon(user);
            }
        });
        const messagesButton = document.getElementById('messagesButton');
        const messagesContainer = document.getElementById('messagesContainer');
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendMessageButton = document.getElementById('sendMessageButton');
        const unreadMessagesBadge = document.getElementById('unreadMessagesBadge');

        // Load messages when the modal is shown
        messagesButton.addEventListener('click', function () {
            // Load messages from the server or database
            fetchMessages();
        });

        // Open chat modal when a message is clicked
        messagesContainer.addEventListener('click', function (event) {
            if (event.target.classList.contains('message-item')) {
                const messageId = event.target.dataset.messageId;
                openChat(messageId);
            }
        });

        // Send message
        sendMessageButton.addEventListener('click', function () {
            const message = messageInput.value;
            if (message.trim() !== '') {
                // Send the message to the server or database
                sendMessage(message);
                messageInput.value = ''; // Clear the input
            }
        });

        // Example functions to load messages and send messages
        function fetchMessages() {
            // Fetch messages from the server or database
            // Example:
            // fetch('/api/messages')
            //     .then(response => response.json())
            //     .then(messages => {
            //         messagesContainer.innerHTML = messages.map(msg => `
            //             <div class="message-item" data-message-id="${msg.id}">
            //                 <img src="${msg.senderImage}" alt="${msg.senderName}" class="sender-image">
            //                 <span>${msg.senderName}</span>
            //                 <span class="message-preview">${msg.preview}</span>
            //                 ${msg.unread ? '<span class="badge bg-danger">جديد</span>' : ''}
            //             </div>
            //         `).join('');
            //         updateUnreadMessagesBadge(messages.filter(msg => msg.unread).length);
            //     });
        }

        function openChat(messageId) {
            // Load chat messages from the server or database
            // Example:
            // fetch(`/api/messages/${messageId}`)
            //     .then(response => response.json())
            //     .then(messages => {
            //         chatContainer.innerHTML = messages.map(msg => `
            //             <div class="message-bubble ${msg.sender === 'user' ? 'sent' : 'received'}">
            //                 ${msg.text}
            //                 <div class="timestamp">${msg.timestamp}</div>
            //             </div>
            //         `).join('');
            //         const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
            //         chatModal.show();
            //     });
        }

        function sendMessage(message) {
            // Send the message to the server or database
            // Example:
            // fetch('/api/messages', {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json'
            //     },
            //     body: JSON.stringify({ message })
            // });
        }

        function updateUnreadMessagesBadge(count) {
            if (count > 0) {
                unreadMessagesBadge.textContent = count;
                unreadMessagesBadge.style.display = 'block';
            } else {
                unreadMessagesBadge.style.display = 'none';
            }
        }

        // Example function to check for new messages periodically
        function checkForNewMessages() {
            // Example:
            // setInterval(() => {
            //     fetch('/api/messages/unread-count')
            //         .then(response => response.json())
            //         .then(count => {
            //             updateUnreadMessagesBadge(count);
            //         });
            // }, 60000); // Check every minute
        }

        // Start checking for new messages
        checkForNewMessages();
    </script>

    </nav>

    </a>
    </div>
    </div>
    </nav>

    </a>
    </li>
    </ul>
    </div>
    </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Map View -->
       

      



    <!-- Add Driver زر اضافة السائقين من قبل الادمنModal -->
    <div class="modal fade" id="addDriverModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة سائق جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">

                    <form id="addDriverForm" onsubmit="handleAddDriver(event)">
                        <div class="mb-4 text-center">
                            <div class="image-upload-container"
                                onclick="document.getElementById('driverImage').click()">
                                <input type="file" id="driverImage" accept="image/*" style="display: none"
                                    onchange="handleImagePreview(event)">
                                <img id="imagePreview" src="#" alt=""
                                    style="display: none; width: 100%; height: 100%; object-fit: cover;">
                                <div class="upload-placeholder">
                                    <i class="fas fa-camera fa-2x mb-2"></i>
                                    <p>انقر لإضافة صورة</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="location-capture-section">
                                <label class="form-label">موقع السائق</label>
                                <div class="d-flex gap-2 mb-2">
                                    <input type="text" class="form-control" id="driverLatitude" placeholder="خط العرض"
                                        readonly>
                                    <input type="text" class="form-control" id="driverLongitude" placeholder="خط الطول"
                                        readonly>
                                </div>
                                <button type="button" class="btn btn-primary w-100" onclick="captureCurrentLocation()">
                                    <i class="fas fa-location-arrow me-2"></i>
                                    تحديد الموقع الحالي
                                </button>
                            </div>
                        </div>
                        <div class="registration-section mb-4">
                            <h6 class="section-title">المستمسكات الرسمية</h6>

                            <!-- هوية الأحوال المدنية -->
                            <div class="row g-3 mb-4">
                                <div class="col-12">
                                    <label class="form-label">هوية الأحوال المدنية</label>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('idCardFront').click()">
                                        <input type="file" id="idCardFront" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'idCardFrontPreview')" required>
                                        <img id="idCardFrontPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <p>صورة الهوية (الأمامية)</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('idCardBack').click()">
                                        <input type="file" id="idCardBack" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'idCardBackPreview')" required>
                                        <img id="idCardBackPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <p>صورة الهوية (الخلفية)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- بطاقة السكن -->
                            <div class="row g-3 mb-4">
                                <div class="col-12">
                                    <label class="form-label">بطاقة السكن</label>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('residenceFront').click()">
                                        <input type="file" id="residenceFront" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'residenceFrontPreview')" required>
                                        <img id="residenceFrontPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-home"></i>
                                            <p>بطاقة السكن (الأمامية)</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('residenceBack').click()">
                                        <input type="file" id="residenceBack" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'residenceBackPreview')" required>
                                        <img id="residenceBackPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-home"></i>
                                            <p>بطاقة السكن (الخلفية)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- إجازة السوق -->
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">إجازة السوق</label>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('licenseFront').click()">
                                        <input type="file" id="licenseFront" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'licenseFrontPreview')" required>
                                        <img id="licenseFrontPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <p>إجازة السوق (الأمامية)</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="document-upload"
                                        onclick="document.getElementById('licenseBack').click()">
                                        <input type="file" id="licenseBack" accept="image/*" style="display: none;"
                                            onchange="previewDocument(this, 'licenseBackPreview')" required>
                                        <img id="licenseBackPreview" src="#" alt="" style="display: none;">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <p>إجازة السوق (الخلفية)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- New Fields for Email and Password -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">البريد الإلكتروني</label>
                                <input type="email" class="form-control" id="driverEmail" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">الرمز السري</label>
                                <input type="password" class="form-control" id="driverPassword" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">إعادة كتابة الرمز السري</label>
                                <input type="password" class="form-control" id="confirmDriverPassword" required>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">اسم السائق</label>
                                    <input type="text" class="form-control" id="driverName" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">رقم الهاتف</label>
                                    <input type="tel" class="form-control" id="driverPhone" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">نوع السيارة</label>
                                    <input type="text" class="form-control" id="carType" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">موديل السيارة</label>
                                    <input type="number" class="form-control" id="carModel" required>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">المنطقة</label>
                                    <select class="form-control" id="driverLocation" onchange="loadAreas(this.value)" required>
                                        <option value="">اختر المحافظة</option>
                                        <option value="بغداد">بغداد</option>
                                        <option value="الكرخ">الكرخ</option>
                                        <option value="الرصافة">الرصافة</option>
                                        <option value="البصرة">البصرة</option>
                                        <option value="نينوى">نينوى</option>
                                        <option value="الموصل">الموصل</option>
                                        <option value="النجف">النجف</option>
                                        <option value="الكوفة">الكوفة</option>
                                        <option value="كربلاء">كربلاء</option>
                                        <option value="الحسينية">الحسينية</option>
                                        <option value="أربيل">أربيل</option>
                                        <option value="كركوك">كركوك</option>
                                        <option value="الأنبار">الأنبار</option>
                                        <option value="الرمادي">الرمادي</option>
                                        <option value="الفلوجة">الفلوجة</option>
                                        <option value="بابل">بابل</option>
                                        <option value="الحلة">الحلة</option>
                                        <option value="المسيب">المسيب</option>
                                        <option value="الهاشمية">الهاشمية</option>
                                        <option value="القاسم">القاسم</option>
                                        <option value="ديالى">ديالى</option>
                                        <option value="بعقوبة">بعقوبة</option>
                                        <option value="ذي قار">ذي قار</option>
                                        <option value="الناصرية">الناصرية</option>
                                        <option value="السليمانية">السليمانية</option>
                                        <option value="صلاح الدين">صلاح الدين</option>
                                        <option value="تكريت">تكريت</option>
                                        <option value="واسط">واسط</option>
                                        <option value="الكوت">الكوت</option>
                                        <option value="ميسان">ميسان</option>
                                        <option value="العمارة">العمارة</option>
                                        <option value="المثنى">المثنى</option>
                                        <option value="السماوة">السماوة</option>
                                        <option value="دهوك">دهوك</option>
                                        <option value="القادسية">القادسية</option>
                                        <option value="الديوانية">الديوانية</option>
                                    </select>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">المنطقة</label>
                                    <select class="form-control" id="driverArea" required>
                                        <option value="">اختر المنطقة</option>
                                    </select>
                                </div>



                                <div class="col-12">
                                    <label class="form-label">معلومات إضافية</label>
                                    <textarea class="form-control" id="driverBio" rows="3"></textarea>
                                </div>
                            </div>

                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary w-100">إضافة السائق</button>
                            </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
    </div>
    <!-- نافذة تعديل بيانات السائق -->
    <div class="modal fade" id="editDriverModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تعديل بيانات السائق</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editDriverForm" onsubmit="handleEditDriver(event)">
                        <input type="hidden" id="editDriverId">

                        <div class="mb-4 text-center">
                            <div class="image-upload-container"
                                onclick="document.getElementById('editDriverImage').click()">
                                <input type="file" id="editDriverImage" accept="image/*" style="display: none"
                                    onchange="handleEditImagePreview(event)">
                                <img id="editImagePreview" src="#" alt=""
                                    style="display: none; width: 100%; height: 200px; object-fit: cover; border-radius: 10px;">
                                <div class="upload-placeholder">
                                    <i class="fas fa-camera fa-2x mb-2"></i>
                                    <p>انقر لتغيير الصورة</p>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">اسم السائق</label>
                                <input type="text" class="form-control" id="editDriverName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">رقم الهاتف</label>
                                <input type="tel" class="form-control" id="editDriverPhone" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">نوع السيارة</label>
                                <input type="text" class="form-control" id="editCarType" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">موديل السيارة</label>
                                <input type="number" class="form-control" id="editCarModel" required>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">المنطقة</label>
                                <select class="form-control" id="editDriverLocation" required>
                                    <option value="">اختر المحافظة</option>
                                    <option value="بغداد">بغداد</option>
                                    <option value="الكرخ">الكرخ</option>
                                    <option value="الرصافة">الرصافة</option>
                                    <option value="البصرة">البصرة</option>
                                    <option value="نينوى">نينوى</option>
                                    <option value="الموصل">الموصل</option>
                                    <option value="النجف">النجف</option>
                                    <option value="الكوفة">الكوفة</option>
                                    <option value="كربلاء">كربلاء</option>
                                    <option value="الحسينية">الحسينية</option>
                                    <option value="أربيل">أربيل</option>
                                    <option value="كركوك">كركوك</option>
                                    <option value="الأنبار">الأنبار</option>
                                    <option value="الرمادي">الرمادي</option>
                                    <option value="الفلوجة">الفلوجة</option>
                                    <option value="بابل">بابل</option>
                                    <option value="الحلة">الحلة</option>
                                    <option value="المسيب">المسيب</option>
                                    <option value="الهاشمية">الهاشمية</option>
                                    <option value="القاسم">القاسم</option>
                                    <option value="ديالى">ديالى</option>
                                    <option value="بعقوبة">بعقوبة</option>
                                    <option value="ذي قار">ذي قار</option>
                                    <option value="الناصرية">الناصرية</option>
                                    <option value="السليمانية">السليمانية</option>
                                    <option value="صلاح الدين">صلاح الدين</option>
                                    <option value="تكريت">تكريت</option>
                                    <option value="واسط">واسط</option>
                                    <option value="الكوت">الكوت</option>
                                    <option value="ميسان">ميسان</option>
                                    <option value="العمارة">العمارة</option>
                                    <option value="المثنى">المثنى</option>
                                    <option value="السماوة">السماوة</option>
                                    <option value="دهوك">دهوك</option>
                                    <option value="القادسية">القادسية</option>
                                    <option value="الديوانية">الديوانية</option>
                                    <!-- إضافة باقي المدن -->
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">معلومات إضافية</label>
                                <textarea class="form-control" id="editDriverBio" rows="3"></textarea>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary w-100">حفظ التغييرات</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="notificationStatus" class="mt-2 small text-muted"></div>
    </div>

    <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="searchModalLabel">بحث عن سائق</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="search-wrapper">
                        <!-- حقل البحث -->
                        <div class="search-input-wrapper mb-3">
                            <div class="input-group">
                                <input type="text" class="form-control search-input" id="navbarSearchInput"
                                    placeholder="ابحث عن اسم السائق، المنطقة، نوع السيارة..." autofocus>
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                            </div>
                        </div>

                        <!-- خيارات البحث -->
                        <div class="search-options mb-3">
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="searchType" id="searchAll" checked>
                                <label class="btn btn-outline-primary" for="searchAll">الكل</label>

                                <input type="radio" class="btn-check" name="searchType" id="searchName">
                                <label class="btn btn-outline-primary" for="searchName">الاسم</label>

                                <input type="radio" class="btn-check" name="searchType" id="searchLocation">
                                <label class="btn btn-outline-primary" for="searchLocation">المنطقة</label>

                                <input type="radio" class="btn-check" name="searchType" id="searchCar">
                                <label class="btn btn-outline-primary" for="searchCar">السيارة</label>
                            </div>
                        </div>

                        <!-- نتائج البحث -->
                        <div id="searchResults" class="search-results"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- نافذة الرسائل المنبثقة -->
    <div class="modal fade" id="messagesModal" tabindex="-1" aria-labelledby="messagesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="messagesModalLabel">الرسائل</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="messagesContainer">
                        <!-- قائمة الرسائل ستظهر هنا -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة المحادثة -->
    <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content chat-window">
                <!-- رأس النافذة مع صورة واسم السائق -->
                <div class="modal-header chat-header">
                    <img id="driverImage"
                        src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527"
                        alt="صورة السائق" class="rounded-circle me-2" style="width: 60px; height: 60px;">
                    <div>
                        <h5 class="modal-title" id="driverName">اسم السائق</h5>
                        <small id="driverCardInfo" style="color: #ffffff;">بطاقة السائق</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>

                </div>
                <!-- اختيار المشوار -->
                <div class="modal-body chat-body">
                    <div id="tripSelection" class="mb-3">
                        <small id="driverCardInfo" style="color: #ffffff;"> عدد الـــمشــوار </small>
                        <input type="number" id="tripCount" class="form-control mb-2" placeholder="أدخل عدد المشاوير"
                            min="1">

                        <small id="driverCardInfo" style="color: #ffffff;"> نوع الواجــــهة</small>

                        <input type="text" id="tripDestination" class="form-control mb-2" placeholder="أدخل الوجهة">

                        <small id="driverCardInfo" style="color: #ffffff;"> نوع الرحـــله</small>
                        <select id="tripType" class="form-control mb-3">
                            <option value="ذهاب">ذهاب</option>
                            <option value="ذهاب وعودة">ذهاب وعودة</option>
                        </select>

                        <button class="btn btn-success w-100" onclick="confirmTrip()">تأكيد المشوار</button>
                    </div>
                    <!-- منطقة الرسائل -->
                    <div id="chatMessages" class="chat-messages d-none"></div>
                </div>
                <!-- شريط الإدخال -->
                <div class="modal-footer chat-footer d-none">
                    <div class="input-group">
                        <input type="text" id="chatInput" class="form-control chat-input"
                            placeholder="اكتب رسالتك هنا...">
                        <button class="btn btn-primary send-btn" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- تعديل نافذة اختيار نوع الحساب -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 text-center">
                    <h5 class="modal-title w-100">اختر العملية</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body py-4">
                    <div class="row g-4">
                        <!-- زر تسجيل الدخول -->
                        <div class="col-12 mb-3">
                            <div class="account-type-card" onclick="openLoginModal()">
                                <div class="icon-container mb-3">
                                    <i class="fas fa-sign-in-alt fa-3x"></i>
                                </div>
                                <h6>تسجيل الدخول</h6>
                                <p class="small text-muted">لديك حساب بالفعل؟ سجل دخولك</p>
                            </div>
                        </div>
                        <!-- زر انشاء حساب -->
                        <div class="col-12">
                            <div class="account-type-card" onclick="openUserRegistration()">
                                <div class="icon-container mb-3">
                                    <i class="fas fa-user fa-3x"></i>
                                </div>
                                <h6>انشاء حساب</h6>
                                <p class="small text-muted">احجز رحلاتك بسهولة</p>
                            </div>
                        </div>
                        <!-- زر إضافة سائق -->
                        <div class="col-12">
                            <div class="account-type-card" onclick="showAddDriverModal()">
                                <div class="icon-container mb-3">
                                    <i class="fas fa-user-plus fa-3x"></i>
                                </div>
                                <h6>إضافة سائق</h6>
                                <p class="small text-muted">أضف سائق جديد إلى النظام</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تسجيل الدخول -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تسجيل الدخول</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm" onsubmit="handleLogin(event)">
                        <div class="mb-3">
                            <label class="form-label">البريد الإلكتروني</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">كلمة المرور</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-sign-in-alt me-2"></i>
                                تسجيل الدخول
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تسجيل السائق -->
    <div class="modal fade" id="driverRegistrationModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="text-center w-100">
                        <img src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527"
                            alt="شعار التطبيق" style="height: 60px;">
                        <h5 class="modal-title mt-2">تسجيل سائق جديد</h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="driverRegistrationForm" class="needs-validation" novalidate>
                        <!-- المعلومات الشخصية -->
                        <div class="registration-section mb-4">
                            <h6 class="section-title">المعلومات الشخصية</h6>
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="text-center mb-3">
                                        <div class="driver-photo-upload"
                                            onclick="document.getElementById('driverPhoto').click()">
                                            <img id="driverPhotoPreview" src="#" alt="">
                                            <div class="upload-placeholder">
                                                <i class="fas fa-camera"></i>
                                                <span>صورة شخصية</span>
                                            </div>
                                        </div>
                                        <input type="file" id="driverPhoto" accept="image/*" style="display: none;"
                                            onchange="previewDriverPhoto(this)">
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">الاسم الثلاثي</label>
                                    <input type="text" class="form-control" name="fullName" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">العمر</label>
                                    <input type="number" class="form-control" name="age" min="18" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">رقم الهاتف</label>
                                    <input type="tel" class="form-control" name="phone" required>
                                </div>
                            </div>
                        </div>

                        <!-- معلومات المركبة -->
                        <div class="registration-section mb-4">
                            <h6 class="section-title">معلومات المركبة</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">نوع المركبة</label>
                                    <select class="form-select" name="vehicleType" required>
                                        <option value="">اختر نوع المركبة</option>
                                        <option value="أجرة">أجرة</option>
                                        <option value="خصوصي">خصوصي</option>
                                        <option value="باص">باص</option>
                                        <option value="صالون">صالون</option>
                                        <option value="تحميل">تحميل</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">موديل المركبة</label>
                                    <input type="number" class="form-control" name="vehicleModel" min="1990" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">رقم المركبة</label>
                                    <input type="text" class="form-control" name="vehicleNumber" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">لون المركبة</label>
                                    <input type="text" class="form-control" name="vehicleColor" required>
                                </div>
                            </div>
                        </div>

                        <!-- المستمسكات -->
                        <div class="registration-section mb-4">
                            <h6 class="section-title">المستمسكات</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">صورة الهوية الوجه الأمامي</label>
                                    <div class="document-upload" onclick="document.getElementById('idFront').click()">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <span>اضغط للرفع</span>
                                        </div>
                                        <img id="idFrontPreview" src="#" alt="">
                                    </div>
                                    <input type="file" id="idFront" accept="image/*" style="display: none;"
                                        onchange="previewDocument(this, 'idFrontPreview')" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">صورة الهوية الوجه الخلفي</label>
                                    <div class="document-upload" onclick="document.getElementById('idBack').click()">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <span>اضغط للرفع</span>
                                        </div>
                                        <img id="idBackPreview" src="#" alt="">
                                    </div>
                                    <input type="file" id="idBack" accept="image/*" style="display: none;"
                                        onchange="previewDocument(this, 'idBackPreview')" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">إجازة السوق الوجه الأمامي</label>
                                    <div class="document-upload"
                                        onclick="document.getElementById('licenseFront').click()">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <span>اضغط للرفع</span>
                                        </div>
                                        <img id="licenseFrontPreview" src="#" alt="">
                                    </div>
                                    <input type="file" id="licenseFront" accept="image/*" style="display: none;"
                                        onchange="previewDocument(this, 'licenseFrontPreview')" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">إجازة السوق الوجه الخلفي</label>
                                    <div class="document-upload"
                                        onclick="document.getElementById('licenseBack').click()">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-id-card"></i>
                                            <span>اضغط للرفع</span>
                                        </div>
                                        <img id="licenseBackPreview" src="#" alt="">
                                    </div>
                                    <input type="file" id="licenseBack" accept="image/*" style="display: none;"
                                        onchange="previewDocument(this, 'licenseBackPreview')" required>
                                </div>
                            </div>
                        </div>

                        <!-- معلومات السكن -->
                        <div class="registration-section mb-4">
                            <h6 class="section-title">معلومات السكن</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">المحافظة</label>
                                    <select class="form-select" name="province" onchange="loadAreas(this.value)"
                                        required>
                                        <option value="">اختر المحافظة</option>
                                        <!-- سيتم ملء الخيارات بواسطة JavaScript -->
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">المنطقة</label>
                                    <select class="form-select" name="area" required>
                                        <option value="">اختر المنطقة</option>
                                        <!-- سيتم ملء الخيارات بواسطة JavaScript -->
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">العنوان التفصيلي</label>
                                    <textarea class="form-control" name="address" rows="2" required></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="fas fa-user-plus me-2"></i>
                                تسجيل
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
  
    <div id="locationOptions">
        <!-- other elements -->
    </div>
    <!-- نافذة تسجيل المستخدم -->
    <div class="modal fade" id="userRegistrationModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="text-center w-100">
                        <img src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527"
                            alt="شعار التطبيق" style="height: 60px;">
                        <h5 class="modal-title mt-2">تسجيل مستخدم جديد</h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userRegistrationForm" class="needs-validation" novalidate>
                        <!-- المعلومات الشخصية -->
                        <div class="registration-section mb-4">
                            <h6 class="section-title">المعلومات الشخصية</h6>
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="text-center mb-3">
                                        <div class="user-photo-upload"
                                            onclick="document.getElementById('userPhoto').click()">
                                            <img id="userPhotoPreview" src="#" alt="">
                                            <div class="upload-placeholder">
                                                <i class="fas fa-camera"></i>
                                                <span>صورة شخصية</span>
                                            </div>
                                        </div>
                                        <input type="file" id="userPhoto" accept="image/*" style="display: none;"
                                            onchange="previewUserPhoto(this)">
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">الاسم الثلاثي</label>
                                    <input type="text" class="form-control" name="fullName" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">البريد الإلكتروني</label>
                                    <input type="email" class="form-control" name="email" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">رقم الهاتف</label>
                                    <input type="tel" class="form-control" name="phone" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">كلمة المرور</label>
                                    <input type="password" class="form-control" name="password" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">تأكيد كلمة المرور</label>
                                    <input type="password" class="form-control" name="confirmPassword" required>
                                </div>
                            </div>
                        </div>

                        <!-- معلومات السكن -->
                        <div class="registration-section mb-4">
                            <h6 class="section-title">معلومات السكن</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">المحافظة</label>
                                    <select class="form-select" name="province" onchange="loadAreas(this.value)"
                                        required>
                                        <option value="">اختر المحافظة</option>
                                        <!-- سيتم ملء الخيارات عبر JavaScript -->
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">المنطقة</label>
                                    <select class="form-select" name="area" required>
                                        <option value="">اختر المنطقة</option>
                                        <!-- سيتم ملء الخيارات عبر JavaScript -->
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">العنوان التفصيلي</label>
                                    <textarea class="form-control" name="address" rows="2" required></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- الشروط والأحكام -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="terms" id="terms" required>
                            <label class="form-check-label" for="terms">
                                أوافق على <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">الشروط
                                    والأحكام</a>
                            </label>
                        </div>

                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="fas fa-user-plus me-2"></i>
                                تسجيل
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- إضافة قبل نهاية div#map -->
    <button id="nearbySearchBtn" class="nearby-search-btn" title="البحث عن السائقين في الجوار">
        <i class="fas fa-search"></i>
    </button>

    <div class="radius-control" style="display: none;">
        <label>نطاق البحث: <span id="radiusValue">5</span> كم</label>
        <input type="range" id="radiusSlider" min="1" max="20" value="5">
    </div>
    <div id="nearbyResults" class="nearby-results" style="display: none;">
        <div class="nearby-results-header">
            <h3>السائقين في الجوار</h3>
            <button class="close-results">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="nearby-results-content"></div>
    </div>


    <!-- إضافة هذا الجزء في نهاية الملف قبل إغلاق وسم body -->

    <!-- نافذة المحادثة المحسنة للسائق -->
    <div class="modal fade" id="driverChatModal" tabindex="-1" aria-labelledby="driverChatModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content chat-window">
                <!-- رأس النافذة مع صورة واسم المستخدم -->
                <div class="modal-header chat-header">
                    <img id="userImage"
                        src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527"
                        alt="صورة المستخدم" class="rounded-circle me-2" style="width: 50px; height: 50px;">
                    <div>
                        <h5 class="modal-title" id="userName">اسم المستخدم</h5>
                        <small id="userInfo" style="color: #ffffff;">معلومات إضافية</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                </div>

                <!-- منطقة المحادثة -->
                <div class="modal-body chat-body" id="driverChatBody">
                    <!-- ستتم إضافة الرسائل هنا بشكل ديناميكي -->
                    <div class="no-messages">لا توجد رسائل سابقة</div>
                </div>

                <!-- شريط الإدخال -->
                <div class="modal-footer chat-footer">
                    <div class="input-group w-100">
                        <input type="text" id="driverChatInput" class="form-control chat-input"
                            placeholder="اكتب رسالتك هنا...">
                        <button class="btn send-btn" id="driverSendMessageBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة قائمة المحادثات -->
    <div class="modal fade" id="chatListModal" tabindex="-1" aria-labelledby="chatListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chatListModalLabel">قائمة المحادثات</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                </div>
                <div class="modal-body">
                    <div class="driver-chats-container" id="driverChatsList">
                        <!-- ستتم إضافة المحادثات هنا بشكل ديناميكي -->
                        <div class="no-chats-message">لا توجد محادثات بعد</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- إضافة عناصر الصوت للإشعارات -->
    <audio id="messageSound"
        src="https://github.com/AlQasimMall/taxialpasha/raw/main/%D8%A7%D9%84%D9%87%D8%A7%D8%AA%D9%81-%D8%A7%D9%84%D8%AB%D8%A7%D8%A8%D8%AA.mp3"
        preload="auto"></audio>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- تهيئة Firebase (نفس الاعدادات الموجودة في ملف index.html) -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEMiAI",
            authDomain: "messageemeapp.firebaseapp.com",
            databaseURL: "https://messageemeapp-default-rtdb.firebaseio.com",
            projectId: "messageemeapp",
            storageBucket: "messageemeapp.appspot.com",
            messagingSenderId: "255034474844",
            appId: "1:255034474844:web:5e3b7a6bc4b2fb94cc4199"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        const database = firebase.database();
        const storage = firebase.storage();
    </script>

    <!-- App Scripts -->
    <script>
        // قائمة المحافظات والمناطق في العراق
        const iraqProvinces = {
           "بغداد": ["الكرخ", "الرصافة", "الأعظمية", "الكاظمية", "المنصور", "الدورة", "الشعب", "الكرادة", "زيونة", "الغدير", "البلديات", "الشعلة", "الحرية", "الوشاش", "حي الجامعة", "الصليخ", "بغداد الجديدة", "مدينة الصدر", "الزعفرانية", "العامرية", "الغزالية", "الجادرية", "الحارثية", "الجهاد", "البياع", "الخضراء", "حي الخليج", "التاجي"],
    "البصرة": ["البصرة الجديدة", "الزبير", "أبو الخصيب", "القرنة", "شط العرب", "الفاو", "الهارثة", "الدير", "المدينة", "العشار", "البراضعية", "الخور", "النجيبية", "الفيحاء", "المعقل", "سفوان", "الخصيب", "جبيلة", "القبلة", "ياسين خريبط", "الشعيبة"],
    "نينوى": ["الموصل", "تلعفر", "الحمدانية", "سنجار", "الحضر", "البعاج", "عين سفني", "تلكيف", "القيارة", "مخمور", "شيخان", "الحيدانية", "الشمال", "وانة", "سميل"],
    "أربيل": ["عنكاوا", "شقلاوة", "خبات", "سوران", "جومان", "رواندوز", "ميرگسور", "كوية", "المركز", "دشتي هولير", "خيفتي", "دارتو", "بنصلاوة", "حرير", "سيديكان", "شيروان-مزن", "مخمور", "قوشتبة"],
    "النجف": ["الكوفة", "المناذرة", "المشخاب", "الحيدرية", "العباسية", "القادسية", "الحرية", "النجف القديمة", "الغري", "النصر", "الوفاء", "الزهراء", "الجامعة", "السلام", "الغدير", "المرتضى", "القدس", "الأمير"],
    "كربلاء": ["الحسينية", "الهندية", "عين التمر", "الحر", "الجدول الغربي", "مركز كربلاء", "الخيرات", "الرشيد", "العباس", "الإصلاح", "الحسين", "المخيم", "الأنصار", "باب الخان", "الإسكان"],
    "كركوك": ["دبس", "الحويجة", "داقوق", "تازة", "شوان", "يايجي", "الملتقى", "العروبة", "القادسية", "الواسطي", "المنصور", "النصر", "الرياض", "الرشاد", "الزاب", "الرياض", "الصناعي"],
    "الأنبار": ["الرمادي", "الفلوجة", "هيت", "حديثة", "الخالدية", "الصقلاوية", "كبيسة", "العامرية", "الحبانية", "راوة", "عنه", "الرطبة", "القائم", "البغدادي", "الكرمة", "الوليد", "الحقلانية", "الرحالية"],
    "بابل": ["الحلة", "المسيب", "الهاشمية", "القاسم", "المحاويل", "الكفل", "النيل", "أبو غرق", "المدحتية", "الإسكندرية", "جرف الصخر", "الأمين", "بابل الجديدة", "الكرار", "الجامعة", "القاضية", "المدينة القديمة", "نادر", "الطهمازية", "الإمام", "المصطفى", "الشوملي"],
    "ديالى": ["بعقوبة", "المقدادية", "خانقين", "بلدروز", "كفري", "الخالص", "جلولاء", "قزانية", "مندلي", "قرة تبة", "السد العظيم", "بهرز", "كنعان", "هبهب", "أبو صيدا", "الوجيهية", "السلام", "العظيم", "بني سعد"],
    "ذي قار": ["الناصرية", "سوق الشيوخ", "الشطرة", "الرفاعي", "الجبايش", "قلعة سكر", "الغراف", "البطحاء", "النصر", "الإصلاح", "الفجر", "الدواية", "سيد دخيل", "الفضلية", "النهروان", "الإسكان", "الصدرين", "الحبوبي", "المنتظر"],
    "السليمانية": ["جمجمال", "حلبجة", "رانية", "دوكان", "قلعة دزة", "بازيان", "بكرجو", "سرجنار", "سيتك", "تانجرو", "سيد صادق", "بينجوين", "قرداغ", "شهرزور", "سيروان", "عربت", "دوكان", "ماوت"],
    "صلاح الدين": ["تكريت", "سامراء", "بيجي", "بلد", "الدور", "الشرقاط", "طوز خورماتو", "العلم", "يثرب", "الدجيل", "عين الفرس", "سليمان بيك", "الفارس", "صلاح الدين الجديد", "آمرلي", "الحويش", "الأسحاقي", "القادسية", "الدبس"],
    "واسط": ["الكوت", "النعمانية", "الحي", "بدرة", "الصويرة", "العزيزية", "الموفقية", "الشحيمية", "الزبيدية", "تاج الدين", "الدبوني", "جصان", "الأحرار", "الدجيلة", "الزهراء", "الفلاحية", "الكرامة", "الرميلة"],
    "ميسان": ["العمارة", "المجر الكبير", "الكحلاء", "علي الغربي", "قلعة صالح", "الميمونة", "الكميت", "السلام", "العدل", "الخير", "الرحمة", "المشرح", "الطيب", "البتيرة", "آل بوشامة", "المناذرة", "المزرعة"],
    "المثنى": ["السماوة", "الرميثة", "السوير", "المجد", "الخضر", "الهلال", "النجمي", "الوركاء", "الدراجي", "بصية", "السلمان", "آل بدير", "أم راكبة", "الإسلام", "البساتين", "الغدير", "المثنى الجديدة"],
    "دهوك": ["زاخو", "العمادية", "سميل", "الشيخان", "ئاكرى", "بردرش", "زاويتة", "باتيل", "كاني ماسي", "ديرلوك", "دهوك المركز", "سرسنك", "الدوسكي", "بامرني", "بيبوز", "مانكيش", "فايدة", "شاريا"],
    "القادسية": ["الديوانية", "عفك", "الشامية", "الحمزة", "نفر", "غماس", "سومر", "الشنافية", "الدغارة", "السنية", "الشافعية", "الجمهوري", "الإسكان", "الفرات", "الزهراء", "المهناوية", "البدير", "سيد الشهداء", "الجزائر", "الصدرين"]
};

        
        // متغيرات عامة تستخدم في التطبيق
        let allDrivers = []; // مصفوفة تخزين جميع السائقين
        let filteredDrivers = []; // مصفوفة تخزين السائقين بعد التصفية
        let carTypesList = []; // قائمة أنواع السيارات المتاحة
        let isDataLoaded = false; // مؤشر تحميل البيانات
        
        // تهيئة لوحة التحميل الهيكلية
        function initializeLoadingSkeletons() {
            const loadingState = document.getElementById('loadingState');
            loadingState.innerHTML = '';
            
            // إنشاء 5 بطاقات هيكلية للتحميل
            for (let i = 0; i < 5; i++) {
                loadingState.innerHTML += `
                <div class="skeleton-card">
                    <div class="skeleton-image position-relative">
                        <div class="skeleton-loader"></div>
                        <div class="skeleton-wave"></div>
                    </div>
                    <div class="skeleton-content position-relative">
                        <div class="skeleton-title skeleton-loader"></div>
                        <div class="skeleton-details">
                            <div class="skeleton-detail skeleton-loader"></div>
                            <div class="skeleton-detail skeleton-loader"></div>
                        </div>
                        <div class="skeleton-actions">
                            <div class="skeleton-button skeleton-loader"></div>
                            <div class="skeleton-button skeleton-loader"></div>
                            <div class="skeleton-button skeleton-loader"></div>
                        </div>
                        <div class="skeleton-wave"></div>
                    </div>
                </div>
                `;
            }
        }
        
        // تهيئة قائمة المحافظات
        function initializeProvinceSelect() {
            const provinceSelect = document.getElementById('provinceFilter');
            
            // مسح الخيارات الحالية ما عدا الخيار الأول
            const defaultOption = provinceSelect.options[0];
            provinceSelect.innerHTML = '';
            provinceSelect.appendChild(defaultOption);
            
            // إضافة المحافظات من القائمة
            Object.keys(iraqProvinces).forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                provinceSelect.appendChild(option);
            });
        }
        
        // تحميل المناطق بناءً على المحافظة المختارة
        function loadAreas(province) {
            const areaSelect = document.getElementById('areaFilter');
            
            // إعادة ضبط خيارات المناطق
            areaSelect.innerHTML = '<option value="">جميع المناطق</option>';
            
            // تعطيل أو تفعيل اختيار المنطقة حسب اختيار المحافظة
            if (!province) {
                areaSelect.disabled = true;
                return;
            }
            
            // تحميل المناطق للمحافظة المختارة
            const areas = iraqProvinces[province] || [];
            
            if (areas.length > 0) {
                areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    areaSelect.appendChild(option);
                });
                areaSelect.disabled = false;
            } else {
                areaSelect.disabled = true;
            }
        }
        
        // تحديث قائمة أنواع السيارات
        function updateCarTypesList() {
            // استخلاص قائمة أنواع السيارات الفريدة من البيانات
            const types = new Set();
            
            allDrivers.forEach(driver => {
                if (driver.carType && driver.carType.trim() !== '') {
                    types.add(driver.carType.trim());
                }
            });
            
            // تحديث القائمة العامة
            carTypesList = Array.from(types).sort();
            
            // تحديث قائمة الاختيار في الواجهة
            const carTypeFilter = document.getElementById('carTypeFilter');
            const defaultOption = carTypeFilter.options[0];
            carTypeFilter.innerHTML = '';
            carTypeFilter.appendChild(defaultOption);
            
            carTypesList.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                carTypeFilter.appendChild(option);
            });
        }
        
        // فلترة السائقين بناءً على المعايير المحددة
        function filterDrivers() {
            // الحصول على قيم الفلاتر
            const province = document.getElementById('provinceFilter').value;
            const area = document.getElementById('areaFilter').value;
            const status = document.getElementById('statusFilter').value;
            const carType = document.getElementById('carTypeFilter').value;
            const searchText = document.getElementById('searchFilter').value.toLowerCase();
            
            // التأكد من تحميل البيانات
            if (!isDataLoaded || allDrivers.length === 0) {
                return;
            }
            
            // فلترة السائقين
            filteredDrivers = allDrivers.filter(driver => {
                // فلتر المحافظة
                if (province && (!driver.location || driver.location !== province)) {
                    return false;
                }
                
                // فلتر المنطقة
                if (area && (!driver.area || driver.area !== area)) {
                    return false;
                }
                
                // فلتر الحالة
                if (status) {
                    const isApproved = driver.approved === true;
                    const isActive = isApproved && driver.active;
                    
                    if (status === 'available' && !isActive) {
                        return false;
                    } else if (status === 'busy' && isActive) {
                        return false;
                    } else if (status === 'pending' && isApproved) {
                        return false;
                    }
                }
                
                // فلتر نوع السيارة
                if (carType && (!driver.carType || driver.carType !== carType)) {
                    return false;
                }
                
                // فلتر البحث النصي
                if (searchText) {
                    const nameMatch = driver.name && driver.name.toLowerCase().includes(searchText);
                    const phoneMatch = driver.phone && driver.phone.toLowerCase().includes(searchText);
                    const carMatch = driver.carType && driver.carType.toLowerCase().includes(searchText);
                    const locationMatch = driver.location && driver.location.toLowerCase().includes(searchText);
                    
                    if (!nameMatch && !phoneMatch && !carMatch && !locationMatch) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // عرض النتائج
            renderDrivers();
            
            // إظهار رسالة التوست
            showToast(`تم العثور على ${filteredDrivers.length} سائق`, 'info');
        }
        
        // عرض السائقين في الواجهة
        function renderDrivers() {
            const driversList = document.getElementById('driversList');
            const emptyState = document.getElementById('emptyState');
            
            // تفريغ قائمة السائقين
            driversList.innerHTML = '';
            
            // إذا لم يوجد سائقين متطابقين
            if (filteredDrivers.length === 0) {
                driversList.style.display = 'none';
                emptyState.style.display = 'flex';
                return;
            }
            
            // إخفاء حالة القائمة الفارغة وإظهار القائمة
            driversList.style.display = 'flex';
            emptyState.style.display = 'none';
            
            // إضافة كل سائق إلى القائمة
            filteredDrivers.forEach(driver => {
                addDriverToList(driver, driver.id);
            });
        }
        
        // إضافة بطاقة سائق إلى القائمة
        function addDriverToList(driver, driverId) {
            const driversList = document.getElementById('driversList');
            
            // تحديد حالة السائق
            const isApproved = driver.approved === true;
            const isPending = driver.approvalStatus === 'pending';
            const isActive = isApproved && driver.active;
            
            // تحديد فئة الحالة
            let statusClass = '';
            let statusText = '';
            
            if (!isApproved) {
                statusClass = 'status-pending';
                statusText = 'قيد المراجعة';
            } else if (isActive) {
                statusClass = 'status-available';
                statusText = 'متاح';
            } else {
                statusClass = 'status-busy';
                statusText = 'مشغول';
            }
            
            // تحديد ما إذا كان السائق مفضلاً
            const isFavorite = isDriverFavorited(driverId);
            
            // إنشاء بطاقة السائق
            const driverCard = document.createElement('div');
            driverCard.className = 'driver-list-item animate__animated animate__fadeIn';
            driverCard.dataset.driverId = driverId;
            driverCard.dataset.status = isActive ? 'available' : (isPending ? 'pending' : 'busy');
            driverCard.dataset.province = driver.location || '';
            driverCard.dataset.area = driver.area || '';
            
            driverCard.innerHTML = `
                <img src="${driver.imageUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" 
                     alt="${driver.name || 'سائق'}" 
                     class="driver-image" 
                     ${!isApproved ? 'style="filter: grayscale(100%);"' : ''}>
                <div class="driver-info">
                    <div class="driver-name">
                        ${driver.name || 'سائق جديد'}
                        <div class="driver-rating">
                            <i class="fas fa-star"></i> ${driver.rating ? driver.rating.toFixed(1) : '5.0'}
                        </div>
                    </div>
                    <div class="driver-details">
                        <div class="detail-item">
                            <i class="fas fa-car"></i>
                            <span>${driver.carType || ''} ${driver.carModel || ''}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${driver.location || ''} ${driver.area ? '- ' + driver.area : ''}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-route"></i>
                            <span>${driver.trips || 0} رحلة</span>
                        </div>
                    </div>
                    <div class="driver-actions">
                        <button class="action-btn view-btn" onclick="viewDriverDetails('${driverId}')">
                            <i class="fas fa-eye"></i>
                            عرض التفاصيل
                        </button>
                        <button class="action-btn chat-btn" onclick="openChatModal('${driverId}')" ${!isApproved ? 'disabled' : ''}>
                            <i class="fas fa-comment"></i>
                            مراسلة
                        </button>
                        <button class="action-btn call-btn" onclick="callDriver('${driverId}')" ${!isActive ? 'disabled' : ''}>
                            <i class="fas fa-phone-alt"></i>
                            اتصال
                        </button>
                    </div>
                </div>
                <div class="driver-status-badge ${statusClass}">
                    <i class="fas fa-circle"></i> ${statusText}
                </div>
                <button class="favorite-toggle ${isFavorite ? 'active' : ''}" onclick="toggleFavorite('${driverId}', event)">
                    <i class="${isFavorite ? 'fas' : 'far'} fa-star"></i>
                </button>
            `;
            
            driversList.appendChild(driverCard);
        }
        
        // تحميل البيانات من Firebase
        function loadDriversFromFirebase() {
            // إظهار حالة التحميل
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('driversList').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            
            // إخفاء مؤشر التحميل الرئيسي إذا كان ظاهراً
            hideLoading();
            
            // إعادة ضبط المتغيرات العامة
            allDrivers = [];
            filteredDrivers = [];
            isDataLoaded = false;
            
            // استعلام قاعدة البيانات
            return firebase.database().ref('drivers').once('value')
                .then(snapshot => {
                    // التحقق من وجود بيانات
                    if (!snapshot.exists()) {
                        // لا توجد بيانات، إظهار حالة القائمة الفارغة
                        document.getElementById('loadingState').style.display = 'none';
                        document.getElementById('driversList').style.display = 'none';
                        document.getElementById('emptyState').style.display = 'flex';
                        return;
                    }
                    
                    // تحويل البيانات من قاعدة البيانات إلى مصفوفة
                    snapshot.forEach(driverSnapshot => {
                        const driver = driverSnapshot.val();
                        const driverId = driverSnapshot.key;
                        
                        // ضمان وجود معرف فريد للسائق
                        driver.id = driverId;
                        
                        // إضافة السائق إلى المصفوفة الرئيسية
                        allDrivers.push(driver);
                    });
                    
                    // نسخ جميع السائقين إلى مصفوفة التصفية
                    filteredDrivers = [...allDrivers];
                    
                    // تحديث قائمة أنواع السيارات
                    updateCarTypesList();
                    
                    // تحديث العلامة لإظهار أن البيانات تم تحميلها
                    isDataLoaded = true;
                    
                    // إخفاء حالة التحميل وعرض القائمة
                    document.getElementById('loadingState').style.display = 'none';
                    
                    // عرض السائقين
                    renderDrivers();
                    
                    // إظهار رسالة نجاح
                    showToast(`تم تحميل ${allDrivers.length} سائق`, 'success');
                })
                .catch(error => {
                    // معالجة الأخطاء
                    console.error('Error loading drivers:', error);
                    
                    // إخفاء حالة التحميل وإظهار رسالة خطأ
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('driversList').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'flex';
                    document.getElementById('emptyState').querySelector('h3').textContent = 'حدث خطأ';
                    document.getElementById('emptyState').querySelector('p').textContent = 'حدث خطأ أثناء تحميل بيانات السائقين. يرجى المحاولة مرة أخرى لاحقاً.';
                    document.getElementById('emptyState').querySelector('i').className = 'fas fa-exclamation-triangle';
                    
                    // إظهار رسالة خطأ
                    showToast('حدث خطأ في تحميل بيانات السائقين', 'error');
                });
        }
        
        // إعادة ضبط الفلاتر
        function resetFilters() {
            document.getElementById('provinceFilter').value = '';
            document.getElementById('areaFilter').value = '';
            document.getElementById('areaFilter').disabled = true;
            document.getElementById('statusFilter').value = '';
            document.getElementById('carTypeFilter').value = '';
            document.getElementById('searchFilter').value = '';
            
            // إعادة ضبط مصفوفة التصفية
            filteredDrivers = [...allDrivers];
            
            // عرض السائقين
            renderDrivers();
            
            // إظهار رسالة نجاح
            showToast('تم إعادة ضبط الفلاتر', 'success');
        }
        
        // عرض تفاصيل السائق
        function viewDriverDetails(driverId) {
            // إظهار مؤشر التحميل
            showLoading();
            
            // جلب بيانات السائق
            firebase.database().ref(`drivers/${driverId}`).once('value')
                .then(snapshot => {
                    // إخفاء مؤشر التحميل
                    hideLoading();
                    
                    const driver = snapshot.val();
                    if (!driver) {
                        showToast('لم يتم العثور على بيانات السائق', 'error');
                        return;
                    }
                    
                    // تحديد حالة السائق
                    const isApproved = driver.approved === true;
                    const isActive = isApproved && driver.active;
                    
                    // تحديد ما إذا كان السائق مفضلاً
                    const isFavorite = isDriverFavorited(driverId);
                    
                    // إنشاء محتوى نافذة التفاصيل
                    const contentDiv = document.getElementById('driverDetailsContent');
                    
                    // تنسيق تاريخ الانضمام
                    const joinDate = driver.createdAt || driver.registrationDate 
                        ? new Date(driver.createdAt || driver.registrationDate).toLocaleDateString('ar-IQ')
                        : 'غير متوفر';
                    
                    // تنسيق نجوم التقييم
                    const rating = driver.rating || 5.0;
                    let starsHtml = '';
                    
                    for (let i = 1; i <= 5; i++) {
                        if (i <= Math.floor(rating)) {
                            starsHtml += '<i class="fas fa-star"></i> ';
                        } else if (i == Math.ceil(rating) && rating % 1 > 0) {
                            starsHtml += '<i class="fas fa-star-half-alt"></i> ';
                        } else {
                            starsHtml += '<i class="far fa-star"></i> ';
                        }
                    }
                    
                    contentDiv.innerHTML = `
                        <div class="driver-profile-header">
                            <img src="${driver.imageUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" 
                                 alt="صورة السائق" 
                                 class="profile-image"
                                 ${!isApproved ? 'style="filter: grayscale(80%);"' : ''}>
                            <div class="profile-info">
                                <h4 class="profile-name">${driver.name || 'سائق جديد'}</h4>
                                <div class="driver-rating mb-2">
                                    ${starsHtml}
                                    <span>${rating.toFixed(1)}</span> (${driver.trips || 0} رحلة)
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-cards">
                            <div class="info-card">
                                <div class="card-icon">
                                    <i class="fas fa-car"></i>
                                </div>
                                <div class="card-title">نوع السيارة</div>
                                <div class="card-value">${driver.carType || ''} ${driver.carModel || ''}</div>
                            </div>
                            
                            <div class="info-card">
                                <div class="card-icon">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <div class="card-title">المنطقة</div>
                                <div class="card-value">${driver.location || ''} ${driver.area ? '- ' + driver.area : ''}</div>
                            </div>
                            
                            <div class="info-card">
                                <div class="card-icon">
                                    <i class="fas fa-route"></i>
                                </div>
                                <div class="card-title">الرحلات</div>
                                <div class="card-value">${driver.trips || 0} رحلة</div>
                            </div>
                            
                            <div class="info-card">
                                <div class="card-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div class="card-title">تاريخ الانضمام</div>
                                <div class="card-value">${joinDate}</div>
                            </div>
                            
                            <div class="info-card">
                                <div class="card-icon">
                                    <i class="fas fa-phone-alt"></i>
                                </div>
                                <div class="card-title">رقم الهاتف</div>
                                <div class="card-value">${driver.phone || 'غير متوفر'}</div>
                            </div>
                        </div>
                        
                        <div class="documents-section">
                            <h5>المستندات المتحقق منها</h5>
                            <div class="document-items">
                                <div class="document-item">
                                    <div class="document-icon">
                                        <i class="fas fa-id-card"></i>
                                    </div>
                                    <div class="document-name">هوية الأحوال</div>
                                </div>
                                
                                <div class="document-item">
                                    <div class="document-icon">
                                        <i class="fas fa-id-card-alt"></i>
                                    </div>
                                    <div class="document-name">إجازة السوق</div>
                                </div>
                                
                                <div class="document-item">
                                    <div class="document-icon">
                                        <i class="fas fa-home"></i>
                                    </div>
                                    <div class="document-name">بطاقة السكن</div>
                                </div>
                                
                                <div class="document-item">
                                    <div class="document-icon">
                                        <i class="fas fa-car-side"></i>
                                    </div>
                                    <div class="document-name">سنوية السيارة</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="openChatWindow('${driverId}')" ${!isApproved ? 'disabled' : ''}>
                                <i class="fas fa-comment"></i> مراسلة
                            </button>
                            <button class="btn btn-success" onclick="callDriver('${driverId}')" ${!isActive ? 'disabled' : ''}>
                                <i class="fas fa-phone-alt"></i> اتصال
                            </button>
                            <button class="btn btn-warning" id="favoriteBtn" onclick="toggleFavoriteModal('${driverId}')" ${!isApproved ? 'disabled' : ''}>
                                <i class="${isFavorite ? 'fas' : 'far'} fa-star"></i> ${isFavorite ? 'إزالة من المفضلة' : 'إضافة للمفضلة'}
                            </button>
                        </div>
                    `;
                    
                    // فتح نافذة التفاصيل
                    const modal = new bootstrap.Modal(document.getElementById('driverDetailsModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error fetching driver details:', error);
                    hideLoading();
                    showToast('حدث خطأ في تحميل بيانات السائق', 'error');
                });
        }
        
        // فتح نافذة المحادثة
        function openChatWindow(driverId) {
            // التحقق من حالة تسجيل الدخول أولاً
            const currentUser = getCurrentUser();
            if (!currentUser) {
                showLoginPrompt('للتواصل مع السائق يرجى تسجيل الدخول أولاً');
                return;
            }
            
            // إظهار مؤشر التحميل
            showLoading();
            
            // جلب بيانات السائق
            firebase.database().ref(`drivers/${driverId}`).once('value')
                .then(snapshot => {
                    // إخفاء مؤشر التحميل
                    hideLoading();
                    
                    const driver = snapshot.val();
                    if (!driver) {
                        showToast('لم يتم العثور على بيانات السائق', 'error');
                        return;
                    }
                    
                    // إذا كانت الدالة متوفرة في النطاق العام
                    if (typeof window.openChatWindow === 'function') {
                        window.openChatWindow(driverId, driver.imageUrl, driver.name, driver.carType);
                    } else {
                        // إنشاء نافذة محادثة بسيطة
                        Swal.fire({
                            title: 'محادثة مع ' + driver.name,
                            html: `
                                <div class="text-center">
                                    <img src="${driver.imageUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" 
                                         alt="${driver.name}" 
                                         class="rounded-circle mb-3"
                                         style="width: 80px; height: 80px; object-fit: cover; border: 3px solid #FFD700;">
                                    <h5>${driver.name}</h5>
                                    <p class="mb-3">${driver.carType} - ${driver.carModel}</p>
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control" placeholder="اكتب رسالتك هنا...">
                                        <button class="btn btn-primary" type="button">إرسال</button>
                                    </div>
                                </div>
                            `,
                            showCancelButton: true,
                            cancelButtonText: 'إغلاق',
                            showConfirmButton: false,
                            width: '500px',
                            background: '#1a1a1a',
                            color: '#FFFFFF'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error opening chat:', error);
                    hideLoading();
                    showToast('حدث خطأ في فتح المحادثة', 'error');
                });
        }
        
        // الاتصال بالسائق
        function callDriver(driverId) {
            // التحقق من حالة تسجيل الدخول أولاً
            const currentUser = getCurrentUser();
            if (!currentUser) {
                showLoginPrompt('للاتصال بالسائق يرجى تسجيل الدخول أولاً');
                return;
            }
            
            // إظهار مؤشر التحميل
            showLoading();
            
            // جلب بيانات السائق
            firebase.database().ref(`drivers/${driverId}`).once('value')
                .then(snapshot => {
                    // إخفاء مؤشر التحميل
                    hideLoading();
                    
                    const driver = snapshot.val();
                    if (!driver) {
                        showToast('لم يتم العثور على بيانات السائق', 'error');
                        return;
                    }
                    
                    // فتح نافذة تأكيد الاتصال
                    Swal.fire({
                        title: 'تأكيد الاتصال',
                        html: `
                            <div class="text-center">
                                <img src="${driver.imageUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" 
                                     alt="${driver.name}" 
                                     style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 15px;">
                                <h5>${driver.name}</h5>
                                <p class="text-muted">${driver.phone}</p>
                            </div>
                        `,
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonText: 'اتصال',
                        cancelButtonText: 'إلغاء',
                        confirmButtonColor: '#4CAF50',
                        background: '#1a1a1a',
                        color: '#FFFFFF'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // تحديث حالة السائق إلى مشغول
                            firebase.database().ref(`drivers/${driverId}`).update({
                                active: false
                            }).then(() => {
                                // فتح تطبيق الهاتف
                                window.location.href = `tel:${driver.phone}`;
                                
                                // إعادة تحميل السائقين بعد 3 ثوانٍ
                                setTimeout(() => {
                                    loadDriversFromFirebase();
                                }, 3000);
                            });
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching driver for call:', error);
                    hideLoading();
                    showToast('حدث خطأ في الاتصال بالسائق', 'error');
                });
        }
        
        // تطبيق البحث المتقدم
        function applyAdvancedSearch() {
            // الحصول على قيم البحث المتقدم
            const searchText = document.getElementById('advancedSearch').value.toLowerCase();
            const ratingValue = parseFloat(document.getElementById('ratingRange').value);
            const availableOnly = document.getElementById('availableOnly').checked;
            
            // التأكد من تحميل البيانات
            if (!isDataLoaded || allDrivers.length === 0) {
                return;
            }
            
            // فلترة السائقين
            filteredDrivers = allDrivers.filter(driver => {
                // فلتر التقييم
                const rating = driver.rating || 5.0;
                if (rating < ratingValue) {
                    return false;
                }
                
                // فلتر الحالة
                if (availableOnly) {
                    const isApproved = driver.approved === true;
                    const isActive = isApproved && driver.active;
                    if (!isActive) {
                        return false;
                    }
                }
                
                // فلتر البحث النصي
                if (searchText) {
                    const nameMatch = driver.name && driver.name.toLowerCase().includes(searchText);
                    const phoneMatch = driver.phone && driver.phone.toLowerCase().includes(searchText);
                    const carMatch = driver.carType && driver.carType.toLowerCase().includes(searchText);
                    const locationMatch = driver.location && driver.location.toLowerCase().includes(searchText);
                    
                    if (!nameMatch && !phoneMatch && !carMatch && !locationMatch) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // عرض النتائج
            renderDrivers();
            
            // إغلاق نافذة البحث المتقدم
            const searchModal = bootstrap.Modal.getInstance(document.getElementById('searchModal'));
            if (searchModal) {
                searchModal.hide();
            }
            
            // إظهار رسالة التوست
            showToast(`تم العثور على ${filteredDrivers.length} سائق`, 'info');
        }
        
        // تحديث قيمة التقييم في شريط التمرير
        function updateRatingValue() {
            const ratingValue = document.getElementById('ratingValue');
            const ratingRange = document.getElementById('ratingRange');
            
            if (ratingValue && ratingRange) {
                ratingValue.textContent = `${ratingRange.value}+`;
            }
        }
        
        // التحقق من وجود السائق في المفضلة
        function isDriverFavorited(driverId) {
            const favorites = getFavoriteDrivers();
            return favorites.includes(driverId);
        }
        
        // الحصول على قائمة السائقين المفضلين
        function getFavoriteDrivers() {
            const favoritesStr = localStorage.getItem('favoriteDrivers');
            return favoritesStr ? JSON.parse(favoritesStr) : [];
        }
        
        // حفظ قائمة السائقين المفضلين
        function saveFavoriteDrivers(favorites) {
            localStorage.setItem('favoriteDrivers', JSON.stringify(favorites));
            
            // تحديث عداد السائقين المفضلين
            updateFavoriteDriversBadge();
        }
        
        // تبديل حالة السائق المفضل
        function toggleFavorite(driverId, event) {
            // إيقاف انتشار الحدث
            if (event) {
                event.stopPropagation();
            }
            
            // التحقق من حالة تسجيل الدخول أولاً
            const currentUser = getCurrentUser();
            if (!currentUser) {
                showLoginPrompt('لإضافة السائق للمفضلة يرجى تسجيل الدخول أولاً');
                return;
            }
            
            // الحصول على قائمة المفضلين
            const favorites = getFavoriteDrivers();
            
            // التحقق من وجود السائق في المفضلة
            const index = favorites.indexOf(driverId);
            
            if (index !== -1) {
                // إزالة السائق من المفضلة
                favorites.splice(index, 1);
                showToast('تم إزالة السائق من المفضلة', 'info');
            } else {
                // إضافة السائق إلى المفضلة
                favorites.push(driverId);
                showToast('تم إضافة السائق إلى المفضلة', 'success');
            }
            
            // حفظ القائمة الجديدة
            saveFavoriteDrivers(favorites);
            
            // تحديث واجهة المستخدم
            updateFavoriteButtonUI(driverId);
        }
        
        // تبديل حالة السائق المفضل في النافذة المنبثقة
        function toggleFavoriteModal(driverId) {
            toggleFavorite(driverId);
            
            // تحديث زر المفضلة في النافذة المنبثقة
            const favoriteBtn = document.getElementById('favoriteBtn');
            const isFavorite = isDriverFavorited(driverId);
            
            if (favoriteBtn) {
                favoriteBtn.innerHTML = `
                    <i class="${isFavorite ? 'fas' : 'far'} fa-star"></i> 
                    ${isFavorite ? 'إزالة من المفضلة' : 'إضافة للمفضلة'}
                `;
            }
        }
        
        // تحديث واجهة زر المفضلة
        function updateFavoriteButtonUI(driverId) {
            const isFavorite = isDriverFavorited(driverId);
            
            // تحديث جميع أزرار هذا السائق
            const favoriteButtons = document.querySelectorAll(`.favorite-toggle[onclick*="${driverId}"]`);
            favoriteButtons.forEach(button => {
                const icon = button.querySelector('i');
                
                if (isFavorite) {
                    button.classList.add('active');
                    icon.className = 'fas fa-star';
                } else {
                    button.classList.remove('active');
                    icon.className = 'far fa-star';
                }
            });
        }
        
        // تحديث عداد السائقين المفضلين
        function updateFavoriteDriversBadge() {
            const favorites = getFavoriteDrivers();
            const badge = document.getElementById('favoriteDriversBadge');
            
            if (badge) {
                if (favorites.length > 0) {
                    badge.textContent = favorites.length;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        // عرض نافذة تأكيد تسجيل الدخول
        function showLoginPrompt(message) {
            Swal.fire({
                title: 'مطلوب تسجيل الدخول',
                text: message,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'تسجيل الدخول',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#FFD700',
                background: '#1a1a1a',
                color: '#FFFFFF'
            }).then((result) => {
                if (result.isConfirmed) {
                    // فتح نافذة تسجيل الدخول
                    const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
                    loginModal.show();
                }
            });
        }
        
        // الحصول على بيانات المستخدم الحالي
        function getCurrentUser() {
            const userJson = localStorage.getItem('currentUser');
            if (!userJson) return null;
            
            try {
                return JSON.parse(userJson);
            } catch (error) {
                console.error('Error parsing user data:', error);
                return null;
            }
        }
        
        // توغل الشريط الجانبي
        function toggleSideNav() {
            const sideNav = document.getElementById('sideNav');
            const navBackdrop = document.getElementById('navBackdrop');
            
            sideNav.classList.toggle('open');
            navBackdrop.classList.toggle('show');
            document.body.classList.toggle('side-nav-open');
        }
        
        // دالة تسجيل الخروج
        function handleLogout() {
            // إزالة بيانات المستخدم من التخزين المحلي
            localStorage.removeItem('currentUser');
            
            // إعادة تعيين واجهة المستخدم
            resetUserInterface();
            
            // عرض رسالة نجاح
            showToast('تم تسجيل الخروج بنجاح', 'success');
        }
        
        // إعادة ضبط واجهة المستخدم بعد تسجيل الخروج
        function resetUserInterface() {
            // إعادة تعيين معلومات المستخدم في الشريط الجانبي
            const sideNavUserInfo = document.querySelector('.side-nav-user-info');
            if (sideNavUserInfo) {
                sideNavUserInfo.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-user-circle text-white" style="font-size: 4rem;"></i>
                        <h6 class="text-white mt-3">مرحباً بك</h6>
                        <p class="text-white-50 small">قم بتسجيل الدخول للوصول إلى حسابك</p>
                        <div class="mt-3">
                            <button class="btn btn-gold w-100 mb-2" data-bs-toggle="modal" data-bs-target="#loginModal">
                                تسجيل الدخول
                            </button>
                            <button class="btn btn-outline-light w-100 mb-2" data-bs-toggle="modal" data-bs-target="#userRegistrationModal">
                                إنشاء حساب
                            </button>
                            <button class="btn btn-outline-light w-100" data-bs-toggle="modal" data-bs-target="#addDriverModal">
                                إضافة سائق
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // إخفاء زر تسجيل الخروج
            const logoutBtn = document.querySelector('.logout-btn');
            if (logoutBtn) {
                logoutBtn.style.display = 'none';
            }
            
            // إعادة تعيين صورة المستخدم في الشريط العلوي
            const userProfileImage = document.getElementById('userProfileImage');
            const defaultProfileIcon = document.getElementById('defaultProfileIcon');
            const profileText = document.getElementById('profileText');
            
            if (userProfileImage) userProfileImage.style.display = 'none';
            if (defaultProfileIcon) defaultProfileIcon.style.display = 'inline-block';
            if (profileText) {
                profileText.textContent = 'تسجيل الدخول';
                profileText.style.display = 'inline-block';
            }
        }
        
        // إظهار مؤشر التحميل
        function showLoading() {
            const loadingSpinner = document.getElementById('loadingSpinner');
            if (loadingSpinner) {
                loadingSpinner.style.display = 'flex';
            }
        }
        
        // إخفاء مؤشر التحميل
        function hideLoading() {
            const loadingSpinner = document.getElementById('loadingSpinner');
            if (loadingSpinner) {
                loadingSpinner.style.display = 'none';
            }
            
            // التأكد من إخفاء مؤشر التحميل الهيكلي أيضًا
            document.getElementById('loadingState').style.display = 'none';
        }
        
        // إظهار رسالة توست
        function showToast(message, type = 'success') {
            // قائمة الأيقونات
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            // قائمة الألوان
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#17a2b8'
            };
            
            // إنشاء عنصر التوست
            const toast = document.createElement('div');
            toast.className = `toast animate__animated animate__fadeInRight`;
            toast.style.backgroundColor = '#1a1a1a';
            toast.style.color = '#ffffff';
            toast.style.border = `1px solid ${colors[type]}`;
            toast.style.borderRadius = '10px';
            toast.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.5)';
            toast.style.margin = '0 0 10px 0';
            toast.style.padding = '10px 15px';
            toast.style.display = 'flex';
            toast.style.alignItems = 'center';
            toast.style.maxWidth = '300px';
            
            // إضافة محتوى التوست
            toast.innerHTML = `
                <i class="fas ${icons[type]}" style="color: ${colors[type]}; margin-left: 10px; font-size: 1.2rem;"></i>
                <div style="flex: 1;">${message}</div>
                <button style="background: transparent; border: none; color: #aaa; font-size: 1.1rem; margin-right: 5px; cursor: pointer;"
                        onclick="this.parentElement.remove()">
                    &times;
                </button>
            `;
            
            // إضافة التوست إلى الحاوية
            const toastContainer = document.getElementById('toastContainer');
            if (toastContainer) {
                toastContainer.appendChild(toast);
                
                // إزالة التوست بعد 5 ثوانٍ
                setTimeout(() => {
                    toast.classList.replace('animate__fadeInRight', 'animate__fadeOutRight');
                    setTimeout(() => {
                        toast.remove();
                    }, 500);
                }, 5000);
            }
        }
        
        // عرض السائقين المفضلين
        function showFavoriteDrivers() {
            // التحقق من حالة تسجيل الدخول أولاً
            const currentUser = getCurrentUser();
            if (!currentUser) {
                showLoginPrompt('لعرض السائقين المفضلين يرجى تسجيل الدخول أولاً');
                return;
            }
            
            // الحصول على قائمة السائقين المفضلين
            const favorites = getFavoriteDrivers();
            
            if (favorites.length === 0) {
                Swal.fire({
                    title: 'لا يوجد سائقين مفضلين',
                    text: 'لم تقم بإضافة أي سائق إلى المفضلة بعد.',
                    icon: 'info',
                    confirmButtonText: 'حسناً',
                    background: '#1a1a1a',
                    color: '#FFFFFF'
                });
                return;
            }
            
            // إظهار مؤشر التحميل
            showLoading();
            
            // استعلام السائقين المفضلين
            const promises = favorites.map(driverId => {
                return firebase.database().ref(`drivers/${driverId}`).once('value')
                    .then(snapshot => {
                        const driver = snapshot.val();
                        return driver ? { id: driverId, ...driver } : null;
                    });
            });
            
            Promise.all(promises)
                .then(results => {
                    // إخفاء مؤشر التحميل
                    hideLoading();
                    
                    // تصفية السائقين الموجودين
                    const drivers = results.filter(driver => driver !== null);
                    
                    // بناء محتوى النافذة
                    let content = '';
                    
                    if (drivers.length === 0) {
                        content = `
                            <div class="text-center py-4">
                                <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #FFD700; margin-bottom: 15px;"></i>
                                <h5>لا يوجد سائقين متاحين</h5>
                                <p class="text-muted">تمت إزالة السائقين المفضلين من النظام.</p>
                            </div>
                        `;
                    } else {
                        content = `
                            <div class="favorite-drivers-container">
                                ${drivers.map(driver => `
                                    <div class="favorite-driver-card" data-driver-id="${driver.id}">
                                        <div class="d-flex align-items-center gap-3 mb-3">
                                            <img src="${driver.imageUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" 
                                                 alt="${driver.name}" 
                                                 style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                                            <div style="flex: 1;">
                                                <h6 style="margin: 0; color: #FFD700;">${driver.name || 'سائق'}</h6>
                                                <div style="font-size: 0.8rem; color: #ccc;">
                                                    <i class="fas fa-star" style="color: #FFD700;"></i> ${driver.rating ? driver.rating.toFixed(1) : '5.0'} | ${driver.trips || 0} رحلة
                                                </div>
                                            </div>
                                            <button class="remove-favorite-btn" onclick="toggleFavorite('${driver.id}', event)" title="إزالة من المفضلة">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <button class="action-btn view-btn" onclick="viewDriverDetails('${driver.id}')" style="width: 100%; padding: 8px 0; border-radius: 5px; border: none; background: #FFD700; color: #000; font-weight: bold;">
                                                <i class="fas fa-eye"></i> التفاصيل
                                            </button>
                                            <button class="action-btn chat-btn" onclick="openChatWindow('${driver.id}')" style="width: 100%; padding: 8px 0; border-radius: 5px; border: none; background: #333; color: #FFD700; border: 1px solid #FFD700;">
                                                <i class="fas fa-comment"></i> مراسلة
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    // عرض النافذة المنبثقة
                    Swal.fire({
                        title: 'السائقين المفضلين',
                        html: content,
                        width: '500px',
                        padding: '20px',
                        background: '#1a1a1a',
                        color: '#FFFFFF',
                        showConfirmButton: drivers.length === 0,
                        confirmButtonText: 'حسناً',
                        showCloseButton: true,
                        customClass: {
                            popup: 'dark-popup',
                            title: 'text-white'
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching favorite drivers:', error);
                    hideLoading();
                    showToast('حدث خطأ في تحميل السائقين المفضلين', 'error');
                });
        }
        
        // تهيئة حالة المستخدم
        function updateUserState() {
            const currentUser = getCurrentUser();
            
            if (currentUser) {
                // تحديث معلومات المستخدم في الشريط الجانبي
                const sideNavUserInfo = document.querySelector('.side-nav-user-info');
                if (sideNavUserInfo) {
                    sideNavUserInfo.innerHTML = `
                        <div class="text-center">
                            <img src="${currentUser.photoUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/user-photos%2F1741376568952_default-avatar.png?alt=media&token=ad672ccf-c8e1-4788-a252-52de6c3ceedd'}" 
                                 alt="${currentUser.fullName || 'المستخدم'}" 
                                 class="rounded-circle mb-3"
                                 style="width: 80px; height: 80px; object-fit: cover; border: 3px solid #FFD700;">
                            <h6 class="text-white mb-1">${currentUser.fullName || 'المستخدم'}</h6>
                            <span class="badge bg-gold mb-2">${currentUser.userType === 'driver' ? 'سائق' : 'مستخدم'}</span>
                            <p class="text-white-50 small mb-3">${currentUser.email || ''}</p>
                        </div>
                    `;
                }
                
                // إظهار زر تسجيل الخروج
                const logoutBtn = document.querySelector('.logout-btn');
                if (logoutBtn) {
                    logoutBtn.style.display = 'flex';
                }
                
                // تحديث صورة المستخدم في الشريط العلوي
                const userProfileImage = document.getElementById('userProfileImage');
                const defaultProfileIcon = document.getElementById('defaultProfileIcon');
                const profileText = document.getElementById('profileText');
                
                if (userProfileImage && defaultProfileIcon && profileText) {
                    userProfileImage.src = currentUser.photoUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/user-photos%2F1741376568952_default-avatar.png?alt=media&token=ad672ccf-c8e1-4788-a252-52de6c3ceedd';
                    userProfileImage.style.display = 'block';
                    defaultProfileIcon.style.display = 'none';
                    profileText.textContent = currentUser.fullName || 'المستخدم';
                }
            }
        }
        
        // إضافة مستمع النقر على رابط السائقين المفضلين
        function setupEventListeners() {
            // مستمع حدث لتغيير قيمة التقييم في البحث المتقدم
            const ratingRange = document.getElementById('ratingRange');
            if (ratingRange) {
                ratingRange.addEventListener('input', updateRatingValue);
            }
            
            // مستمع حدث للنقر على رابط السائقين المفضلين
            const favoriteDriversLink = document.getElementById('favoriteDriversLink');
            if (favoriteDriversLink) {
                favoriteDriversLink.addEventListener('click', function(event) {
                    event.preventDefault();
                    // إغلاق الشريط الجانبي قبل عرض المفضلة
                    const sideNav = document.getElementById('sideNav');
                    const navBackdrop = document.getElementById('navBackdrop');
                    if (sideNav && sideNav.classList.contains('open')) {
                        sideNav.classList.remove('open');
                        navBackdrop.classList.remove('show');
                        document.body.classList.remove('side-nav-open');
                    }
                    
                    showFavoriteDrivers();
                });
            }
        }
        
        // تهيئة الصفحة عند التحميل
        document.addEventListener('DOMContentLoaded', function() {
            // تهيئة لوحة التحميل الهيكلية
            initializeLoadingSkeletons();
            
            // تهيئة قائمة المحافظات
            initializeProvinceSelect();
            
            // تحديث قيمة التقييم في البحث المتقدم
            updateRatingValue();
            
            // تهيئة مستمعات الأحداث
            setupEventListeners();
            
            // تحديث حالة المستخدم
            updateUserState();
            
            // تحديث عداد السائقين المفضلين
            updateFavoriteDriversBadge();
            
            // تحميل السائقين من Firebase
            loadDriversFromFirebase();
        });




 // دالة معالجة إضافة سائق
 async function handleAddDriver(event) {
            event.preventDefault();
            showLoading();

            try {
            // التحقق من تطابق كلمات المرور
            const email = document.getElementById('driverEmail').value;
            const password = document.getElementById('driverPassword').value;
            const confirmPassword = document.getElementById('confirmDriverPassword').value;

            if (!email || !password) {
                throw new Error('يرجى إدخال البريد الإلكتروني وكلمة المرور');
            }

            if (password !== confirmPassword) {
                throw new Error('كلمات المرور غير متطابقة');
            }

            // التحقق من تحميل جميع المستندات المطلوبة
            const requiredFiles = {
                'idCardFront': 'صورة الهوية الأمامية',
                'idCardBack': 'صورة الهوية الخلفية',
                'residenceFront': 'صورة بطاقة السكن الأمامية',
                'residenceBack': 'صورة بطاقة السكن الخلفية',
                'licenseFront': 'صورة إجازة السوق الأمامية',
                'licenseBack': 'صورة إجازة السوق الخلفية',
                'driverImage': 'الصورة الشخصية'
            };

            const uploadedFiles = {};
            for (const [fileId, description] of Object.entries(requiredFiles)) {
                const fileInput = document.getElementById(fileId);
                if (!fileInput.files || !fileInput.files[0]) {
                throw new Error(`الرجاء تحميل ${description}`);
                }
                uploadedFiles[fileId] = fileInput.files[0];
            }

            // الحصول على الإحداثيات
            const latitude = parseFloat(document.getElementById('driverLatitude').value);
            const longitude = parseFloat(document.getElementById('driverLongitude').value);

            if (!latitude || !longitude) {
                throw new Error('يرجى تحديد موقع السائق أولاً');
            }

            // 1. إنشاء حساب المستخدم في Firebase Authentication
            const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
            const uid = userCredential.user.uid;

            // رفع جميع الملفات إلى Firebase Storage
            const uploadPromises = {};
            for (const [fileId, file] of Object.entries(uploadedFiles)) {
                const fileRef = storage.ref(`drivers/documents/${uid}/${Date.now()}_${fileId}_${file.name}`);
                uploadPromises[fileId] = fileRef.put(file).then(snapshot => snapshot.ref.getDownloadURL());
            }

            const uploadedUrls = await Promise.all(Object.values(uploadPromises));
            const documentUrls = {};
            Object.keys(uploadPromises).forEach((key, index) => {
                documentUrls[key] = uploadedUrls[index];
            });

            // تجهيز بيانات السائق
            const driverData = {
                uid: uid, // إضافة معرف المستخدم من Authentication
                email: email, // إضافة البريد الإلكتروني
                name: document.getElementById('driverName').value,
                phone: document.getElementById('driverPhone').value,
                carType: document.getElementById('carType').value,
                carModel: document.getElementById('carModel').value,
                location: document.getElementById('driverLocation').value,
                coordinates: {
                lat: latitude,
                lng: longitude
                },
                bio: document.getElementById('driverBio').value,
                imageUrl: documentUrls.driverImage,
                documents: {
                idCard: {
                    front: documentUrls.idCardFront,
                    back: documentUrls.idCardBack
                },
                residenceCard: {
                    front: documentUrls.residenceFront,
                    back: documentUrls.residenceBack
                },
                driverLicense: {
                    front: documentUrls.licenseFront,
                    back: documentUrls.licenseBack
                }
                },
                rating: 5,
                trips: 0,
                approved: false,
                approvalStatus: 'pending',
                active: false,
                registrationDate: firebase.database.ServerValue.TIMESTAMP,
                lastUpdate: firebase.database.ServerValue.TIMESTAMP,
                role: 'driver' // إضافة دور المستخدم
            };

            // 2. حفظ البيانات في قاعدة البيانات الرئيسية
            await database.ref(`drivers/${uid}`).set(driverData);

            // 3. حفظ المعلومات في قسم المستخدمين أيضًا للتحقق من الأدوار
            await database.ref(`users/${uid}`).set({
                uid: uid,
                email: email,
                name: driverData.name,
                phone: driverData.phone,
                imageUrl: driverData.imageUrl,
                role: 'driver',
                registrationDate: firebase.database.ServerValue.TIMESTAMP
            });

            // 4. تحديث ملف تعريف المستخدم في Authentication
            await userCredential.user.updateProfile({
                displayName: driverData.name,
                photoURL: driverData.imageUrl
            });

            // 5. إرسال إشعار إلى نظام الإشعارات حول السائق الجديد
            sendNotificationToAllUsers({
                type: 'new_driver',
                title: 'سائق جديد في منطقتك',
                message: `انضم السائق ${driverData.name} إلى منطقة ${driverData.location}`,
                icon: driverData.imageUrl,
                driverId: uid,
                timestamp: Date.now(),
                location: driverData.location
            });

            // إرسال بريد تأكيد الحساب
            await userCredential.user.sendEmailVerification();

            // إغلاق النافذة المنبثقة
            const modal = bootstrap.Modal.getInstance(document.getElementById('addDriverModal'));
            modal.hide();

            // إعادة تعيين النموذج
            document.getElementById('addDriverForm').reset();

            // إعادة تعيين معاينات الصور
            resetImagePreviews();

            // عرض رسالة نجاح
            Swal.fire({
                title: 'تم تقديم الطلب بنجاح!',
                html: `
                <div class="success-message">
                    <p>تم إنشاء حساب السائق وإرسال طلبك للمراجعة</p>
                    <p>تم إرسال بريد إلكتروني للتحقق إلى: ${email}</p>
                    <p>معرف السائق: ${uid}</p>
                    <small>سيتم مراجعة طلبك وتفعيل حسابك قريباً</small>
                </div>
                `,
                icon: 'success',
                confirmButtonText: 'حسناً',
                confirmButtonColor: '#FFD700'
            });

            // تحديث قائمة السائقين
            loadDrivers();

            } catch (error) {
            console.error('Error adding driver:', error);
            let errorMessage = error.message;

            // تحسين رسائل خطأ Firebase Authentication
            if (error.code === 'auth/email-already-in-use') {
                errorMessage = 'البريد الإلكتروني مستخدم بالفعل';
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = 'البريد الإلكتروني غير صالح';
            } else if (error.code === 'auth/weak-password') {
                errorMessage = 'كلمة المرور ضعيفة جدًا، يرجى استخدام كلمة مرور أقوى';
            }

            showToast(errorMessage, 'error');
            } finally {
            hideLoading();
            }
        }
           
                
        // دالة معالجة تسجيل المستخدم الجديد
        async function handleUserRegistration(event) {
            event.preventDefault();
            showLoading();

            try {
                const formData = new FormData(event.target);
                const email = formData.get('email');
                const password = formData.get('password');
                const confirmPassword = formData.get('confirmPassword');
                const fullName = formData.get('fullName');
                const phone = formData.get('phone');
                const province = formData.get('province');
                const area = formData.get('area');
                const address = formData.get('address');
                
                // التحقق من تطابق كلمات المرور
                if (password !== confirmPassword) {
                    throw new Error('كلمات المرور غير متطابقة');
                }
                
                // التحقق من الموافقة على الشروط والأحكام
                const terms = formData.get('terms');
                if (!terms) {
                    throw new Error('يجب الموافقة على الشروط والأحكام');
                }

                // إنشاء حساب جديد في Firebase Authentication
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // رفع الصورة الشخصية إذا وجدت
                let photoUrl = null;
                const photoFile = document.getElementById('userPhoto').files[0];
                if (photoFile) {
                    const imageRef = firebase.storage().ref(`users/${user.uid}/${Date.now()}_${photoFile.name}`);
                    const uploadTask = await imageRef.put(photoFile);
                    photoUrl = await uploadTask.ref.getDownloadURL();
                    
                    // تحديث صورة المستخدم في الملف الشخصي
                    await user.updateProfile({
                        displayName: fullName,
                        photoURL: photoUrl
                    });
                } else {
                    // تحديث اسم المستخدم في الملف الشخصي حتى لو لم تكن هناك صورة
                    await user.updateProfile({
                        displayName: fullName
                    });
                }

                // حفظ البيانات الإضافية في Realtime Database
                const userData = {
                    uid: user.uid,
                    fullName: fullName,
                    email: email,
                    phone: phone,
                    province: province,
                    area: area,
                    address: address,
                    photoUrl: photoUrl,
                    userType: 'user',
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    lastLogin: firebase.database.ServerValue.TIMESTAMP
                };

                await firebase.database().ref(`users/${user.uid}`).set(userData);

                // إرسال بريد تأكيد الحساب
                await user.sendEmailVerification();

                // حفظ بيانات المستخدم في التخزين المحلي
                localStorage.setItem('currentUser', JSON.stringify(userData));
                
                // تحديث واجهة المستخدم
                updateUIAfterLogin(userData);

                // إغلاق نافذة التسجيل
                const modal = bootstrap.Modal.getInstance(document.getElementById('userRegistrationModal'));
                if (modal) {
                    modal.hide();
                }

                // إرسال حدث نجاح تسجيل الدخول
                document.dispatchEvent(new CustomEvent('login-success'));

                // عرض رسالة نجاح
                Swal.fire({
                    title: 'تم التسجيل بنجاح!',
                    html: `
                        <div class="user-registration-success">
                            <p>مرحباً بك ${fullName} في تطبيق تاكسي العراق</p>
                            <p class="text-muted">تم إرسال رابط تأكيد إلى بريدك الإلكتروني: ${email}</p>
                        </div>
                    `,
                    icon: 'success',
                    confirmButtonColor: '#FFD700',
                    confirmButtonText: 'تم'
                });

            } catch (error) {
                console.error('Registration error:', error);
                
                let errorMessage = 'حدث خطأ أثناء التسجيل';
                
                // ترجمة رسائل خطأ Firebase
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'البريد الإلكتروني مستخدم بالفعل';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'البريد الإلكتروني غير صالح';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'كلمة المرور ضعيفة جداً';
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage = 'تسجيل المستخدمين غير مفعل حالياً';
                        break;
                    default:
                        errorMessage = error.message;
                }
                
                Swal.fire({
                    title: 'خطأ!',
                    text: errorMessage,
                    icon: 'error',
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'حسناً'
                });
            } finally {
                hideLoading();
            }
        }

        // دالة فحص وتهيئة نموذج تسجيل المستخدم
        function initUserRegistrationForm() {
            const userRegistrationForm = document.getElementById('userRegistrationForm');
            if (userRegistrationForm) {
                // إزالة أي مستمعات سابقة لتجنب التكرار
                const newForm = userRegistrationForm.cloneNode(true);
                userRegistrationForm.parentNode.replaceChild(newForm, userRegistrationForm);
                
                // إضافة مستمع الحدث الجديد
                newForm.addEventListener('submit', handleUserRegistration);
                
                // إضافة التحقق من تطابق كلمات المرور
                const passwordInput = newForm.querySelector('input[name="password"]');
                const confirmPasswordInput = newForm.querySelector('input[name="confirmPassword"]');
                
                if (passwordInput && confirmPasswordInput) {
                    confirmPasswordInput.addEventListener('input', function() {
                        if (this.value !== passwordInput.value) {
                            this.setCustomValidity('كلمات المرور غير متطابقة');
                        } else {
                            this.setCustomValidity('');
                        }
                    });
                    
                    passwordInput.addEventListener('input', function() {
                        if (confirmPasswordInput.value && this.value !== confirmPasswordInput.value) {
                            confirmPasswordInput.setCustomValidity('كلمات المرور غير متطابقة');
                        } else {
                            confirmPasswordInput.setCustomValidity('');
                        }
                    });
                }
                
                console.log('تم تهيئة نموذج تسجيل المستخدم');
            }
        }

        // استدعاء دالة التهيئة عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            initUserRegistrationForm();
            
            // إعادة تهيئة النموذج عند فتح النافذة المنبثقة
            const userRegistrationModal = document.getElementById('userRegistrationModal');
            if (userRegistrationModal) {
                userRegistrationModal.addEventListener('shown.bs.modal', function() {
                    initUserRegistrationForm();
                });
            }
        });
        
       // دالة معالجة تسجيل الدخول
async function handleLogin(event) {
    event.preventDefault();
    showLoading();
    
    try {
        const formData = new FormData(event.target);
        const email = formData.get('email');
        const password = formData.get('password');

        // تحقق من حقول الإدخال
        if (!email || !password) {
            throw new Error('يرجى إدخال البريد الإلكتروني وكلمة المرور');
        }

        // محاولة تسجيل الدخول باستخدام Firebase
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // البحث عن بيانات المستخدم في قاعدة البيانات
        let userData = null;

        // البحث في جدول المستخدمين أولاً
        const userSnapshot = await firebase.database().ref(`users/${user.uid}`).once('value');
        userData = userSnapshot.val();

        // إذا لم نجد المستخدم في جدول المستخدمين، نبحث في جدول السائقين
        if (!userData) {
            const driverSnapshot = await firebase.database().ref(`drivers`).orderByChild('uid').equalTo(user.uid).once('value');
            const driversData = driverSnapshot.val();
            
            if (driversData) {
                // استخراج بيانات السائق
                const driverId = Object.keys(driversData)[0];
                userData = driversData[driverId];
                userData.userType = 'driver';
            }
        }

        // إذا لم نجد بيانات في قاعدة البيانات، استخدم بيانات المصادقة فقط
        if (!userData) {
            userData = {
                uid: user.uid,
                email: user.email,
                fullName: user.displayName || 'المستخدم',
                photoUrl: user.photoURL,
                userType: 'user'
            };
        }

        // حفظ بيانات المستخدم في التخزين المحلي
        localStorage.setItem('currentUser', JSON.stringify(userData));

        // تحديث واجهة المستخدم
        updateUIAfterLogin(userData);

        // إغلاق نافذة تسجيل الدخول
        const loginModal = document.getElementById('loginModal');
        if (loginModal) {
            const modalInstance = bootstrap.Modal.getInstance(loginModal);
            if (modalInstance) {
                modalInstance.hide();
            }
        }

        // إرسال حدث نجاح تسجيل الدخول
        document.dispatchEvent(new CustomEvent('login-success'));

        showToast('تم تسجيل الدخول بنجاح', 'success');
    } catch (error) {
        console.error('Login error:', error);
        
        let errorMessage = 'فشل تسجيل الدخول';
        
        // ترجمة رسائل خطأ Firebase
        switch (error.code) {
            case 'auth/user-not-found':
                errorMessage = 'البريد الإلكتروني غير مسجل';
                break;
            case 'auth/wrong-password':
                errorMessage = 'كلمة المرور غير صحيحة';
                break;
            case 'auth/invalid-email':
                errorMessage = 'البريد الإلكتروني غير صالح';
                break;
            case 'auth/user-disabled':
                errorMessage = 'تم تعطيل هذا الحساب';
                break;
            case 'auth/too-many-requests':
                errorMessage = 'تم تجاوز عدد محاولات تسجيل الدخول المسموح بها، يرجى المحاولة لاحقاً';
                break;
            default:
                errorMessage = error.message;
        }
        
        showToast(errorMessage, 'error');
    } finally {
        hideLoading();
    }
}

// دالة إظهار مؤشر التحميل
function showLoading() {
    const loadingSpinner = document.getElementById('loadingSpinner');
    if (loadingSpinner) {
        loadingSpinner.style.display = 'flex';
    } else {
        // إنشاء مؤشر التحميل إذا لم يكن موجوداً
        const spinner = document.createElement('div');
        spinner.id = 'loadingSpinner';
        spinner.className = 'loading-spinner';
        spinner.innerHTML = '<div class="spinner"></div>';
        document.body.appendChild(spinner);
    }
    
    // تعطيل التفاعل مع الصفحة أثناء التحميل
    document.body.style.pointerEvents = 'none';
}

        // دالة معدلة لفتح نافذة المحادثة مع التحقق من تسجيل الدخول
        function openChatWindow(driverId, driverImage, driverName, driverCard) {
            // التحقق من حالة تسجيل الدخول أولاً
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!currentUser) {
                // إذا لم يكن المستخدم مسجل الدخول، نعرض نافذة تسجيل الدخول
                showLoginPrompt('يجب تسجيل الدخول أو إنشاء حساب للتمكن من مراسلة السائق');
                return;
            }
            
            // إذا كان المستخدم مسجل الدخول، نستمر بفتح نافذة المحادثة
            currentChatDriverId = driverId;
            currentDriverImage = driverImage || '';
            currentDriverName = driverName || '';
            currentDriverCard = driverCard || '';

            // تحديث بيانات السائق في النافذة
            const driverImageEl = document.getElementById('driverImage');
            const driverNameEl = document.getElementById('driverName');
            const driverCardInfoEl = document.getElementById('driverCardInfo');
            
            if (driverImageEl) driverImageEl.src = currentDriverImage || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527';
            if (driverNameEl) driverNameEl.innerText = currentDriverName || 'السائق';
            if (driverCardInfoEl) driverCardInfoEl.innerText = currentDriverCard ? `بطاقة: ${currentDriverCard}` : '';

            // إعادة ضبط النافذة: إظهار إدخال الرحلة
            const tripSelection = document.getElementById('tripSelection');
            const chatFooter = document.querySelector('.chat-footer');
            const chatMessages = document.getElementById('chatMessages');
            
            if (tripSelection) tripSelection.classList.remove('d-none');
            if (chatFooter) chatFooter.classList.add('d-none');
            if (chatMessages) chatMessages.classList.add('d-none');

            // إظهار النافذة
            const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
            chatModal.show();
        }

        // دالة للتحقق من حالة تسجيل الدخول قبل القيام بأي إجراء يتطلب تسجيل الدخول
        function checkAuthBeforeAction(action, message) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!currentUser) {
                // إذا لم يكن المستخدم مسجل الدخول، نعرض نافذة تسجيل الدخول
                showLoginPrompt(message || 'يجب تسجيل الدخول أو إنشاء حساب للقيام بهذا الإجراء');
                return false;
            }
            
            // إذا كان المستخدم مسجل الدخول، نقوم بتنفيذ الإجراء
            if (typeof action === 'function') {
                action();
            }
            
            return true;
        }

        // دالة عرض نافذة تأكيد تسجيل الدخول
        function showLoginPrompt(message) {
            Swal.fire({
                title: 'مطلوب تسجيل الدخول',
                text: message || 'يجب تسجيل الدخول أو إنشاء حساب للمتابعة',
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'تسجيل الدخول',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#FFD700',
                cancelButtonColor: '#6c757d',
                background: '#1a1a1a',
                color: '#FFFFFF',
                showDenyButton: true,
                denyButtonText: 'إنشاء حساب',
                denyButtonColor: '#28a745'
            }).then((result) => {
                if (result.isConfirmed) {
                    // فتح نافذة تسجيل الدخول
                    const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
                    loginModal.show();
                } else if (result.isDenied) {
                    // فتح نافذة إنشاء حساب
                    const regModal = new bootstrap.Modal(document.getElementById('userRegistrationModal'));
                    regModal.show();
                }
            });
        }

        // تعديل دالة viewDriverLocation للتحقق من تسجيل الدخول أيضًا
        function viewDriverLocation(driverId) {
            // التحقق من حالة تسجيل الدخول للاطلاع على موقع السائق (اختياري)
            // يمكنك التعليق على هذا التحقق إذا كنت ترغب بعرض الموقع بدون تسجيل دخول
            
            /*
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                showLoginPrompt('يجب تسجيل الدخول أو إنشاء حساب للاطلاع على موقع السائق');
                return;
            }
            */
            
            database.ref(`drivers/${driverId}`).once('value', (snapshot) => {
                const driver = snapshot.val();
                if (driver && driver.coordinates) {
                    // التحقق من حالة الموافقة
                    const isApproved = driver.approved === true;
                    const isPending = driver.approvalStatus === 'pending';
                    const { lat, lng } = driver.coordinates;

                    map.flyTo([lat, lng], 15, {
                        animate: true,
                        duration: 1.5
                    });

                    markerLayer.clearLayers();

                    // تعديل مظهر العلامة حسب حالة الموافقة
                    const driverMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            html: `
                                <div style="position: relative; text-align: center;" class="${isApproved ? 'approved' : (isPending ? 'pending' : 'not-approved')}">
                                    <img src="${driver.imageUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" 
                                         alt="صورة السائق" 
                                         style="width: 50px; height: 50px; border: 3px solid #FFD700; 
                                         border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                                         filter: ${!isApproved ? 'grayscale(100%)' : 'none'};
                                         opacity: ${!isApproved ? '0.7' : '1'};">
                                    <i class="fas fa-taxi" 
                                       style="position: absolute; bottom: -5px; right: 50%; transform: translateX(50%); 
                                       color: ${isApproved ? '#FFD700' : '#999'}; font-size: 1.5rem;"></i>
                                    ${!isApproved ? `
                                    <div class="status-badge" style="position: absolute; top: -10px; right: -10px; 
                                         background: ${isPending ? '#FFD700' : '#dc3545'}; color: ${isPending ? '#000' : '#fff'};
                                         padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold;">
                                        ${isPending ? 'قيد المراجعة' : 'غير مفعل'}
                                    </div>` : ''}
                                </div>
                            `,
                            className: 'driver-marker',
                            iconSize: [60, 60],
                            iconAnchor: [25, 50]
                        }),
                    }).addTo(markerLayer);

                    // تحديث محتوى النافذة المنبثقة
                    const popupContent = `
                        <div style="text-align: center; font-family: 'Segoe UI', sans-serif; min-width: 200px; 
                             background: #000000; border-radius: 10px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                            ${!isApproved ? `
                            <div class="status-banner" style="background: ${isPending ? '#FFD700' : '#dc3545'}; 
                                 color: ${isPending ? '#000' : '#fff'}; padding: 5px; margin: -15px -15px 15px -15px; 
                                 border-radius: 10px 10px 0 0; font-weight: bold;">
                                ${isPending ? 'هذا السائق قيد المراجعة' : 'هذا السائق غير مفعل حالياً'}
                            </div>
                            ` : ''}
                            
                            <div class="driver-popup-header" style="margin-bottom: 10px;">
                                <img src="${driver.imageUrl || 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/driver-images%2F7605a607-6cf8-4b32-aee1-fa7558c98452.png?alt=media&token=5cf9e67c-ba6e-4431-a6a0-79dede15b527'}" 
                                     alt="صورة السائق" 
                                     style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #FFD700; 
                                     margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
                                     filter: ${!isApproved ? 'grayscale(100%)' : 'none'};">
                                <h5 style="color: #FFFFFF; font-weight: bold; margin: 8px 0;">${driver.name}</h5>
                            </div>
                            
                            <div class="driver-popup-stats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 15px;">
                                <div style="text-align: center;">
                                    <div style="font-weight: bold; color: #FFD700;">
                                        <i class="fas fa-star"></i> ${driver.rating ? driver.rating.toFixed(1) : '5.0'}
                                    </div>
                                    <div style="font-size: 0.8rem; color: #FFFFFF;">التقييم</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-weight: bold; color: #FFD700;">
                                        <i class="fas fa-route"></i> ${driver.trips || 0}
                                    </div>
                                    <div style="font-size: 0.8rem; color: #FFFFFF;">الرحلات</div>
                                </div>
                            </div>
                            
                            <div class="driver-popup-info" style="margin-bottom: 15px; text-align: right; color: #FFFFFF;">
                                <p style="margin: 5px 0;">
                                    <i class="fas fa-car" style="color: #FFD700; margin-left: 5px;"></i>
                                    ${driver.carType} - ${driver.carModel}
                                </p>
                                <p style="margin: 5px 0;">
                                    <i class="fas fa-map-marker-alt" style="color: #FFD700; margin-left: 5px;"></i>
                                    ${driver.location}
                                </p>
                                <p style="margin: 5px 0;">
                                    <i class="fas fa-phone" style="color: #FFD700; margin-left: 5px;"></i>
                                    ${driver.phone}
                                </p>
                            </div>
                    
                            <div class="driver-popup-actions" style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                <button onclick="openChatWindow('${driverId}')" 
                                        style="background: #FFD700; color: #333; border: none; padding: 8px 15px; 
                                        border-radius: 20px; cursor: ${isApproved ? 'pointer' : 'not-allowed'}; 
                                        font-weight: bold; display: flex; align-items: center; justify-content: center; 
                                        gap: 5px; transition: all 0.3s ease; opacity: ${isApproved ? '1' : '0.5'};"
                                        ${!isApproved ? 'disabled' : ''}>
                                    <i class="fas fa-comment"></i>
                                    ${isApproved ? 'مراسلة السائق' : 'غير متاح حالياً'}
                                </button>
                            </div>

                            ${!isApproved ? `
                                <div class="approval-notice">
                                    ${isPending ?
                                        'هذا السائق قيد المراجعة. سيتم تفعيل الحساب قريباً.' :
                                        'هذا الحساب غير مفعل. يرجى انتظار الموافقة.'}
                                </div>
                            ` : ''}
                        </div>
                    `;

                    driverMarker.bindPopup(popupContent, {
                        maxWidth: 300,
                        className: 'custom-popup'
                    }).openPopup();

                    scrollToMap();

                    // تعديل رسالة التأكيد حسب حالة الموافقة
                    if (isApproved) {
                        Swal.fire({
                            title: '🚖 تم تحديد موقع السائق!',
                            html: `
                                <p style="font-size: 1rem; color: #555;">
                                    السائق <b>${driver.name}</b> بانتظارك.
                                </p>
                                <p style="color: #666;">هل ترغب بمراسلته الآن؟</p>
                            `,
                            icon: 'success',
                            showCancelButton: true,
                            confirmButtonColor: '#FFD700',
                            cancelButtonColor: '#6c757d',
                            confirmButtonText: '📨 نعم، مراسلة السائق',
                            cancelButtonText: '❌ إغلاق',
                        }).then((result) => {
                            if (result.isConfirmed) {
                                openChatWindow(driverId);
                            }
                        });
                    } else {
                        Swal.fire({
                            title: 'تنبيه!',
                            html: `
                                <p style="font-size: 1rem; color: #555;">
                                    السائق <b>${driver.name}</b> ${isPending ? 'قيد المراجعة' : 'غير مفعل حالياً'}.
                                </p>
                                <p style="color: #666;">لا يمكن التواصل مع السائق حتى يتم تفعيل حسابه.</p>
                            `,
                            icon: 'warning',
                            confirmButtonColor: '#6c757d',
                            confirmButtonText: 'حسناً'
                        });
                    }
                } else {
                    showToast('لم يتم العثور على موقع السائق.', 'error');
                }
            });
        }

        // تعديل باقي دوال التفاعل مع السائق للتحقق من تسجيل الدخول
        function bookDriver(driverId) {
            // التحقق من حالة تسجيل الدخول لحجز السائق
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                showLoginPrompt('يجب تسجيل الدخول أو إنشاء حساب لحجز السائق');
                return;
            }
            
            showLoading();
            database.ref(`drivers/${driverId}`).once('value', (snapshot) => {
                const driver = snapshot.val();
                if (driver && driver.active) {
                    setTimeout(() => {
                        hideLoading();
                        database.ref(`drivers/${driverId}`).update({
                            active: false // تعيين الحالة إلى "مشغول"
                        }).then(() => {
                            showToast(`تم إرسال طلب الحجز إلى ${driver.name}`);
                            window.location.href = `tel:${driver.phone}`;
                            loadDrivers(); // تحديث حالة السائقين في الواجهة
                        });
                    }, 1500);
                } else {
                    hideLoading();
                    showToast('السائق غير متاح حالياً', 'error');
                }
            });
        }

        // تعديل دالة الإضافة إلى المفضلة للتحقق من تسجيل الدخول
        function addToFavorites(driverId) {
            // التحقق من حالة تسجيل الدخول للإضافة إلى المفضلة
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                showLoginPrompt('يجب تسجيل الدخول أو إنشاء حساب لإضافة السائق إلى المفضلة');
                return;
            }
            
            const driverCard = document.querySelector(`[data-driver-id="${driverId}"]`);
            if (driverCard) {
                const favoritesContainer = document.getElementById('favoritesContainer');
                if (favoritesContainer) {
                    const clonedCard = driverCard.cloneNode(true);
                    favoritesContainer.appendChild(clonedCard);
                    showToast('تمت إضافة السائق إلى المفضلة', 'success');
                    
                    // حفظ إلى التخزين المحلي أو قاعدة البيانات
                    saveFavoriteDriver(driverId, currentUser.uid);
                } else {
                    showToast('خطأ في إضافة السائق إلى المفضلة', 'error');
                }
            }
        }

        // دالة حفظ السائق المفضل إلى قاعدة البيانات
        function saveFavoriteDriver(driverId, userId) {
            database.ref(`favorites/${userId}/${driverId}`).set({
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                console.log('تم حفظ السائق في المفضلة');
            }).catch(error => {
                console.error('خطأ في حفظ السائق المفضل:', error);
            });
        }

        // دالة فتح نافذة المحادثة
        function openChatModal(driverId) {
            openChatWindow(driverId);
        }

// دالة عرض قائمة المستخدم
function showUserMenu(event) {
    event.preventDefault();
    const userData = JSON.parse(localStorage.getItem('currentUser'));
    
    Swal.fire({
        title: `مرحباً ${userData.fullName || userData.name}`,
        html: `
            <div class="text-center mb-3">
                <img src="${userData.photoUrl || userData.photoURL || 'default-avatar.png'}" 
                     alt="صورة المستخدم" 
                     class="rounded-circle mb-3"
                     style="width: 100px; height: 100px; object-fit: cover;">
                <p class="mb-2">${userData.email}</p>
                <p class="text-muted">${userData.phone || ''}</p>
            </div>
        `,
        showCancelButton: true,
        showDenyButton: true,
        confirmButtonText: 'تعديل الملف الشخصي',
        denyButtonText: 'تسجيل الخروج',
        cancelButtonText: 'إغلاق',
        confirmButtonColor: '#FFD700',
        denyButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d'
    }).then((result) => {
        if (result.isConfirmed) {
            // فتح نافذة تعديل الملف الشخصي
            showEditProfileModal();
        } else if (result.isDenied) {
            handleLogout();
        }
    });
}

// مراقبة حالة تسجيل الدخول
firebase.auth().onAuthStateChanged(async (user) => {
    if (user) {
        // المستخدم مسجل الدخول
        console.log('User is signed in:', user.uid);
        
        try {
            const userDataSnapshot = await firebase.database().ref(`users/${user.uid}`).once('value');
            const userData = userDataSnapshot.val();
            
            if (userData) {
                updateUIAfterLogin({
                    ...userData,
                    name: user.displayName,
                    photo: user.photoURL
                });
            }
        } catch (error) {
            console.error('Error fetching user data:', error);
        }
    } else {
        // المستخدم غير مسجل الدخول
        console.log('User is signed out');
        localStorage.removeItem('currentUser');
        resetUserInterface();
    }
});
        // ...existing code...
    </script>
<script src="nearby-drivers.js"></script>
<script src="auth.js"></script>
<script src="modal.js"></script>
<script src="favorite-drivers.js"></script>
<script src="notifications-manager.js"></script>


</body>

</html>